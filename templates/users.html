{% extends "base.html" %}
{% block title %}User Management - GBot Web{% endblock %}

{% block content %}
<div class="dark-page">
    <!-- Main Content Grid -->
    <div class="dark-users-grid">
        <!-- Add New User Card -->
        <div class="dark-card add-user-card">
            <div class="dark-card-header">
                <h3 class="dark-card-title">
                    <span class="title-icon">â•</span>
                    Add New User
                </h3>
                <p class="dark-card-subtitle">Create a new user account with role-based access</p>
            </div>
            
            <div class="dark-card-body">
                <form class="user-form" id="add-user-form">
                    <div class="dark-form-group">
                        <label for="new-username" class="dark-form-label">
                            <span class="label-icon">ğŸ‘¤</span>
                            Username
                        </label>
                        <input type="text" 
                               id="new-username" 
                               class="dark-form-input" 
                               placeholder="Enter username" 
                               required>
                    </div>
                    
                    <div class="dark-form-group">
                        <label for="new-password" class="dark-form-label">
                            <span class="label-icon">ğŸ”’</span>
                            Password
                        </label>
                        <input type="password" 
                               id="new-password" 
                               class="dark-form-input" 
                               placeholder="Enter secure password" 
                               required>
                    </div>
                    
                    <div class="dark-form-group">
                        <label for="new-role" class="dark-form-label">
                            <span class="label-icon">ğŸ­</span>
                            Role
                        </label>
                        <select id="new-role" class="dark-form-select">
                            <option value="support">ğŸ‘¨â€ğŸ’¼ Support</option>
                            <option value="mailer">ğŸ“§ Mailer</option>
                            <option value="admin">ğŸ”§ Admin</option>
                        </select>
                    </div>
                    
                    <button type="button" onclick="addUser()" class="dark-btn dark-btn-primary">
                        <span class="btn-icon">â•</span>
                        Add User
                    </button>
                </form>
            </div>
        </div>
        
        <!-- Existing Users Card -->
        <div class="dark-card users-list-card">
            <div class="dark-card-header">
                <h3 class="dark-card-title">
                    <span class="title-icon">ğŸ“‹</span>
                    Existing Users
                </h3>
                <p class="dark-card-subtitle">Manage existing user accounts and permissions</p>
            </div>
            
            <div class="dark-card-body">
                <div id="user-list" class="dark-users-container">
                    <div class="dark-loading-state">
                        <div class="dark-loading-spinner"></div>
                        <p>Loading users...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
// User management functions
function addUser() {
    const username = document.getElementById('new-username').value.trim();
    const password = document.getElementById('new-password').value.trim();
    const role = document.getElementById('new-role').value;
    
    if (!username || !password) {
        alert('Please fill in all fields');
        return;
    }
    
    fetch('/api/add-user', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({username, password, role})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('âœ… User added successfully!');
            document.getElementById('new-username').value = '';
            document.getElementById('new-password').value = '';
            loadUsers();
        } else {
            alert('âŒ Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('âŒ Network error: ' + error);
    });
}

function loadUsers() {
    fetch('/api/list-users')
    .then(response => response.json())
    .then(data => {
        if (data.success && Array.isArray(data.users)) {
            const userList = document.getElementById('user-list');
            if (data.users.length === 0) {
                userList.innerHTML = '<p>No users found.</p>';
                return;
            }
            
            userList.innerHTML = data.users.map((user, index) => `
                <div class="dark-user-item">
                    <div class="dark-user-info">
                        <div class="dark-user-number">${index + 1}</div>
                        <div class="dark-user-details">
                            <div class="dark-user-name">${user.username}</div>
                            <span class="dark-role-badge dark-role-${user.role}">
                                ${user.role === 'admin' ? 'ğŸ”§' : user.role === 'mailer' ? 'ğŸ“§' : 'ğŸ‘¨â€ğŸ’¼'} 
                                ${user.role.charAt(0).toUpperCase() + user.role.slice(1)}
                            </span>
                        </div>
                    </div>
                    <div class="dark-user-actions">
                        <button onclick="editUser('${user.username}', '${user.role}')" class="dark-btn dark-btn-secondary">
                            <span class="btn-icon">âœï¸</span>
                            Edit
                        </button>
                        <button onclick="deleteUser('${user.username}')" class="dark-btn dark-btn-danger">
                            <span class="btn-icon">ğŸ—‘ï¸</span>
                            Delete
                        </button>
                    </div>
                </div>
            `).join('');
        } else {
            document.getElementById('user-list').innerHTML = '<p>Error loading users.</p>';
        }
    })
    .catch(error => {
        console.error("Fetch error:", error);
        document.getElementById('user-list').innerHTML = '<p>Network error loading users.</p>';
    });
}

function editUser(username, currentRole) {
    const newPassword = prompt(`Enter new password for user "${username}":`);
    if (!newPassword) return;
    
    const newRole = prompt(`Enter role for "${username}" (admin/support/mailer):`, currentRole);
    if (!newRole) return;
    
    if (newRole !== 'admin' && newRole !== 'support' && newRole !== 'mailer') {
        alert('Role must be either "admin", "support", or "mailer"');
        return;
    }
    
    fetch('/api/edit-user', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({username, password: newPassword, role: newRole})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('âœ… User updated successfully!');
            loadUsers();
        } else {
            alert('âŒ Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('âŒ Network error: ' + error);
    });
}

function deleteUser(username) {
    if (username === '{{ user }}') {
        alert('âŒ Cannot delete your own account!');
        return;
    }
    
    if (!confirm(`âš ï¸ Delete user "${username}"?\n\nThis action cannot be undone.`)) {
        return;
    }
    
    fetch('/api/delete-user', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({username})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('âœ… User deleted successfully!');
            loadUsers();
        } else {
            alert('âŒ Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('âŒ Network error: ' + error);
    });
}

// Load users when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadUsers();
});
</script>
{% endblock %}