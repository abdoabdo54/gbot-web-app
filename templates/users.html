{% extends "base.html" %}
{% block title %}User Management - GBot{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header Section -->
    <div class="section">
        <h2 style="color: var(--text-primary); font-weight: 700; margin-bottom: 2rem; font-size: 1.5rem;">
            <i class="bi bi-people me-2"></i>User Management
        </h2>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 2rem;">
            <!-- Add New User -->
            <div style="background: var(--bg-secondary); padding: 2rem; border-radius: 12px; border: 1px solid var(--border-primary);">
                <h3 style="color: var(--text-primary); font-weight: 600; margin-bottom: 1.5rem; font-size: 1.25rem;">
                    <i class="bi bi-person-plus me-2"></i>Add New User
                </h3>
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label for="new-username" style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem; font-size: 0.875rem;">Username:</label>
                    <input type="text" id="new-username" placeholder="Enter username" required 
                           style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-primary); border-radius: 6px; font-size: 0.875rem; background: var(--bg-primary); color: var(--text-primary);">
                </div>
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label for="new-password" style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem; font-size: 0.875rem;">Password:</label>
                    <input type="password" id="new-password" placeholder="Enter password" required 
                           style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-primary); border-radius: 6px; font-size: 0.875rem; background: var(--bg-primary); color: var(--text-primary);">
                </div>
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label for="new-role" style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem; font-size: 0.875rem;">Role:</label>
                    <select id="new-role" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-primary); border-radius: 6px; font-size: 0.875rem; background: var(--bg-primary); color: var(--text-primary);">
                        <option value="support">Support</option>
                        <option value="mailer">Mailer</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <button onclick="addUser()" class="btn btn-primary" style="background: var(--accent-primary); color: var(--bg-primary); padding: 0.75rem 1.5rem; border-radius: 6px; font-weight: 500; font-size: 0.875rem; width: 100%;">
                    <i class="bi bi-plus-circle me-2"></i>Add User
                </button>
            </div>
            
            <!-- Existing Users -->
            <div>
                <h3 style="color: var(--text-primary); font-weight: 600; margin-bottom: 1.5rem; font-size: 1.25rem;">
                    <i class="bi bi-people me-2"></i>Existing Users
                </h3>
                <div id="user-list" style="margin-top: 1rem;">
                    <div style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                        <i class="bi bi-hourglass-split fs-1 mb-3"></i>
                        <p>Loading users...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Form Control Focus States */
.form-control:focus, input:focus, select:focus {
    border-color: var(--accent-secondary);
    box-shadow: 0 0 0 3px rgba(0, 112, 243, 0.1);
    outline: none;
}

/* Button Hover Effects */
.btn:hover {
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
}

/* User Card Styles */
.user-card {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background: var(--bg-primary);
    margin-bottom: 0.75rem;
    border-radius: 8px;
    border: 1px solid var(--border-primary);
    transition: all 0.2s ease;
}

.user-card:hover {
    box-shadow: var(--shadow-sm);
    transform: translateY(-1px);
}

.user-info {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.user-number {
    font-weight: 600;
    min-width: 30px;
    color: var(--text-secondary);
}

.user-details {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.user-name {
    font-weight: 600;
    font-size: 1rem;
    color: var(--text-primary);
}

.user-role {
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
}

.user-role.admin {
    background: var(--accent-error);
    color: white;
}

.user-role.mailer {
    background: #f5a623;
    color: white;
}

.user-role.support {
    background: var(--accent-success);
    color: white;
}

.user-actions {
    display: flex;
    gap: 0.5rem;
}

.action-btn {
    background: var(--bg-tertiary);
    color: var(--text-primary);
    border: 1px solid var(--border-primary);
    padding: 0.5rem 1rem;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.875rem;
    font-weight: 500;
    transition: all 0.2s ease;
}

.action-btn:hover {
    background: var(--bg-secondary);
    transform: translateY(-1px);
}

.action-btn.edit {
    background: var(--accent-secondary);
    color: white;
    border-color: var(--accent-secondary);
}

.action-btn.delete {
    background: var(--accent-error);
    color: white;
    border-color: var(--accent-error);
}

/* Responsive Design */
@media (max-width: 768px) {
    .container-fluid {
        padding: 1rem;
    }
    
    .section > div {
        grid-template-columns: 1fr;
    }
    
    .user-card {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
    }
    
    .user-actions {
        width: 100%;
        justify-content: flex-end;
    }
}
</style>

<script>
// User management functions
function addUser() {
    const username = document.getElementById('new-username').value.trim();
    const password = document.getElementById('new-password').value.trim();
    const role = document.getElementById('new-role').value;
    
    if (!username || !password) {
        alert('Please fill in all fields');
        return;
    }
    
    fetch('/api/add-user', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({username, password, role})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('✅ User added successfully!');
            document.getElementById('new-username').value = '';
            document.getElementById('new-password').value = '';
            loadUsers();
        } else {
            alert('❌ Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('❌ Network error: ' + error);
    });
}

function loadUsers() {
    fetch('/api/list-users')
    .then(response => response.json())
    .then(data => {
        if (data.success && Array.isArray(data.users)) {
            const userList = document.getElementById('user-list');
            if (data.users.length === 0) {
                userList.innerHTML = `
                    <div style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                        <i class="bi bi-people fs-1 mb-3"></i>
                        <p>No users found.</p>
                    </div>
                `;
                return;
            }
            
            userList.innerHTML = data.users.map((user, index) => `
                <div class="user-card">
                    <div class="user-info">
                        <span class="user-number">${index + 1}</span>
                        <div class="user-details">
                            <div class="user-name">${user.username}</div>
                            <span class="user-role ${user.role}">${user.role}</span>
                        </div>
                    </div>
                    <div class="user-actions">
                        <button onclick="editUser('${user.username}', '${user.role}')" class="action-btn edit">
                            <i class="bi bi-pencil me-1"></i>Edit
                        </button>
                        <button onclick="deleteUser('${user.username}')" class="action-btn delete">
                            <i class="bi bi-trash me-1"></i>Delete
                        </button>
                    </div>
                </div>
            `).join('');
        } else {
            document.getElementById('user-list').innerHTML = `
                <div style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                    <i class="bi bi-exclamation-triangle fs-1 mb-3"></i>
                    <p>Failed to load users</p>
                </div>
            `;
        }
    })
    .catch(error => {
        document.getElementById('user-list').innerHTML = `
            <div style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                <i class="bi bi-exclamation-triangle fs-1 mb-3"></i>
                <p>Network error: ${error}</p>
            </div>
        `;
    });
}

function editUser(username, currentRole) {
    const newRole = prompt(`Edit role for ${username} (current: ${currentRole}):\nEnter: support, mailer, or admin`);
    
    if (newRole && ['support', 'mailer', 'admin'].includes(newRole.toLowerCase())) {
        fetch('/api/update-user-role', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({username, role: newRole.toLowerCase()})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('✅ User role updated successfully!');
                loadUsers();
            } else {
                alert('❌ Error: ' + data.error);
            }
        })
        .catch(error => {
            alert('❌ Network error: ' + error);
        });
    }
}

function deleteUser(username) {
    if (confirm(`Are you sure you want to delete user "${username}"?`)) {
        fetch('/api/delete-user', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({username})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('✅ User deleted successfully!');
                loadUsers();
            } else {
                alert('❌ Error: ' + data.error);
            }
        })
        .catch(error => {
            alert('❌ Network error: ' + error);
        });
    }
}

// Load users on page load
document.addEventListener('DOMContentLoaded', function() {
    loadUsers();
});
</script>
{% endblock %}