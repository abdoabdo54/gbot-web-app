{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- DNS Management Header -->
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title">
                        <i class="fas fa-globe"></i> DNS & Namecheap Management
                        <span class="badge badge-info" id="dnsStatus">Loading...</span>
                    </h4>
                    <p class="text-muted">Manage DNS records and Google Site Verification</p>
                </div>
            </div>
        </div>

        <!-- Configuration Section -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-cog"></i> Namecheap API Configuration</h5>
                </div>
                <div class="card-body">
                    <div id="configStatus" class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        Checking configuration...
                    </div>
                    
                    <form id="namecheapConfigForm">
                        <div class="form-group">
                            <label for="apiUser">API User</label>
                            <input type="text" class="form-control" id="apiUser" placeholder="your_api_user">
                        </div>
                        <div class="form-group">
                            <label for="apiKey">API Key</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="apiKey" placeholder="your_api_key">
                                <div class="input-group-append">
                                    <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('apiKey')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                            <small class="text-warning">⚠️ Stored in plain text - encrypt before production!</small>
                        </div>
                        <div class="form-group">
                            <label for="username">Username</label>
                            <input type="text" class="form-control" id="username" placeholder="your_username">
                        </div>
                        <div class="form-group">
                            <label for="clientIp">Client IP</label>
                            <input type="text" class="form-control" id="clientIp" placeholder="your_whitelisted_ip">
                            <small class="text-muted">Must be whitelisted in Namecheap account</small>
                        </div>
                        <div class="form-group">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="isSandbox" checked>
                                <label class="form-check-label" for="isSandbox">
                                    Use Sandbox Environment
                                </label>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save Configuration
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-bolt"></i> Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="btn-group-vertical w-100">
                        <button class="btn btn-success mb-2" onclick="showCreateSubdomainModal()">
                            <i class="fas fa-plus"></i> Create Subdomain
                        </button>
                        <button class="btn btn-info mb-2" onclick="showAddRecordModal()">
                            <i class="fas fa-list"></i> Add DNS Record
                        </button>
                        <button class="btn btn-warning mb-2" onclick="showVerifyDomainModal()">
                            <i class="fas fa-shield-alt"></i> Verify with Google
                        </button>
                        <button class="btn btn-secondary" onclick="loadDNSHistory()">
                            <i class="fas fa-history"></i> View History
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Domain Records Viewer -->
            <div class="card mt-3">
                <div class="card-header">
                    <h5><i class="fas fa-search"></i> View Domain Records</h5>
                </div>
                <div class="card-body">
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" id="domainToView" placeholder="example.com">
                        <div class="input-group-append">
                            <button class="btn btn-primary" onclick="loadDomainRecords()">
                                <i class="fas fa-search"></i> Load
                            </button>
                        </div>
                    </div>
                    <div id="domainRecordsResult"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- DNS Records Display -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-list"></i> DNS Records & History</h5>
                </div>
                <div class="card-body">
                    <div id="dnsRecordsTable">
                        <p class="text-muted">Load domain records or view history to see DNS data</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Subdomain Modal -->
<div class="modal fade" id="createSubdomainModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create Subdomain</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="createSubdomainForm">
                    <div class="form-group">
                        <label for="subDomain">Domain</label>
                        <input type="text" class="form-control" id="subDomain" placeholder="example.com" required>
                    </div>
                    <div class="form-group">
                        <label for="subSubdomain">Subdomain</label>
                        <input type="text" class="form-control" id="subSubdomain" placeholder="api" required>
                    </div>
                    <div class="form-group">
                        <label for="subTarget">Target</label>
                        <input type="text" class="form-control" id="subTarget" placeholder="192.168.1.1 or target.example.com" required>
                    </div>
                    <div class="form-group">
                        <label for="subRecordType">Record Type</label>
                        <select class="form-control" id="subRecordType">
                            <option value="A">A Record</option>
                            <option value="CNAME">CNAME</option>
                            <option value="TXT">TXT</option>
                            <option value="MX">MX</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="subTTL">TTL (seconds)</label>
                        <input type="number" class="form-control" id="subTTL" value="1800" min="300">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createSubdomain()">
                    <i class="fas fa-plus"></i> Create
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add DNS Record Modal -->
<div class="modal fade" id="addRecordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add DNS Record</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addRecordForm">
                    <div class="form-group">
                        <label for="recordDomain">Domain</label>
                        <input type="text" class="form-control" id="recordDomain" placeholder="example.com" required>
                    </div>
                    <div class="form-group">
                        <label for="recordName">Record Name</label>
                        <input type="text" class="form-control" id="recordName" placeholder="@ or www or subdomain" required>
                        <small class="text-muted">Use @ for root domain</small>
                    </div>
                    <div class="form-group">
                        <label for="recordType">Record Type</label>
                        <select class="form-control" id="recordType" onchange="handleRecordTypeChange()">
                            <option value="A">A Record</option>
                            <option value="CNAME">CNAME</option>
                            <option value="TXT">TXT</option>
                            <option value="MX">MX</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="recordValue">Record Value</label>
                        <input type="text" class="form-control" id="recordValue" placeholder="192.168.1.1" required>
                    </div>
                    <div class="form-group" id="mxPrefGroup" style="display: none;">
                        <label for="mxPref">MX Preference</label>
                        <input type="number" class="form-control" id="mxPref" placeholder="10" min="0">
                    </div>
                    <div class="form-group">
                        <label for="recordTTL">TTL (seconds)</label>
                        <input type="number" class="form-control" id="recordTTL" value="1800" min="300">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addDNSRecord()">
                    <i class="fas fa-plus"></i> Add Record
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Google Verification Modal -->
<div class="modal fade" id="verifyDomainModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Google Site Verification</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    This will automatically get a verification token from Google, add it as a TXT record, and verify the domain.
                </div>
                <form id="verifyDomainForm">
                    <div class="form-group">
                        <label for="verifyDomain">Domain to Verify</label>
                        <input type="text" class="form-control" id="verifyDomain" placeholder="example.com" required>
                    </div>
                </form>
                <div id="verificationProgress" style="display: none;">
                    <div class="progress mb-3">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%"></div>
                    </div>
                    <div id="verificationSteps"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="verifyWithGoogle()">
                    <i class="fas fa-shield-alt"></i> Start Verification
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// DNS Management JavaScript Functions

// Initialize page
$(document).ready(function() {
    loadDNSStatus();
    loadNamecheapConfig();
});

// Load DNS module status
async function loadDNSStatus() {
    try {
        const response = await fetch('/api/dns/health');
        const result = await response.json();
        
        const statusBadge = document.getElementById('dnsStatus');
        if (result.success) {
            statusBadge.className = 'badge badge-success';
            statusBadge.textContent = 'DNS Module Active';
        } else {
            statusBadge.className = 'badge badge-danger';
            statusBadge.textContent = 'DNS Module Error';
        }
    } catch (error) {
        document.getElementById('dnsStatus').className = 'badge badge-danger';
        document.getElementById('dnsStatus').textContent = 'Connection Error';
    }
}

// Load Namecheap configuration
async function loadNamecheapConfig() {
    try {
        const response = await fetch('/api/dns/namecheap/config');
        const result = await response.json();
        
        const configStatus = document.getElementById('configStatus');
        
        if (result.configured) {
            configStatus.className = 'alert alert-success';
            configStatus.innerHTML = '<i class="fas fa-check-circle"></i> Namecheap API configured successfully';
            
            // Populate form fields
            document.getElementById('apiUser').value = result.config.api_user || '';
            document.getElementById('username').value = result.config.username || '';
            document.getElementById('clientIp').value = result.config.client_ip || '';
            document.getElementById('isSandbox').checked = result.config.is_sandbox || false;
        } else {
            configStatus.className = 'alert alert-warning';
            configStatus.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Namecheap API not configured';
        }
    } catch (error) {
        document.getElementById('configStatus').className = 'alert alert-danger';
        document.getElementById('configStatus').innerHTML = '<i class="fas fa-times-circle"></i> Failed to load configuration';
    }
}

// Save Namecheap configuration
document.getElementById('namecheapConfigForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const config = {
        api_user: document.getElementById('apiUser').value,
        api_key: document.getElementById('apiKey').value,
        username: document.getElementById('username').value,
        client_ip: document.getElementById('clientIp').value,
        is_sandbox: document.getElementById('isSandbox').checked
    };
    
    try {
        const response = await fetch('/api/dns/namecheap/config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(config)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('success', 'Configuration saved successfully! ' + (result.warning || ''));
            loadNamecheapConfig();
        } else {
            showAlert('danger', 'Failed to save configuration: ' + result.error);
        }
    } catch (error) {
        showAlert('danger', 'Network error: ' + error.message);
    }
});

// Show modals
function showCreateSubdomainModal() {
    $('#createSubdomainModal').modal('show');
}

function showAddRecordModal() {
    $('#addRecordModal').modal('show');
}

function showVerifyDomainModal() {
    $('#verifyDomainModal').modal('show');
}

// Create subdomain
async function createSubdomain() {
    const data = {
        domain: document.getElementById('subDomain').value,
        subdomain: document.getElementById('subSubdomain').value,
        target: document.getElementById('subTarget').value,
        record_type: document.getElementById('subRecordType').value,
        ttl: parseInt(document.getElementById('subTTL').value)
    };
    
    try {
        const response = await fetch('/api/dns/namecheap/subdomain', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('success', `Subdomain ${result.subdomain} created successfully!`);
            $('#createSubdomainModal').modal('hide');
            document.getElementById('createSubdomainForm').reset();
        } else {
            showAlert('danger', 'Failed to create subdomain: ' + result.error);
        }
    } catch (error) {
        showAlert('danger', 'Network error: ' + error.message);
    }
}

// Add DNS record
async function addDNSRecord() {
    const data = {
        domain: document.getElementById('recordDomain').value,
        name: document.getElementById('recordName').value,
        type: document.getElementById('recordType').value,
        value: document.getElementById('recordValue').value,
        ttl: parseInt(document.getElementById('recordTTL').value)
    };
    
    if (data.type === 'MX') {
        data.mx_pref = parseInt(document.getElementById('mxPref').value) || 10;
    }
    
    try {
        const response = await fetch('/api/dns/namecheap/records', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('success', result.message);
            $('#addRecordModal').modal('hide');
            document.getElementById('addRecordForm').reset();
        } else {
            showAlert('danger', 'Failed to add record: ' + result.error);
        }
    } catch (error) {
        showAlert('danger', 'Network error: ' + error.message);
    }
}

// Verify domain with Google
async function verifyWithGoogle() {
    const domain = document.getElementById('verifyDomain').value;
    
    if (!domain) {
        showAlert('warning', 'Please enter a domain to verify');
        return;
    }
    
    document.getElementById('verificationProgress').style.display = 'block';
    updateVerificationProgress(25, 'Starting verification process...');
    
    try {
        const response = await fetch('/api/dns/namecheap/verify-domain', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ domain })
        });
        
        updateVerificationProgress(50, 'Getting verification token...');
        
        const result = await response.json();
        
        if (result.success) {
            updateVerificationProgress(100, 'Domain verified successfully!');
            showAlert('success', `Domain ${domain} verified with Google! Token: ${result.verification_token}`);
            
            setTimeout(() => {
                $('#verifyDomainModal').modal('hide');
                document.getElementById('verifyDomainForm').reset();
                document.getElementById('verificationProgress').style.display = 'none';
            }, 2000);
        } else {
            updateVerificationProgress(100, 'Verification failed');
            showAlert('danger', 'Verification failed: ' + result.error);
        }
    } catch (error) {
        updateVerificationProgress(100, 'Network error occurred');
        showAlert('danger', 'Network error: ' + error.message);
    }
}

function updateVerificationProgress(percent, message) {
    document.querySelector('.progress-bar').style.width = percent + '%';
    document.getElementById('verificationSteps').innerHTML = '<p class="mb-0">' + message + '</p>';
}

// Load domain records
async function loadDomainRecords() {
    const domain = document.getElementById('domainToView').value;
    
    if (!domain) {
        showAlert('warning', 'Please enter a domain name');
        return;
    }
    
    try {
        const response = await fetch(`/api/dns/namecheap/records/${domain}`);
        const result = await response.json();
        
        const resultDiv = document.getElementById('domainRecordsResult');
        
        if (result.success) {
            displayDomainRecords(result.records, domain);
        } else {
            resultDiv.innerHTML = '<div class="alert alert-danger">Failed to load records: ' + result.error + '</div>';
        }
    } catch (error) {
        document.getElementById('domainRecordsResult').innerHTML = 
            '<div class="alert alert-danger">Network error: ' + error.message + '</div>';
    }
}

function displayDomainRecords(records, domain) {
    const container = document.getElementById('dnsRecordsTable');
    
    if (!records || records.length === 0) {
        container.innerHTML = '<div class="alert alert-info">No DNS records found for ' + domain + '</div>';
        return;
    }
    
    let html = '<h6>DNS Records for ' + domain + '</h6>';
    html += '<div class="table-responsive">';
    html += '<table class="table table-striped table-sm">';
    html += '<thead><tr><th>Name</th><th>Type</th><th>Value</th><th>TTL</th><th>Actions</th></tr></thead><tbody>';
    
    records.forEach(record => {
        html += '<tr>';
        html += '<td>' + (record.Name || '@') + '</td>';
        html += '<td><span class="badge badge-primary">' + record.Type + '</span></td>';
        html += '<td><code>' + record.Address + '</code></td>';
        html += '<td>' + (record.TTL || 'Auto') + '</td>';
        html += '<td>';
        html += '<button class="btn btn-sm btn-danger" onclick="deleteRecord(\'' + domain + '\', \'' + record.Name + '\', \'' + record.Type + '\')">';
        html += '<i class="fas fa-trash"></i></button>';
        html += '</td>';
        html += '</tr>';
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
}

// Delete DNS record
async function deleteRecord(domain, name, type) {
    if (!confirm(`Delete ${type} record "${name}" for ${domain}?`)) {
        return;
    }
    
    try {
        const response = await fetch('/api/dns/namecheap/records', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ domain, name, type })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('success', result.message);
            loadDomainRecords(); // Reload records
        } else {
            showAlert('danger', 'Failed to delete record: ' + result.error);
        }
    } catch (error) {
        showAlert('danger', 'Network error: ' + error.message);
    }
}

// Load DNS history
async function loadDNSHistory() {
    try {
        const response = await fetch('/api/dns/records/history');
        const result = await response.json();
        
        if (result.success) {
            displayDNSHistory(result.records);
        } else {
            showAlert('danger', 'Failed to load history: ' + result.error);
        }
    } catch (error) {
        showAlert('danger', 'Network error: ' + error.message);
    }
}

function displayDNSHistory(records) {
    const container = document.getElementById('dnsRecordsTable');
    
    if (!records || records.length === 0) {
        container.innerHTML = '<div class="alert alert-info">No DNS history found</div>';
        return;
    }
    
    let html = '<h6>DNS Records History</h6>';
    html += '<div class="table-responsive">';
    html += '<table class="table table-striped table-sm">';
    html += '<thead><tr><th>Domain</th><th>Name</th><th>Type</th><th>Value</th><th>TTL</th><th>Status</th><th>Created</th><th>By</th></tr></thead><tbody>';
    
    records.forEach(record => {
        html += '<tr' + (record.is_active ? '' : ' class="table-secondary"') + '>';
        html += '<td>' + record.domain + '</td>';
        html += '<td>' + record.record_name + '</td>';
        html += '<td><span class="badge badge-primary">' + record.record_type + '</span></td>';
        html += '<td><code>' + record.record_value + '</code></td>';
        html += '<td>' + record.ttl + '</td>';
        html += '<td><span class="badge ' + (record.is_active ? 'badge-success' : 'badge-secondary') + '">';
        html += record.is_active ? 'Active' : 'Deleted';
        html += '</span></td>';
        html += '<td>' + new Date(record.created_at).toLocaleString() + '</td>';
        html += '<td>' + (record.created_by || 'System') + '</td>';
        html += '</tr>';
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
}

// Handle record type change for MX records
function handleRecordTypeChange() {
    const recordType = document.getElementById('recordType').value;
    const mxPrefGroup = document.getElementById('mxPrefGroup');
    
    if (recordType === 'MX') {
        mxPrefGroup.style.display = 'block';
        document.getElementById('recordValue').placeholder = 'mail.example.com';
    } else {
        mxPrefGroup.style.display = 'none';
        if (recordType === 'A') {
            document.getElementById('recordValue').placeholder = '192.168.1.1';
        } else if (recordType === 'CNAME') {
            document.getElementById('recordValue').placeholder = 'target.example.com';
        } else if (recordType === 'TXT') {
            document.getElementById('recordValue').placeholder = 'v=spf1 include:_spf.google.com ~all';
        }
    }
}

// Toggle password visibility
function togglePassword(fieldId) {
    const field = document.getElementById(fieldId);
    const icon = field.nextElementSibling.querySelector('i');
    
    if (field.type === 'password') {
        field.type = 'text';
        icon.className = 'fas fa-eye-slash';
    } else {
        field.type = 'password';
        icon.className = 'fas fa-eye';
    }
}

// Show alert messages
function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="close" data-dismiss="alert">&times;</button>
    `;
    
    const container = document.querySelector('.container-fluid');
    container.insertBefore(alertDiv, container.firstChild);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}
</script>
{% endblock %}