{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <h2>DNS Manager</h2>

  <!-- Namecheap Config -->
  <div class="card mb-3">
    <div class="card-header">Namecheap API Configuration</div>
    <div class="card-body">
      <div class="row g-2">
        <div class="col-md-3">
          <label class="form-label">ApiUser</label>
          <input id="nc_api_user" class="form-control" />
        </div>
        <div class="col-md-3">
          <label class="form-label">UserName</label>
          <input id="nc_username" class="form-control" />
        </div>
        <div class="col-md-3">
          <label class="form-label">ApiKey</label>
          <input id="nc_api_key" class="form-control" type="password"
                 placeholder="Leave empty to keep existing" />
          <!-- !!! PLAIN STORAGE â€” REPLACE BEFORE PROD -->
        </div>
        <div class="col-md-3">
          <label class="form-label">ClientIp</label>
          <input id="nc_client_ip" class="form-control"
                 placeholder="Your server public IP" />
        </div>
      </div>

      <div class="row g-2 mt-2">
        <div class="col-md-6">
          <label class="form-label">API URL</label>
          <input id="nc_api_url" class="form-control"
                 placeholder="https://api.namecheap.com/xml.response" />
        </div>
        <div class="col-md-3 form-check mt-4">
          <input id="nc_is_sandbox" class="form-check-input" type="checkbox" />
          <label class="form-check-label">Use Sandbox</label>
        </div>
      </div>

      <div class="mt-3">
        <button class="btn btn-primary" onclick="saveConfig()">Save Configuration</button>
        <button class="btn btn-secondary" onclick="fetchDomains()">Fetch Domains</button>
        <button class="btn btn-outline-info" onclick="viewDiagnostics()">View Diagnostics</button>
      </div>

      <small id="config_status" class="text-muted d-block mt-2"></small>
    </div>
  </div>

  <!-- Domains -->
  <div class="card mb-3">
    <div class="card-header">Domains</div>
    <div class="card-body">
      <table class="table table-sm" id="domains_table">
        <thead>
          <tr>
            <th>Domain</th>
            <th>Expires</th>
            <th>IsOurDNS</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Google Site Verification & DNS Records -->
  <div class="row">
    <div class="col-md-6">
      <div class="card mb-3">
        <div class="card-header">Google Site Verification</div>
        <div class="card-body">
          <div class="mb-2">
            <label class="form-label">Selected domain</label>
            <input id="verify_domain" class="form-control" placeholder="example.com" />
          </div>
          <div class="mb-2">
            <label class="form-label">Host/Subdomain</label>
            <input id="verify_host" class="form-control" value="@" />
          </div>
          <div class="form-check mb-2">
            <input id="auto_verify" class="form-check-input" type="checkbox" checked />
            <label class="form-check-label">Auto verify after TXT created</label>
          </div>
          <button class="btn btn-primary" onclick="generateTxt()">Generate TXT & Apply</button>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card mb-3">
        <div class="card-header">DNS Records</div>
        <div class="card-body">
          <div class="mb-2">
            <label class="form-label">Selected domain</label>
            <input id="record_domain" class="form-control" placeholder="example.com" />
          </div>
          <div class="mb-2">
            <label class="form-label">Host</label>
            <input id="record_host" class="form-control" placeholder="@ or subdomain" />
          </div>
          <div class="mb-2">
            <label class="form-label">Type</label>
            <select id="record_type" class="form-select">
              <option>A</option>
              <option>AAAA</option>
              <option>CNAME</option>
              <option>TXT</option>
              <option>MX</option>
            </select>
          </div>
          <div class="mb-2">
            <label class="form-label">Value</label>
            <input id="record_value" class="form-control" />
          </div>
          <div class="mb-2">
            <label class="form-label">TTL</label>
            <input id="record_ttl" class="form-control" value="1800" />
          </div>
          <button class="btn btn-success" onclick="upsertRecord()">Add/Update Record</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Debug Log -->
  <div class="card">
    <div class="card-header">Debug Log</div>
    <div class="card-body" style="max-height: 250px; overflow-y: auto;" id="debug_log"></div>
  </div>
</div>

<script>
async function api(url, options = {}) {
  const res = await fetch(url, {
    headers: { 'Content-Type': 'application/json' },
    credentials: 'same-origin',
    ...options,
  });
  const ct = res.headers.get('content-type') || '';
  if (!ct.includes('application/json')) {
    const text = await res.text();
    return { success: false, error: `HTTP ${res.status}: ${text.slice(0, 300)}` };
  }
  return res.json();
}

async function loadConfig() {
  const res = await api('/api/dns/namecheap/config');
  if (res.config && res.config.api_user) {
    document.getElementById('nc_api_user').value = res.config.api_user || '';
    document.getElementById('nc_username').value = res.config.username || '';
    document.getElementById('nc_client_ip').value = res.config.client_ip || '';
    document.getElementById('nc_api_url').value = res.config.api_url || '';
    document.getElementById('nc_is_sandbox').checked = !!res.config.is_sandbox;
  }
}

async function saveConfig() {
  const body = {
    api_user: document.getElementById('nc_api_user').value.trim(),
    username: document.getElementById('nc_username').value.trim(),
    api_key: document.getElementById('nc_api_key').value.trim(),
    client_ip: document.getElementById('nc_client_ip').value.trim(),
    api_url: document.getElementById('nc_api_url').value.trim(),
    is_sandbox: document.getElementById('nc_is_sandbox').checked,
  };
  const res = await api('/api/dns/namecheap/config', {
    method: 'POST',
    body: JSON.stringify(body),
  });
  document.getElementById('config_status').innerText = res.success
    ? 'Configuration saved'
    : `Error: ${res.error || 'Unknown'}`;
  fetchDomains();
}

async function fetchDomains() {
  const res = await api('/api/dns/namecheap/domains');
  const tbody = document.querySelector('#domains_table tbody');
  tbody.innerHTML = '';
  if (!res.success) {
    appendLog(`getList ERROR: ${res.error || 'Unknown'}`, 'error');
    return;
  }
  (res.domains || []).forEach(d => {
    const tr = document.createElement('tr');
    tr.onclick = () => {
      document.getElementById('verify_domain').value = d.Domain;
      document.getElementById('record_domain').value = d.Domain;
    };
    tr.innerHTML = `
      <td>${d.Domain}</td>
      <td>${d.Expires || ''}</td>
      <td>${d.IsOurDNS ? 'Yes' : 'No'}</td>
    `;
    tbody.appendChild(tr);
  });
  appendLog(`Fetched ${ (res.domains || []).length } domains`, 'success');
}

async function generateTxt() {
  const body = {
    domain: document.getElementById('verify_domain').value.trim(),
    host: document.getElementById('verify_host').value.trim(),
    auto_verify: document.getElementById('auto_verify').checked,
  };
  const res = await api('/api/dns/namecheap/verify-domain', {
    method: 'POST',
    body: JSON.stringify(body),
  });
  if (res.success) {
    appendLog(`TXT created for ${body.domain}`, 'success');
  } else {
    appendLog(`verify-domain ERROR: ${res.error}`, 'error');
  }
}

async function upsertRecord() {
  const body = {
    domain: document.getElementById('record_domain').value.trim(),
    host: document.getElementById('record_host').value.trim(),
    type: document.getElementById('record_type').value,
    value: document.getElementById('record_value').value.trim(),
    ttl: document.getElementById('record_ttl').value.trim(),
  };
  const res = await api('/api/dns/namecheap/record', {
    method: 'POST',
    body: JSON.stringify(body),
  });
  if (res.success) {
    appendLog(`Record upserted for ${body.domain} ${body.host}`, 'success');
  } else {
    appendLog(`record ERROR: ${res.error}`, 'error');
  }
}

async function viewDiagnostics() {
  const res = await api('/api/dns/namecheap/diagnostics');
  appendLog(JSON.stringify(res.debug || res, null, 2), res.success ? 'info' : 'error');
}

async function loadLogs() {
  const res = await api('/api/dns/namecheap/logs?limit=100');
  if (res.success && res.logs) {
    const box = document.getElementById('debug_log');
    box.innerHTML = '';
    res.logs.forEach(l => {
      const div = document.createElement('div');
      div.className = `small text-${l.status === 'success' ? 'success' : (l.status === 'error' ? 'danger' : 'muted')}`;
      div.textContent = `[${l.timestamp}] ${l.operation} ${l.domain || ''} - ${l.status}: ${l.message}`;
      box.appendChild(div);
    });
  }
}

function appendLog(msg, status='info') {
  const box = document.getElementById('debug_log');
  const div = document.createElement('div');
  const cls = status === 'success' ? 'text-success'
            : status === 'error' ? 'text-danger'
            : 'text-muted';
  div.className = `small ${cls}`;
  div.textContent = msg;
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}

loadConfig();
fetchDomains();
setInterval(loadLogs, 5000);
</script>
{% endblock %}
