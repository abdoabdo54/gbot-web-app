
{% extends "base.html" %}
{% block title %}Dashboard - GBot Web{% endblock %}

{% block content %}
<!-- Tab Navigation -->
<div class="tab-navigation">
    <nav>
        <button class="tab-button active" onclick="showTab('tab1')">
            <i class="fas fa-user-friends"></i>
            <span>Account & User Mgmt</span>
        </button>
        <button class="tab-button" onclick="showTab('tab2')">
            <i class="fas fa-user-plus"></i>
            <span>User Create/Delete/Domain</span>
        </button>
        <button class="tab-button" onclick="showTab('tab3')">
            <i class="fas fa-exchange-alt"></i>
            <span>Bulk Domain Change & SMTP/CSV</span>
        </button>
    </nav>
</div>

<!-- Tab 1: Account & User Management (existing content) -->
<div id="tab1" class="tab-content active">    
<!-- Account Selection & Authentication -->
<div class="github-card">
    <div class="github-card-header">
        <h3 class="github-card-title">
            <i class="fas fa-user-friends"></i>
            Account Selection & Authentication
        </h3>
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr auto; gap: 16px; align-items: end; margin-bottom: 20px;">
        <div class="form-group-github">
            <label for="account-select" class="form-label-github">
                <i class="fas fa-user-circle"></i> Select Account
            </label>
            <select id="account-select" class="form-control-github">
            <option value="">Choose an account...</option>
                {% for account in accounts %}
                <option value="{{ account.account_name }}" data-account-id="{{ account.id }}">{{ account.account_name }}</option>
            {% endfor %}
        </select>
        </div>
        <button onclick="authenticateAccount()" class="btn-github btn-github-primary">
            <i class="fas fa-key"></i> Authenticate Selected
        </button>
    </div>
    
    <div style="display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 20px;">
        {% if session.role != 'mailer' %}
        <button onclick="openAddAccountModal()" class="btn-github">
            <i class="fas fa-plus"></i> Add Manually
        </button>
        <button onclick="addFromServerJSON()" class="btn-github">
            <i class="fas fa-folder-open"></i> Add from Server JSON
        </button>
        {% endif %}
        {% if session.role == 'admin' %}
        <button onclick="forceTokenStatusCheck()" class="btn-github" style="background-color: var(--color-warning-emphasis); border-color: var(--color-warning-emphasis); color: #ffffff;">
            <i class="fas fa-search"></i> Check Token Status Now (Admin)
        </button>
        {% endif %}    
        <button onclick="enterAuthorizationCode()" class="btn-github">
            <i class="fas fa-code"></i> Enter Authorization Code
        </button>
    </div>
    
    <!-- Search and Account List Area -->
    <div class="account-management-area">
        <div class="search-and-list">
            <input type="text" id="account-search" placeholder="Search accounts in list..." 
                    oninput="filterAccounts()" class="search-input" 
                    autocomplete="off" autocomplete="nope" readonly onfocus="this.removeAttribute('readonly');">
            
            <div id="account-list-area" class="account-list">
                {% for account in accounts %}
                <div class="account-item" onclick="selectAccountFromList('{{ account.account_name }}', {{ account.id }})" data-account-id="{{ account.id }}">
                    {{ account.account_name }}
                </div>
                {% endfor %}
            </div>
        </div>
        
        <div class="account-actions">
            <button onclick="authenticateFromList()" class="action-button" style="height: 50px; font-size: 12px;">
                üîë Authenticate<br>(List Selection)
            </button>
            {% if session.role == 'admin' %}
            <button onclick="openBulkDeleteModal()" class="action-button delete-button" style="background-color: #dc3545; border-color: #dc3545; height: 50px; font-size: 12px;">
                üóëÔ∏è Bulk Delete<br>(Admin Only)
            </button>
            {% endif %}
            <button onclick="deleteFromList()" class="action-button delete-button" style="height: 50px; font-size: 12px;">
                üóëÔ∏è Delete Account<br>(List Selection)
            </button>
        </div>
    </div>
    <div id="account-count-display" class="count-display">
        <span id="account-stats">Loading account statistics...</span>
    </div>
    <div id="auth-status" class="status-box">
        <p>No account authenticated</p>
    </div>
</div>

<!-- Add Account Modal -->
<div id="addAccountModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">
                <i class="fas fa-plus"></i> Add Account Manually
            </h3>
            <button type="button" class="btn-github" onclick="closeAddAccountModal()" style="margin-left: auto;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
        <form id="addAccountForm">
                <div class="form-group-github">
                    <label for="new-account-email" class="form-label-github">
                        <i class="fas fa-envelope"></i> Account Email
                    </label>
                    <input type="email" id="new-account-email" class="form-control-github" required placeholder="admin@yourdomain.com">
            </div>
                <div class="form-group-github">
                    <label for="new-client-id" class="form-label-github">
                        <i class="fas fa-key"></i> Client ID
                    </label>
                    <input type="text" id="new-client-id" class="form-control-github" required placeholder="123456789-abcdef.apps.googleusercontent.com">
            </div>
                <div class="form-group-github">
                    <label for="new-client-secret" class="form-label-github">
                        <i class="fas fa-lock"></i> Client Secret
                    </label>
                    <input type="password" id="new-client-secret" class="form-control-github" required placeholder="GOCSPX-your_client_secret">
            </div>
        </form>
        </div>
        <div class="modal-footer">
            <button type="button" onclick="saveNewAccount()" class="btn-github btn-github-primary">
                <i class="fas fa-save"></i> Save Account
            </button>
            <button type="button" onclick="closeAddAccountModal()" class="btn-github">
                <i class="fas fa-times"></i> Cancel
            </button>
        </div>
    </div>
</div>



<!-- OAuth Authorization Modal -->
<div id="oauthModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">
                <i class="fas fa-link"></i> OAuth Authorization Required
            </h3>
            <button type="button" class="btn-github" onclick="closeOAuthModal()" style="margin-left: auto;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <p>Please copy this link and open it in your browser to authorize the account:</p>
            <div id="oauthUrl" class="data-display" style="font-family: monospace; word-break: break-all; margin: 16px 0;"></div>
            <div style="background-color: rgba(9, 105, 218, 0.1); border: 1px solid var(--color-accent-emphasis); border-radius: 6px; padding: 12px; color: var(--color-accent-fg); font-size: 14px;">
                <i class="fas fa-lightbulb"></i>
                <strong>Tip:</strong> You can copy this link to use in another browser or app for authorization.
            </div>
        </div>
        <div class="modal-footer">
            <button onclick="copyOAuthUrl()" class="btn-github">
                <i class="fas fa-copy"></i> Copy Link
            </button>
            <button onclick="openOAuthUrl()" class="btn-github btn-github-primary">
                <i class="fas fa-external-link-alt"></i> Open Link
            </button>
            <button onclick="closeOAuthModal()" class="btn-github">
                <i class="fas fa-times"></i> Close
            </button>
        </div>
    </div>
</div>

<!-- Bulk Delete Accounts Modal -->
<div id="bulkDeleteModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">
                <i class="fas fa-trash-alt"></i> Bulk Delete Accounts
            </h3>
            <button type="button" class="btn-github" onclick="closeBulkDeleteModal()" style="margin-left: auto;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div style="background-color: rgba(220, 53, 69, 0.1); border: 1px solid #dc3545; border-radius: 6px; padding: 12px; margin-bottom: 16px; color: #dc3545;">
                <i class="fas fa-exclamation-triangle"></i>
                <strong>Warning:</strong> This action will permanently delete the specified accounts. This cannot be undone!
            </div>
            
            <div class="form-group-github">
                <label for="bulkDeleteAccounts" class="form-label-github">
                    <i class="fas fa-list"></i> Account Names (one per line)
                </label>
                <textarea id="bulkDeleteAccounts" class="form-control-github" rows="8" 
                          placeholder="Enter account names, one per line:&#10;admin@domain1.com&#10;user@domain2.com&#10;manager@domain3.com"
                          style="font-family: 'Courier New', monospace; font-size: 14px;"></textarea>
                <small style="color: #656d76; font-size: 12px;">
                    Enter the exact account names (email addresses) that you want to delete, one per line.
                </small>
            </div>
            
            <div id="bulkDeleteProgress" style="display: none; margin-top: 16px;">
                <div style="background: #f6f8fa; border-radius: 6px; padding: 16px; border: 1px solid #d0d7de;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span id="bulkDeleteStatus">Processing...</span>
                        <span id="bulkDeleteCount">0/0</span>
                    </div>
                    <div style="background: #e1e4e8; border-radius: 6px; height: 8px; overflow: hidden;">
                        <div id="bulkDeleteProgressBar" style="background: #dc3545; height: 100%; width: 0%; transition: width 0.3s; border-radius: 6px;"></div>
                    </div>
                </div>
            </div>
            
            <div id="bulkDeleteResults" style="display: none; margin-top: 16px;">
                <h6 style="font-weight: 600; margin-bottom: 8px; color: #24292f;">
                    <i class="fas fa-list-check"></i> Deletion Results
                </h6>
                <div id="bulkDeleteResultsContent" style="background: #f6f8fa; padding: 12px; border-radius: 6px; border: 1px solid #d0d7de; max-height: 200px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 12px;">
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button onclick="executeBulkDelete()" class="btn-github btn-github-danger" id="bulkDeleteExecuteBtn">
                <i class="fas fa-trash-alt"></i> Delete Accounts
            </button>
            <button onclick="closeBulkDeleteModal()" class="btn-github">
                <i class="fas fa-times"></i> Cancel
            </button>
        </div>
    </div>
</div>

    <!-- User Listing & Actions -->
<div class="github-card">
    <div class="github-card-header">
        <h3 class="github-card-title">
            <i class="fas fa-users"></i>
            User Listing & Basic Actions
        </h3>
    </div>
        
        <div class="button-row">
        <button onclick="retrieveUsers()" class="btn-github btn-github-primary">
            <i class="fas fa-chart-bar"></i> Retrieve All Users
        </button>
        <button onclick="clearUserList()" class="btn-github">
            <i class="fas fa-broom"></i> Clear List
        </button>
        <button onclick="copyAllUsers()" class="btn-github">
            <i class="fas fa-copy"></i> Copy All
        </button>
        </div>
        
        <div id="user-display" class="data-display">
        <div class="status-info">
            <p><strong><i class="fas fa-users"></i> User Management</strong></p>
            <p>Click "Retrieve All Users" to load and display all users from your Google Workspace.</p>
            <p><small>This will show user status (Active/Suspended), admin privileges, and provide options for bulk operations.</small></p>
        </div>
        </div>
        
        <!-- Individual User Actions -->
        <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 16px; align-items: end; margin-top: 16px;">
            <div class="form-group-github">
                <label for="suspend-user-email" class="form-label-github">
                    <i class="fas fa-user-slash"></i> Suspend User
                </label>
                <input type="email" id="suspend-user-email" class="form-control-github" placeholder="user@domain.com">
            </div>
            <div class="form-group-github">
                <label for="unsuspend-user-email" class="form-label-github">
                    <i class="fas fa-user-check"></i> Unsuspend User
                </label>
                <input type="email" id="unsuspend-user-email" class="form-control-github" placeholder="user@domain.com">
            </div>
            <div style="display: flex; gap: 8px;">
                <button onclick="suspendUser()" class="btn-github btn-github-warning">
                    <i class="fas fa-user-slash"></i> Suspend
                </button>
                <button onclick="unsuspendUser()" class="btn-github btn-github-success">
                    <i class="fas fa-user-check"></i> Unsuspend
                </button>
            </div>
        </div>
        
        
        <div id="user-count" class="count-display">Total Users: 0</div>
        
    <div style="display: grid; grid-template-columns: 1fr auto; gap: 16px; align-items: end; margin-top: 16px;">
        <div class="form-group-github">
            <label for="new-password" class="form-label-github">
                <i class="fas fa-lock"></i> New Password for All Users
            </label>
            <input type="password" id="new-password" class="form-control-github" placeholder="Enter new password for all users" autocomplete="new-password" readonly onfocus="this.removeAttribute('readonly');">
        </div>
        <button onclick="updateAllPasswords()" class="btn-github btn-github-danger">
            <i class="fas fa-key"></i> Update Password (All)
        </button>
        </div>
    </div>
    
    <!-- Activity Log Section -->
    <div class="github-card" style="margin-top: 24px;">
        <div class="github-card-header">
            <h3 class="github-card-title">
                <i class="fas fa-list-alt"></i>
                Activity Log
            </h3>
            <div class="button-row">
                <button onclick="clearLogs()" class="btn-github btn-github-secondary" style="font-size: 12px; padding: 4px 8px;">
                    <i class="fas fa-trash"></i> Clear Logs
                </button>
                <button onclick="copyLogs()" class="btn-github" style="font-size: 12px; padding: 4px 8px;">
                    <i class="fas fa-copy"></i> Copy Logs
                </button>
                <button onclick="downloadLogs()" class="btn-github" style="font-size: 12px; padding: 4px 8px;">
                    <i class="fas fa-download"></i> Download
                </button>
            </div>
        </div>
        
        <div id="activity-log" class="log-display" style="
            background: #f8f9fa; 
            border: 1px solid #e1e4e8; 
            border-radius: 6px; 
            padding: 12px; 
            max-height: 300px; 
            overflow-y: auto; 
            font-family: 'Courier New', monospace; 
            font-size: 12px; 
            line-height: 1.4;
            white-space: pre-wrap;
            word-wrap: break-word;
        ">
            <div style="color: #6a737d; font-style: italic;">
                üìù Activity log will appear here...
            </div>
        </div>
        
        <div style="margin-top: 8px; font-size: 11px; color: #6a737d;">
            <i class="fas fa-info-circle"></i> 
            This log shows all user management activities, API calls, and system messages.
        </div>
    </div>

    <!-- Domain Info
    <div class="section">
        <h3>üåê Domain Info & Subdomain Utility</h3>
        
        <div class="button-row">
            <button onclick="retrieveDomains()">üîç Retrieve Domains</button>
            <button onclick="clearDomainDisplay()">üßπ Clear Display</button>
        </div>
        
        <div id="domain-display" class="data-display">
            <p>Click 'Retrieve Domains' to view domains here...</p>
        </div>
    </div> -->

    <!-- Suspended Users -->
<div class="github-card">
    <div class="github-card-header">
        <h3 class="github-card-title">
            <i class="fas fa-user-slash"></i>
            Suspended User Management
        </h3>
    </div>
        
        <div class="button-row">
        <button onclick="loadSuspendedUsers()" class="btn-github btn-github-primary">
            <i class="fas fa-search"></i> Load Suspended Users
        </button>
        <button onclick="copySuspendedUsers()" class="btn-github">
            <i class="fas fa-copy"></i> Copy Selected
        </button>
        <button onclick="refreshSuspendedUsers()" class="btn-github">
            <i class="fas fa-sync-alt"></i> Refresh Status
        </button>
        <button onclick="clearSuspendedUsers()" class="btn-github">
            <i class="fas fa-broom"></i> Clear Display
        </button>
        </div>
        
        <div id="suspended-display" class="data-display">
        <div class="status-info">
            <p><strong><i class="fas fa-user-slash"></i> Suspended User Management</strong></p>
            <p>Click "Load Suspended Users" to check for suspended accounts in your Google Workspace.</p>
            <p><small>This will show all users with suspended status, including their names, emails, and admin privileges.</small></p>
        </div>
        </div>
        
        <div id="suspended-count" class="count-display">Suspended Users: 0</div>
        
        <!-- Bulk Suspension Actions -->
        <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 16px; align-items: end; margin-top: 16px;">
            <div class="form-group-github">
                <label for="bulk-suspend-emails" class="form-label-github">
                    <i class="fas fa-user-slash"></i> Bulk Suspend Users
                </label>
                <textarea id="bulk-suspend-emails" class="form-control-github" rows="3" placeholder="Enter email addresses (one per line)&#10;user1@domain.com&#10;user2@domain.com"></textarea>
            </div>
            <div class="form-group-github">
                <label for="bulk-unsuspend-emails" class="form-label-github">
                    <i class="fas fa-user-check"></i> Bulk Unsuspend Users
                </label>
                <textarea id="bulk-unsuspend-emails" class="form-control-github" rows="3" placeholder="Enter email addresses (one per line)&#10;user1@domain.com&#10;user2@domain.com"></textarea>
            </div>
            <div style="display: flex; flex-direction: column; gap: 8px;">
                <button onclick="bulkSuspendUsers()" class="btn-github btn-github-warning">
                    <i class="fas fa-user-slash"></i> Bulk Suspend
                </button>
                <button onclick="bulkUnsuspendUsers()" class="btn-github btn-github-success">
                    <i class="fas fa-user-check"></i> Bulk Unsuspend
                </button>
            </div>
        </div>
</div>
</div>

<!-- Tab 2: User Create/Delete/Domain -->
<div id="tab2" class="tab-content">
    
    <!-- Create Single User -->
    <div class="github-card">
        <div class="github-card-header">
            <h3 class="github-card-title">
                <i class="fas fa-user-plus"></i>
                Create Single User
            </h3>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
            <div class="form-group-github">
                <label for="new-user-first-name" class="form-label-github">
                    <i class="fas fa-user"></i> First Name
                </label>
                <input type="text" id="new-user-first-name" class="form-control-github" placeholder="Enter first name">
        </div>
            <div class="form-group-github">
                <label for="new-user-last-name" class="form-label-github">
                    <i class="fas fa-user"></i> Last Name
                </label>
                <input type="text" id="new-user-last-name" class="form-control-github" placeholder="Enter last name">
            </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
            <div class="form-group-github">
                <label for="new-user-email" class="form-label-github">
                    <i class="fas fa-envelope"></i> Email Address
                </label>
                <input type="email" id="new-user-email" class="form-control-github" placeholder="user@domain.com">
            </div>
            <div class="form-group-github">
                <label for="new-user-password" class="form-label-github">
                    <i class="fas fa-lock"></i> Password
                </label>
                <input type="password" id="new-user-password" class="form-control-github" placeholder="Enter password">
            </div>
        </div>
        <button onclick="createSingleUser()" class="btn-github btn-github-primary">
            <i class="fas fa-plus"></i> Create User
        </button>
    </div>

    <!-- Domain Management -->
    <div class="github-card">
        <div class="github-card-header">
            <h3 class="github-card-title">
                <i class="fas fa-globe"></i>
                Domain Management
            </h3>
        </div>
        <div class="button-row">
            <button onclick="getDomainInfo()" class="btn-github btn-github-primary">
                <i class="fas fa-search"></i> Retrieve Domains
            </button>
            <button onclick="refreshDomainStatus()" class="btn-github" style="margin-left: 8px;">
                <i class="fas fa-sync-alt"></i> Refresh Status
            </button>
            <!-- Auto Change Subdomain button moved to Tab 3 Workflow 2 -->
        </div>
        <div id="domain-info-display" class="data-display">
            <div class="status-info">
                <p><strong><i class="fas fa-globe"></i> Domain Information</strong></p>
                <p>Click "Retrieve Domains" to view domains here...</p>
        </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr auto; gap: 16px; align-items: end; margin-top: 16px;">
            <div class="form-group-github">
                <label for="new-domain-alias" class="form-label-github">
                    <i class="fas fa-plus"></i> New Domain Alias
                </label>
                <input type="text" id="new-domain-alias" class="form-control-github" placeholder="Enter new domain alias">
            </div>
            <button onclick="addDomainAlias()" class="btn-github btn-github-primary">
                <i class="fas fa-plus"></i> Add Domain Alias
            </button>
        </div>
    </div>

    <!-- Create Users from CSV File -->
    <div class="github-card">
        <div class="github-card-header">
            <h3 class="github-card-title">
                <i class="fas fa-file-csv"></i>
                Create Users from CSV File
            </h3>
        </div>
        <div style="display: grid; grid-template-columns: 1fr auto; gap: 16px; align-items: end;">
            <div class="form-group-github">
                <label for="csv-file-input" class="form-label-github">
                    <i class="fas fa-file-upload"></i> Select CSV File
                </label>
                <input type="file" id="csv-file-input" class="form-control-github" accept=".csv">
            </div>
            <button onclick="createUsersFromCSV()" class="btn-github btn-github-primary">
                <i class="fas fa-upload"></i> Create Users from CSV
            </button>
        </div>
    </div>

    <!-- Create Random Users -->
    <div class="github-card">
        <div class="github-card-header">
            <h3 class="github-card-title">
                <i class="fas fa-random"></i>
                Create Random Users
            </h3>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 16px; align-items: end;">
            <div class="form-group-github">
                <label for="random-user-count" class="form-label-github">
                    <i class="fas fa-hashtag"></i> Number of Users
                </label>
                <input type="number" id="random-user-count" class="form-control-github" min="1" max="100" placeholder="e.g., 10">
            </div>
            <div class="form-group-github">
                <label for="random-user-domain" class="form-label-github">
                    <i class="fas fa-globe"></i> Domain
                </label>
                <input type="text" id="random-user-domain" class="form-control-github" placeholder="example.com">
            </div>
            <div class="form-group-github">
                <label for="random-user-password" class="form-label-github">
                    <i class="fas fa-lock"></i> Password
                </label>
                <input type="text" id="random-user-password" class="form-control-github" placeholder="Password for all users">
            </div>
            <button onclick="createRandomUsers()" class="btn-github btn-github-primary">
                <i class="fas fa-random"></i> Create Random Users
            </button>
        </div>
    </div>

    <!-- Create Random Admin Users -->
    <div class="github-card">
        <div class="github-card-header">
            <h3 class="github-card-title">
                <i class="fas fa-user-shield"></i>
                Create Random Admin Users
            </h3>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr auto; gap: 16px; align-items: end;">
            <div class="form-group-github">
                <label for="random-admin-count" class="form-label-github">
                    <i class="fas fa-hashtag"></i> Number of Admins
                </label>
                <input type="number" id="random-admin-count" class="form-control-github" min="1" max="50" placeholder="e.g., 5">
            </div>
            <div class="form-group-github">
                <label for="random-admin-domain" class="form-label-github">
                    <i class="fas fa-globe"></i> Domain
                </label>
                <input type="text" id="random-admin-domain" class="form-control-github" placeholder="example.com">
            </div>
            <div class="form-group-github">
                <label for="random-admin-password" class="form-label-github">
                    <i class="fas fa-lock"></i> Password
                </label>
                <input type="text" id="random-admin-password" class="form-control-github" placeholder="Password for all admins">
            </div>
            <div class="form-group-github">
                <label for="admin-role" class="form-label-github">
                    <i class="fas fa-crown"></i> Admin Role
                </label>
                <select id="admin-role" class="form-control-github">
                    <option value="SUPER_ADMIN">Super Admin (Full Access)</option>
                    <option value="USER_MANAGEMENT_ADMIN">User Management Admin</option>
                    <option value="HELP_DESK_ADMIN">Help Desk Admin</option>
                    <option value="SERVICE_ADMIN">Service Admin</option>
                    <option value="BILLING_ADMIN">Billing Admin</option>
                    <option value="SECURITY_ADMIN">Security Admin</option>
                </select>
            </div>
            <button onclick="createRandomAdminUsers()" class="btn-github btn-github-warning">
                <i class="fas fa-user-shield"></i> Create Admin Users
            </button>
        </div>
        <div style="margin-top: 12px; padding: 12px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px;">
            <i class="fas fa-info-circle" style="color: #f39c12; margin-right: 8px;"></i>
            <span style="color: #856404; font-size: 14px;">
                <strong>Note:</strong> Creates users with basic admin privileges. Specific role assignments require Google Admin Console configuration.
            </span>
        </div>
    </div>

    <!-- Update Passwords for Specific Users -->
    <div class="github-card">
        <div class="github-card-header">
            <h3 class="github-card-title">
                <i class="fas fa-key"></i>
                Update Passwords for Specific Users
            </h3>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 16px; align-items: end;">
            <div class="form-group-github">
                <label for="password-update-users" class="form-label-github">
                    <i class="fas fa-users"></i> Users (one per line)
                </label>
                <textarea id="password-update-users" class="form-control-github" rows="4" placeholder="user1@domain.com&#10;user2@domain.com&#10;user3@domain.com"></textarea>
            </div>
            <div class="form-group-github">
                <label for="password-update-new-password" class="form-label-github">
                    <i class="fas fa-lock"></i> New Password
                </label>
                <input type="text" id="password-update-new-password" class="form-control-github" placeholder="New password for all users">
            </div>
            <button onclick="updateUserPasswords()" class="btn-github btn-github-primary">
                <i class="fas fa-key"></i> Update Passwords
            </button>
        </div>
    </div>

    <!-- Change Domain for Specific Users -->
    <div class="github-card">
        <div class="github-card-header">
            <h3 class="github-card-title">
                <i class="fas fa-exchange-alt"></i>
                Change Domain for Specific Users
            </h3>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
            <div class="form-group-github">
                <label for="old-domain" class="form-label-github">
                    <i class="fas fa-globe"></i> Current Domain
                </label>
                <input type="text" id="old-domain" class="form-control-github" placeholder="old.com">
            </div>
            <div class="form-group-github">
                <label for="new-domain" class="form-label-github">
                    <i class="fas fa-globe"></i> New Domain
                </label>
                <input type="text" id="new-domain" class="form-control-github" placeholder="new.com">
            </div>
        </div>
        <div class="form-group-github" style="margin-bottom: 20px;">
            <label for="domain-change-emails" class="form-label-github">
                <i class="fas fa-envelope"></i> Email Addresses (one per line)
            </label>
            <textarea id="domain-change-emails" class="form-control-github" rows="4" placeholder="user1@old.com&#10;user2@old.com&#10;user3@old.com"></textarea>
        </div>
        <button onclick="changeDomainForUsers()" class="btn-github btn-github-primary">
            <i class="fas fa-exchange-alt"></i> Change Domain for These Users
        </button>
    </div>

    <!-- Delete Specific Users -->
    <div class="github-card">
        <div class="github-card-header">
            <h3 class="github-card-title">
                <i class="fas fa-user-times"></i>
                Delete Specific Users
            </h3>
        </div>
        <div class="form-group-github" style="margin-bottom: 20px;">
            <label for="delete-user-emails" class="form-label-github">
                <i class="fas fa-envelope"></i> Email Addresses to Delete (one per line)
            </label>
            <textarea id="delete-user-emails" class="form-control-github" rows="4" placeholder="user1@domain.com&#10;user2@domain.com&#10;user3@domain.com"></textarea>
        </div>
        <button onclick="deleteSpecificUsers()" class="btn-github btn-github-danger">
            <i class="fas fa-trash"></i> Delete These Users
        </button>
    </div>

    <!-- Results Log -->
    <div class="github-card">
        <div class="github-card-header">
            <h3 class="github-card-title">
                <i class="fas fa-file-alt"></i>
                Results Log
            </h3>
        </div>
        <div style="display: flex; gap: 12px; margin-bottom: 16px;">
            <button onclick="clearResultsLog()" class="btn-github">
                <i class="fas fa-broom"></i> Clear Log
            </button>
            <button onclick="copyResultsLog()" class="btn-github">
                <i class="fas fa-copy"></i> Copy Log
            </button>
        </div>
        <div id="results-log" class="data-display" style="font-family: monospace; font-size: 13px;"></div>
    </div>
</div>

<!-- Tab 3: Bulk Domain Change -->
<div id="tab3" class="tab-content">
    
    <!-- Workflow 1: Change Domain using CSV File -->
    <div class="github-card">
        <div class="github-card-header">
            <h3 class="github-card-title">
                <i class="fas fa-file-csv"></i>
                Workflow 1: Change Domain using CSV File
            </h3>
        </div>
        
        <!-- Step 1.1: Download Current Users to CSV -->
        <div style="margin-bottom: 32px;">
            <h4 style="font-size: 16px; font-weight: 600; color: var(--color-fg-default); margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-download" style="color: var(--color-accent-fg);"></i>
                Step 1.1: Download Current Users to CSV
            </h4>
            <div style="margin-bottom: 16px;">
                <button onclick="downloadAllUsersCSV()" class="btn-github btn-github-primary">
                    <i class="fas fa-download"></i> Download All Users
                </button>
                </div>
            <div style="background-color: rgba(9, 105, 218, 0.1); border: 1px solid var(--color-accent-emphasis); border-radius: 6px; padding: 12px; color: var(--color-accent-fg); font-size: 14px;">
                <i class="fas fa-info-circle"></i>
                CSV will be saved to: <strong id="csv-save-path">Downloads folder</strong>
            </div>
        </div>
        
        <!-- Step 1.2: Select New Domain and Apply to Downloaded CSV -->
        <div style="margin-bottom: 32px;">
            <h4 style="font-size: 16px; font-weight: 600; color: var(--color-fg-default); margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-globe" style="color: var(--color-accent-fg);"></i>
                Step 1.2: Select New Domain and Apply to Downloaded CSV
            </h4>
            <div style="display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 16px;">
                <button onclick="retrieveAvailableDomains()" class="btn-github">
                    <i class="fas fa-search"></i> Retrieve Available Domains
                </button>
                <button onclick="getDomainUsageStats()" class="btn-github" style="background-color: var(--color-success-emphasis); border-color: var(--color-success-emphasis); color: #ffffff;">
                    <i class="fas fa-chart-bar"></i> Domain Usage Stats
                </button>
                <button onclick="clearOldDomainData()" class="btn-github" style="background-color: var(--color-warning-emphasis); border-color: var(--color-warning-emphasis); color: #ffffff;">
                    <i class="fas fa-trash"></i> Clear Old Data
                </button>
                <button onclick="applySelectedDomainToCSV()" class="btn-github btn-github-primary">
                    <i class="fas fa-check"></i> Apply Selected Domain to CSV
                </button>
                <button onclick="debugDomainUsers()" class="btn-github" style="background-color: #6f42c1; border-color: #6f42c1; color: #ffffff;">
                    <i class="fas fa-bug"></i> Debug Domain Users
                </button>
                </div>
                
            <div id="available-domains" class="data-display">
                <div class="status-info">
                    <p><strong><i class="fas fa-globe"></i> Domain Selection</strong></p>
                    <p>Click 'Retrieve Available Domains' to view available domains</p>
                </div>
            </div>
        </div>
        
        <!-- Step 1.3: Process Domain Changes from Modified CSV -->
        <div>
            <h4 style="font-size: 16px; font-weight: 600; color: var(--color-fg-default); margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-cogs" style="color: var(--color-accent-fg);"></i>
                Step 1.3: Process Domain Changes from Modified CSV
            </h4>
            <div style="display: grid; grid-template-columns: 1fr auto; gap: 16px; align-items: end; margin-bottom: 16px;">
                <div class="form-group-github">
                    <label for="csv-file-path" class="form-label-github">
                        <i class="fas fa-file-csv"></i> CSV File Path
                    </label>
                    <input type="text" id="csv-file-path" class="form-control-github" placeholder="CSV file path will appear here after download/apply, or browse manually..." readonly>
                </div>
                <button onclick="browseCSVFile()" class="btn-github">
                    <i class="fas fa-folder-open"></i> Browse Manually...
                </button>
                </div>
            <button onclick="processDomainChangesFromCSV()" class="btn-github btn-github-primary">
                <i class="fas fa-cogs"></i> Process Domain Changes from CSV
            </button>
        </div>
    </div>

    <!-- Workflow 2: Change Domain for All Users (Non-CSV, Excludes Admin) -->
    <div class="github-card">
        <div class="github-card-header">
            <h3 class="github-card-title">
                <i class="fas fa-exchange-alt"></i>
                Workflow 2: Change Domain for All Users (Non-CSV, Excludes Admin)
            </h3>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
            <div class="form-group-github">
                <label for="current-domain-suffix" class="form-label-github">
                    <i class="fas fa-globe"></i> Current Domain Suffix
                </label>
                <input type="text" id="current-domain-suffix" class="form-control-github" placeholder="old-domain.com">
            </div>
            <div class="form-group-github">
                <label for="new-domain-suffix" class="form-label-github">
                    <i class="fas fa-globe"></i> New Domain Suffix
                </label>
                <input type="text" id="new-domain-suffix" class="form-control-github" placeholder="new-domain.com">
            </div>
            </div>
        
        <button onclick="changeDomainForAllUsers()" class="btn-github" style="background-color: var(--color-warning-emphasis); border-color: var(--color-warning-emphasis); color: #ffffff;">
            <i class="fas fa-exchange-alt"></i> Change Domain for ALL Matching Users (Non-Admin)
        </button>
        
        <!-- Auto Change Subdomain button moved here from Domain Management section -->
        <button onclick="autoChangeSubdomain()" class="btn-github" style="margin-left: 8px; background-color: #9C27B0; border-color: #9C27B0; color: white;">
            <i class="fas fa-magic"></i> Auto Change Subdomain
        </button>
        
        <!-- Progress Indicator -->
        <div id="domain-change-progress" class="progress-container" style="display: none; margin-top: 20px;">
            <div class="progress-header">
                <h4 style="margin: 0; color: var(--color-fg-default);">
                    <i class="fas fa-spinner fa-spin"></i> Domain Change Progress
                </h4>
                <span id="progress-percentage" style="color: var(--color-fg-muted);">0%</span>
            </div>
            <div class="progress-bar-container">
                <div id="progress-bar" class="progress-bar" style="width: 0%;"></div>
            </div>
            <div id="progress-message" class="progress-message" style="margin-top: 8px; color: var(--color-fg-muted); font-size: 14px;">
                Initializing...
            </div>
        </div>
    </div>

    <!-- Mega Upgrade: Multi-Account Workflow -->
    <div class="github-card">
        <div class="github-card-header">
            <h3 class="github-card-title">
                <i class="fas fa-rocket"></i>
                Mega Upgrade: Multi-Account Workflow
            </h3>
        </div>
        
        <p style="color: #656d76; margin-bottom: 24px; font-size: 14px;">
            Process multiple accounts simultaneously with automated workflows. Select which features to apply to all accounts.
        </p>
        
        <button onclick="openMegaUpgradeModal()" class="btn-github btn-github-primary" style="width: 100%; padding: 16px; font-size: 16px;">
            <i class="fas fa-magic"></i> Launch Mega Upgrade Workflow
        </button>
    </div>

    <!-- App Password Management -->
    <div class="github-card">
        <div class="github-card-header">
            <h3 class="github-card-title">
                <i class="fas fa-key"></i>
                App Password Management
            </h3>
        </div>
        
        <p style="color: #656d76; margin-bottom: 24px; font-size: 14px;">
            Upload and manage app passwords for SMTP authentication. When retrieving, the system automatically 
            updates the domain part to match your current domain and formats output as SMTP configuration 
            (user@domain,app_password,smtp.gmail.com,587) ready for direct use in email clients.
        </p>
        
        <!-- Upload Section -->
        <div style="margin-bottom: 24px;">
            <h4 style="margin-bottom: 16px; color: #24292f;">
                <i class="fas fa-upload"></i> Upload App Passwords
            </h4>
            <div class="form-group-github">
                <label for="app-password-file" class="form-label-github">
                    <i class="fas fa-file-text"></i> App Password File (.txt)
                </label>
                <input type="file" id="app-password-file" class="form-control-github" accept=".txt" 
                       style="padding: 12px; border: 2px dashed #d0d7de; background: #f6f8fa;">
                <small style="color: #656d76; font-size: 12px;">
                    Upload a .txt file with format: user@domain.com:app_password (one per line)<br>
                    Output will be formatted as: user@domain.com,app_password,smtp.gmail.com,587
                </small>
            </div>
            <button onclick="uploadAppPasswords()" class="btn-github btn-github-primary">
                <i class="fas fa-upload"></i> Upload App Passwords
            </button>
        </div>
        
        <!-- Retrieve Section -->
        <div style="margin-bottom: 24px;">
            <h4 style="margin-bottom: 16px; color: #24292f;">
                <i class="fas fa-download"></i> Retrieve App Passwords
            </h4>
            <div style="display: grid; grid-template-columns: 1fr auto; gap: 16px; align-items: end;">
                <div class="form-group-github">
                    <label for="retrieve-domain" class="form-label-github">
                        <i class="fas fa-globe"></i> New Domain
                    </label>
                    <input type="text" id="retrieve-domain" class="form-control-github" 
                           placeholder="newdomain.com" value="">
                    <small style="color: #656d76; font-size: 12px;">
                        Enter the domain you want to use for all usernames
                    </small>
                </div>
                <button onclick="retrieveAppPasswords()" class="btn-github btn-github-primary">
                    <i class="fas fa-sync-alt"></i> Update & Optimize
                </button>
            </div>
        </div>
        
        <!-- Display Section -->
        <div style="margin-bottom: 24px;">
            <h4 style="margin-bottom: 16px; color: #24292f;">
                <i class="fas fa-list"></i> App Passwords Display
            </h4>
            <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                <button onclick="copyAppPasswords()" class="btn-github">
                    <i class="fas fa-copy"></i> Copy
                </button>
                <button onclick="clearAppPasswordsDisplay()" class="btn-github">
                    <i class="fas fa-broom"></i> Clear Display
                </button>
                <button onclick="deleteAllAppPasswords()" class="btn-github" 
                        style="background-color: #d73a49; border-color: #d73a49; color: white;"
                        id="delete-all-btn">
                    <i class="fas fa-trash-alt"></i> Delete All (Admin Only)
                </button>
            </div>
            <textarea id="app-passwords-display" class="form-control-github" rows="8" 
                      placeholder="SMTP configuration will appear here in format: user@domain.com,app_password,smtp.gmail.com,587" readonly
                      style="font-family: monospace; font-size: 13px; background: #f6f8fa;"></textarea>
        </div>
    </div>

    <!-- Results Log (Covers Both Workflows) -->
    <div class="github-card">
        <div class="github-card-header">
            <h3 class="github-card-title">
                <i class="fas fa-file-alt"></i>
                Results Log (Covers Both Workflows)
            </h3>
        </div>
        
        <div style="margin-bottom: 16px;">
            <button onclick="clearBulkDomainLog()" class="btn-github">
                <i class="fas fa-broom"></i> Clear Log
            </button>
        </div>
        
        <div id="bulk-domain-results" class="data-display" style="font-family: monospace; font-size: 13px;">
            <div class="status-info">
                <p><strong><i class="fas fa-file-alt"></i> Processing Results</strong></p>
                <p>Processing results will appear here...</p>
            </div>
        </div>
    </div>

    <!-- SMTP Credential Tester -->
    <div class="github-card" style="margin-top: 32px;">
        <div class="github-card-header">
            <h3 class="github-card-title">
                <i class="fas fa-envelope"></i>
                SMTP Credential Tester
            </h3>
        </div>
        
        <div class="form-group-github" style="margin-bottom: 20px;">
            <label for="smtp-credentials" class="form-label-github">
                <i class="fas fa-key"></i> SMTP Credentials (email:password, one per line)
            </label>
            <textarea id="smtp-credentials" class="form-control-github" rows="5" placeholder="user1@gmail.com:password123&#10;user2@outlook.com:apppassword456&#10;user3@yahoo.com:secretpass789"></textarea>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-bottom: 20px;">
            <div class="form-group-github">
                <label for="smtp-recipient" class="form-label-github">
                    <i class="fas fa-envelope"></i> Recipient Email
                </label>
                <input type="email" id="smtp-recipient" class="form-control-github" placeholder="test@domain.com">
            </div>
            <div class="form-group-github">
                <label for="smtp-server" class="form-label-github">
                    <i class="fas fa-server"></i> SMTP Server
                </label>
                <input type="text" id="smtp-server" class="form-control-github" value="smtp.gmail.com" placeholder="SMTP Server">
            </div>
            <div class="form-group-github">
                <label for="smtp-port" class="form-label-github">
                    <i class="fas fa-plug"></i> Port
                </label>
                <input type="number" id="smtp-port" class="form-control-github" value="587" placeholder="Port">
            </div>
        </div>
        
        <div style="display: flex; gap: 12px; margin-bottom: 20px;">
            <button onclick="testSMTPCredentials()" class="btn-github btn-github-primary">
                <i class="fas fa-paper-plane"></i> Send Test Emails
            </button>
            <button onclick="interruptSMTPTesting()" class="btn-github" style="background-color: var(--color-warning-emphasis); border-color: var(--color-warning-emphasis); color: #ffffff;">
                <i class="fas fa-stop"></i> Interrupt Sending
            </button>
            <button onclick="clearSMTPResults()" class="btn-github">
                <i class="fas fa-broom"></i> Clear Log / Reset Files
            </button>
        </div>
        
        <div>
            <h4 style="font-size: 16px; font-weight: 600; color: var(--color-fg-default); margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-chart-bar" style="color: var(--color-accent-fg);"></i>
                SMTP Test Results
            </h4>
            <div id="smtp-results-log" class="data-display" style="font-family: monospace; font-size: 13px;">
                <div class="status-info">
                    <p><strong><i class="fas fa-envelope"></i> SMTP Testing Results</strong></p>
                    <p>Test results will appear here...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Generate Sample CSV for User Creation -->
    <div class="github-card" style="margin-top: 24px;">
        <div class="github-card-header">
            <h3 class="github-card-title">
                <i class="fas fa-file-csv"></i>
                Generate Sample CSV for User Creation
            </h3>
            </div>
            
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-bottom: 20px;">
            <div class="form-group-github">
                <label for="csv-num-users" class="form-label-github">
                    <i class="fas fa-hashtag"></i> Number of Users
                </label>
                <input type="number" id="csv-num-users" class="form-control-github" min="1" max="1000" placeholder="e.g., 50">
            </div>
            <div class="form-group-github">
                <label for="csv-domain" class="form-label-github">
                    <i class="fas fa-globe"></i> Domain
                </label>
                <input type="text" id="csv-domain" class="form-control-github" placeholder="yourdomain.com">
            </div>
            <div class="form-group-github">
                <label for="csv-password" class="form-label-github">
                    <i class="fas fa-lock"></i> Default Password
                </label>
                <input type="text" id="csv-password" class="form-control-github" placeholder="Default password for all users">
            </div>
        </div>
        
        <div style="display: flex; gap: 12px; margin-bottom: 20px;">
            <button onclick="generateUserCSV()" class="btn-github btn-github-primary">
                <i class="fas fa-download"></i> Generate CSV File
            </button>
            <button onclick="previewCSV()" class="btn-github">
                <i class="fas fa-eye"></i> Preview CSV
            </button>
        </div>
        
        <div id="csv-download-area" class="data-display"></div>
        
        <div id="csv-preview-area" class="csv-preview"></div>
    </div>
</div>
</div>



<script>
let currentAccount = null;
let isAuthenticated = false;
let selectedAccountFromList = null;
let selectedAccountId = null;
let smtpTesting = false;
let selectedDomain = null;

// Tab switching functionality
function showTab(tabId) {
    console.log('Switching to tab:', tabId);
    
    // Hide all tab contents
    const tabs = document.querySelectorAll('.tab-content');
    tabs.forEach(tab => {
        tab.classList.remove('active');
        tab.style.display = 'none';
    });
    
    // Remove active class from all tab buttons
    const buttons = document.querySelectorAll('.tab-button');
    buttons.forEach(button => {
        button.classList.remove('active');
        button.style.background = 'var(--color-canvas-subtle)';
        button.style.borderBottom = '1px solid var(--color-border-default)';
        button.style.color = 'var(--color-fg-muted)';
    });
    
    // Show selected tab
    const selectedTab = document.getElementById(tabId);
    if (selectedTab) {
        console.log('Found tab element:', selectedTab);
        selectedTab.classList.add('active');
        selectedTab.style.display = 'block';
        selectedTab.style.visibility = 'visible';
        selectedTab.style.opacity = '1';
        selectedTab.style.height = 'auto';
        selectedTab.style.overflow = 'visible';
        
        // No special handling needed for 3-tab layout
    } else {
        console.error('Tab not found:', tabId);
    }
    
    // Add active class to clicked button  
    const clickedButton = event ? event.target.closest('.tab-button') : document.querySelector(`[onclick="showTab('${tabId}')"]`);
    if (clickedButton) {
        clickedButton.classList.add('active');
        clickedButton.style.background = 'var(--color-canvas-default)';
        clickedButton.style.borderBottom = '3px solid var(--color-accent-emphasis)';
        clickedButton.style.color = 'var(--color-fg-default)';
        clickedButton.style.fontWeight = '600';
    }
}

// Initialize tabs on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing tabs...');
    
    // Check if all tabs exist
    for (let i = 1; i <= 4; i++) {
        const tab = document.getElementById(`tab${i}`);
        console.log(`Tab ${i} exists:`, !!tab);
        if (tab) {
            console.log(`Tab ${i} content length:`, tab.innerHTML.length);
        }
    }
    
    // Ensure tab1 is visible by default
    showTab('tab1');
    
    // 3-tab layout is now complete - no special initialization needed
});

async function loadTokenStatusWithLive() {
    try {
        console.log('=== Starting LIVE token status check ===');
        
        // Reset counters
        let totalAccounts = 0;
        let validAccounts = 0;
        let invalidAccounts = 0;
        
        // Get list of accounts first
        const accountItems = document.querySelectorAll('.account-item');
        totalAccounts = accountItems.length;
        
        // Initialize display
        updateAccountStats(totalAccounts, 0, 0, 'Checking...');
        
        // Check each account individually (LIVE UPDATES)
        for (let item of accountItems) {
            // FIX: Clean the account name - remove status symbols
            const itemCopy = item.cloneNode(true);
            const statusSpan = itemCopy.querySelector('.token-status');
            if (statusSpan) {
                statusSpan.remove();
            }
            const accountName = itemCopy.textContent.trim();
            
            try {
                // Show "checking" status
                showAccountChecking(item, accountName);
                
                // Check this specific account
                const isValid = await checkSingleAccountLive(accountName);
                
                // Update visual immediately
                updateAccountVisual(item, accountName, isValid);
                
                // Update counters
                if (isValid) {
                    validAccounts++;
                } else {
                    invalidAccounts++;
                }
                
                // Update stats in real-time
                updateAccountStats(totalAccounts, validAccounts, invalidAccounts, 'Checking...');
                
                // Update dropdown too (with clean name)
                updateDropdownOption(accountName, isValid);
                
            } catch (error) {
                console.error(`Error checking ${accountName}:`, error);
                updateAccountVisual(item, accountName, false);
                invalidAccounts++;
                updateAccountStats(totalAccounts, validAccounts, invalidAccounts, 'Checking...');
            }
        }
        
        // Final update
        updateAccountStats(totalAccounts, validAccounts, invalidAccounts, 'Complete');
        
        // Save results to cache/SFTP for persistence
        await saveTokenStatusResults();
        
        console.log(`‚úÖ Live check complete: ${validAccounts}/${totalAccounts} authenticated`);
        
    } catch (error) {
        console.error('Live token status check failed:', error);
    }
}

// Check single account status
async function checkSingleAccountLive(accountName) {
    try {
        const response = await fetch('/api/check-token-status', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({account_name: accountName})
        });
        
        const data = await response.json();
        return data.success && data.is_valid;
        
    } catch (error) {
        console.error(`Token check failed for ${accountName}:`, error);
        return false;
    }
}

// Show account being checked
function showAccountChecking(item, accountName) {
    const oldStatus = item.querySelector('.token-status');
    if (oldStatus) oldStatus.remove();
    
    const statusSpan = document.createElement('span');
    statusSpan.className = 'token-status checking';
    statusSpan.textContent = ' üîÑ';
    statusSpan.style.cssText = 'float: right; margin-left: 10px; color: orange;';
    item.appendChild(statusSpan);
}

// Update account visual status
function updateAccountVisual(item, accountName, isValid) {
    const oldStatus = item.querySelector('.token-status');
    if (oldStatus) oldStatus.remove();
    
    const statusSpan = document.createElement('span');
    statusSpan.className = isValid ? 'token-status valid' : 'token-status invalid';
    statusSpan.textContent = isValid ? ' ‚úÖ' : ' ‚ùå';
    statusSpan.style.cssText = 'float: right; margin-left: 10px;';
    item.appendChild(statusSpan);
    
    console.log(`‚úÖ Updated ${accountName}: ${isValid ? 'Valid' : 'Invalid'}`);
}

// Update dropdown option
function updateDropdownOption(accountName, isValid) {
    // Clean account name for selector (escape special characters)
    const cleanAccountName = accountName.replace(/[^a-zA-Z0-9@.\-_]/g, '');
    
    try {
        // Try to find option by value
        const option = document.querySelector(`#account-select option[value="${accountName}"]`);
        if (option) {
            option.textContent = `${accountName} ${isValid ? '‚úÖ' : '‚ùå'}`;
        } else {
            // If not found, try finding by text content
            const allOptions = document.querySelectorAll('#account-select option');
            allOptions.forEach(opt => {
                if (opt.value === accountName || opt.textContent.includes(accountName)) {
                    opt.textContent = `${accountName} ${isValid ? '‚úÖ' : '‚ùå'}`;
                }
            });
        }
    } catch (error) {
        console.error(`Error updating dropdown for ${accountName}:`, error);
    }
}

// Update stats counter in real-time
function updateAccountStats(total, valid, invalid, status) {
    const statsElement = document.getElementById('account-stats');
    if (statsElement) {
        const checked = valid + invalid;
        statsElement.innerHTML = `
            <span class="stat-item">Total: <strong>${total}</strong></span>
            <span class="stat-item">Checked: <strong>${checked}/${total}</strong></span>
            <span class="stat-item stat-valid">‚úÖ Authenticated: <strong>${valid}</strong></span>
            <span class="stat-item stat-invalid">‚ùå Need Auth: <strong>${invalid}</strong></span>
            <span class="stat-item" style="color: #007bff;">Status: <strong>${status}</strong></span>
        `;
    }
}

// Save results for persistence (survives restart)
async function saveTokenStatusResults() {
    try {
        // Collect current status with CLEAN account names
        const results = {};
        const accountItems = document.querySelectorAll('.account-item');
        
        accountItems.forEach(item => {
            // Get ONLY the account name text, exclude status symbols
            const accountNameElement = item.cloneNode(true);
            
            // Remove the status span to get clean account name
            const statusSpan = accountNameElement.querySelector('.token-status');
            if (statusSpan) {
                statusSpan.remove();
            }
            
            // Get clean account name
            const accountName = accountNameElement.textContent.trim();
            
            // Get the actual status
            const statusElement = item.querySelector('.token-status');
            
            if (statusElement && accountName) {
                const isValid = statusElement.textContent.includes('‚úÖ');
                results[accountName] = {
                    is_valid: isValid,
                    last_checked: new Date().toISOString()
                };
                
                console.log(`Clean save: "${accountName}" = ${isValid}`);
            }
        });
        
        console.log('Saving results for', Object.keys(results).length, 'accounts');
        
        // Save to server for persistence
        const response = await fetch('/api/save-token-status-cache', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({status_results: results})
        });
        
        const data = await response.json();
        console.log('Save response:', data);
        
    } catch (error) {
        console.error('Failed to save token status results:', error);
    }
}

// Load saved results on page load (for persistence)
async function loadSavedTokenStatus() {
    try {
        const response = await fetch('/api/load-token-status-cache', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        
        const data = await response.json();
        
        if (data.success && data.status) {
            console.log('Loading saved token status...');
            displaySavedTokenStatus(data.status);
            return true;
        }
        
        return false;
        
    } catch (error) {
        console.error('Failed to load saved token status:', error);
        return false;
    }
}

// Display saved status from cache
function displaySavedTokenStatus(statusData) {
    const accountItems = document.querySelectorAll('.account-item');
    let totalAccounts = accountItems.length;
    let validAccounts = 0;
    let invalidAccounts = 0;
    
    accountItems.forEach(item => {
        const accountName = item.textContent.trim();
        
        if (statusData[accountName]) {
            const isValid = statusData[accountName].is_valid;
            updateAccountVisual(item, accountName, isValid);
            updateDropdownOption(accountName, isValid);
            
            if (isValid) {
                validAccounts++;
            } else {
                invalidAccounts++;
            }
        }
    });
    
    updateAccountStats(totalAccounts, validAccounts, invalidAccounts, 'Loaded from cache');
    console.log(`Loaded cached status: ${validAccounts}/${totalAccounts} authenticated`);
}

// Main function - use database for token status
async function initializeTokenStatus() {
    console.log('Initializing token status from database...');
    await checkTokenStatusFromDatabase();
}

// Auto-refresh every 8 hours (but user can manually refresh anytime)
setInterval(checkTokenStatusFromDatabase, 8 * 60 * 60 * 1000);

// Load on page load
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(initializeTokenStatus, 1000);
    
    // Check if there's a currently authenticated account in session
    checkCurrentAuthenticationStatus();
});

// Check current authentication status from session
async function checkCurrentAuthenticationStatus() {
    try {
        const response = await fetch('/api/get-account-status', {
            method: 'GET',
            headers: {'Content-Type': 'application/json'}
        });
        
        const data = await response.json();
        
        if (data.success && data.status) {
            const { total, authenticated, need_auth } = data.status;
            
            // Update the auth status display
            if (authenticated > 0) {
                // Get the current authenticated account name
                const currentAccountName = sessionStorage.getItem('current_account_name');
                if (currentAccountName) {
                    updateAuthStatus(currentAccountName, true, `Currently authenticated (${authenticated}/${total} accounts)`);
                }
            }
            
            console.log(`Current authentication status: ${authenticated}/${total} accounts authenticated`);
        }
    } catch (error) {
        console.error('Failed to check current authentication status:', error);
    }
}


// Tab switching function
function showTab(tabId) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remove active class from all buttons
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById(tabId).classList.add('active');
    
    // Mark button as active
    event.target.classList.add('active');
    
    // Auto-refresh domain data when domains tab is shown
    if (tabId === 'tab3' && isAuthenticated) {
        setTimeout(() => {
            retrieveAvailableDomains();
        }, 500);
    }
}

// Results log functions
function logResult(message) {
    const log = document.getElementById('results-log');
    const activityLog = document.getElementById('activity-log');
    const timestamp = new Date().toLocaleTimeString();
    const logEntry = `[${timestamp}] ${message}\n`;
    
    // Log to results log (existing functionality)
    log.textContent += logEntry;
    log.scrollTop = log.scrollHeight;
    
    // Also log to activity log
    if (activityLog) {
        // Remove the placeholder text if it exists
        if (activityLog.textContent.includes('üìù Activity log will appear here...')) {
            activityLog.textContent = '';
        }
        activityLog.textContent += logEntry;
        activityLog.scrollTop = activityLog.scrollHeight;
    }
}

function clearResultsLog() {
    document.getElementById('results-log').textContent = '';
}

// Activity log management functions
function clearLogs() {
    if (confirm('üóëÔ∏è Are you sure you want to clear all activity logs?')) {
        document.getElementById('activity-log').textContent = 'üìù Activity log cleared. New activities will appear here...';
        logResult('üìù Activity log cleared by user');
    }
}

function copyLogs() {
    const activityLog = document.getElementById('activity-log');
    const logText = activityLog.textContent;
    
    if (!logText || logText.includes('üìù Activity log will appear here...') || logText.includes('üìù Activity log cleared.')) {
        alert('üìù No logs to copy. Perform some actions first.');
        return;
    }
    
    navigator.clipboard.writeText(logText).then(() => {
        logResult('üìã Activity logs copied to clipboard');
    }).catch(err => {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = logText;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        logResult('üìã Activity logs copied to clipboard (fallback method)');
    });
}

function downloadLogs() {
    const activityLog = document.getElementById('activity-log');
    const logText = activityLog.textContent;
    
    if (!logText || logText.includes('üìù Activity log will appear here...') || logText.includes('üìù Activity log cleared.')) {
        alert('üìù No logs to download. Perform some actions first.');
        return;
    }
    
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
    const filename = `gbot-activity-log-${timestamp}.txt`;
    
    const blob = new Blob([logText], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    
    logResult(`üíæ Activity logs downloaded as ${filename}`);
}

async function copyToClipboard(text) {
    try {
        // Try modern clipboard API first
        if (navigator.clipboard && window.isSecureContext) {
            await navigator.clipboard.writeText(text);
            return true;
        } else {
            // Fallback method for HTTP sites
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            const successful = document.execCommand('copy');
            document.body.removeChild(textArea);
            return successful;
        }
    } catch (err) {
        console.error('Copy failed:', err);
        return false;
    }
}

function enterAuthorizationCode() {
    const accountName = document.getElementById('account-select').value;
    
    if (!accountName) {
        alert('Please select an account first');
        return;
    }
    
    // Get the account ID from the selected option
    const selectedOption = document.querySelector(`#account-select option[value="${accountName}"]`);
    const accountId = selectedOption ? selectedOption.getAttribute('data-account-id') : null;
    
    if (!accountId) {
        alert('Account ID not found. Please refresh the page and try again.');
        return;
    }
    
    const authCode = prompt('Paste the authorization code from the authentication page:');
    
    if (!authCode) {
        return;
    }
    
    // Complete authentication with code
    fetch('/api/complete-oauth', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            auth_code: authCode.trim(),
            account_id: accountId,
            account_name: accountName
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ Authentication completed successfully!');
            
            // Store the authenticated account in sessionStorage for persistence
            sessionStorage.setItem('current_account_name', accountName);
            
            updateAccountStatusAfterAuth(accountName, true);
        } else {
            alert('‚ùå Authentication failed: ' + data.error);
        }
    })
    .catch(error => {
        alert('‚ùå Network error: ' + error);
    });
}

function copyResultsLog() {
    const logContent = document.getElementById('results-log').textContent;
    if (logContent.trim()) {
        copyToClipboard(logContent).then(success => {
            if (success) {
                alert('üìã Log copied to clipboard!');
            } else {
                alert('‚ùå Copy failed - please try manually selecting the text');
            }
        });
    } else {
        alert('No log content to copy');
    }
}

function updateAuthStatus(account, authenticated, message) {
    const statusBox = document.getElementById('auth-status');
    currentAccount = account;
    isAuthenticated = authenticated;
    
    if (authenticated) {
        statusBox.innerHTML = `<p style="color: green;">‚úÖ Authenticated as: ${account}</p>`;
        statusBox.className = 'status-box success';
    } else {
        statusBox.innerHTML = `<p style="color: red;">‚ùå ${message || 'Not authenticated'}</p>`;
        statusBox.className = 'status-box error';
    }
}

function authenticateAccount() {
    const select = document.getElementById('account-select');
    const accountName = select.value;
    
    if (!accountName) {
        alert('Please select an account first');
        return;
    }
    
    // Get the account ID from the selected option
    const selectedOption = select.querySelector(`option[value="${accountName}"]`);
    const accountId = selectedOption ? selectedOption.getAttribute('data-account-id') : null;
    
    if (!accountId) {
        alert('Account ID not found. Please refresh the page and try again.');
        return;
    }
    
    console.log('DEBUG: Authenticating account:', accountName, 'ID:', accountId);
    updateAuthStatus(accountName, false, 'Authenticating...');
    
    fetch('/api/authenticate', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({account_id: accountId, account_name: accountName})
    })
    .then(response => response.json())
    .then(data => {
        console.log('DEBUG: API response:', data);
        
        if (data.success) {
            updateAuthStatus(accountName, true, data.message);
            
            // Store the authenticated account in sessionStorage for persistence
            sessionStorage.setItem('current_account_name', accountName);
            
            // UPDATE THE VISUAL STATUS IMMEDIATELY
            updateAccountStatusAfterAuth(accountName, true);
            
        } else if (data.oauth_required && data.oauth_url) {
            console.log('DEBUG: OAuth URL received:', data.oauth_url);
            updateAuthStatus(accountName, false, 'OAuth URL generated - opening...');
            
            // Show OAuth modal with the URL
            showOAuthModal(data.oauth_url);
            
        } else {
            console.error('DEBUG: Authentication failed:', data.error);
            updateAuthStatus(accountName, false, data.error || 'Authentication failed');
        }
    })
    .catch(error => {
        console.error('DEBUG: Network error:', error);
        updateAuthStatus(accountName, false, 'Network error: ' + error);
    });
}

function completeOAuthWithCode() {
    const authCode = prompt('Paste the authorization code from the OAuth success page:');
    const accountName = document.getElementById('account-select').value;
    
    if (!authCode || !accountName) {
        alert('Code and account selection required');
        return;
    }
    
    fetch('/api/complete-oauth', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            auth_code: authCode.trim(),
            account_name: accountName
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ Authentication completed successfully!');
            updateAccountStatusAfterAuth(accountName, true);
        } else {
            alert('‚ùå Authentication failed: ' + data.error);
        }
    })
    .catch(error => {
        alert('‚ùå Network error: ' + error);
    });
}


// OAuth Modal functions
function showOAuthModal(authUrl) {
    const modal = document.getElementById('oauthModal');
    const urlDiv = document.getElementById('oauthUrl');
    
    urlDiv.textContent = authUrl;
    modal.style.display = 'block';
    
    // Store URL globally for copying
    window.currentOAuthUrl = authUrl;
}

function closeOAuthModal() {
    document.getElementById('oauthModal').style.display = 'none';
}

function copyOAuthUrl() {
    if (window.currentOAuthUrl) {
        copyToClipboard(window.currentOAuthUrl).then(success => {
            if (success) {
                alert('‚úÖ OAuth URL copied to clipboard!');
            } else {
                alert('‚ùå Copy failed - please select and copy manually');
            }
        });
    }
}

function openOAuthUrl() {
    if (window.currentOAuthUrl) {
        window.open(window.currentOAuthUrl, '_blank');
    }
}

// Update existing window click handler
window.onclick = function(event) {
    const modal = document.getElementById('oauthModal');
    if (event.target === modal) {
        closeOAuthModal();
    }
}

function retrieveUsers() {
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    document.getElementById('user-display').innerHTML = `
        <div class="status-info" style="background: #fff3cd; border-color: #ffeaa7;">
            <p><strong>üìä Loading Users</strong></p>
            <p>Retrieving user data from Google Admin API...</p>
            <p><small>This may take up to 2 minutes for large user bases (10k+ users).</small></p>
            <div style="margin-top: 10px;">
                <div class="progress-bar" style="width: 100%; background-color: #f0f0f0; border-radius: 5px; overflow: hidden;">
                    <div class="progress-fill" style="width: 0%; height: 20px; background-color: #007bff; transition: width 0.3s ease;"></div>
                </div>
                <p style="margin-top: 5px; font-size: 12px; color: #666;">Please wait while we retrieve all users...</p>
            </div>
        </div>`;
    
    // Batched retrieval to avoid 504 timeouts
    const allUsers = [];
    let nextToken = null;
    let batches = 0;
    const progressFill = document.querySelector('.progress-fill');

    const fetchBatch = async () => {
        const payload = { mode: 'batched', max_pages: 6 };
        if (nextToken) payload.page_token = nextToken;
        const resp = await fetch('/api/retrieve-users', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        const text = await resp.text();
        let data;
        try { data = JSON.parse(text); } catch (e) { throw new Error('SERVER_HTML:' + text.slice(0,200)); }
        if (!data.success) throw new Error(data.error || 'Unknown error');
        allUsers.push(...data.users);
        nextToken = data.next_page_token || null;
        batches += 1;
        if (progressFill) progressFill.style.width = Math.min(95, 10 + batches * 8) + '%';
        if (nextToken) {
            await new Promise(r => setTimeout(r, 150));
            return fetchBatch();
        }
        if (progressFill) progressFill.style.width = '100%';
        return allUsers;
    };

    fetchBatch().then(users => {
        const activeUsers = users.filter(user => !user.suspended).length;
        const suspendedUsers = users.filter(user => user.suspended).length;
        const adminUsers = users.filter(user => user.admin).length;
        let html = `<div class="status-summary">
            <div class="status-item"><span class="status-label">üìä Total Users:</span><span class="status-value">${users.length}</span></div>
            <div class="status-item"><span class="status-label">‚úÖ Active Users:</span><span class="status-value">${activeUsers}</span></div>
            <div class="status-item"><span class="status-label">üö´ Suspended Users:</span><span class="status-value">${suspendedUsers}</span></div>
            <div class="status-item"><span class="status-label">üëë Admin Users:</span><span class="status-value">${adminUsers}</span></div>
        </div>`;
        users.forEach(user => {
            const statusBadge = user.suspended ? '<span class="badge suspended">üö´ Suspended</span>' : '<span class="badge active">‚úÖ Active</span>';
            html += `<div class="user-item ${user.suspended ? 'suspended-user-item' : ''}">
                <span class="email">${user.email}</span>
                <span class="name">${user.first_name} ${user.last_name}</span>
                <span class="status-badges">${user.admin ? '<span class="badge admin">üëë Admin</span>' : ''}${statusBadge}</span>
            </div>`;
        });
        document.getElementById('user-display').innerHTML = html;
        document.getElementById('user-count').textContent = `Total Users: ${users.length}`;
        setTimeout(() => { loadSuspendedUsers(); }, 500);
    })
    .catch(error => {
        let errorMessage = 'Failed to connect to the server';
        let errorDetails = 'Please check your connection and try again.';
        
        if (error.name === 'TimeoutError' || error.message.includes('timeout')) {
            errorMessage = 'Request Timeout';
            errorDetails = 'The request took longer than 2 minutes. For very large user bases (10k+ users), this is normal. Please try again.';
        } else if (error.name === 'AbortError') {
            errorMessage = 'Request Aborted';
            errorDetails = 'The request was cancelled. Please try again.';
        } else {
            errorMessage = 'Network Error';
            errorDetails = `Failed to connect to the server: ${error.message}`;
        }
        
        if (error.message && error.message.startsWith('SERVER_HTML:')) {
            const snippet = error.message.replace('SERVER_HTML:', '');
            document.getElementById('user-display').innerHTML = `
                <div class="status-info" style="background: #f8d7da; border-color: #f5c6cb;">
                    <p><strong>‚ùå Server Error</strong></p>
                    <p>The server returned an HTML error page instead of JSON. This usually means a timeout or crash upstream.</p>
                    <pre style="white-space: pre-wrap; max-height: 160px; overflow:auto; background:#fff; padding:8px; border:1px solid #eee;">${snippet}</pre>
                </div>`;
        } else {
            document.getElementById('user-display').innerHTML = `
                <div class="status-info" style="background: #f8d7da; border-color: #f5c6cb;">
                    <p><strong>‚ùå ${errorMessage}</strong></p>
                    <p>${errorDetails}</p>
                    <p><small>If you have a very large user base (10k+ users), this may be a timeout. We‚Äôve raised server timeouts to handle this.</small></p>
                </div>`;
        }
    });
}

function clearUserList() {
    document.getElementById('user-display').innerHTML = `
        <div class="status-info">
            <p><strong>üë• User Management</strong></p>
            <p>Click "üìä Retrieve All Users" to load and display all users from your Google Workspace.</p>
            <p><small>This will show user status (Active/Suspended), admin privileges, and provide options for bulk operations.</small></p>
        </div>`;
    document.getElementById('user-count').textContent = 'Total Users: 0';
}

function copyAllUsers() {
    const userElements = document.querySelectorAll('.user-item');
    if (userElements.length === 0) {
        alert('No users to copy');
        return;
    }
    
    const emails = Array.from(userElements).map(element => {
        const emailElement = element.querySelector('.email');
        return emailElement ? emailElement.textContent.trim() : '';
    }).filter(email => email);
    
    const emailText = emails.join('\n');
    
    copyToClipboard(emailText).then(success => {
        if (success) {
            alert(`‚úÖ Copied ${emails.length} user emails to clipboard`);
            logResult(`üìã Copied ${emails.length} user emails to clipboard`);
        } else {
            alert('‚ùå Copy failed - please try manually selecting the text');
        }
    });
}

function updateAllPasswords() {
    const password = document.getElementById('new-password').value;
    
    // Validation
    if (!password || password.length < 8) {
        alert('Password must be at least 8 characters');
        return;
    }
    
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    // Get emails from the displayed user items
    const userItems = document.querySelectorAll('.user-item .email');
    
    if (userItems.length === 0) {
        alert('No users found in the list. Please retrieve users first using "üìä Retrieve All Users" button.');
        return;
    }
    
    // Extract emails from the user display
    const userEmails = Array.from(userItems).map(item => item.textContent.trim());
    
    // Confirmation
    if (!confirm(`Update password for ALL ${userEmails.length} users?\n\nThis action cannot be undone.\n\nNew password: ${password}`)) {
        return;
    }
    
    // Show loading state
    const button = event.target;
    const originalText = button.textContent;
    button.textContent = 'üîÑ Updating Passwords...';
    button.disabled = true;
    
    // Make API request
    fetch('/api/update-all-passwords', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            password: password,
            user_emails: userEmails
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let message = data.message + '\n\n';
            
            if (data.successful_emails.length > 0) {
                message += `‚úÖ Successfully updated (${data.successful_emails.length}):\n`;
                message += data.successful_emails.slice(0, 10).join('\n');
                if (data.successful_emails.length > 10) {
                    message += `\n... and ${data.successful_emails.length - 10} more`;
                }
                message += '\n\n';
            }
            
            if (data.failed_details.length > 0) {
                message += `‚ùå Failed updates (${data.failed_details.length}):\n`;
                data.failed_details.slice(0, 5).forEach(failure => {
                    message += `${failure.email}: ${failure.error}\n`;
                });
                if (data.failed_details.length > 5) {
                    message += `... and ${data.failed_details.length - 5} more failures`;
                }
            }
            
            alert(message);
            
            // Clear password field
            document.getElementById('new-password').value = '';
            
        } else {
            alert('‚ùå Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Network error:', error);
        alert('‚ùå Network error: ' + error.message);
    })
    .finally(() => {
        // Restore button state
        button.textContent = originalText;
        button.disabled = false;
    });
}

function retrieveDomains() {
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    document.getElementById('domain-display').innerHTML = `
        <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 5px; margin: 10px 0;">
            <p><strong>üîç Loading Domains</strong></p>
            <p>Retrieving domain data from Google Admin API...</p>
            <p><small>This may take a moment for large domain lists (500+ domains).</small></p>
            <div style="margin-top: 10px;">
                <div class="progress-bar" style="width: 100%; background-color: #f0f0f0; border-radius: 5px; overflow: hidden;">
                    <div class="progress-fill" style="width: 0%; height: 20px; background-color: #007bff; transition: width 0.3s ease;"></div>
                </div>
                <p style="margin-top: 5px; font-size: 12px; color: #666;">Please wait while we retrieve all domains...</p>
            </div>
        </div>`;
    
    // Batched retrieval to avoid timeouts with large domain lists
    const allDomains = [];
    let nextToken = null;
    let batches = 0;
    const progressFill = document.querySelector('.progress-fill');

    const fetchBatch = async () => {
        const payload = { mode: 'batched' };
        if (nextToken) payload.page_token = nextToken;
        
        const resp = await fetch('/api/retrieve-domains', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        
        const text = await resp.text();
        let data;
        try { data = JSON.parse(text); } catch(e) { throw new Error('SERVER_HTML:' + text.slice(0,200)); }
        
        if (!data.success) throw new Error(data.error || 'Unknown error');
        
        allDomains.push(...data.domains);
        nextToken = data.next_page_token || null;
        batches += 1;
        
        if (progressFill) progressFill.style.width = Math.min(95, 10 + batches * 15) + '%';
        
        if (nextToken) {
            await new Promise(r => setTimeout(r, 200));
            return fetchBatch();
        }
        
        if (progressFill) progressFill.style.width = '100%';
        return allDomains;
    };

    fetchBatch().then(domains => {
        let html = '';
        domains.forEach(domain => {
            // Extract domain information
            const domainName = domain.domainName || domain.domain_name || domain.domain || 'Unknown Domain';
            const isVerified = domain.verified || domain.isVerified || domain.is_verified || false;
            const userCount = domain.user_count || 0;
            const status = domain.status || 'available';
            const statusText = domain.status_text || 'AVAILABLE';
            const statusColor = domain.status_color || '#4CAF50';
            
            // Create status badge based on domain status
            let statusBadge = '';
            if (status === 'in_use') {
                statusBadge = `<span class="badge in-use" style="background-color: #9C27B0; color: white;">üü£ IN USE</span>`;
            } else if (status === 'used') {
                statusBadge = `<span class="badge used" style="background-color: #FF9800; color: white;">üü† USED</span>`;
            } else {
                statusBadge = `<span class="badge available" style="background-color: #4CAF50; color: white;">üü¢ AVAILABLE</span>`;
            }
            
            html += `<div class="domain-item">
                <span class="domain-name">${domainName}</span>
                <span class="user-count">${userCount} users</span>
                ${isVerified ? '<span class="badge verified">‚úÖ Verified</span>' : '<span class="badge unverified">‚ùå Not Verified</span>'}
                ${statusBadge}
            </div>`;
        });
        document.getElementById('domain-display').innerHTML = html;
    })
    .catch(error => {
        if (error.message && error.message.startsWith('SERVER_HTML:')) {
            const snippet = error.message.replace('SERVER_HTML:', '');
            document.getElementById('domain-display').innerHTML = `<div class="domain-error">‚ùå Server Error: HTML error page returned<pre style="white-space: pre-wrap; max-height: 160px; overflow:auto; background:#fff; padding:8px; border:1px solid #eee;">${snippet}</pre></div>`;
        } else {
            document.getElementById('domain-display').innerHTML = `<p style="color: red;">Network error: ${error}</p>`;
        }
    });
}

function clearDomainDisplay() {
    document.getElementById('domain-display').innerHTML = '<p>Click \'Retrieve Domains\' to view domains here...</p>';
}

function loadSuspendedUsers() {
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    document.getElementById('suspended-display').innerHTML = `
        <div class="status-info" style="background: #fff3cd; border-color: #ffeaa7;">
            <p><strong>üîç Loading Suspended Users</strong></p>
            <p>Retrieving user data from Google Admin API...</p>
            <p><small>This may take a few moments depending on the number of users.</small></p>
        </div>`;
    
    fetch('/api/load-suspended-users', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        console.log('Suspended users API response:', data); // Debug log
        if (data.success) {
            if (data.users && data.users.length > 0) {
                let html = `<div class="status-info">
                    <p><strong>üìä Found ${data.total_count} suspended user(s):</strong></p>
                    ${data.debug_info ? `<p><small>Debug: Raw count: ${data.debug_info.raw_suspended_count}, Formatted: ${data.debug_info.formatted_count}</small></p>` : ''}
                </div>`;
                
                data.users.forEach(user => {
                    const fullName = user.full_name || `${user.first_name} ${user.last_name}`.trim() || 'No Name';
                    const adminBadge = user.admin ? '<span class="badge admin">üëë Admin</span>' : '';
                    const suspendedBadge = '<span class="badge suspended">üö´ Suspended</span>';
                    
                    html += `<div class="suspended-user">
                        <div class="user-info">
                            <span class="email">${user.email}</span>
                            <span class="name">${fullName}</span>
                            ${adminBadge}
                            ${suspendedBadge}
                        </div>
                    </div>`;
                });
                
                document.getElementById('suspended-display').innerHTML = html;
            } else {
                document.getElementById('suspended-display').innerHTML = `
                    <div class="status-info">
                        <p><strong>‚úÖ No Suspended Users Found</strong></p>
                        <p>All users in this account are currently active.</p>
                        ${data.debug_info ? `<p><small>Debug: Raw count: ${data.debug_info.raw_suspended_count}, Formatted: ${data.debug_info.formatted_count}</small></p>` : ''}
                    </div>`;
            }
        } else {
            console.error('Suspended users API error:', data); // Debug log
            document.getElementById('suspended-display').innerHTML = `
                <div class="status-info" style="background: #f8d7da; border-color: #f5c6cb;">
                    <p><strong>‚ùå Error Loading Suspended Users</strong></p>
                    <p>${data.error || 'Unknown error occurred'}</p>
                    <p><small>Please try refreshing or re-authenticating your account.</small></p>
                    <button onclick="debugAuthStatus()" class="btn-github" style="margin-top: 10px;">
                        üîç Debug Authentication Status
                    </button>
                    <button onclick="testSuspendedQuery()" class="btn-github" style="margin-top: 10px; margin-left: 10px;">
                        üß™ Test Suspended Query
                    </button>
                    <button onclick="console.log('Full API response:', ${JSON.stringify(data)})" class="btn-github" style="margin-top: 10px; margin-left: 10px;">
                        üìã Log Full Response
                    </button>
                </div>`;
        }
    })
    .catch(error => {
        document.getElementById('suspended-display').innerHTML = `
            <div class="status-info" style="background: #f8d7da; border-color: #f5c6cb;">
                <p><strong>‚ùå Network Error</strong></p>
                <p>Failed to connect to the server: ${error}</p>
                <p><small>Please check your connection and try again.</small></p>
            </div>`;
    });
}

function copySuspendedUsers() {
    const suspendedItems = document.querySelectorAll('.suspended-user .email');
    const emails = Array.from(suspendedItems).map(item => item.textContent.trim());
    
    if (emails.length > 0) {
        copyToClipboard(emails.join('\n')).then(success => {
            if (success) {
                alert(`‚úÖ Copied ${emails.length} suspended email addresses to clipboard!`);
            } else {
                alert('‚ùå Copy failed - please try manually selecting the text');
            }
        });
    } else {
        alert('No suspended users to copy');
    }
}

function refreshSuspendedUsers() {
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    // Clear current display and reload
    document.getElementById('suspended-display').innerHTML = `
        <div class="status-info" style="background: #fff3cd; border-color: #ffeaa7;">
            <p><strong>üîÑ Refreshing Suspended Users</strong></p>
            <p>Updating user status from Google Admin API...</p>
            <p><small>Please wait while we refresh the data.</small></p>
        </div>`;
    
    // Reload after a short delay to show the refresh message
    setTimeout(() => {
        loadSuspendedUsers();
    }, 1000);
}

function clearSuspendedUsers() {
    document.getElementById('suspended-display').innerHTML = `
        <div class="status-info">
            <p><strong>‚õî Suspended User Management</strong></p>
            <p>Click "üîç Load Suspended Users" to check for suspended accounts in your Google Workspace.</p>
            <p><small>This will show all users with suspended status, including their names, emails, and admin privileges.</small></p>
        </div>`;
}

function debugAuthStatus() {
    fetch('/api/debug-auth-status')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const debugInfo = data.debug_info;
            const debugHtml = `
                <div class="status-info" style="background: #e7f3ff; border-color: #b3d9ff;">
                    <p><strong>üîç Authentication Debug Information</strong></p>
                    <p><strong>Current Account:</strong> ${debugInfo.current_account || 'None'}</p>
                    <p><strong>Service Available:</strong> ${debugInfo.service_available ? '‚úÖ Yes' : '‚ùå No'}</p>
                    <p><strong>Token Valid:</strong> ${debugInfo.token_valid ? '‚úÖ Yes' : '‚ùå No'}</p>
                    <p><strong>Session ID:</strong> ${debugInfo.session_id || 'None'}</p>
                    <p><strong>Session Keys:</strong> ${debugInfo.session_keys.join(', ') || 'None'}</p>
                    <button onclick="clearSuspendedUsers()" class="btn-github" style="margin-top: 10px;">
                        üîô Back to Suspended Users
                    </button>
                </div>`;
            document.getElementById('suspended-display').innerHTML = debugHtml;
        } else {
            alert('Debug failed: ' + data.error);
        }
    })
    .catch(error => {
        alert('Debug request failed: ' + error);
    });
}

function testSuspendedQuery() {
    document.getElementById('suspended-display').innerHTML = `
        <div class="status-info" style="background: #fff3cd; border-color: #ffeaa7;">
            <p><strong>üß™ Testing Suspended User Queries</strong></p>
            <p>Running diagnostic tests...</p>
        </div>`;
    
    fetch('/api/test-suspended-query', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        console.log('Test suspended query response:', data);
        if (data.success) {
            const results = data.results;
            let html = `
                <div class="status-info" style="background: #e7f3ff; border-color: #b3d9ff;">
                    <p><strong>üß™ Suspended Query Test Results</strong></p>
                    <p><strong>Account:</strong> ${data.account}</p>
            `;
            
            // Direct suspended query results
            if (results.direct_suspended_query.success) {
                html += `
                    <p><strong>Direct Suspended Query:</strong> ‚úÖ Success</p>
                    <p><strong>Found:</strong> ${results.direct_suspended_query.count} suspended users</p>
                `;
                if (results.direct_suspended_query.users.length > 0) {
                    html += `<p><strong>Users:</strong></p><ul>`;
                    results.direct_suspended_query.users.forEach(user => {
                        html += `<li>${user.email} (suspended: ${user.suspended})</li>`;
                    });
                    html += `</ul>`;
                }
            } else {
                html += `
                    <p><strong>Direct Suspended Query:</strong> ‚ùå Failed</p>
                    <p><strong>Error:</strong> ${results.direct_suspended_query.error}</p>
                `;
            }
            
            // All users filter results
            if (results.all_users_filter.success) {
                html += `
                    <p><strong>All Users Filter:</strong> ‚úÖ Success</p>
                    <p><strong>Total Users:</strong> ${results.all_users_filter.total_users}</p>
                    <p><strong>Suspended Users:</strong> ${results.all_users_filter.suspended_count}</p>
                `;
                if (results.all_users_filter.users.length > 0) {
                    html += `<p><strong>All Users (first 10):</strong></p><ul>`;
                    results.all_users_filter.users.forEach(user => {
                        html += `<li>${user.email} (suspended: ${user.suspended})</li>`;
                    });
                    html += `</ul>`;
                }
            } else {
                html += `
                    <p><strong>All Users Filter:</strong> ‚ùå Failed</p>
                    <p><strong>Error:</strong> ${results.all_users_filter.error}</p>
                `;
            }
            
            html += `
                <button onclick="clearSuspendedUsers()" class="btn-github" style="margin-top: 10px;">
                    üîô Back to Suspended Users
                </button>
            </div>`;
            
            document.getElementById('suspended-display').innerHTML = html;
        } else {
            alert('Test failed: ' + data.error);
        }
    })
    .catch(error => {
        alert('Test request failed: ' + error);
    });
}

function refreshAccounts() {
    // Simply reload the page to refresh accounts from database
    location.reload();
}

// Modal functions
function openAddAccountModal() {
    document.getElementById('addAccountModal').style.display = 'block';
}

function closeAddAccountModal() {
    document.getElementById('addAccountModal').style.display = 'none';
    document.getElementById('addAccountForm').reset();
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('addAccountModal');
    if (event.target == modal) {
        closeAddAccountModal();
    }
}

// Save new account
function saveNewAccount() {
    const email = document.getElementById('new-account-email').value;
    const clientId = document.getElementById('new-client-id').value;
    const clientSecret = document.getElementById('new-client-secret').value;
    
    if (!email || !clientId || !clientSecret) {
        alert('All fields are required');
        return;
    }
    
    if (!email.includes('@')) {
        alert('Please enter a valid email address');
        return;
    }
    
    fetch('/api/add-account', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            account_name: email,
            client_id: clientId,
            client_secret: clientSecret
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ Account added successfully!');
            closeAddAccountModal();
            location.reload(); // Reload to show new account
        } else {
            alert('‚ùå Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('‚ùå Network error: ' + error);
    });
}

// Account list functions
function selectAccountFromList(accountName, accountId) {
    // Remove previous selection
    document.querySelectorAll('.account-item').forEach(item => {
        item.classList.remove('selected');
    });
    
    // Select clicked item
    event.target.classList.add('selected');
    selectedAccountFromList = accountName;
    selectedAccountId = accountId;
    
    // Also update dropdown
    document.getElementById('account-select').value = accountName;
}

function filterAccounts() {
    const searchTerm = document.getElementById('account-search').value.toLowerCase();
    const accountItems = document.querySelectorAll('.account-item');
    
    accountItems.forEach(item => {
        const accountName = item.textContent.toLowerCase();
        if (accountName.includes(searchTerm)) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
}

function authenticateFromList() {
    if (!selectedAccountFromList || !selectedAccountId) {
        alert('Please select an account from the list first');
        return;
    }
    
    // Set the dropdown to selected account and authenticate
    document.getElementById('account-select').value = selectedAccountFromList;
    
    // Call the updated authenticate function
    authenticateAccount();
}


function deleteFromList() {
    if (!selectedAccountFromList || !selectedAccountId) {
        alert('Please select an account from the list first');
        return;
    }
    
    if (!confirm(`Are you sure you want to delete account: ${selectedAccountFromList}?`)) {
        return;
    }
    
    // Delete directly using the stored account ID
    fetch('/api/delete-account', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({account_id: selectedAccountId})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ Account deleted successfully!');
            selectedAccountFromList = null;
            selectedAccountId = null;
            location.reload(); // Reload to refresh the display
        } else {
            alert('‚ùå Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Delete error:', error);
        alert('‚ùå Error: ' + error.message);
    });
}

// Bulk Delete Functions
function openBulkDeleteModal() {
    // Admin check is handled by the backend, so we can proceed directly
    // The button is only shown to admins via server-side template logic
    
    // Clear previous data
    document.getElementById('bulkDeleteAccounts').value = '';
    document.getElementById('bulkDeleteProgress').style.display = 'none';
    document.getElementById('bulkDeleteResults').style.display = 'none';
    document.getElementById('bulkDeleteExecuteBtn').disabled = false;
    
    // Show modal
    document.getElementById('bulkDeleteModal').style.display = 'block';
}

function closeBulkDeleteModal() {
    document.getElementById('bulkDeleteModal').style.display = 'none';
}

function executeBulkDelete() {
    const accountsText = document.getElementById('bulkDeleteAccounts').value.trim();
    
    if (!accountsText) {
        alert('‚ùå Please enter at least one account name to delete.');
        return;
    }
    
    // Parse account names
    const accountNames = accountsText.split('\n')
        .map(name => name.trim())
        .filter(name => name.length > 0);
    
    if (accountNames.length === 0) {
        alert('‚ùå Please enter valid account names.');
        return;
    }
    
    // Confirm deletion
    if (!confirm(`Are you sure you want to delete ${accountNames.length} accounts?\n\nThis action cannot be undone!`)) {
        return;
    }
    
    // Show progress
    document.getElementById('bulkDeleteProgress').style.display = 'block';
    document.getElementById('bulkDeleteResults').style.display = 'none';
    document.getElementById('bulkDeleteExecuteBtn').disabled = true;
    
    // Update progress
    updateBulkDeleteProgress(0, accountNames.length, 'Starting bulk deletion...');
    
    // Execute bulk delete
    fetch('/api/bulk-delete-accounts', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({account_names: accountNames})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateBulkDeleteProgress(accountNames.length, accountNames.length, 'Bulk deletion completed!');
            showBulkDeleteResults(data.results, accountNames.length);
            
            // Reload page after 3 seconds to refresh the account list
            setTimeout(() => {
                location.reload();
            }, 3000);
        } else {
            updateBulkDeleteProgress(0, accountNames.length, 'Bulk deletion failed!');
            showBulkDeleteResults([{success: false, account: 'All', error: data.error}], 0);
        }
    })
    .catch(error => {
        console.error('Bulk delete error:', error);
        updateBulkDeleteProgress(0, accountNames.length, 'Network error occurred!');
        showBulkDeleteResults([{success: false, account: 'All', error: error.message}], 0);
    })
    .finally(() => {
        document.getElementById('bulkDeleteExecuteBtn').disabled = false;
    });
}

function updateBulkDeleteProgress(completed, total, status) {
    const percentage = total > 0 ? (completed / total) * 100 : 0;
    
    document.getElementById('bulkDeleteStatus').textContent = status;
    document.getElementById('bulkDeleteCount').textContent = `${completed}/${total}`;
    document.getElementById('bulkDeleteProgressBar').style.width = percentage + '%';
}

function showBulkDeleteResults(results, totalAccounts) {
    const resultsContainer = document.getElementById('bulkDeleteResultsContent');
    let html = '';
    
    let successful = 0;
    let failed = 0;
    
    results.forEach(result => {
        if (result.success) {
            successful++;
            html += `<div style="color: #2da44e; margin-bottom: 4px;">‚úÖ ${result.account} - Deleted successfully</div>`;
        } else {
            failed++;
            html += `<div style="color: #da3633; margin-bottom: 4px;">‚ùå ${result.account} - ${result.error}</div>`;
        }
    });
    
    // Add summary
    html = `<div style="font-weight: 600; margin-bottom: 8px; color: #24292f;">
                Summary: ${successful} successful, ${failed} failed out of ${totalAccounts} total
            </div>` + html;
    
    resultsContainer.innerHTML = html;
    document.getElementById('bulkDeleteResults').style.display = 'block';
}

function refreshAccountsDisplay() {
    // Simply reload the page to refresh accounts from database
            location.reload();
}

// Admin-only manual token status check
function forceTokenStatusCheck() {
    if (confirm('üîç Force token status check for all accounts?\n\nThis will check the database for current token status.')) {
        console.log('Admin triggered manual token status check');
        
        // Update status display
        updateAccountStats(0, 0, 0, 'Admin check starting...');
        
        // Use database API instead of JSON
        checkTokenStatusFromDatabase();
    }
}

// Check token status from database (replaces JSON-based approach)
async function checkTokenStatusFromDatabase() {
    try {
        console.log('=== Starting DATABASE token status check ===');
        
        // Get token status from database API
        const response = await fetch('/api/check-token-status', {
            method: 'GET',
            headers: {'Content-Type': 'application/json'}
        });
        
        const data = await response.json();
        
        if (data.success && data.token_status) {
            console.log('Database token status received:', data.token_status);
            
            // Update visual status for each account
            let totalAccounts = data.token_status.length;
            let validAccounts = 0;
            let invalidAccounts = 0;
            
            data.token_status.forEach(accountStatus => {
                const accountName = accountStatus.account_name;
                const hasTokens = accountStatus.has_tokens;
                const tokenValid = accountStatus.token_valid;
                
                // Find the account item in the UI
                const accountItems = document.querySelectorAll('.account-item');
                accountItems.forEach(item => {
                    const itemAccountName = item.textContent.trim().split('\n')[0].trim();
                    if (itemAccountName === accountName) {
                        // Remove old status
                        const oldStatus = item.querySelector('.token-status');
                        if (oldStatus) oldStatus.remove();
                        
                        // Add new status
                        const statusSpan = document.createElement('span');
                        statusSpan.className = 'token-status';
                        statusSpan.textContent = tokenValid ? ' ‚úÖ' : ' ‚ùå';
                        statusSpan.style.cssText = 'float: right; margin-left: 10px;';
                        item.appendChild(statusSpan);
                        
                        // Update dropdown
                        updateDropdownOption(accountName, tokenValid);
                        
                        // Count accounts
                        if (tokenValid) {
                            validAccounts++;
                        } else {
                            invalidAccounts++;
                        }
                    }
                });
            });
            
            // Update stats
            updateAccountStats(totalAccounts, validAccounts, invalidAccounts, 'Database check complete');
            console.log(`‚úÖ Database check complete: ${validAccounts}/${totalAccounts} authenticated`);
            
        } else {
            console.error('Failed to get token status from database:', data.error);
            updateAccountStats(0, 0, 0, 'Database check failed');
        }
        
    } catch (error) {
        console.error('Database token status check failed:', error);
        updateAccountStats(0, 0, 0, 'Database check failed');
    }
}

function updateAccountStatusAfterAuth(accountName, isAuthenticated) {
    // Update the account in the list
    const accountItems = document.querySelectorAll('.account-item');
    
    accountItems.forEach(item => {
        const itemAccountName = item.textContent.trim().split('\n')[0].trim();
        
        if (itemAccountName === accountName) {
            // Remove old status
            const oldStatus = item.querySelector('.token-status');
            if (oldStatus) oldStatus.remove();
            
            // Add new status
            const statusSpan = document.createElement('span');
            statusSpan.className = isAuthenticated ? 'token-status valid' : 'token-status invalid';
            statusSpan.textContent = isAuthenticated ? ' ‚úÖ' : ' ‚ùå';
            statusSpan.style.cssText = 'float: right; margin-left: 10px;';
            item.appendChild(statusSpan);
            
            console.log(`Updated ${accountName} status to: ${isAuthenticated ? 'Valid' : 'Invalid'}`);
        }
    });
    
    // Update dropdown
    const option = document.querySelector(`#account-select option[value="${accountName}"]`);
    if (option) {
        option.textContent = `${accountName} ${isAuthenticated ? '‚úÖ' : '‚ùå'}`;
    }
    
    // Update counter
    updateCountersAfterChange();
}

function updateCountersAfterChange() {
    const accountItems = document.querySelectorAll('.account-item');
    let totalAccounts = accountItems.length;
    let validAccounts = 0;
    let invalidAccounts = 0;
    
    accountItems.forEach(item => {
        const statusElement = item.querySelector('.token-status');
        if (statusElement) {
            if (statusElement.textContent.includes('‚úÖ')) {
                validAccounts++;
            } else {
                invalidAccounts++;
            }
        }
    });
    
    updateAccountStats(totalAccounts, validAccounts, invalidAccounts, 'Updated');
}

function addFromServerJSON() {
    // Create a modal dialog instead of simple prompt
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    `;
    
    const dialog = document.createElement('div');
    dialog.style.cssText = `
        background: white;
        padding: 30px;
        border-radius: 10px;
        width: 600px;
        max-width: 90vw;
        max-height: 80vh;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        color: #333;
    `;
    
    dialog.innerHTML = `
        <h3 style="margin-bottom: 20px; color: #007bff;">üìÅ Add Accounts from Server JSON</h3>
        
        <p style="margin-bottom: 15px; color: #666;">
            Enter Google Workspace admin email addresses below (one per line).<br>
            The system will search for corresponding JSON credential files on the server.
        </p>
        
        <div style="margin-bottom: 15px;">
            <label style="font-weight: bold; display: block; margin-bottom: 5px;">Email Addresses:</label>
            <textarea id="emailInput" placeholder="admin@domain1.com&#10;admin@domain2.com&#10;admin@domain3.com&#10;..." 
                style="width: 100%; height: 250px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-family: monospace; resize: vertical;"></textarea>
        </div>
        
        <div style="margin-bottom: 20px; padding: 10px; background: #f8f9fa; border-radius: 5px; border-left: 4px solid #007bff;">
            <strong>üí° Tips:</strong>
            <ul style="margin: 5px 0 0 20px; color: #666;">
                <li>Enter one email address per line</li>
                <li>You can paste multiple emails at once</li>
                <li>Empty lines will be ignored</li>
                <li>Files must be named exactly: <code>&lt;email&gt;.json</code></li>
            </ul>
        </div>
        
        <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button id="cancelBtn" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">
                ‚ùå Cancel
            </button>
            <button id="searchBtn" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;" disabled>
                üîç Search & Add Accounts
            </button>
        </div>
    `;
    
    modal.appendChild(dialog);
    document.body.appendChild(modal);
    
    // Get elements
    const emailInput = dialog.querySelector('#emailInput');
    const searchBtn = dialog.querySelector('#searchBtn');
    const cancelBtn = dialog.querySelector('#cancelBtn');
    
    // Update button state as user types
    function updateButtonState() {
        const text = emailInput.value.trim();
        if (!text) {
            searchBtn.disabled = true;
            return;
        }
        
        const emails = text.split('\n')
            .map(email => email.trim())
            .filter(email => email && email.includes('@'));
        
        searchBtn.disabled = emails.length === 0;
    }
    
    // Add event listeners
    emailInput.addEventListener('input', updateButtonState);
    emailInput.addEventListener('paste', () => setTimeout(updateButtonState, 10));
    
    cancelBtn.addEventListener('click', () => {
        document.body.removeChild(modal);
    });
    
    searchBtn.addEventListener('click', () => {
        const emails = emailInput.value.trim()
            .split('\n')
            .map(email => email.trim())
            .filter(email => email && email.includes('@'));
        
        if (emails.length === 0) {
            alert('No valid email addresses found');
            return;
        }
        
        // Close modal
        document.body.removeChild(modal);
        
        // Show confirmation
        if (!confirm(`Search for JSON credential files for ${emails.length} email address(es)?`)) {
            return;
        }
        
        // Process the search using server configuration
        processServerJSONSearch(emails);
    });
    
    // Close modal when clicking outside
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            document.body.removeChild(modal);
        }
    });
    
    // Focus on textarea
    setTimeout(() => emailInput.focus(), 100);
}

// Separate function to handle the actual API call using server configuration
function processServerJSONSearch(emails) {
    // Show loading in some button (you can modify this)
    const button = document.querySelector('[onclick="addFromServerJSON()"]');
    const originalText = button.textContent;
    button.textContent = 'üîç Searching...';
    button.disabled = true;
    
    // Make API request using server configuration
    fetch('/api/add-from-server-json', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({emails: emails})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let message = data.message + '\n\n';
            
            if (data.added_accounts && data.added_accounts.length > 0) {
                message += `‚úÖ Successfully added:\n${data.added_accounts.join('\n')}\n\n`;
            }
            
            if (data.failed_accounts && data.failed_accounts.length > 0) {
                message += `‚ùå Failed accounts:\n`;
                for (const failed of data.failed_accounts) {
                    message += `${failed.email}: ${failed.error}\n`;
                }
            }
            
            alert(message);
            
            // Refresh the account list if any were added
            if (data.added_accounts && data.added_accounts.length > 0) {
                refreshAccountsDisplay();
            }
        } else {
            alert('‚ùå Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Network error:', error);
        alert('‚ùå Network error: ' + error.message);
    })
    .finally(() => {
        // Restore button state
        button.textContent = originalText;
        button.disabled = false;
    });
}

function debugSFTPFiles() {
    fetch('/api/debug-sftp-files', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let message = "SFTP Directory Contents:\n\n";
            
            if (data.directories.shared_credentials) {
                if (data.directories.shared_credentials.error) {
                    message += `‚ùå shared_credentials: ${data.directories.shared_credentials.error}\n\n`;
                } else {
                    message += `üìÅ shared_credentials (${data.directories.shared_credentials.total_count} files):\n`;
                    message += data.directories.shared_credentials.files.join('\n') + '\n\n';
                }
            }
            
            if (data.directories.account) {
                if (data.directories.account.error) {
                    message += `‚ùå account: ${data.directories.account.error}\n\n`;
                } else {
                    message += `üìÅ account (${data.directories.account.total_count} files):\n`;
                    message += data.directories.account.files.join('\n');
                }
            }
            
            alert(message);
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('Network error: ' + error);
    });
}

// Placeholder functions for buttons that need implementation

function backupFiles() {
    alert('Backup Files feature coming soon!');
}

// Update the existing refreshAccounts function
function refreshAccounts() {
    refreshAccountsDisplay();
}

// Tab 2 Functions

function createUsersFromCSV() {
    const fileInput = document.getElementById('csv-file-input');
    if (!fileInput.files.length) {
        alert('Please select a CSV file first');
        return;
    }
    
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    logResult('üì• Starting CSV user creation...');
    
    const formData = new FormData();
    formData.append('csv_file', fileInput.files[0]);
    
    fetch('/api/create-users-from-csv', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            logResult(`‚úÖ CSV processing completed. Created ${data.created_count} users.`);
            if (data.results) {
                data.results.forEach(result => {
                    if (result.success) {
                        logResult(`‚úÖ Created: ${result.email}`);
                    } else {
                        logResult(`‚ùå Failed: ${result.email} - ${result.error}`);
                    }
                });
            }
        } else {
            logResult(`‚ùå CSV creation failed: ${data.error}`);
        }
    })
    .catch(error => {
        logResult(`‚ùå Network error: ${error}`);
    });
}

function createRandomUsers() {
    const count = document.getElementById('random-user-count').value;
    const domain = document.getElementById('random-user-domain').value;
    const password = document.getElementById('random-user-password').value;
    
    if (!count || count <= 0) {
        alert('Please enter a valid number of users');
        return;
    }
    
    if (!domain || !domain.includes('.')) {
        alert('Please enter a valid domain');
        return;
    }
    
    if (!password || password.length < 8) {
        alert('Please enter a password (minimum 8 characters)');
        return;
    }
    
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    logResult(`üé≤ Creating ${count} random users for ${domain} with password...`);
    
    fetch('/api/create-random-users', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            num_users: parseInt(count),
            domain: domain,
            password: password
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            logResult(`‚úÖ Random user creation completed. Password: ${data.password}`);
            if (data.results) {
                let successCount = 0;
                let failureCount = 0;
                
                data.results.forEach(result => {
                    if (result.result.success) {
                        logResult(`‚úÖ Created: ${result.email}`);
                        successCount++;
                    } else {
                        // Handle different error types for random users
                        if (result.result.error_type === 'domain_limit') {
                            logResult(`üö´ DOMAIN LIMIT: ${result.email} - ${result.result.error}`);
                            logResult(`üí° Solution: Upgrade to paid Google Workspace subscription`);
                        } else if (result.result.error_type === 'duplicate_user') {
                            logResult(`üë§ DUPLICATE: ${result.email} - ${result.result.error}`);
                            logResult(`üí° Solution: User already exists, skipping`);
                        } else {
                            logResult(`‚ùå Failed: ${result.email} - ${result.result.error}`);
                        }
                        failureCount++;
                    }
                });
                
                logResult(`üìä Summary: ${successCount} successful, ${failureCount} failed`);
                
                if (failureCount > 0) {
                    logResult(`üí° Note: Some users failed due to domain limits or duplicates`);
                }
            }
        } else {
            // Handle overall failure
            if (data.error_type === 'domain_limit') {
                logResult(`üö´ DOMAIN LIMIT REACHED: ${data.error}`);
                logResult(`üí° Solution: Upgrade to a paid Google Workspace subscription`);
                logResult(`üìä Target domain: ${domain}`);
            } else {
                logResult(`‚ùå Random user creation failed: ${data.error}`);
            }
        }
    })
    .catch(error => {
        logResult(`‚ùå Network error: ${error.message}`);
        logResult(`üí° Solution: Check your internet connection and try again`);
    });
}

function createRandomAdminUsers() {
    const count = document.getElementById('random-admin-count').value;
    const domain = document.getElementById('random-admin-domain').value;
    const password = document.getElementById('random-admin-password').value;
    const adminRole = document.getElementById('admin-role').value;
    
    if (!count || count <= 0) {
        alert('Please enter a valid number of admin users');
        return;
    }
    
    if (!domain || !domain.includes('.')) {
        alert('Please enter a valid domain');
        return;
    }
    
    if (!password || password.length < 8) {
        alert('Please enter a password (minimum 8 characters)');
        return;
    }
    
    if (!adminRole) {
        alert('Please select an admin role');
        return;
    }
    
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    // Confirm admin creation due to elevated permissions
    if (!confirm(`‚ö†Ô∏è WARNING: You are about to create ${count} admin users with ${adminRole} permissions.\n\nThis will give them elevated access to your Google Workspace.\n\nAre you sure you want to continue?`)) {
        return;
    }
    
    logResult(`üëë Creating ${count} random admin users for ${domain} with ${adminRole} permissions...`);
    
    fetch('/api/create-random-admin-users', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            num_users: parseInt(count),
            domain: domain,
            password: password,
            admin_role: adminRole
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            logResult(`‚úÖ Random admin user creation completed. Password: ${data.password}`);
            if (data.results) {
                let successCount = 0;
                let failureCount = 0;
                
                data.results.forEach(result => {
                    if (result.result.success) {
                        logResult(`‚úÖ Created Admin: ${result.email} (${result.admin_role})`);
                        logResult(`üìù Note: ${result.result.message}`);
                        successCount++;
                    } else {
                        if (result.result.error_type === 'domain_limit') {
                            logResult(`üö´ DOMAIN LIMIT: ${result.email} - ${result.result.error}`);
                            logResult(`üí° Solution: Upgrade to paid Google Workspace subscription`);
                        } else if (result.result.error_type === 'duplicate_user') {
                            logResult(`üë§ DUPLICATE: ${result.email} - ${result.result.error}`);
                            logResult(`üí° Solution: User already exists, skipping`);
                        } else if (result.result.error_type === 'admin_permission_error') {
                            logResult(`üîí ADMIN PERMISSION ERROR: ${result.email} - ${result.result.error}`);
                            logResult(`üí° Solution: Check if you have permission to assign admin roles`);
                        } else {
                            logResult(`‚ùå Failed: ${result.email} - ${result.result.error}`);
                        }
                        failureCount++;
                    }
                });
                
                logResult(`üìä Summary: ${successCount} admin users created, ${failureCount} failed`);
                
                if (successCount > 0) {
                    logResult(`‚ö†Ô∏è IMPORTANT: Admin users have been created with elevated permissions!`);
                    logResult(`üîê Please ensure these accounts are properly secured and monitored.`);
                }
                
                if (failureCount > 0) {
                    logResult(`üí° Note: Some admin users failed due to domain limits, duplicates, or permission issues`);
                }
            }
        } else {
            if (data.error_type === 'domain_limit') {
                logResult(`üö´ DOMAIN LIMIT REACHED: ${data.error}`);
                logResult(`üí° Solution: Upgrade to a paid Google Workspace subscription`);
            } else if (data.error_type === 'admin_permission_error') {
                logResult(`üîí ADMIN PERMISSION ERROR: ${data.error}`);
                logResult(`üí° Solution: Ensure you have permission to create admin users`);
            } else {
                logResult(`‚ùå Random admin user creation failed: ${data.error}`);
            }
        }
    })
    .catch(error => {
        logResult(`‚ùå Network error: ${error.message}`);
        logResult(`üí° Solution: Check your internet connection and try again`);
    });
}

function updateUserPasswords() {
    const usersText = document.getElementById('password-update-users').value;
    const newPassword = document.getElementById('password-update-new-password').value;
    
    if (!usersText.trim()) {
        alert('Please enter user email addresses');
        return;
    }
    
    if (!newPassword || newPassword.length < 8) {
        alert('Please enter a password (minimum 8 characters)');
        return;
    }
    
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    // Parse users from textarea (one per line)
    const users = usersText.split('\n')
        .map(line => line.trim())
        .filter(line => line.length > 0);
    
    if (users.length === 0) {
        alert('Please enter at least one valid email address');
        return;
    }
    
    logResult(`üîë Updating passwords for ${users.length} users...`);
    
    fetch('/api/update-user-passwords', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            users: users,
            new_password: newPassword
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            logResult(`‚úÖ Password update completed!`);
            if (data.results) {
                let successCount = 0;
                let failureCount = 0;
                
                data.results.forEach(result => {
                    if (result.success) {
                        logResult(`‚úÖ Updated: ${result.email}`);
                        successCount++;
                    } else {
                        logResult(`‚ùå Failed: ${result.email} - ${result.error}`);
                        failureCount++;
                    }
                });
                
                logResult(`üìä Summary: ${successCount} successful, ${failureCount} failed`);
            }
        } else {
            logResult(`‚ùå Password update failed: ${data.error}`);
        }
    })
    .catch(error => {
        logResult(`‚ùå Network error: ${error.message}`);
        logResult(`üí° Solution: Check your internet connection and try again`);
    });
}

// User Suspension Functions
function suspendUser() {
    const email = document.getElementById('suspend-user-email').value.trim();
    
    if (!email) {
        alert('Please enter an email address');
        return;
    }
    
    if (!email.includes('@')) {
        alert('Please enter a valid email address');
        return;
    }
    
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    if (!confirm(`‚ö†Ô∏è Are you sure you want to suspend user: ${email}?\n\nThis will prevent them from accessing their account.`)) {
        return;
    }
    
    logResult(`üö´ Suspending user: ${email}...`);
    
    fetch('/api/suspend-user', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ email: email })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            logResult(`‚úÖ ${data.message}`);
            document.getElementById('suspend-user-email').value = '';
        } else {
            logResult(`‚ùå Failed to suspend user: ${data.error}`);
        }
    })
    .catch(error => {
        logResult(`‚ùå Network error: ${error.message}`);
    });
}

function unsuspendUser() {
    const email = document.getElementById('unsuspend-user-email').value.trim();
    
    if (!email) {
        alert('Please enter an email address');
        return;
    }
    
    if (!email.includes('@')) {
        alert('Please enter a valid email address');
        return;
    }
    
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    if (!confirm(`‚úÖ Are you sure you want to unsuspend user: ${email}?\n\nThis will restore their account access.`)) {
        return;
    }
    
    logResult(`‚úÖ Unsuspending user: ${email}...`);
    
    fetch('/api/unsuspend-user', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ email: email })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            logResult(`‚úÖ ${data.message}`);
            document.getElementById('unsuspend-user-email').value = '';
        } else {
            logResult(`‚ùå Failed to unsuspend user: ${data.error}`);
        }
    })
    .catch(error => {
        logResult(`‚ùå Network error: ${error.message}`);
    });
}


function loadSuspendedUsers() {
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    logResult('üîç Loading suspended users...');
    
    fetch('/api/get-suspended-users')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displaySuspendedUsers(data.suspended_users);
            document.getElementById('suspended-count').textContent = `Suspended Users: ${data.total_count}`;
            logResult(`‚úÖ Loaded ${data.total_count} suspended users`);
        } else {
            logResult(`‚ùå Failed to load suspended users: ${data.error}`);
            document.getElementById('suspended-display').innerHTML = `<div class="error-message">‚ùå Error: ${data.error}</div>`;
        }
    })
    .catch(error => {
        logResult(`‚ùå Network error: ${error.message}`);
        document.getElementById('suspended-display').innerHTML = `<div class="error-message">‚ùå Network error: ${error.message}</div>`;
    });
}

function displaySuspendedUsers(users) {
    if (!users || users.length === 0) {
        document.getElementById('suspended-display').innerHTML = '<div class="status-info"><p>‚úÖ No suspended users found</p></div>';
        return;
    }
    
    let html = '<div class="suspended-users-list">';
    html += '<h4 style="margin-bottom: 16px; color: #d73a49;">üö´ Suspended Users</h4>';
    
    users.forEach(user => {
        const adminBadge = user.isAdmin ? '<span class="badge admin">üëë Admin</span>' : '';
        const lastLogin = user.lastLoginTime === 'Never' ? 'Never' : new Date(user.lastLoginTime).toLocaleDateString();
        
        // Standard suspended user styling
        const cardStyle = 'border: 1px solid #d73a49; background: #ffeaea;';
        const statusColor = '#d73a49';
        const statusIcon = 'üö´';
        
        html += `
            <div class="suspended-user-item" style="${cardStyle} border-radius: 6px; padding: 12px; margin-bottom: 8px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>${user.name || user.firstName + ' ' + user.lastName}</strong>
                        <div style="color: #666; font-size: 14px;">${user.email}</div>
                        <div style="color: ${statusColor}; font-size: 12px; margin-top: 4px;">
                            ${statusIcon} Suspended | Last Login: ${lastLogin}
                        </div>
                        <div style="color: #666; font-size: 12px; margin-top: 2px;">
                            Reason: ${user.suspensionReason}
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        ${adminBadge}
                        <button onclick="unsuspendUserFromList('${user.email}')" class="btn-github btn-github-success" style="font-size: 12px; padding: 4px 8px;">
                            <i class="fas fa-user-check"></i> Unsuspend
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    document.getElementById('suspended-display').innerHTML = html;
}

function unsuspendUserFromList(email) {
    if (!confirm(`‚úÖ Are you sure you want to unsuspend user: ${email}?`)) {
        return;
    }
    
    logResult(`‚úÖ Unsuspending user: ${email}...`);
    
    fetch('/api/unsuspend-user', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ email: email })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            logResult(`‚úÖ ${data.message}`);
            // Refresh the suspended users list
            loadSuspendedUsers();
        } else {
            logResult(`‚ùå Failed to unsuspend user: ${data.error}`);
        }
    })
    .catch(error => {
        logResult(`‚ùå Network error: ${error.message}`);
    });
}



function bulkSuspendUsers() {
    const emailsText = document.getElementById('bulk-suspend-emails').value.trim();
    
    if (!emailsText) {
        alert('Please enter email addresses');
        return;
    }
    
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    const emails = emailsText.split('\n')
        .map(line => line.trim())
        .filter(line => line.length > 0 && line.includes('@'));
    
    if (emails.length === 0) {
        alert('Please enter valid email addresses');
        return;
    }
    
    if (!confirm(`‚ö†Ô∏è Are you sure you want to suspend ${emails.length} users?\n\nThis will prevent them from accessing their accounts.`)) {
        return;
    }
    
    logResult(`üö´ Suspending ${emails.length} users...`);
    
    let successCount = 0;
    let failureCount = 0;
    
    const suspendPromises = emails.map(email => 
        fetch('/api/suspend-user', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ email: email })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                successCount++;
                logResult(`‚úÖ Suspended: ${email}`);
            } else {
                failureCount++;
                logResult(`‚ùå Failed: ${email} - ${data.error}`);
            }
        })
        .catch(error => {
            failureCount++;
            logResult(`‚ùå Error: ${email} - ${error.message}`);
        })
    );
    
    Promise.all(suspendPromises).then(() => {
        logResult(`üìä Bulk suspension completed: ${successCount} successful, ${failureCount} failed`);
        document.getElementById('bulk-suspend-emails').value = '';
    });
}

function bulkUnsuspendUsers() {
    const emailsText = document.getElementById('bulk-unsuspend-emails').value.trim();
    
    if (!emailsText) {
        alert('Please enter email addresses');
        return;
    }
    
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    const emails = emailsText.split('\n')
        .map(line => line.trim())
        .filter(line => line.length > 0 && line.includes('@'));
    
    if (emails.length === 0) {
        alert('Please enter valid email addresses');
        return;
    }
    
    if (!confirm(`‚úÖ Are you sure you want to unsuspend ${emails.length} users?\n\nThis will restore their account access.`)) {
        return;
    }
    
    logResult(`‚úÖ Unsuspending ${emails.length} users...`);
    
    let successCount = 0;
    let failureCount = 0;
    
    const unsuspendPromises = emails.map(email => 
        fetch('/api/unsuspend-user', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ email: email })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                successCount++;
                logResult(`‚úÖ Unsuspended: ${email}`);
            } else {
                failureCount++;
                logResult(`‚ùå Failed: ${email} - ${data.error}`);
            }
        })
        .catch(error => {
            failureCount++;
            logResult(`‚ùå Error: ${email} - ${error.message}`);
        })
    );
    
    Promise.all(unsuspendPromises).then(() => {
        logResult(`üìä Bulk unsuspension completed: ${successCount} successful, ${failureCount} failed`);
        document.getElementById('bulk-unsuspend-emails').value = '';
        // Refresh the suspended users list
        loadSuspendedUsers();
    });
}

function copySuspendedUsers() {
    const display = document.getElementById('suspended-display');
    const userItems = display.querySelectorAll('.suspended-user-item');
    
    if (userItems.length === 0) {
        alert('No suspended users to copy');
        return;
    }
    
    let emails = [];
    userItems.forEach(item => {
        const emailElement = item.querySelector('div[style*="color: #666"]');
        if (emailElement) {
            emails.push(emailElement.textContent.trim());
        }
    });
    
    if (emails.length > 0) {
        navigator.clipboard.writeText(emails.join('\n')).then(() => {
            logResult(`üìã Copied ${emails.length} suspended user emails to clipboard`);
        }).catch(() => {
            alert('Failed to copy to clipboard');
        });
    }
}

function refreshSuspendedUsers() {
    loadSuspendedUsers();
}

function clearSuspendedUsers() {
    document.getElementById('suspended-display').innerHTML = `
        <div class="status-info">
            <p><strong><i class="fas fa-user-slash"></i> Suspended User Management</strong></p>
            <p>Click "Load Suspended Users" to check for suspended accounts in your Google Workspace.</p>
            <p><small>This will show all users with suspended status, including their names, emails, and admin privileges.</small></p>
        </div>
    `;
    document.getElementById('suspended-count').textContent = 'Suspended Users: 0';
}

function changeDomainForUsers() {
    const oldDomain = document.getElementById('old-domain').value;
    const newDomain = document.getElementById('new-domain').value;
    const emailsText = document.getElementById('domain-change-emails').value;
    
    if (!oldDomain || !newDomain) {
        alert('Please enter both old and new domains');
        return;
    }
    
    if (!emailsText.trim()) {
        alert('Please enter email addresses');
        return;
    }
    
    const emails = emailsText.split('\n').map(e => e.trim()).filter(e => e);
    
    if (emails.length === 0) {
        alert('No valid email addresses found');
        return;
    }
    
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    logResult(`üîÑ Changing domain from ${oldDomain} to ${newDomain} for ${emails.length} users...`);
    
    fetch('/api/change-domain', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            old_domain: oldDomain,
            new_domain: newDomain,
            user_emails: emails
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            logResult(`‚úÖ Domain change completed for ${emails.length} users.`);
            if (data.results) {
                data.results.forEach(result => {
                    if (result.success) {
                        logResult(`‚úÖ Changed: ${result.old_email} ‚Üí ${result.new_email}`);
                    } else {
                        logResult(`‚ùå Failed: ${result.email} - ${result.error}`);
                    }
                });
            }
        } else {
            logResult(`‚ùå Domain change failed: ${data.error}`);
        }
    })
    .catch(error => {
        logResult(`‚ùå Network error: ${error}`);
    });
}

function deleteSpecificUsers() {
    const emailsText = document.getElementById('delete-user-emails').value;
    
    if (!emailsText.trim()) {
        alert('Please enter email addresses to delete');
        return;
    }
    
    const emails = emailsText.split('\n').map(e => e.trim()).filter(e => e);
    
    if (emails.length === 0) {
        alert('No valid email addresses found');
        return;
    }
    
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    if (!confirm(`‚ö†Ô∏è Are you sure you want to DELETE ${emails.length} users? This cannot be undone!`)) {
        return;
    }
    
    logResult(`‚ùå Deleting ${emails.length} users...`);
    
    fetch('/api/delete-users', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            user_emails: emails
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            logResult(`‚úÖ User deletion completed for ${emails.length} users.`);
            if (data.results) {
                data.results.forEach(result => {
                    if (result.result.success) {
                        logResult(`‚úÖ Deleted: ${result.email}`);
                    } else {
                        logResult(`‚ùå Failed to delete: ${result.email} - ${result.result.error}`);
                    }
                });
            }
        } else {
            logResult(`‚ùå User deletion failed: ${data.error}`);
        }
    })
    .catch(error => {
        console.error('Delete users error:', error);
        logResult(`‚ùå Network error: ${error.message || error}`);
    });
}

function createSingleUser() {
    const firstName = document.getElementById('new-user-first-name').value;
    const lastName = document.getElementById('new-user-last-name').value;
    const email = document.getElementById('new-user-email').value;
    const password = document.getElementById('new-user-password').value;

    if (!firstName || !lastName || !email || !password) {
        alert('Please fill in all fields for the new user.');
        return;
    }

    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }

    logResult(`‚ûï Creating user: ${email}...`);

    fetch('/api/create-gsuite-user', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            first_name: firstName,
            last_name: lastName,
            email: email,
            password: password
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            logResult(`‚úÖ User ${email} created successfully.`);
            // Clear the form after successful creation
            document.getElementById('new-user-first-name').value = '';
            document.getElementById('new-user-last-name').value = '';
            document.getElementById('new-user-email').value = '';
            document.getElementById('new-user-password').value = '';
        } else {
            // Handle different error types with specific messages
            if (data.error_type === 'domain_limit') {
                logResult(`üö´ DOMAIN LIMIT REACHED: ${data.error}`);
                logResult(`üí° Solution: Upgrade to a paid Google Workspace subscription`);
                logResult(`üìä Current domain: ${email.split('@')[1]}`);
            } else if (data.error_type === 'auth_error') {
                logResult(`üîê AUTHENTICATION ERROR: ${data.error}`);
                logResult(`üí° Solution: Please re-authenticate your account`);
            } else if (data.error_type === 'duplicate_user') {
                logResult(`üë§ DUPLICATE USER: ${data.error}`);
                logResult(`üí° Solution: Use a different email address`);
            } else if (data.error_type === 'invalid_domain') {
                logResult(`üåê INVALID DOMAIN: ${data.error}`);
                logResult(`üí° Solution: Check the domain name and try again`);
            } else {
                logResult(`‚ùå Failed to create user ${email}: ${data.error}`);
            }
            
            // Show raw error for debugging if available
            if (data.raw_error) {
                logResult(`üîç Technical details: ${data.raw_error}`);
            }
        }
    })
    .catch(error => {
        logResult(`‚ùå Network error: ${error.message}`);
        logResult(`üí° Solution: Check your internet connection and try again`);
    });
}

function getDomainInfo() {
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }

    logResult('üîç Retrieving domain info...');
    const display = document.getElementById('domain-info-display');
    display.innerHTML = '<p>Loading domains...</p>';

    fetch('/api/get-domain-info')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let html = '';
            if (data.domains.length > 0) {
                data.domains.forEach(domain => {
                    html += `<div class="domain-item">
                        <span>${domain.domainName}</span>
                        <button class="delete-button" onclick="deleteDomain('${domain.domainName}')">Delete</button>
                    </div>`;
                });
            } else {
                html = '<p>No domains found.</p>';
            }
            display.innerHTML = html;
            logResult(`‚úÖ Domain info retrieved successfully.`);
        } else {
            display.innerHTML = `<p style="color: red;">Error: ${data.error}</p>`;
            logResult(`‚ùå Failed to retrieve domain info: ${data.error}`);
        }
    })
    .catch(error => {
        display.innerHTML = `<p style="color: red;">Network error: ${error}</p>`;
        logResult(`‚ùå Network error: ${error}`);
    });
}

function addDomainAlias() {
    const domainAlias = document.getElementById('new-domain-alias').value;

    if (!domainAlias) {
        alert('Please enter a domain alias.');
        return;
    }

    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }

    logResult(`‚ûï Adding domain alias: ${domainAlias}...`);

    fetch('/api/add-domain-alias', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ domain_alias: domainAlias })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            logResult(`‚úÖ Domain alias ${domainAlias} added successfully.`);
            getDomainInfo(); // Refresh the domain list
        } else {
            logResult(`‚ùå Failed to add domain alias ${domainAlias}: ${data.error}`);
        }
    })
    .catch(error => {
        logResult(`‚ùå Network error: ${error}`);
    });
}

function deleteDomain(domainName) {
    if (!confirm(`Are you sure you want to delete the domain: ${domainName}?`)) {
        return;
    }

    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }

    logResult(`‚ùå Deleting domain: ${domainName}...`);

    fetch('/api/delete-domain', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ domain_name: domainName })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            logResult(`‚úÖ Domain ${domainName} deleted successfully.`);
            getDomainInfo(); // Refresh the domain list
        } else {
            logResult(`‚ùå Failed to delete domain ${domainName}: ${data.error}`);
        }
    })
    .catch(error => {
        logResult(`‚ùå Network error: ${error}`);
    });
}


// App Password Management Functions
function uploadAppPasswords() {
    const fileInput = document.getElementById('app-password-file');
    const file = fileInput.files[0];
    
    if (!file) {
        alert('Please select a .txt file to upload');
        return;
    }
    
    if (!file.name.endsWith('.txt')) {
        alert('Please select a .txt file');
        return;
    }
    
    const formData = new FormData();
    formData.append('file', file);
    
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
    button.disabled = true;
    
    fetch('/api/upload-app-passwords', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            logBulkDomain(`‚úÖ ${data.message}`);
            if (data.errors && data.errors.length > 0) {
                logBulkDomain(`‚ö†Ô∏è Errors encountered:`);
                data.errors.forEach(error => {
                    logBulkDomain(`   ${error}`);
                });
            }
            alert(`‚úÖ Upload completed!\n\n${data.message}`);
        } else {
            logBulkDomain(`‚ùå Upload failed: ${data.error}`);
            alert(`‚ùå Upload failed: ${data.error}`);
        }
    })
    .catch(error => {
        logBulkDomain(`‚ùå Network error: ${error}`);
        alert(`‚ùå Network error: ${error.message}`);
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
        fileInput.value = ''; // Clear file input
    });
}

function retrieveAppPasswords() {
    const domain = document.getElementById('retrieve-domain').value.trim();
    
    if (!domain) {
        alert('Please enter a domain');
        return;
    }
    
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Retrieving...';
    button.disabled = true;
    
    fetch('/api/retrieve-app-passwords', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ domain: domain })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const display = document.getElementById('app-passwords-display');
            if (data.app_passwords.length > 0) {
                display.value = data.app_passwords.join('\n');
                logBulkDomain(`‚úÖ ${data.message}`);
                logBulkDomain(`üîÑ Domain updated: All usernames now use ${domain}`);
                logBulkDomain(`üìß SMTP format: user@domain,app_password,smtp.gmail.com,587`);
                if (data.optimization) {
                    logBulkDomain(`‚ö° Optimization: ${data.optimization}`);
                }
            } else {
                display.value = `No app passwords found for domain: ${domain}`;
                logBulkDomain(`‚ÑπÔ∏è No app passwords found for domain ${domain}`);
            }
        } else {
            logBulkDomain(`‚ùå Retrieve failed: ${data.error}`);
            alert(`‚ùå Retrieve failed: ${data.error}`);
        }
    })
    .catch(error => {
        logBulkDomain(`‚ùå Network error: ${error}`);
        alert(`‚ùå Network error: ${error.message}`);
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

function copyAppPasswords() {
    const display = document.getElementById('app-passwords-display');
    
    if (!display.value.trim()) {
        alert('No app passwords to copy');
        return;
    }
    
    display.select();
    document.execCommand('copy');
    
    // Show feedback
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-check"></i> Copied!';
    button.style.backgroundColor = '#2da44e';
    
    setTimeout(() => {
        button.innerHTML = originalText;
        button.style.backgroundColor = '';
    }, 2000);
    
    logBulkDomain('üìã SMTP configuration copied to clipboard');
}

function clearAppPasswordsDisplay() {
    const display = document.getElementById('app-passwords-display');
    display.value = '';
    logBulkDomain('üßπ SMTP configuration display cleared');
}

function deleteAllAppPasswords() {
    // Double confirmation for admin-only permanent deletion
    const confirm1 = confirm('‚ö†Ô∏è ADMIN ONLY: This will PERMANENTLY DELETE ALL app passwords from the database!\n\nThis action cannot be undone!\n\nAre you sure you want to continue?');
    
    if (!confirm1) {
        return;
    }
    
    const confirm2 = confirm('üö® FINAL CONFIRMATION üö®\n\nYou are about to PERMANENTLY DELETE ALL app passwords!\n\nType "DELETE ALL" in the next prompt to confirm.');
    
    if (!confirm2) {
        return;
    }
    
    const finalConfirm = prompt('Type "DELETE ALL" to permanently delete all app passwords:');
    
    if (finalConfirm !== 'DELETE ALL') {
        alert('‚ùå Deletion cancelled. You must type "DELETE ALL" exactly.');
        return;
    }
    
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
    button.disabled = true;
    
    fetch('/api/delete-all-app-passwords', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Clear the display
            document.getElementById('app-passwords-display').value = '';
            logBulkDomain(`üóëÔ∏è ${data.message}`);
            alert(`‚úÖ ${data.message}`);
        } else {
            logBulkDomain(`‚ùå Delete failed: ${data.error}`);
            alert(`‚ùå Delete failed: ${data.error}`);
        }
    })
    .catch(error => {
        logBulkDomain(`‚ùå Network error: ${error}`);
        alert(`‚ùå Network error: ${error.message}`);
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

// Tab 3 Functions - Bulk Domain Change (Desktop App Style)


function downloadAllUsersCSV() {
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    logBulkDomain('üì• Starting download of all users to CSV...');
    
    fetch('/api/download-users-csv', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.csv_data) {
            // Create download
            const blob = new Blob([data.csv_data], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `all_users_${new Date().toISOString().slice(0,10)}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            // Update path display
            document.getElementById('csv-file-path').value = a.download;
            
            logBulkDomain(`‚úÖ Downloaded ${data.user_count} users to CSV: ${a.download}`);
        } else {
            logBulkDomain(`‚ùå Download failed: ${data.error}`);
            alert('Download failed: ' + data.error);
        }
    })
    .catch(error => {
        logBulkDomain(`‚ùå Network error: ${error}`);
        alert('Network error: ' + error);
    });
}

function retrieveAvailableDomains() {
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    logBulkDomain('üîç Retrieving available domains...');
    
    // Show loading state
    const domainList = document.getElementById('available-domains');
    domainList.innerHTML = '<div class="domain-loading">Retrieving domains from Google API... (This may take a moment for large domain lists)</div>';
    
    // Batched retrieval to avoid timeouts with large domain lists
    const allDomains = [];
    let nextToken = null;
    let batches = 0;

    const fetchBatch = async () => {
        const payload = { mode: 'batched' };
        if (nextToken) payload.page_token = nextToken;
        
        const resp = await fetch('/api/retrieve-domains', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        
        const text = await resp.text();
        let data;
        try { data = JSON.parse(text); } catch(e) { throw new Error('SERVER_HTML:' + text.slice(0,200)); }
        
        if (!data.success) throw new Error(data.error || 'Unknown error');
        
        allDomains.push(...data.domains);
        nextToken = data.next_page_token || null;
        batches += 1;
        
        if (nextToken) {
            await new Promise(r => setTimeout(r, 200));
            return fetchBatch();
        }
        
        return allDomains;
    };

    fetchBatch().then(domains => {
        if (domains && domains.length > 0) {
            // First display domains with basic info (no user counts to avoid timeout)
            displayAvailableDomains(domains);
            logBulkDomain(`‚úÖ Retrieved ${domains.length} domains (calculating user counts...)`);
            
            // Then calculate user counts separately to avoid timeout
            calculateUserCounts(domains);
        } else {
            logBulkDomain(`‚ùå No domains found`);
            domainList.innerHTML = `<div class="domain-error">‚ùå No domains found</div>`;
        }
    })
    .catch(error => {
        if (error.message && error.message.startsWith('SERVER_HTML:')) {
            const snippet = error.message.replace('SERVER_HTML:', '');
            logBulkDomain(`‚ùå Server Error: HTML error page returned`);
            domainList.innerHTML = `<div class="domain-error">‚ùå Server Error: HTML error page returned<pre style="white-space: pre-wrap; max-height: 160px; overflow:auto; background:#fff; padding:8px; border:1px solid #eee;">${snippet}</pre></div>`;
        } else {
            logBulkDomain(`‚ùå Network error: ${error}`);
            domainList.innerHTML = `<div class="domain-error">‚ùå Network error: ${error}</div>`;
        }
    });
}

function getDomainUsageStats() {
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    logBulkDomain('üìä Retrieving domain usage statistics for current account...');
    
    // Show loading state
    const domainList = document.getElementById('available-domains');
    domainList.innerHTML = '<div class="domain-loading">Retrieving domain usage statistics for current account...</div>';
    
    // First get fresh domain data from the authenticated account
    fetch('/api/retrieve-domains', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.domains) {
            // Display the domain data with new three-state system
            const inUseDomains = data.domains.filter(d => d.status === 'in_use').length;
            const usedDomains = data.domains.filter(d => d.status === 'used').length;
            const availableDomains = data.domains.filter(d => d.status === 'available').length;
            
            displayDomainUsageStats({
                total_domains: data.domains.length,
                in_use_domains: inUseDomains,
                used_domains: usedDomains,
                available_domains: availableDomains,
                total_users: data.domains.reduce((sum, d) => sum + (d.user_count || 0), 0),
                domains: data.domains.map(d => ({
                    domain_name: d.domain_name,
                    user_count: d.user_count || 0,
                    is_verified: d.verified || false,
                    is_used: d.is_used || false,
                    status: d.status || 'available',
                    status_text: d.status_text || 'AVAILABLE',
                    status_color: d.status_color || 'green',
                    ever_used: d.ever_used || false,
                    last_updated: new Date().toISOString()
                }))
            });
            logBulkDomain(`‚úÖ Retrieved domain usage statistics for current account`);
        } else {
            logBulkDomain(`‚ùå Failed to retrieve domain stats: ${data.error}`);
            domainList.innerHTML = `<div class="domain-error">‚ùå Failed to retrieve domain stats: ${data.error}</div>`;
            alert('Failed to retrieve domain stats: ' + data.error);
        }
    })
    .catch(error => {
        logBulkDomain(`‚ùå Network error: ${error}`);
        domainList.innerHTML = `<div class="domain-error">‚ùå Network error: ${error}</div>`;
        alert('Network error: ' + error);
    });
}



function calculateUserCounts(domains) {
    // Calculate user counts for domains separately to avoid timeout
    if (!domains || domains.length === 0) return;
    
    // Extract domain names
    const domainNames = domains.map(d => d.domain_name || d.domainName).filter(name => name);
    
    if (domainNames.length === 0) return;
    
    logBulkDomain(`üîç Calculating user counts for ${domainNames.length} domains...`);
    
    // Show loading indicator
    const domainList = document.getElementById('available-domains');
    const loadingDiv = document.createElement('div');
    loadingDiv.id = 'user-count-loading';
    loadingDiv.innerHTML = '<div style="background: #f0f8ff; padding: 10px; margin: 10px 0; border-radius: 5px; text-align: center;"><span style="color: #0066cc;">üîÑ Calculating user counts...</span></div>';
    domainList.appendChild(loadingDiv);
    
    // Call the separate user count calculation API
    fetch('/api/calculate-domain-users', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ domains: domainNames })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.domain_user_counts) {
            // Update domains with user counts
            const updatedDomains = domains.map(domain => {
                const domainName = domain.domain_name || domain.domainName;
                const userCount = data.domain_user_counts[domainName] || 0;
                
                // Update status based on user count
                let status, status_text, status_color;
                if (userCount > 0) {
                    status = 'in_use';
                    status_text = 'IN USE';
                    status_color = '#9C27B0';
                } else if (domain.ever_used) {
                    status = 'used';
                    status_text = 'USED';
                    status_color = '#FF9800';
                } else {
                    status = 'available';
                    status_text = 'AVAILABLE';
                    status_color = '#4CAF50';
                }
                
                return {
                    ...domain,
                    user_count: userCount,
                    status: status,
                    status_text: status_text,
                    status_color: status_color
                };
            });
            
            // Remove loading indicator
            const loadingDiv = document.getElementById('user-count-loading');
            if (loadingDiv) loadingDiv.remove();
            
            // Update display with user counts
            displayAvailableDomains(updatedDomains);
            logBulkDomain(`‚úÖ Updated ${updatedDomains.length} domains with user counts`);
        } else {
            logBulkDomain(`‚ùå Failed to calculate user counts: ${data.error || 'Unknown error'}`);
            const loadingDiv = document.getElementById('user-count-loading');
            if (loadingDiv) {
                loadingDiv.innerHTML = '<div style="background: #ffe6e6; padding: 10px; margin: 10px 0; border-radius: 5px; text-align: center;"><span style="color: #cc0000;">‚ùå Failed to calculate user counts</span></div>';
            }
        }
    })
    .catch(error => {
        logBulkDomain(`‚ùå Error calculating user counts: ${error}`);
        const loadingDiv = document.getElementById('user-count-loading');
        if (loadingDiv) {
            loadingDiv.innerHTML = '<div style="background: #ffe6e6; padding: 10px; margin: 10px 0; border-radius: 5px; text-align: center;"><span style="color: #cc0000;">‚ùå Error calculating user counts</span></div>';
        }
    });
}

function clearOldDomainData() {
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    if (!confirm('‚ö†Ô∏è This will clear domain data older than 30 days. Continue?')) {
        return;
    }
    
    logBulkDomain('üóëÔ∏è Clearing old domain data...');
    
    fetch('/api/clear-old-domain-data', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            logBulkDomain(`‚úÖ ${data.message}`);
            alert(`‚úÖ ${data.message}`);
            // Refresh the display
            setTimeout(() => {
                getDomainUsageStats();
            }, 500);
        } else {
            logBulkDomain(`‚ùå Failed to clear old data: ${data.error}`);
            alert('Failed to clear old data: ' + data.error);
        }
    })
    .catch(error => {
        logBulkDomain(`‚ùå Network error: ${error}`);
        alert('Network error: ' + error);
    });
}

function debugDomainUsers() {
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    const currentDomain = document.getElementById('current-domain-suffix').value.trim();
    if (!currentDomain) {
        alert('Please enter a domain in the "Current Domain Suffix" field first');
        return;
    }
    
    logBulkDomain(`üêõ Debugging users for domain: ${currentDomain}`);
    
    fetch('/api/debug-domain-users', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({domain: currentDomain})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            logBulkDomain(`üêõ Debug Results for ${data.domain}:`);
            logBulkDomain(`   Total users found: ${data.total_users_found}`);
            logBulkDomain(`   Users with domain ${data.domain}: ${data.domain_users_found}`);
            
            if (data.domain_users && data.domain_users.length > 0) {
                logBulkDomain(`   Domain users:`);
                data.domain_users.forEach(user => {
                    logBulkDomain(`     - ${user.email} (Admin: ${user.isAdmin}, Suspended: ${user.suspended})`);
                });
            } else {
                logBulkDomain(`   ‚ùå No users found with domain ${data.domain}`);
            }
        } else {
            logBulkDomain(`‚ùå Debug failed: ${data.error}`);
            alert('Debug failed: ' + data.error);
        }
    })
    .catch(error => {
        logBulkDomain(`‚ùå Network error: ${error}`);
        alert('Network error: ' + error);
    });
}

function displayDomainUsageStats(stats) {
    const domainList = document.getElementById('available-domains');
    
    let html = `
        <div class="stats-summary" style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <h3 style="margin: 0 0 15px 0; color: #333;">üìä Domain Usage Summary</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                <div style="text-align: center; padding: 10px; background: white; border-radius: 5px;">
                    <div style="font-size: 24px; font-weight: bold; color: #2196F3;">${stats.total_domains}</div>
                    <div style="font-size: 12px; color: #666;">Total Domains</div>
                </div>
                <div style="text-align: center; padding: 10px; background: white; border-radius: 5px;">
                    <div style="font-size: 24px; font-weight: bold; color: #4CAF50;">${stats.available_domains || 0}</div>
                    <div style="font-size: 12px; color: #666;">Available</div>
                </div>
                <div style="text-align: center; padding: 10px; background: white; border-radius: 5px;">
                    <div style="font-size: 24px; font-weight: bold; color: #FF9800;">${stats.used_domains || 0}</div>
                    <div style="font-size: 12px; color: #666;">Used</div>
                </div>
                <div style="text-align: center; padding: 10px; background: white; border-radius: 5px;">
                    <div style="font-size: 24px; font-weight: bold; color: #9C27B0;">${stats.in_use_domains || 0}</div>
                    <div style="font-size: 12px; color: #666;">In Use</div>
                </div>
                <div style="text-align: center; padding: 10px; background: white; border-radius: 5px;">
                    <div style="font-size: 24px; font-weight: bold; color: #666;">${stats.total_users}</div>
                    <div style="font-size: 12px; color: #666;">Total Users</div>
                </div>
            </div>
        </div>
    `;
    
    if (stats.domains.length === 0) {
        html += '<p class="placeholder-text">No domains found in database</p>';
    } else {
        html += '<h4 style="margin: 20px 0 10px 0; color: #333;">Domain Details:</h4>';
        html += stats.domains.map(domain => {
            // New three-state system
            let statusColor, statusText, domainClass, domainNameColor;
            
            if (domain.status === 'in_use') {
                // Purple - currently has users
                statusColor = '#9C27B0';
                statusText = 'IN USE';
                domainClass = 'domain-item in-use-domain';
                domainNameColor = '#9C27B0';
            } else if (domain.status === 'used') {
                // Orange - previously used but no current users
                statusColor = '#FF9800';
                statusText = 'USED';
                domainClass = 'domain-item used-domain';
                domainNameColor = '#FF9800';
            } else {
                // Green - never been used (available)
                statusColor = '#4CAF50';
                statusText = 'AVAILABLE';
                domainClass = 'domain-item';
                domainNameColor = 'black';
            }
            
            return `<div class="${domainClass}">
                <strong style="color: ${domainNameColor};">${domain.domain_name}</strong>
                <span style="float: right; color: #666;">${domain.user_count} users</span>
                <div style="margin-top: 5px;">
                    ${domain.is_verified ? '<span style="color: green;">‚úÖ Verified</span>' : '<span style="color: red;">‚ùå Not Verified</span>'}
                    <span style="color: ${statusColor}; margin-left: 10px; font-weight: bold;">${statusText}</span>
                </div>
                ${domain.last_updated ? `<div style="font-size: 11px; color: #999; margin-top: 3px;">Last updated: ${new Date(domain.last_updated).toLocaleString()}</div>` : ''}
            </div>`;
        }).join('');
    }
    
    domainList.innerHTML = html;
}

function displayAvailableDomains(domains) {
    const domainList = document.getElementById('available-domains');
    
    if (domains.length === 0) {
        domainList.innerHTML = '<p class="placeholder-text">No domains found</p>';
        return;
    }
    
    // Add summary at the top with new three-state system
    const totalDomains = domains.length;
    const availableDomains = domains.filter(d => d.status === 'available').length;
    const usedDomains = domains.filter(d => d.status === 'used').length;
    const inUseDomains = domains.filter(d => d.status === 'in_use').length;
    const totalUsers = domains.reduce((sum, d) => sum + d.user_count, 0);
    
    let html = `
        <div class="stats-summary">
            <h3>üìä Domain Summary</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
                <div style="text-align: center; padding: 8px; background: white; border-radius: 5px;">
                    <div style="font-size: 20px; font-weight: bold; color: #2196F3;">${totalDomains}</div>
                    <div style="font-size: 11px; color: #666;">Total</div>
                </div>
                <div style="text-align: center; padding: 8px; background: white; border-radius: 5px;">
                    <div style="font-size: 20px; font-weight: bold; color: #4CAF50;">${availableDomains}</div>
                    <div style="font-size: 11px; color: #666;">Available</div>
                </div>
                <div style="text-align: center; padding: 8px; background: white; border-radius: 5px;">
                    <div style="font-size: 20px; font-weight: bold; color: #FF9800;">${usedDomains}</div>
                    <div style="font-size: 11px; color: #666;">Used</div>
                </div>
                <div style="text-align: center; padding: 8px; background: white; border-radius: 5px;">
                    <div style="font-size: 20px; font-weight: bold; color: #9C27B0;">${inUseDomains}</div>
                    <div style="font-size: 11px; color: #666;">In Use</div>
                </div>
                <div style="text-align: center; padding: 8px; background: white; border-radius: 5px;">
                    <div style="font-size: 20px; font-weight: bold; color: #666;">${totalUsers}</div>
                    <div style="font-size: 11px; color: #666;">Users</div>
                </div>
            </div>
        </div>
        <h4 style="margin: 15px 0 10px 0; color: #333;">Domain Details:</h4>
    `;
    
    html += domains.map(domain => {
        // New three-state system
        let statusColor, statusText, domainClass, clickHandler, domainNameColor;
        
        if (domain.status === 'in_use') {
            // Purple - currently has users
            statusColor = '#9C27B0';  // Purple
            statusText = 'IN USE';
            domainClass = 'domain-item in-use-domain';
            clickHandler = '';  // Not selectable
            domainNameColor = '#9C27B0';
        } else if (domain.status === 'used') {
            // Orange - previously used but no current users
            statusColor = '#FF9800';  // Orange
            statusText = 'USED';
            domainClass = 'domain-item used-domain';
            clickHandler = '';  // Not selectable
            domainNameColor = '#FF9800';
        } else {
            // Green - never been used (available)
            statusColor = '#4CAF50';  // Green
            statusText = 'AVAILABLE';
            domainClass = 'domain-item';
            clickHandler = `onclick="selectDomain('${domain.domain_name}')"`;
            domainNameColor = 'black';
        }
        
        return `<div class="${domainClass}" ${clickHandler}>
            <strong style="color: ${domainNameColor};">${domain.domain_name}</strong>
            <span style="float: right; color: #666; font-weight: bold;">${domain.user_count} users</span>
            <div style="margin-top: 5px;">
                ${domain.verified ? '<span style="color: green;">‚úÖ Verified</span>' : '<span style="color: red;">‚ùå Not Verified</span>'}
                <span style="color: ${statusColor}; margin-left: 10px; font-weight: bold;">${statusText}</span>
            </div>
        </div>`;
    }).join('');
    
    domainList.innerHTML = html;
}

function selectDomain(domainName) {
    // Check if domain is used
    const domainElement = event.target.closest('.domain-item');
    if (domainElement.classList.contains('used-domain')) {
        alert('‚ùå This domain has already been used and cannot be selected again.');
        return;
    }
    
    // Remove previous selection
    document.querySelectorAll('.domain-item').forEach(item => {
        item.classList.remove('selected');
    });
    
    // Select clicked domain
    domainElement.classList.add('selected');
    selectedDomain = domainName;
    
    logBulkDomain(`üìå Selected domain: ${domainName}`);
}

function applySelectedDomainToCSV() {
    if (!selectedDomain) {
        alert('Please select a domain first');
        return;
    }
    
    const csvPath = document.getElementById('csv-file-path').value;
    if (!csvPath) {
        alert('Please download users CSV first');
        return;
    }
    
    logBulkDomain(`‚úÖ Applying domain ${selectedDomain} to CSV...`);
    
    fetch('/api/apply-domain-to-csv', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            selected_domain: selectedDomain,
            csv_path: csvPath
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Domain status is automatically updated by the apply-domain-to-csv endpoint
            // Update CSV path to modified version
            document.getElementById('csv-file-path').value = data.modified_csv_path;
            logBulkDomain(`‚úÖ Domain applied successfully. Modified CSV: ${data.modified_csv_path}`);
            logBulkDomain(`üìä ${data.modified_count} users will be updated to ${selectedDomain}`);
        } else {
            logBulkDomain(`‚ùå Failed to apply domain: ${data.error}`);
            alert('Failed to apply domain: ' + data.error);
        }
    })
    .catch(error => {
        logBulkDomain(`‚ùå Network error: ${error}`);
        alert('Network error: ' + error);
    });
}

function browseCSVFile() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.csv';
    input.onchange = function(e) {
        const file = e.target.files[0];
        if (file) {
            document.getElementById('csv-file-path').value = file.name;
            logBulkDomain(`üìÅ Selected CSV file: ${file.name}`);
        }
    };
    input.click();
}

function processDomainChangesFromCSV() {
    const csvPath = document.getElementById('csv-file-path').value;
    
    if (!csvPath) {
        alert('Please select or specify a CSV file first');
        return;
    }
    
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    if (!confirm('‚ö†Ô∏è Process domain changes from CSV?\n\nThis will update user domains as specified in the CSV file.\n\nThis action cannot be easily undone!')) {
        return;
    }
    
    logBulkDomain(`‚öôÔ∏è Processing domain changes from CSV: ${csvPath}`);
    
    fetch('/api/process-csv-domain-changes', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            csv_path: csvPath
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            logBulkDomain(`‚úÖ CSV processing completed!`);
            logBulkDomain(`üìä Results: ${data.successful} successful, ${data.failed} failed, ${data.skipped} skipped`);
            
            if (data.results) {
                data.results.forEach(result => {
                    if (result.success) {
                        logBulkDomain(`‚úÖ Updated: ${result.old_email} ‚Üí ${result.new_email}`);
                    } else {
                        logBulkDomain(`‚ùå Failed: ${result.email} - ${result.error}`);
                    }
                });
            }
        } else {
            logBulkDomain(`‚ùå CSV processing failed: ${data.error}`);
            alert('CSV processing failed: ' + data.error);
        }
    })
    .catch(error => {
        logBulkDomain(`‚ùå Network error: ${error}`);
        alert('Network error: ' + error);
    });
}

function changeDomainForAllUsers() {
    const currentDomain = document.getElementById('current-domain-suffix').value.trim();
    const newDomain = document.getElementById('new-domain-suffix').value.trim();
    
    if (!currentDomain || !newDomain) {
        alert('Please enter both current and new domain suffixes');
        return;
    }
    
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    if (!confirm(`‚ö†Ô∏è Change domain for ALL users?\n\n${currentDomain} ‚Üí ${newDomain}\n\nThis will affect ALL non-admin users with the current domain.\nThis action cannot be easily undone!\n\nContinue?`)) {
        return;
    }
    
    // Show progress indicator
    const progressContainer = document.getElementById('domain-change-progress');
    const progressBar = document.getElementById('progress-bar');
    const progressPercentage = document.getElementById('progress-percentage');
    const progressMessage = document.getElementById('progress-message');
    
    progressContainer.style.display = 'block';
    progressBar.style.width = '0%';
    progressPercentage.textContent = '0%';
    progressMessage.textContent = 'Starting domain change process...';
    
    logBulkDomain(`üîÑ Starting bulk domain change: ${currentDomain} ‚Üí ${newDomain}`);
    
    // Start domain change process (using working synchronous function)
    console.log(`Starting domain change: ${currentDomain} -> ${newDomain}`);
    
    // Start progress animation
    let progress = 0;
    const progressInterval = setInterval(() => {
        progress += Math.random() * 15; // Random progress increments
        if (progress > 90) progress = 90; // Don't go to 100% until done
        progressBar.style.width = `${progress}%`;
        progressPercentage.textContent = `${Math.round(progress)}%`;
        progressMessage.textContent = `Processing domain change... ${Math.round(progress)}%`;
    }, 500);
    
    fetch('/api/change-domain-all-users', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            current_domain: currentDomain,
            new_domain: newDomain,
            exclude_admin: true
        })
    })
    .then(response => {
        console.log(`Domain change response status: ${response.status}`);
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            throw new Error(`Server returned HTML instead of JSON. Status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log(`Domain change response data:`, data);
        // Clear progress animation
        clearInterval(progressInterval);
        
        if (data.success) {
            // Domain change completed successfully
            logBulkDomain(`‚úÖ ${data.message || 'Domain change completed successfully!'}`);
            progressBar.style.width = '100%';
            progressPercentage.textContent = '100%';
            progressMessage.textContent = 'Domain change completed successfully!';
            
            // Hide progress indicator after 3 seconds
            setTimeout(() => {
                progressContainer.style.display = 'none';
            }, 3000);
                    } else {
            throw new Error(data.error || 'Failed to change domains');
        }
    })
    .catch(error => {
        console.error('Domain change start error:', error);
        // Clear progress animation
        clearInterval(progressInterval);
        logBulkDomain(`‚ùå Failed to start domain change: ${error.message}`);
        progressContainer.style.display = 'none';
    });
}

function pollProgress(taskId) {
    const progressBar = document.getElementById('progress-bar');
    const progressPercentage = document.getElementById('progress-percentage');
    const progressMessage = document.getElementById('progress-message');
    const progressContainer = document.getElementById('domain-change-progress');
    
    const poll = () => {
        console.log(`Polling for task: ${taskId}`);
        fetch(`/api/progress/${taskId}`)
        .then(response => {
            console.log(`Progress response status: ${response.status}`);
            return response.json();
        })
        .then(data => {
            console.log(`Progress response data:`, data);
            if (data.success && data.progress) {
                const progress = data.progress;
                console.log(`Progress status: ${progress.status}, message: ${progress.message}`);
                
                // Update progress bar
                progressBar.style.width = `${progress.percentage}%`;
                progressPercentage.textContent = `${progress.percentage}%`;
                progressMessage.textContent = progress.message;
                
                // Update log with progress
                if (progress.status === 'processing') {
                    logBulkDomain(`üîÑ ${progress.message} (${progress.percentage}%)`);
                } else if (progress.status === 'completed') {
                    logBulkDomain(`‚úÖ ${progress.message}`);
                    progressContainer.style.display = 'none';
                    return; // Stop polling
                } else if (progress.status === 'error') {
                    logBulkDomain(`‚ùå ${progress.message}`);
                    progressContainer.style.display = 'none';
                    return; // Stop polling
                } else if (progress.status === 'not_found') {
                    logBulkDomain(`‚ùå Task not found: ${progress.message}`);
                    progressContainer.style.display = 'none';
                    return; // Stop polling
                }
                
                // Continue polling if still processing
                if (progress.status === 'processing' || progress.status === 'starting') {
                    setTimeout(poll, 1000); // Poll every second
        } else {
                    // If we get an unexpected status, log it and stop polling
                    logBulkDomain(`‚ùå Unexpected status: ${progress.status} - ${progress.message}`);
                    progressContainer.style.display = 'none';
                }
            } else {
                logBulkDomain(`‚ùå Failed to get progress: ${data.error || 'Unknown error'}`);
                progressContainer.style.display = 'none';
        }
    })
    .catch(error => {
            console.error('Progress polling error:', error);
            logBulkDomain(`‚ùå Progress polling failed: ${error.message}`);
            progressContainer.style.display = 'none';
        });
    };
    
    // Start polling
    poll();
}

function logBulkDomain(message) {
    const log = document.getElementById('bulk-domain-results');
    const timestamp = new Date().toLocaleTimeString();
    
    if (log.querySelector('.placeholder-text')) {
        log.innerHTML = '';
    }
    
    log.textContent += `[${timestamp}] ${message}\n`;
    log.scrollTop = log.scrollHeight;
}

function clearBulkDomainLog() {
    document.getElementById('bulk-domain-results').innerHTML = '<p class="placeholder-text">Processing results will appear here...</p>';
}

function autoChangeSubdomain() {
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    // Confirm the action
    if (!confirm('üîÑ Auto Change Subdomain\n\nThis will automatically change all users from the current in-use domain to the next available domain (ascending order).\n\nThis action cannot be easily undone!\n\nContinue?')) {
        return;
    }
    
    logBulkDomain('üîÑ Starting automated subdomain change...');
    
    // Show progress indicator
    const progressContainer = document.getElementById('domain-change-progress');
    const progressBar = document.getElementById('progress-bar');
    const progressMessage = document.getElementById('progress-message');
    const progressPercentage = document.getElementById('progress-percentage');
    
    progressContainer.style.display = 'block';
    progressBar.style.width = '0%';
    progressPercentage.textContent = '0%';
    progressMessage.textContent = 'Initializing automated subdomain change...';
    
    // Show progress indicator on button
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Changing...';
    button.disabled = true;
    
    // Simulate progress updates
    let progress = 0;
    const progressInterval = setInterval(() => {
        progress += 2;
        if (progress <= 90) {
            progressBar.style.width = progress + '%';
            progressPercentage.textContent = progress + '%';
            progressMessage.textContent = `Processing domain change... ${progress}%`;
        }
    }, 200);
    
    fetch('/api/auto-change-subdomain', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        clearInterval(progressInterval);
        progressBar.style.width = '100%';
        progressPercentage.textContent = '100%';
        
        if (data.success) {
            logBulkDomain(`‚úÖ ${data.message}`);
            logBulkDomain(`üìä Successfully changed ${data.successful_changes}/${data.total_users} users`);
            logBulkDomain(`üîÑ Domain change: ${data.current_domain} ‚Üí ${data.next_domain}`);
            logBulkDomain(`üìã Available domains: ${data.available_domains.join(', ')}`);
            
            if (data.failed_changes > 0) {
                logBulkDomain(`‚ö†Ô∏è ${data.failed_changes} users failed to change`);
                if (data.failed_details && data.failed_details.length > 0) {
                    data.failed_details.forEach(failed => {
                        logBulkDomain(`‚ùå Failed: ${failed.email} - ${failed.error}`);
                    });
                }
            }
            
            progressMessage.textContent = 'Automated subdomain change completed successfully!';
            
            // Refresh domain display
            getDomainInfo();
            
            // Auto-retrieve app passwords for the new domain
            setTimeout(() => {
                document.getElementById('retrieve-domain').value = data.next_domain;
                retrieveAppPasswords();
            }, 1000);
            
            // Show success message
            alert(`‚úÖ Automated subdomain change completed!\n\n${data.message}\n\nChanged ${data.successful_changes}/${data.total_users} users from ${data.current_domain} to ${data.next_domain}`);
            
        } else {
            logBulkDomain(`‚ùå Auto change subdomain failed: ${data.error}`);
            progressMessage.textContent = `Failed: ${data.error}`;
            alert(`‚ùå Failed to change subdomain: ${data.error}`);
        }
    })
    .catch(error => {
        clearInterval(progressInterval);
        logBulkDomain(`‚ùå Network error: ${error}`);
        progressMessage.textContent = `Network error: ${error.message}`;
        alert(`‚ùå Network error: ${error.message}`);
    })
    .finally(() => {
        // Restore button
        button.innerHTML = originalText;
        button.disabled = false;
        
        // Hide progress after 3 seconds
        setTimeout(() => {
            progressContainer.style.display = 'none';
        }, 3000);
    });
}

function refreshDomainStatus() {
    
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
    button.disabled = true;
    
    fetch('/api/refresh-domain-status', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`‚úÖ Domain status refreshed successfully!\n\n${data.message}\n\nUpdated domains:\n${data.updated_domains.join('\n')}`);
            // Refresh the domain display
            getDomainInfo();
        } else {
            alert('‚ùå Failed to refresh domain status: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Refresh domain status error:', error);
        alert('‚ùå Network error: ' + error.message);
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

// Tab 4 Functions - SMTP & CSV

function testSMTPCredentials() {
    const credentials = document.getElementById('smtp-credentials').value.trim();
    const recipient = document.getElementById('smtp-recipient').value.trim();
    const server = document.getElementById('smtp-server').value.trim();
    const port = document.getElementById('smtp-port').value;
    
    if (!credentials) {
        alert('Please enter SMTP credentials');
        return;
    }
    
    if (!recipient || !recipient.includes('@')) {
        alert('Please enter a valid recipient email');
        return;
    }
    
    smtpTesting = true;
    clearSMTPResults();
    logSMTPResult('üöÄ Starting SMTP credential testing...');
    logSMTPResult(`üìß Recipient: ${recipient}`);
    logSMTPResult(`üñ•Ô∏è Server: ${server}:${port}`);
    logSMTPResult('‚îÄ'.repeat(50));
    
    // Start SMTP testing with progress tracking
    fetch('/api/test-smtp-progress', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            credentials: credentials,
            recipient_email: recipient,
            smtp_server: server,
            smtp_port: parseInt(port)
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const taskId = data.task_id;
            logSMTPResult(`üìä Testing ${credentials.split('\n').filter(line => line.trim()).length} credentials...`);
            
            // Poll for progress updates
            const progressInterval = setInterval(() => {
                fetch(`/api/smtp-progress/${taskId}`)
                .then(response => response.json())
                .then(progressData => {
                    if (progressData.success) {
                        const progress = progressData.progress;
                        
                        // Update progress message
                        if (progress.current_email) {
                            logSMTPResult(`üîÑ [${progress.progress}/${progress.total}] Testing ${progress.current_email}...`);
                        } else {
                            logSMTPResult(`üîÑ [${progress.progress}/${progress.total}] ${progress.message}`);
                        }
                        
                        // Show results as they come in
                        if (progress.results && progress.results.length > 0) {
                            const latestResult = progress.results[progress.results.length - 1];
                            if (latestResult.status === 'success') {
                                logSMTPResult(`‚úÖ [${progress.progress}/${progress.total}] ${latestResult.email}: ${latestResult.message || 'Success'}`);
                            } else {
                                logSMTPResult(`‚ùå [${progress.progress}/${progress.total}] ${latestResult.email}: ${latestResult.error}`);
                            }
                        }
                        
                        // Check if completed
                        if (progress.status === 'completed') {
                            clearInterval(progressInterval);
                            smtpTesting = false;
                            logSMTPResult('‚îÄ'.repeat(50));
                            logSMTPResult(`üìà Final Summary: ${progress.success_count}/${progress.total} credentials working`);
                        } else if (progress.status === 'error') {
                            clearInterval(progressInterval);
                            smtpTesting = false;
                            logSMTPResult(`‚ùå SMTP testing failed: ${progress.message}`);
                        }
                    } else {
                        clearInterval(progressInterval);
                        smtpTesting = false;
                        logSMTPResult(`‚ùå Progress tracking failed: ${progressData.error}`);
                    }
                })
                .catch(error => {
                    clearInterval(progressInterval);
                    smtpTesting = false;
                    logSMTPResult(`‚ùå Progress check error: ${error.message}`);
                });
            }, 1000); // Check every second
            
        } else {
            smtpTesting = false;
            logSMTPResult(`‚ùå Failed to start SMTP testing: ${data.error}`);
        }
    })
    .catch(error => {
        smtpTesting = false;
        logSMTPResult(`‚ùå Error: ${error.message}`);
        console.error('SMTP Test Error:', error);
    });
}

function interruptSMTPTesting() {
    if (smtpTesting) {
        smtpTesting = false;
        logSMTPResult('‚èπÔ∏è SMTP testing interrupted by user');
        alert('SMTP testing interrupted');
    } else {
        alert('No SMTP testing in progress');
    }
}

function clearSMTPResults() {
    document.getElementById('smtp-results-log').textContent = '';
}

function logSMTPResult(message) {
    const log = document.getElementById('smtp-results-log');
    const timestamp = new Date().toLocaleTimeString();
    log.textContent += `[${timestamp}] ${message}\n`;
    log.scrollTop = log.scrollHeight;
}

function generateUserCSV() {
    const numUsers = document.getElementById('csv-num-users').value;
    const domain = document.getElementById('csv-domain').value.trim();
    const password = document.getElementById('csv-password').value.trim();
    
    if (!numUsers || numUsers <= 0) {
        alert('Please enter a valid number of users');
        return;
    }
    
    if (!domain || !domain.includes('.')) {
        alert('Please enter a valid domain');
        return;
    }
    
    if (!password) {
        alert('Please enter a default password');
        return;
    }
    
    logResult(`üìù Generating CSV with ${numUsers} users for ${domain}...`);
    
    fetch('/api/generate-csv', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            num_users: parseInt(numUsers),
            domain: domain,
            password: password
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.csv_data) {
            // Create download link
            const blob = new Blob([data.csv_data], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const filename = `users_${domain}_${numUsers}.csv`;
            
            document.getElementById('csv-download-area').innerHTML = `
                <a href="${url}" download="${filename}" class="download-btn">
                    üì• Download ${filename} (${numUsers} users)
                </a>
            `;
            
            logResult(`‚úÖ CSV file generated successfully: ${filename}`);
        } else {
            logResult(`‚ùå CSV generation failed: ${data.error}`);
            alert('Failed to generate CSV: ' + data.error);
        }
    })
    .catch(error => {
        logResult(`‚ùå Network error: ${error}`);
        alert('Network error: ' + error);
    });
}


function previewCSV() {
    const numUsers = Math.min(document.getElementById('csv-num-users').value || 5, 10); // Preview max 10
    const domain = document.getElementById('csv-domain').value.trim() || 'example.com';
    const password = document.getElementById('csv-password').value.trim() || 'DefaultPass123';
    
    fetch('/api/preview-csv', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            num_users: parseInt(numUsers),
            domain: domain,
            password: password
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.preview) {
            document.getElementById('csv-preview-area').innerHTML = `
                <h4>üìã CSV Preview (first ${numUsers} rows):</h4>
                <pre>${data.preview}</pre>
            `;
        } else {
            alert('Failed to preview CSV: ' + data.error);
        }
    })
    .catch(error => {
        alert('Network error: ' + error);
    });
}



/*

// COMMENTED OUT - Email Template Functions
function generateEmailTemplate() {
    const subject = document.getElementById('email-subject').value.trim();
    const body = document.getElementById('email-body').value.trim();
    
    if (!subject || !body) {
        alert('Please enter both subject and body');
        return;
    }
    
    // Sample data for template preview
    const sampleData = {
        email: 'john.doe@example.com',
        password: 'TempPass123',
        first_name: 'John',
        last_name: 'Doe'
    };
    
    let previewSubject = subject;
    let previewBody = body;
    
    // Replace placeholders
    Object.keys(sampleData).forEach(key => {
        const placeholder = `{${key}}`;
        previewSubject = previewSubject.replace(new RegExp(placeholder, 'g'), sampleData[key]);
        previewBody = previewBody.replace(new RegExp(placeholder, 'g'), sampleData[key]);
    });
    
    document.getElementById('email-template-preview').innerHTML = `
        <h4>üìß Email Template Preview:</h4>
        <div style="border: 1px solid #ddd; padding: 1rem; background: white;">
            <div><strong>Subject:</strong> ${previewSubject}</div>
            <hr>
            <div style="white-space: pre-wrap;">${previewBody}</div>
        </div>
        <p><small>üìù Sample data used: ${JSON.stringify(sampleData, null, 2)}</small></p>
    `;
}

// COMMENTED OUT - Email Template Functions
function testEmailTemplate() {
    alert('Email template testing feature coming soon!');
}
*/

// Mega Upgrade Functions
function openMegaUpgradeModal() {
    document.getElementById('megaUpgradeModal').style.display = 'block';
}

function closeMegaUpgradeModal() {
    document.getElementById('megaUpgradeModal').style.display = 'none';
}

function startMegaUpgrade() {
    const accountsText = document.getElementById('mega-accounts-list').value.trim();
    
    if (!accountsText) {
        alert('Please enter at least one account');
        return;
    }
    
    // Parse accounts from textarea (one per line)
    const accounts = accountsText.split('\n')
        .map(line => line.trim())
        .filter(line => line && line.includes('@')); // Filter out empty lines and invalid emails
    
    if (accounts.length === 0) {
        alert('Please enter valid email addresses (one per line)');
        return;
    }
    
    // Get selected features
    const features = {
        authenticate: document.getElementById('feature-authenticate').checked,
        changeSubdomain: document.getElementById('feature-change-subdomain').checked,
        retrievePasswords: document.getElementById('feature-retrieve-passwords').checked,
        updatePasswords: document.getElementById('feature-update-passwords').checked
    };
    
    // Show progress section
    document.getElementById('megaUpgradeProgress').style.display = 'block';
    document.getElementById('megaStartBtn').style.display = 'none';
    document.getElementById('megaStopBtn').style.display = 'inline-block';
    
    // Reset log counter for new process
    window.lastLoggedCount = 0;
    
    // Start mega upgrade process
    runMegaUpgradeWorkflow(accounts, features);
}

function stopMegaUpgrade() {
    // Stop the process (implementation depends on backend)
    document.getElementById('megaStartBtn').style.display = 'inline-block';
    document.getElementById('megaStopBtn').style.display = 'none';
    logBulkDomain('‚èπÔ∏è Mega upgrade process stopped by user');
}

function clearMegaUpgradeResults() {
    document.getElementById('app-passwords-display').value = '';
    logBulkDomain('üßπ Mega upgrade results cleared');
}

function updateMegaProgress(percentage, message) {
    const progressBar = document.getElementById('megaProgressBar');
    const progressPercent = document.getElementById('megaProgressPercent');
    const progressText = document.getElementById('megaProgressText');
    
    if (progressBar && progressPercent && progressText) {
        progressBar.style.width = percentage + '%';
        progressPercent.textContent = percentage + '%';
        progressText.textContent = message;
    }
}

function testMegaUpgrade() {
    const accountsText = document.getElementById('mega-accounts-list').value.trim();
    
    if (!accountsText) {
        alert('Please enter at least one account');
        return;
    }
    
    // Parse accounts from textarea (one per line)
    const accounts = accountsText.split('\n')
        .map(line => line.trim())
        .filter(line => line && line.includes('@')); // Filter out empty lines and invalid emails
    
    if (accounts.length === 0) {
        alert('Please enter valid email addresses (one per line)');
        return;
    }
    
    // Get selected features
    const features = {
        authenticate: document.getElementById('feature-authenticate').checked,
        changeSubdomain: document.getElementById('feature-change-subdomain').checked,
        retrievePasswords: document.getElementById('feature-retrieve-passwords').checked,
        updatePasswords: document.getElementById('feature-update-passwords').checked
    };
    
    logBulkDomain('üß™ Starting SIMPLE Test Mega Upgrade...');
    logBulkDomain(`üìä Testing ${accounts.length} accounts with selected features`);
    logBulkDomain(`üîß Features: ${Object.keys(features).filter(k => features[k]).join(', ')}`);
    logBulkDomain('‚îÄ'.repeat(50));
    
    // Test the NEW simple endpoint
    fetch('/api/test-simple-mega', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            accounts: accounts,
            features: features
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            logBulkDomain(`‚úÖ SIMPLE Test completed successfully: ${data.message}`);
            logBulkDomain(`üìä Received accounts: ${data.received_accounts.join(', ')}`);
            logBulkDomain(`üîß Received features: ${JSON.stringify(data.received_features)}`);
            logBulkDomain(`üìã Total accounts: ${data.total_accounts}`);
            logBulkDomain('‚îÄ'.repeat(50));
            logBulkDomain('üéâ SIMPLE Test completed - Basic communication works!');
        } else {
            logBulkDomain(`‚ùå SIMPLE Test failed: ${data.error}`);
        }
    })
    .catch(error => {
        logBulkDomain(`‚ùå SIMPLE Test error: ${error.message}`);
        console.error('SIMPLE Test Error:', error);
    });
}

function debugMegaUpgrade() {
    const accountsText = document.getElementById('mega-accounts-list').value.trim();
    
    if (!accountsText) {
        alert('Please enter at least one account');
        return;
    }
    
    // Parse accounts from textarea (one per line)
    const accounts = accountsText.split('\n')
        .map(line => line.trim())
        .filter(line => line && line.includes('@')); // Filter out empty lines and invalid emails
    
    if (accounts.length === 0) {
        alert('Please enter valid email addresses (one per line)');
        return;
    }
    
    // Get selected features
    const features = {
        authenticate: document.getElementById('feature-authenticate').checked,
        changeSubdomain: document.getElementById('feature-change-subdomain').checked,
        retrievePasswords: document.getElementById('feature-retrieve-passwords').checked,
        updatePasswords: document.getElementById('feature-update-passwords').checked
    };
    
    logBulkDomain('üêõ Starting DEBUG Mega Upgrade...');
    logBulkDomain(`üìä Debugging ${accounts.length} accounts with selected features`);
    logBulkDomain(`üîß Features: ${Object.keys(features).filter(k => features[k]).join(', ')}`);
    logBulkDomain('‚îÄ'.repeat(50));
    
    // Test the debug endpoint
    fetch('/api/debug-mega-upgrade', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            accounts: accounts,
            features: features
        })
    })
    .then(response => {
        logBulkDomain(`üîç Response status: ${response.status}`);
        logBulkDomain(`üîç Response headers: ${JSON.stringify(Object.fromEntries(response.headers))}`);
        return response.json();
    })
    .then(data => {
        if (data.success) {
            logBulkDomain(`‚úÖ DEBUG completed successfully: ${data.message}`);
            logBulkDomain(`üìä Accounts received: ${data.accounts_received}`);
            logBulkDomain(`üîß Features received: ${JSON.stringify(data.features_received)}`);
            logBulkDomain(`üóÑÔ∏è Database accounts: ${data.database_accounts}`);
            logBulkDomain(`üîç Debug info: ${data.debug_info}`);
            logBulkDomain('‚îÄ'.repeat(50));
            logBulkDomain('üéâ DEBUG completed - All systems operational!');
        } else {
            logBulkDomain(`‚ùå DEBUG failed: ${data.error}`);
            if (data.traceback) {
                logBulkDomain(`üîç Traceback: ${data.traceback}`);
            }
        }
    })
    .catch(error => {
        logBulkDomain(`‚ùå DEBUG error: ${error.message}`);
        console.error('DEBUG Error:', error);
    });
}

function runMegaUpgradeWorkflow(accounts, features) {
    logBulkDomain('üöÄ Starting Mega Upgrade Workflow...');
    logBulkDomain(`üìä Processing ${accounts.length} accounts with selected features`);
    logBulkDomain(`üîß Features: ${Object.keys(features).filter(k => features[k]).join(', ')}`);
    logBulkDomain('‚îÄ'.repeat(50));
    
    // Show detailed processing for each account
    accounts.forEach((account, index) => {
        logBulkDomain(`üìß Account ${index + 1}: ${account}`);
    });
    logBulkDomain('‚îÄ'.repeat(50));
    
    // Update progress indicator
    updateMegaProgress(0, 'Initializing...');
    
    // Show processing message with more detail
    logBulkDomain('‚è≥ Starting automated processing...');
    updateMegaProgress(10, 'Looking up accounts in database...');
    logBulkDomain('üîç Step 1: Looking up accounts in database...');
    
    updateMegaProgress(20, 'Authenticating accounts...');
    logBulkDomain('üîê Step 2: Authenticating accounts...');
    
    updateMegaProgress(30, 'Changing subdomains...');
    logBulkDomain('üîÑ Step 3: Changing subdomains...');
    
    updateMegaProgress(40, 'Generating app passwords...');
    logBulkDomain('üîë Step 4: Generating app passwords...');
    logBulkDomain('‚îÄ'.repeat(50));
    
    updateMegaProgress(50, 'Sending request to server...');
    
    // Start the mega upgrade process
    fetch('/api/mega-upgrade', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            accounts: accounts,
            features: features
        })
    })
    .then(response => {
        updateMegaProgress(70, 'Processing server response...');
        logBulkDomain(`üì° Response received: ${response.status} ${response.statusText}`);
        return response.json();
    })
    .then(data => {
        updateMegaProgress(80, 'Analyzing results...');
        logBulkDomain('‚îÄ'.repeat(50));
        logBulkDomain('üìã PROCESSING RESULTS:');
        
        if (data.success) {
            updateMegaProgress(90, 'Finalizing results...');
            logBulkDomain(`‚úÖ Mega upgrade completed successfully!`);
            logBulkDomain(`üìä Results: ${data.successful_accounts} successful, ${data.failed_accounts} failed`);
            logBulkDomain(`üìã Total accounts processed: ${data.total_accounts}`);
            
            // Display detailed results for each account
            if (data.final_results && data.final_results.length > 0) {
                logBulkDomain('‚îÄ'.repeat(50));
                logBulkDomain('‚úÖ SUCCESSFUL ACCOUNTS:');
                data.final_results.forEach((result, index) => {
                    logBulkDomain(`  ${index + 1}. Account: ${result.account}`);
                    logBulkDomain(`     New Name: ${result.new_account_name}`);
                    logBulkDomain(`     App Password: ${result.app_password}`);
                    logBulkDomain(`     Status: ${result.status}`);
                });
            }

            // Display SMTP results if available
            if (data.smtp_results && data.smtp_results.length > 0) {
                logBulkDomain('‚îÄ'.repeat(50));
                logBulkDomain('üìß SMTP CONFIGURATION RESULTS:');
                data.smtp_results.forEach((smtp, index) => {
                    logBulkDomain(`  ${index + 1}. ${smtp}`);
                });
                
                const display = document.getElementById('app-passwords-display');
                display.value = data.smtp_results.join('\n');
                logBulkDomain(`üìã ${data.smtp_results.length} SMTP results displayed in textarea`);
            }

            // Display failed details if any
            if (data.failed_details && data.failed_details.length > 0) {
                logBulkDomain('‚îÄ'.repeat(50));
                logBulkDomain('‚ùå FAILED ACCOUNTS DETAILS:');
                data.failed_details.forEach((detail, index) => {
                    logBulkDomain(`  ${index + 1}. Account: ${detail.account}`);
                    logBulkDomain(`     Step: ${detail.step}`);
                    logBulkDomain(`     Error: ${detail.error}`);
                });
            }

            updateMegaProgress(100, 'Completed successfully!');
            logBulkDomain('‚îÄ'.repeat(50));
            logBulkDomain('üéâ Mega Upgrade Workflow Finished!');
            
            // Hide progress after 2 seconds
            setTimeout(() => {
                document.getElementById('megaUpgradeProgress').style.display = 'none';
            }, 2000);
        } else {
            updateMegaProgress(100, 'Failed');
            document.getElementById('megaStartBtn').style.display = 'inline-block';
            document.getElementById('megaStopBtn').style.display = 'none';
            logBulkDomain(`‚ùå Mega upgrade failed: ${data.error}`);
            logBulkDomain('‚îÄ'.repeat(50));
            logBulkDomain('üîç Check server logs for more details');
        }
    })
    .catch(error => {
        updateMegaProgress(100, 'Network Error');
        document.getElementById('megaStartBtn').style.display = 'inline-block';
        document.getElementById('megaStopBtn').style.display = 'none';
        logBulkDomain(`‚ùå Network Error: ${error.message}`);
        logBulkDomain('‚îÄ'.repeat(50));
        logBulkDomain('üîç Check server connection and logs');
        console.error('Mega Upgrade Error:', error);
    });
}

</script>

<!-- Mega Upgrade Modal -->
<div id="megaUpgradeModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 1200px; width: 95%;">
        <div class="modal-header">
            <h2><i class="fas fa-rocket"></i> Mega Upgrade: Multi-Account Workflow</h2>
            <span class="close" onclick="closeMegaUpgradeModal()">&times;</span>
        </div>
        
        <div class="modal-body">
            <!-- Feature Selection -->
            <div style="margin-bottom: 24px;">
                <h3 style="margin-bottom: 16px; color: #24292f;">
                    <i class="fas fa-cogs"></i> Select Features to Apply
                </h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
                    <label class="checkbox-container">
                        <input type="checkbox" id="feature-authenticate" checked>
                        <span class="checkmark"></span>
                        <i class="fas fa-key"></i> Authenticate Accounts
                    </label>
                    <label class="checkbox-container">
                        <input type="checkbox" id="feature-change-subdomain" checked>
                        <span class="checkmark"></span>
                        <i class="fas fa-exchange-alt"></i> Auto Change Subdomain
                    </label>
                    <label class="checkbox-container">
                        <input type="checkbox" id="feature-retrieve-passwords" checked>
                        <span class="checkmark"></span>
                        <i class="fas fa-download"></i> Retrieve App Passwords
                    </label>
                    <label class="checkbox-container">
                        <input type="checkbox" id="feature-update-passwords" checked>
                        <span class="checkmark"></span>
                        <i class="fas fa-sync-alt"></i> Update Domain in Passwords
                    </label>
                </div>
            </div>
            
            <!-- Account Input -->
            <div style="margin-bottom: 24px;">
                <h3 style="margin-bottom: 16px; color: #24292f;">
                    <i class="fas fa-users"></i> Account List (One per line)
                </h3>
                <div class="form-group-github">
                    <label for="mega-accounts-list" class="form-label-github">
                        <i class="fas fa-list"></i> Accounts (One email per line)
                    </label>
                    <textarea id="mega-accounts-list" class="form-control-github" rows="8" 
                              placeholder="Enter accounts one per line:&#10;admin@domain1.com&#10;support@domain2.com&#10;mailer@domain3.com&#10;...&#10;&#10;Supports unlimited accounts for processing"
                              style="font-family: monospace; font-size: 13px;"></textarea>
                    <small style="color: #656d76; font-size: 12px;">
                        Enter one email address per line. The system will process all accounts with the selected features.
                    </small>
                </div>
            </div>
            
            <!-- Progress Section -->
            <div id="megaUpgradeProgress" style="display: none; margin-bottom: 24px;">
                <h3 style="margin-bottom: 16px; color: #24292f;">
                    <i class="fas fa-tasks"></i> Progress
                </h3>
                <div style="background: #f6f8fa; border: 1px solid #d0d7de; border-radius: 6px; padding: 16px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span id="megaProgressText">Initializing...</span>
                        <span id="megaProgressPercent">0%</span>
                    </div>
                    <div style="background: #d0d7de; border-radius: 3px; height: 8px; overflow: hidden;">
                        <div id="megaProgressBar" style="background: #2da44e; height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div style="display: flex; gap: 12px; justify-content: center;">
                <button onclick="startMegaUpgrade()" class="btn-github btn-github-primary" id="megaStartBtn">
                    <i class="fas fa-play"></i> Run Mega Upgrade
                </button>
                <button onclick="testMegaUpgrade()" class="btn-github" style="background-color: #28a745; border-color: #28a745; color: white;">
                    <i class="fas fa-vial"></i> Test (No Threading)
                </button>
                <button onclick="debugMegaUpgrade()" class="btn-github" style="background-color: #6f42c1; border-color: #6f42c1; color: white;">
                    <i class="fas fa-bug"></i> Debug Mega Upgrade
                </button>
                <button onclick="stopMegaUpgrade()" class="btn-github" style="background-color: #d73a49; border-color: #d73a49; color: white;" id="megaStopBtn" style="display: none;">
                    <i class="fas fa-stop"></i> Stop Process
                </button>
                <button onclick="clearMegaUpgradeResults()" class="btn-github">
                    <i class="fas fa-broom"></i> Clear Results
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}
