{% extends "base.html" %}
{% block title %}Dashboard - GBot Web{% endblock %}

{% block content %}
<!-- Simple test to verify JavaScript works -->
<script>
console.log('Dashboard template loaded');
function testFunction() {
    alert('JavaScript is working!');
}
</script>

<!-- Tab Navigation -->
<div class="tab-navigation">
    <button class="tab-button active" onclick="showTab('tab1')">ğŸ‘¤ Account & User Mgmt</button>
    <button class="tab-button" onclick="showTab('tab2')">â•âœï¸ User Create/Delete/Domain</button>
    <button class="tab-button" onclick="showTab('tab3')">ğŸ”„ Bulk Domain Change</button>
    <button class="tab-button" onclick="showTab('tab4')">âœ‰ï¸ SMTP & CSV Gen</button>
</div>

<!-- Tab 1: Account & User Management -->
<div id="tab1" class="tab-content active">    
    <!-- Account Selection & Authentication -->
    <div class="section">
        <h3>ğŸ‘¤ Account Selection & Authentication</h3>
        
        <div class="form-row">
            <label for="account-select">Select Account:</label>
            <select id="account-select">
                <option value="">Choose an account...</option>
                {% for account in accounts %}
                <option value="{{ account.account_name }}" data-account-id="{{ account.id }}">{{ account.account_name }}</option>
                {% endfor %}
            </select>
            <button onclick="authenticateAccount()">ğŸ”‘ Authenticate Selected</button>
        </div>
        
        <div class="form-row">
            <button onclick="testFunction()" style="background: red; color: white;">ğŸ§ª TEST JS</button>
            <button onclick="openAddAccountModal()">â• Add Manually</button>
            <button onclick="addFromServerJSON()">ğŸ“ Add from Server JSON</button>
            {% if session.role == 'admin' %}
            <button onclick="forceTokenStatusCheck()" class="btn btn-warning">
                ğŸ” Check Token Status Now (Admin)
            </button>
            {% endif %}    
            <button onclick="enterAuthorizationCode()">ğŸ“ Enter Authorization Code</button>
        </div>
        
        <!-- Search and Account List Area -->
        <div class="account-management-area">
            <div class="search-and-list">
                <input type="text" id="account-search" placeholder="Search accounts in list..." 
                        oninput="filterAccounts()" class="search-input" 
                        autocomplete="off" autocomplete="nope" readonly onfocus="this.removeAttribute('readonly');">
                
                <div id="account-list-area" class="account-list">
                    {% for account in accounts %}
                    <div class="account-item" onclick="selectAccountFromList('{{ account.account_name|replace("'", "\\'")|replace('"', '\\"') }}', {{ account.id }})" data-account-id="{{ account.id }}">
                        {{ account.account_name }}
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <div class="account-actions">
                <button onclick="authenticateFromList()" class="action-button">
                    ğŸ”‘ Authenticate<br>(List Selection)
                </button>
                <button onclick="deleteFromList()" class="action-button delete-button">
                    ğŸ—‘ï¸ Delete Account<br>(List Selection)
                </button>
            </div>
        </div>
        <div id="account-count-display" class="count-display">
            <span id="account-stats">Loading account statistics...</span>
        </div>
        <div id="auth-status" class="status-box">
            <p>No account authenticated</p>
        </div>
    </div>

    <!-- Add Account Modal -->
    <div id="addAccountModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAddAccountModal()">&times;</span>
            <h3>Add Account Manually</h3>
            <form id="addAccountForm">
                <div class="form-group">
                    <label for="new-account-email">Account Email:</label>
                    <input type="email" id="new-account-email" required placeholder="admin@yourdomain.com">
                </div>
                <div class="form-group">
                    <label for="new-client-id">Client ID:</label>
                    <input type="text" id="new-client-id" required placeholder="123456789-abcdef.apps.googleusercontent.com">
                </div>
                <div class="form-group">
                    <label for="new-client-secret">Client Secret:</label>
                    <input type="password" id="new-client-secret" required placeholder="GOCSPX-your_client_secret">
                </div>
                <div class="form-buttons">
                    <button type="button" onclick="saveNewAccount()">ğŸ’¾ Save Account</button>
                    <button type="button" onclick="closeAddAccountModal()">âŒ Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- OAuth Authorization Modal -->
    <div id="oauthModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ğŸ”— OAuth Authorization Required</h3>
                <button class="modal-close" onclick="closeOAuthModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p>Please copy this link and open it in your browser to authorize the account:</p>
                <div id="oauthUrl" class="account-details"></div>
                <p><small>ğŸ’¡ <strong>Tip:</strong> You can copy this link to use in another browser or app for authorization.</small></p>
            </div>
            <div class="modal-footer">
                <button class="btn-copy" onclick="copyOAuthUrl()">ğŸ“‹ Copy Link</button>
                <button class="btn-close" onclick="openOAuthUrl()">ğŸŒ Open Link</button>
                <button class="btn-close" onclick="closeOAuthModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- User Listing & Actions -->
    <div class="section">
        <h3>ğŸ§‘â€ğŸ’» User Listing & Basic Actions</h3>
        
        <div class="button-row">
            <button onclick="retrieveUsers()">ğŸ“Š Retrieve All Users</button>
            <button onclick="clearUserList()">ğŸ§¹ Clear List</button>
            <button onclick="copyAllUsers()">ğŸ“‹ Copy All</button>
        </div>
        
        <div id="user-display" class="data-display">
            <div class="status-info">
                <p><strong>ğŸ‘¥ User Management</strong></p>
                <p>Click "ğŸ“Š Retrieve All Users" to load and display all users from your Google Workspace.</p>
                <p><small>This will show user status (Active/Suspended), admin privileges, and provide options for bulk operations.</small></p>
            </div>
        </div>
        
        <div id="user-count" class="count-display">Total Users: 0</div>
        
        <div class="form-row">
            <input type="password" id="new-password" placeholder="New password for all users" autocomplete="new-password" readonly onfocus="this.removeAttribute('readonly');">
            <button onclick="updateAllPasswords()">ğŸ”‘ Update Password (All)</button>
        </div>
    </div>

    <!-- Domain Management -->
    <div class="section">
        <h3>ğŸŒ Domain Management</h3>
        
        <div class="button-row">
            <button onclick="retrieveDomains()">ğŸ” Retrieve Domains</button>
            <button onclick="clearDomainDisplay()">ğŸ§¹ Clear Display</button>
        </div>
        
        <div id="domain-display" class="data-display">
            <div class="status-info">
                <p><strong>ğŸŒ Domain Information</strong></p>
                <p>Click "ğŸ” Retrieve Domains" to load and display all domains in your Google Workspace.</p>
            </div>
        </div>
        
        <div class="form-row">
            <button onclick="loadSuspendedUsers()">ğŸ” Load Suspended Users</button>
            <button onclick="copySuspendedUsers()">ğŸ“‹ Copy Selected</button>
            <button onclick="refreshSuspendedUsers()" class="secondary-button">ğŸ”„ Refresh Status</button>
            <button onclick="clearSuspendedUsers()" class="secondary-button">ğŸ§¹ Clear Display</button>
        </div>
        
        <div id="suspended-users-display" class="data-display">
            <div class="status-info">
                <p><strong>â¸ï¸ Suspended Users</strong></p>
                <p>Click "ğŸ” Load Suspended Users" to display all suspended users in your workspace.</p>
            </div>
        </div>
    </div>
</div>

<!-- Tab 2: User Create/Delete/Domain -->
<div id="tab2" class="tab-content">
    <div class="section">
        <h3>â•âœï¸ User Create/Delete/Domain</h3>
        
        <div class="form-row">
            <input type="text" id="new-user-first-name" placeholder="First Name">
            <input type="text" id="new-user-last-name" placeholder="Last Name">
            <input type="email" id="new-user-email" placeholder="Email">
            <input type="password" id="new-user-password" placeholder="Password">
            <button onclick="createSingleUser()">â• Create User</button>
        </div>
        
        <div class="button-row">
            <button onclick="getDomainInfo()">ğŸ” Retrieve Domains</button>
        </div>
        
        <div class="form-row">
            <input type="text" id="domain-alias" placeholder="Domain Alias">
            <button onclick="addDomainAlias()">â• Add Domain Alias</button>
        </div>
        
        <div class="button-row">
            <button onclick="createUsersFromCSV()">ğŸ“¥ Create Users from CSV</button>
            <input type="file" id="csv-file-input" accept=".csv" style="display: none;">
        </div>
        
        <div class="form-row">
            <input type="number" id="random-user-count" placeholder="Number of users" min="1" max="100">
            <input type="text" id="random-user-domain" placeholder="Domain">
            <button onclick="createRandomUsers()">ğŸ² Create Random Users</button>
        </div>
        
        <div class="form-row">
            <input type="text" id="old-domain" placeholder="Old Domain">
            <input type="text" id="new-domain" placeholder="New Domain">
            <button onclick="changeDomainForUsers()">ğŸ”„ Change Domain for These Users</button>
        </div>
        
        <div class="button-row">
            <button onclick="deleteSpecificUsers()" class="delete-button">âŒ Delete These Users</button>
        </div>
        
        <div id="results-log" class="log-display"></div>
        
        <div class="button-row">
            <button onclick="clearResultsLog()">ğŸ§¹ Clear Log</button>
            <button onclick="copyResultsLog()">ğŸ“‹ Copy Log</button>
        </div>
    </div>
</div>

<!-- Tab 3: Bulk Domain Change -->
<div id="tab3" class="tab-content">
    <div class="section">
        <h3>ğŸ”„ Bulk Domain Change</h3>
        
        <div class="button-row">
            <button onclick="downloadAllUsersCSV()" class="primary-button">ğŸ“¥ Download All Users</button>
        </div>
        
        <div class="form-row">
            <input type="text" id="csv-domain-filter" placeholder="Filter by domain (optional)">
            <input type="text" id="csv-password" placeholder="Default password" value="DefaultPass123">
        </div>
        
        <div class="button-row">
            <button onclick="retrieveAvailableDomains()" class="secondary-button">ğŸ” Retrieve Available Domains</button>
            <button onclick="getDomainUsageStats()" class="info-button">ğŸ“Š Domain Usage Stats</button>
            <button onclick="clearOldDomainData()" class="warning-button">ğŸ—‘ï¸ Clear Old Data</button>
            <button onclick="applySelectedDomainToCSV()" class="primary-button">âœ… Apply Selected Domain to CSV</button>
            <button onclick="debugDomainUsers()" class="debug-button">ğŸ› Debug Domain Users</button>
        </div>
        
        <div id="available-domains-display" class="data-display">
            <div class="status-info">
                <p><strong>ğŸŒ Available Domains</strong></p>
                <p>Click "ğŸ” Retrieve Available Domains" to load all domains in your workspace.</p>
            </div>
        </div>
        
        <div class="form-row">
            <input type="file" id="csv-file-input-bulk" accept=".csv" style="display: none;">
            <button onclick="browseCSVFile()" class="secondary-button">ğŸ“ Browse Manually...</button>
        </div>
        
        <div class="button-row">
            <button onclick="processDomainChangesFromCSV()" class="primary-button">âš™ï¸ Process Domain Changes from CSV</button>
        </div>
        
        <div class="form-row">
            <input type="text" id="bulk-old-domain" placeholder="Old Domain">
            <input type="text" id="bulk-new-domain" placeholder="New Domain">
            <button onclick="changeDomainForAllUsers()" class="warning-button">ğŸ”„ Change Domain for ALL Matching Users (Non-Admin)</button>
        </div>
        
        <div id="bulk-domain-log" class="log-display"></div>
        
        <div class="button-row">
            <button onclick="clearBulkDomainLog()" class="secondary-button">ğŸ§¹ Clear Log</button>
        </div>
    </div>
</div>

<!-- Tab 4: SMTP & CSV Gen -->
<div id="tab4" class="tab-content">
    <div class="section">
        <h3>âœ‰ï¸ SMTP & CSV Generation</h3>
        
        <div class="form-row">
            <input type="text" id="smtp-server" placeholder="SMTP Server">
            <input type="number" id="smtp-port" placeholder="Port" value="587">
            <input type="text" id="smtp-username" placeholder="Username">
            <input type="password" id="smtp-password" placeholder="Password">
            <input type="email" id="test-email" placeholder="Test Email">
        </div>
        
        <div class="button-row">
            <button onclick="testSMTPCredentials()">âœ‰ï¸ Send Test Emails</button>
            <button onclick="interruptSMTPTesting()" class="button-warning">â¹ï¸ Interrupt Sending</button>
            <button onclick="clearSMTPResults()">ğŸ§¹ Clear Log / Reset Files</button>
        </div>
        
        <div id="smtp-results" class="log-display"></div>
        
        <div class="form-row">
            <input type="number" id="csv-num-users" placeholder="Number of users" min="1" max="1000" value="10">
            <input type="text" id="csv-domain" placeholder="Domain" value="example.com">
            <input type="password" id="csv-password" placeholder="Password" value="DefaultPass123">
        </div>
        
        <div class="button-row">
            <button onclick="generateUserCSV()">ğŸ“¥ Generate CSV File</button>
            <button onclick="previewCSV()">ğŸ‘ï¸ Preview CSV</button>
        </div>
        
        <div id="csv-preview-area" class="data-display"></div>
        
        <div class="form-row">
            <input type="text" id="email-subject" placeholder="Email Subject">
            <textarea id="email-body" placeholder="Email Body (use {email}, {password}, {first_name}, {last_name} as placeholders)"></textarea>
        </div>
        
        <div class="button-row">
            <button onclick="generateEmailTemplate()">ğŸ“§ Generate Template</button>
            <button onclick="testEmailTemplate()">ğŸ§ª Test Template</button>
        </div>
        
        <div id="email-template-preview" class="data-display"></div>
    </div>
</div>

<script>
// Global variables
let isAuthenticated = false;
let currentAccountName = '';
let currentAccountId = null;

// Test function
function testFunction() {
    console.log('testFunction() called - JavaScript is working!');
    alert('JavaScript is working!');
}

// Simple test to check if basic JavaScript works
console.log('Dashboard script loaded');

// Basic function definitions to prevent errors
function openAddAccountModal() {
    console.log('openAddAccountModal() called');
    alert('Add account modal will be implemented');
}

function addFromServerJSON() {
    console.log('addFromServerJSON() called');
    alert('Add from server JSON will be implemented');
}

function forceTokenStatusCheck() {
    console.log('forceTokenStatusCheck() called');
    alert('Token status check will be implemented');
}

function enterAuthorizationCode() {
    console.log('enterAuthorizationCode() called');
    alert('Enter authorization code will be implemented');
}

function selectAccountFromList(accountName, accountId) {
    console.log('selectAccountFromList() called:', accountName, accountId);
    alert('Account selected: ' + accountName);
}

function authenticateFromList() {
    authenticateAccount();
}

function deleteFromList() {
    alert('Delete account functionality will be implemented');
}

function filterAccounts() {
    alert('Filter accounts functionality will be implemented');
}

function closeAddAccountModal() {
    alert('Close modal functionality will be implemented');
}

function saveNewAccount() {
    alert('Save account functionality will be implemented');
}

function retrieveUsers() {
    alert('Retrieve users functionality will be implemented');
}

function clearUserList() {
    alert('Clear user list functionality will be implemented');
}

function copyAllUsers() {
    alert('Copy all users functionality will be implemented');
}

function updateAllPasswords() {
    alert('Update all passwords functionality will be implemented');
}

function retrieveDomains() {
    alert('Retrieve domains functionality will be implemented');
}

function clearDomainDisplay() {
    alert('Clear domain display functionality will be implemented');
}

function loadSuspendedUsers() {
    alert('Load suspended users functionality will be implemented');
}

function copySuspendedUsers() {
    alert('Copy suspended users functionality will be implemented');
}

function refreshSuspendedUsers() {
    alert('Refresh suspended users functionality will be implemented');
}

function clearSuspendedUsers() {
    alert('Clear suspended users functionality will be implemented');
}

// Tab switching function
function showTab(tabId) {
    console.log('showTab() called with tabId:', tabId);
    
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remove active class from all buttons
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab
    const targetTab = document.getElementById(tabId);
    if (targetTab) {
        targetTab.classList.add('active');
        console.log('Tab activated:', tabId);
    } else {
        console.error('Tab not found:', tabId);
    }
    
    // Mark button as active
    if (event && event.target) {
        event.target.classList.add('active');
    }
}

// Results log functions
function logResult(message) {
    const log = document.getElementById('results-log');
    if (log) {
        const timestamp = new Date().toLocaleTimeString();
        log.textContent += `[${timestamp}] ${message}\n`;
        log.scrollTop = log.scrollHeight;
    }
}

function clearResultsLog() {
    const log = document.getElementById('results-log');
    if (log) log.textContent = '';
}

// Authentication functions
function authenticateAccount() {
    console.log('authenticateAccount() called');
    const select = document.getElementById('account-select');
    const accountName = select.value;
    
    console.log('Selected account:', accountName);
    
    if (!accountName) {
        alert('Please select an account first');
        return;
    }
    
    // Get the account ID from the selected option
    const selectedOption = select.querySelector(`option[value="${accountName}"]`);
    const accountId = selectedOption ? selectedOption.getAttribute('data-account-id') : null;
    
    if (!accountId) {
        alert('Account ID not found. Please refresh the page and try again.');
        return;
    }
    
    console.log('DEBUG: Authenticating account:', accountName, 'ID:', accountId);
    updateAuthStatus(accountName, false, 'Authenticating...');
    
    fetch('/api/authenticate', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({account_id: accountId, account_name: accountName})
    })
    .then(response => response.json())
    .then(data => {
        console.log('DEBUG: API response:', data);
        
        if (data.success) {
            updateAuthStatus(accountName, true, data.message);
            isAuthenticated = true;
            currentAccountName = accountName;
            currentAccountId = accountId;
            
            // Store the authenticated account in sessionStorage for persistence
            sessionStorage.setItem('current_account_name', accountName);
            
        } else if (data.oauth_required && data.oauth_url) {
            console.log('DEBUG: OAuth URL received:', data.oauth_url);
            updateAuthStatus(accountName, false, 'OAuth URL generated - opening...');
            showOAuthModal(data.oauth_url);
            
        } else {
            console.error('DEBUG: Authentication failed:', data.error);
            updateAuthStatus(accountName, false, data.error || 'Authentication failed');
        }
    })
    .catch(error => {
        console.error('DEBUG: Network error:', error);
        updateAuthStatus(accountName, false, 'Network error: ' + error);
    });
}

function updateAuthStatus(account, authenticated, message) {
    const statusBox = document.getElementById('auth-status');
    if (statusBox) {
        if (authenticated) {
            statusBox.innerHTML = `<p style="color: green;">âœ… ${message || 'Authenticated'}</p>`;
            statusBox.className = 'status-box success';
        } else {
            statusBox.innerHTML = `<p style="color: red;">âŒ ${message || 'Not authenticated'}</p>`;
            statusBox.className = 'status-box error';
        }
    }
}

// Modal functions
function openAddAccountModal() {
    console.log('openAddAccountModal() called');
    const modal = document.getElementById('addAccountModal');
    if (modal) modal.style.display = 'block';
}

function closeAddAccountModal() {
    const modal = document.getElementById('addAccountModal');
    if (modal) modal.style.display = 'none';
}

function showOAuthModal(authUrl) {
    const modal = document.getElementById('oauthModal');
    const urlDiv = document.getElementById('oauthUrl');
    if (modal && urlDiv) {
        urlDiv.textContent = authUrl;
        modal.style.display = 'block';
    }
}

function closeOAuthModal() {
    const modal = document.getElementById('oauthModal');
    if (modal) modal.style.display = 'none';
}

function copyOAuthUrl() {
    const urlDiv = document.getElementById('oauthUrl');
    if (urlDiv) {
        navigator.clipboard.writeText(urlDiv.textContent).then(() => {
            alert('OAuth URL copied to clipboard!');
        });
    }
}

function openOAuthUrl() {
    const urlDiv = document.getElementById('oauthUrl');
    if (urlDiv) {
        window.open(urlDiv.textContent, '_blank');
    }
}

// Account management functions
function selectAccountFromList(accountName, accountId) {
    console.log('selectAccountFromList() called:', accountName, accountId);
    // Update the dropdown selection
    const select = document.getElementById('account-select');
    if (select) {
        select.value = accountName;
    }
}

function authenticateFromList() {
    authenticateAccount();
}

function deleteFromList() {
    const select = document.getElementById('account-select');
    const accountName = select.value;
    
    if (!accountName) {
        alert('Please select an account first');
        return;
    }
    
    if (confirm(`Are you sure you want to delete account: ${accountName}?`)) {
        // Implementation for delete
        alert('Delete functionality will be implemented');
    }
}

function saveNewAccount() {
    const email = document.getElementById('new-account-email').value;
    const clientId = document.getElementById('new-client-id').value;
    const clientSecret = document.getElementById('new-client-secret').value;
    
    if (!email || !clientId || !clientSecret) {
        alert('Please fill in all fields');
        return;
    }
    
    fetch('/api/add-account', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            account_name: email,
            client_id: clientId,
            client_secret: clientSecret
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Account added successfully!');
            closeAddAccountModal();
            location.reload();
        } else {
            alert('Failed to add account: ' + data.error);
        }
    })
    .catch(error => {
        alert('Network error: ' + error);
    });
}

// User management functions
function retrieveUsers() {
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    logResult('ğŸ“Š Retrieving users...');
    
    fetch('/api/retrieve-users', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            account_name: currentAccountName
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            logResult(`âœ… Retrieved ${data.users.length} users`);
            displayUsers(data.users);
        } else {
            logResult(`âŒ Failed to retrieve users: ${data.error}`);
        }
    })
    .catch(error => {
        logResult(`âŒ Network error: ${error}`);
    });
}

function displayUsers(users) {
    const display = document.getElementById('user-display');
    const count = document.getElementById('user-count');
    
    if (display) {
        let html = '<div class="user-list">';
        users.forEach(user => {
            html += `
                <div class="user-item">
                    <strong>${user.name.fullName}</strong> (${user.primaryEmail})
                    <br><small>Status: ${user.suspended ? 'Suspended' : 'Active'}</small>
                </div>
            `;
        });
        html += '</div>';
        display.innerHTML = html;
    }
    
    if (count) {
        count.textContent = `Total Users: ${users.length}`;
    }
}

function clearUserList() {
    const display = document.getElementById('user-display');
    const count = document.getElementById('user-count');
    
    if (display) {
        display.innerHTML = '<div class="status-info"><p><strong>ğŸ‘¥ User Management</strong></p><p>Click "ğŸ“Š Retrieve All Users" to load and display all users from your Google Workspace.</p></div>';
    }
    
    if (count) {
        count.textContent = 'Total Users: 0';
    }
}

function copyAllUsers() {
    const userElements = document.querySelectorAll('.user-item');
    const emails = Array.from(userElements).map(element => {
        const emailMatch = element.textContent.match(/\(([^)]+)\)/);
        return emailMatch ? emailMatch[1] : '';
    }).filter(email => email);
    
    if (emails.length > 0) {
        navigator.clipboard.writeText(emails.join('\n')).then(() => {
            alert(`Copied ${emails.length} email addresses to clipboard!`);
        });
    } else {
        alert('No users to copy');
    }
}

function updateAllPasswords() {
    const newPassword = document.getElementById('new-password').value;
    
    if (!newPassword) {
        alert('Please enter a new password');
        return;
    }
    
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    logResult('ğŸ”‘ Updating passwords for all users...');
    
    fetch('/api/update-all-passwords', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            account_name: currentAccountName,
            new_password: newPassword
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            logResult(`âœ… Password update completed. ${data.successful} successful, ${data.failed} failed`);
        } else {
            logResult(`âŒ Password update failed: ${data.error}`);
        }
    })
    .catch(error => {
        logResult(`âŒ Network error: ${error}`);
    });
}

// Domain management functions
function retrieveDomains() {
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    logResult('ğŸ” Retrieving domains...');
    
    fetch('/api/retrieve-domains', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            account_name: currentAccountName
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            logResult(`âœ… Retrieved ${data.domains.length} domains`);
            displayDomains(data.domains);
        } else {
            logResult(`âŒ Failed to retrieve domains: ${data.error}`);
        }
    })
    .catch(error => {
        logResult(`âŒ Network error: ${error}`);
    });
}

function displayDomains(domains) {
    const display = document.getElementById('domain-display');
    
    if (display) {
        let html = '<div class="domain-list">';
        domains.forEach(domain => {
            html += `
                <div class="domain-item">
                    <strong>${domain.domainName}</strong>
                    <br><small>Verified: ${domain.verified ? 'Yes' : 'No'}</small>
                </div>
            `;
        });
        html += '</div>';
        display.innerHTML = html;
    }
}

function clearDomainDisplay() {
    const display = document.getElementById('domain-display');
    
    if (display) {
        display.innerHTML = '<div class="status-info"><p><strong>ğŸŒ Domain Information</strong></p><p>Click "ğŸ” Retrieve Domains" to load and display all domains in your Google Workspace.</p></div>';
    }
}

function loadSuspendedUsers() {
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    logResult('ğŸ” Loading suspended users...');
    
    fetch('/api/load-suspended-users', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            account_name: currentAccountName
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            logResult(`âœ… Loaded ${data.users.length} suspended users`);
            displaySuspendedUsers(data.users);
        } else {
            logResult(`âŒ Failed to load suspended users: ${data.error}`);
        }
    })
    .catch(error => {
        logResult(`âŒ Network error: ${error}`);
    });
}

function displaySuspendedUsers(users) {
    const display = document.getElementById('suspended-users-display');
    
    if (display) {
        if (users.length === 0) {
            display.innerHTML = '<div class="status-info"><p><strong>â¸ï¸ Suspended Users</strong></p><p>No suspended users found.</p></div>';
        } else {
            let html = '<div class="suspended-users-list">';
            users.forEach(user => {
                html += `
                    <div class="user-item">
                        <strong>${user.name.fullName}</strong> (${user.primaryEmail})
                        <br><small>Suspended: ${user.suspensionReason || 'Unknown reason'}</small>
                    </div>
                `;
            });
            html += '</div>';
            display.innerHTML = html;
        }
    }
}

function copySuspendedUsers() {
    const userElements = document.querySelectorAll('.suspended-users-list .user-item');
    const emails = Array.from(userElements).map(element => {
        const emailMatch = element.textContent.match(/\(([^)]+)\)/);
        return emailMatch ? emailMatch[1] : '';
    }).filter(email => email);
    
    if (emails.length > 0) {
        navigator.clipboard.writeText(emails.join('\n')).then(() => {
            alert(`Copied ${emails.length} suspended user emails to clipboard!`);
        });
    } else {
        alert('No suspended users to copy');
    }
}

function refreshSuspendedUsers() {
    loadSuspendedUsers();
}

function clearSuspendedUsers() {
    const display = document.getElementById('suspended-users-display');
    
    if (display) {
        display.innerHTML = '<div class="status-info"><p><strong>â¸ï¸ Suspended Users</strong></p><p>Click "ğŸ” Load Suspended Users" to display all suspended users in your workspace.</p></div>';
    }
}

// Other functions (placeholder implementations)
function enterAuthorizationCode() {
    const code = prompt('Enter authorization code:');
    if (code) {
        alert('Authorization code functionality will be implemented');
    }
}

function forceTokenStatusCheck() {
    alert('Token status check functionality will be implemented');
}

function addFromServerJSON() {
    alert('Add from server JSON functionality will be implemented');
}

function filterAccounts() {
    alert('Filter accounts functionality will be implemented');
}

function createSingleUser() {
    alert('Create single user functionality will be implemented');
}

function getDomainInfo() {
    alert('Get domain info functionality will be implemented');
}

function addDomainAlias() {
    alert('Add domain alias functionality will be implemented');
}

function createUsersFromCSV() {
    alert('Create users from CSV functionality will be implemented');
}

function createRandomUsers() {
    alert('Create random users functionality will be implemented');
}

function changeDomainForUsers() {
    alert('Change domain for users functionality will be implemented');
}

function deleteSpecificUsers() {
    alert('Delete specific users functionality will be implemented');
}

function copyResultsLog() {
    const log = document.getElementById('results-log');
    if (log && log.textContent) {
        navigator.clipboard.writeText(log.textContent).then(() => {
            alert('Results log copied to clipboard!');
        });
    } else {
        alert('No results to copy');
    }
}

function downloadAllUsersCSV() {
    alert('Download all users CSV functionality will be implemented');
}

function retrieveAvailableDomains() {
    alert('Retrieve available domains functionality will be implemented');
}

function getDomainUsageStats() {
    alert('Get domain usage stats functionality will be implemented');
}

function clearOldDomainData() {
    alert('Clear old domain data functionality will be implemented');
}

function applySelectedDomainToCSV() {
    alert('Apply selected domain to CSV functionality will be implemented');
}

function debugDomainUsers() {
    alert('Debug domain users functionality will be implemented');
}

function browseCSVFile() {
    alert('Browse CSV file functionality will be implemented');
}

function processDomainChangesFromCSV() {
    alert('Process domain changes from CSV functionality will be implemented');
}

function changeDomainForAllUsers() {
    alert('Change domain for all users functionality will be implemented');
}

function clearBulkDomainLog() {
    const log = document.getElementById('bulk-domain-log');
    if (log) log.textContent = '';
}

function testSMTPCredentials() {
    alert('Test SMTP credentials functionality will be implemented');
}

function interruptSMTPTesting() {
    alert('Interrupt SMTP testing functionality will be implemented');
}

function clearSMTPResults() {
    const results = document.getElementById('smtp-results');
    if (results) results.textContent = '';
}

function generateUserCSV() {
    alert('Generate user CSV functionality will be implemented');
}

function previewCSV() {
    alert('Preview CSV functionality will be implemented');
}

function generateEmailTemplate() {
    alert('Generate email template functionality will be implemented');
}

function testEmailTemplate() {
    alert('Test email template functionality will be implemented');
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('Dashboard loaded, initializing...');
    
    // Test if basic JavaScript is working
    console.log('Testing basic JavaScript functionality...');
    testFunction();
    
    // Add click event listeners for debugging
    console.log('Adding event listeners...');
    
    // Test if buttons are clickable
    document.addEventListener('click', function(e) {
        console.log('Click detected on:', e.target.tagName, e.target.className, e.target.id);
    });
    
    // Test if functions are defined
    console.log('Function availability check:');
    console.log('showTab function:', typeof showTab);
    console.log('authenticateAccount function:', typeof authenticateAccount);
    console.log('openAddAccountModal function:', typeof openAddAccountModal);
});

// Close modals when clicking outside
window.onclick = function(event) {
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    });
}
</script>
{% endblock %}
