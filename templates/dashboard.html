{% extends "base.html" %}
{% block title %}Dashboard - GBot Web{% endblock %}

{% block content %}
<!-- Tab Navigation -->
<div class="tab-navigation">
    <nav>
        <button class="tab-button active" onclick="showTab('tab1')">
            <i class="fas fa-user-friends"></i>
            <span>Account & User Mgmt</span>
        </button>
        <button class="tab-button" onclick="showTab('tab2')">
            <i class="fas fa-user-plus"></i>
            <span>User Create/Delete/Domain</span>
        </button>
        <button class="tab-button" onclick="showTab('tab3')">
            <i class="fas fa-exchange-alt"></i>
            <span>Bulk Domain Change & SMTP/CSV</span>
        </button>
    </nav>
</div>

<!-- Tab 1: Account & User Management (existing content) -->
<div id="tab1" class="tab-content active">    
<!-- Account Selection & Authentication -->
<div class="github-card">
    <div class="github-card-header">
        <h3 class="github-card-title">
            <i class="fas fa-user-friends"></i>
            Account Selection & Authentication
        </h3>
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr auto; gap: 16px; align-items: end; margin-bottom: 20px;">
        <div class="form-group-github">
            <label for="account-select" class="form-label-github">
                <i class="fas fa-user-circle"></i> Select Account
            </label>
            <select id="account-select" class="form-control-github">
            <option value="">Choose an account...</option>
                {% for account in accounts %}
                <option value="{{ account.account_name }}" data-account-id="{{ account.id }}">{{ account.account_name }}</option>
            {% endfor %}
        </select>
        </div>
        <button onclick="authenticateAccount()" class="btn-github btn-github-primary">
            <i class="fas fa-key"></i> Authenticate Selected
        </button>
    </div>
    
    <div style="display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 20px;">
        {% if session.role != 'mailer' %}
        <button onclick="openAddAccountModal()" class="btn-github">
            <i class="fas fa-plus"></i> Add Manually
        </button>
        <button onclick="addFromServerJSON()" class="btn-github">
            <i class="fas fa-folder-open"></i> Add from Server JSON
        </button>
        {% endif %}
        {% if session.role == 'admin' %}
        <button onclick="forceTokenStatusCheck()" class="btn-github" style="background-color: var(--color-warning-emphasis); border-color: var(--color-warning-emphasis); color: #ffffff;">
            <i class="fas fa-search"></i> Check Token Status Now (Admin)
        </button>
        {% endif %}    
        <button onclick="enterAuthorizationCode()" class="btn-github">
            <i class="fas fa-code"></i> Enter Authorization Code
        </button>
    </div>
    
    <!-- Search and Account List Area -->
    <div class="account-management-area">
        <div class="search-and-list">
            <input type="text" id="account-search" placeholder="Search accounts in list..." 
                    oninput="filterAccounts()" class="search-input" 
                    autocomplete="off" autocomplete="nope" readonly onfocus="this.removeAttribute('readonly');">
            
            <div id="account-list-area" class="account-list">
                {% for account in accounts %}
                <div class="account-item" data-account-name="{{ account.account_name }}" data-account-id="{{ account.id }}" onclick="selectAccountFromList(this.dataset.accountName, this.dataset.accountId)">
                    {{ account.account_name }}
                </div>
                {% endfor %}
            </div>
        </div>
        
        <div class="account-actions">
            <button onclick="authenticateFromList()" class="action-button" style="height: 50px; font-size: 12px;">
                <i class="fas fa-key"></i> Authenticate<br>(List Selection)
            </button>
            {% if session.role == 'admin' %}
            <button onclick="openBulkDeleteModal()" class="action-button delete-button" style="background-color: #dc3545; border-color: #dc3545; height: 50px; font-size: 12px;">
                <i class="fas fa-trash"></i> Bulk Delete<br>(Admin Only)
            </button>
            {% endif %}
            <button onclick="deleteFromList()" class="action-button delete-button" style="height: 50px; font-size: 12px;">
                <i class="fas fa-trash"></i> Delete Account<br>(List Selection)
            </button>
        </div>
    </div>
    <div id="account-count-display" class="count-display">
        <span id="account-stats">Loading account statistics...</span>
    </div>
    <div id="auth-status" class="status-box">
        <p>No account authenticated</p>
    </div>
</div>

<!-- Add Account Modal -->
<div id="addAccountModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">
                <i class="fas fa-plus"></i> Add Account Manually
            </h3>
            <button type="button" class="btn-github" onclick="closeAddAccountModal()" style="margin-left: auto;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
        <form id="addAccountForm">
                <div class="form-group-github">
                    <label for="new-account-email" class="form-label-github">
                        <i class="fas fa-envelope"></i> Account Email
                    </label>
                    <input type="email" id="new-account-email" class="form-control-github" required placeholder="admin@yourdomain.com">
            </div>
                <div class="form-group-github">
                    <label for="new-client-id" class="form-label-github">
                        <i class="fas fa-key"></i> Client ID
                    </label>
                    <input type="text" id="new-client-id" class="form-control-github" required placeholder="123456789-abcdef.apps.googleusercontent.com">
            </div>
                <div class="form-group-github">
                    <label for="new-client-secret" class="form-label-github">
                        <i class="fas fa-lock"></i> Client Secret
                    </label>
                    <input type="password" id="new-client-secret" class="form-control-github" required placeholder="GOCSPX-your_client_secret">
            </div>
        </form>
        </div>
        <div class="modal-footer">
            <button type="button" onclick="saveNewAccount()" class="btn-github btn-github-primary">
                <i class="fas fa-save"></i> Save Account
            </button>
            <button type="button" onclick="closeAddAccountModal()" class="btn-github">
                <i class="fas fa-times"></i> Cancel
            </button>
        </div>
    </div>
</div>



<!-- OAuth Authorization Modal -->
<div id="oauthModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">
                <i class="fas fa-link"></i> OAuth Authorization Required
            </h3>
            <button type="button" class="btn-github" onclick="closeOAuthModal()" style="margin-left: auto;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <p>Please copy this link and open it in your browser to authorize the account:</p>
            <div id="oauthUrl" class="data-display" style="font-family: monospace; word-break: break-all; margin: 16px 0;"></div>
            <div style="background-color: rgba(9, 105, 218, 0.1); border: 1px solid var(--color-accent-emphasis); border-radius: 6px; padding: 12px; color: var(--color-accent-fg); font-size: 14px;">
                <i class="fas fa-lightbulb"></i>
                <strong>Tip:</strong> You can copy this link to use in another browser or app for authorization.
            </div>
        </div>
        <div class="modal-footer">
            <button onclick="copyOAuthUrl()" class="btn-github">
                <i class="fas fa-copy"></i> Copy Link
            </button>
            <button onclick="openOAuthUrl()" class="btn-github btn-github-primary">
                <i class="fas fa-external-link-alt"></i> Open Link
            </button>
            <button onclick="closeOAuthModal()" class="btn-github">
                <i class="fas fa-times"></i> Close
            </button>
        </div>
    </div>
</div>

<!-- Bulk Delete Accounts Modal -->
<div id="bulkDeleteModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">
                <i class="fas fa-trash-alt"></i> Bulk Delete Accounts
            </h3>
            <button type="button" class="btn-github" onclick="closeBulkDeleteModal()" style="margin-left: auto;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div style="background-color: rgba(220, 53, 69, 0.1); border: 1px solid #dc3545; border-radius: 6px; padding: 12px; margin-bottom: 16px; color: #dc3545;">
                <i class="fas fa-exclamation-triangle"></i>
                <strong>Warning:</strong> This action will permanently delete the specified accounts. This cannot be undone!
            </div>
            
            <div class="form-group-github">
                <label for="bulkDeleteAccounts" class="form-label-github">
                    <i class="fas fa-list"></i> Account Names (one per line)
                </label>
                <textarea id="bulkDeleteAccounts" class="form-control-github" rows="8" 
                          placeholder="Enter account names, one per line:&#10;admin@domain1.com&#10;user@domain2.com&#10;manager@domain3.com"
                          style="font-family: 'Courier New', monospace; font-size: 14px;"></textarea>
                <small style="color: #656d76; font-size: 12px;">
                    Enter the exact account names (email addresses) that you want to delete, one per line.
                </small>
            </div>
            
            <div id="bulkDeleteProgress" style="display: none; margin-top: 16px;">
                <div style="background: #f6f8fa; border-radius: 6px; padding: 16px; border: 1px solid #d0d7de;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span id="bulkDeleteStatus">Processing...</span>
                        <span id="bulkDeleteCount">0/0</span>
                    </div>
                    <div style="background: #e1e4e8; border-radius: 6px; height: 8px; overflow: hidden;">
                        <div id="bulkDeleteProgressBar" style="background: #dc3545; height: 100%; width: 0%; transition: width 0.3s; border-radius: 6px;"></div>
                    </div>
                </div>
            </div>
            
            <div id="bulkDeleteResults" style="display: none; margin-top: 16px;">
                <h6 style="font-weight: 600; margin-bottom: 8px; color: #24292f;">
                    <i class="fas fa-list-check"></i> Deletion Results
                </h6>
                <div id="bulkDeleteResultsContent" style="background: #f6f8fa; padding: 12px; border-radius: 6px; border: 1px solid #d0d7de; max-height: 200px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 12px;">
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button onclick="executeBulkDelete()" class="btn-github btn-github-danger" id="bulkDeleteExecuteBtn">
                <i class="fas fa-trash-alt"></i> Delete Accounts
            </button>
            <button onclick="closeBulkDeleteModal()" class="btn-github">
                <i class="fas fa-times"></i> Cancel
            </button>
        </div>
    </div>
</div>

    <!-- User Listing & Actions -->
<div class="github-card">
    <div class="github-card-header">
        <h3 class="github-card-title">
            <i class="fas fa-users"></i>
            User Listing & Basic Actions
        </h3>
    </div>
        
        <div class="button-row">
        <button onclick="retrieveUsers()" class="btn-github btn-github-primary">
            <i class="fas fa-chart-bar"></i> Retrieve All Users
        </button>
        <button onclick="clearUserList()" class="btn-github">
            <i class="fas fa-broom"></i> Clear List
        </button>
        <button onclick="copyAllUsers()" class="btn-github">
            <i class="fas fa-copy"></i> Copy All
        </button>
        </div>
        
        <div id="user-display" class="data-display">
        <div class="status-info">
            <p><strong><i class="fas fa-users"></i> User Management</strong></p>
            <p>Click "Retrieve All Users" to load and display all users from your Google Workspace.</p>
            <p><small>This will show user status (Active/Suspended), admin privileges, and provide options for bulk operations.</small></p>
        </div>
        </div>
        
        <!-- Individual User Actions -->
        <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 16px; align-items: end; margin-top: 16px;">
            <div class="form-group-github">
                <label for="suspend-user-email" class="form-label-github">
                    <i class="fas fa-user-slash"></i> Suspend User
                </label>
                <input type="email" id="suspend-user-email" class="form-control-github" placeholder="user@domain.com">
            </div>
            <div class="form-group-github">
                <label for="unsuspend-user-email" class="form-label-github">
                    <i class="fas fa-user-check"></i> Unsuspend User
                </label>
                <input type="email" id="unsuspend-user-email" class="form-control-github" placeholder="user@domain.com">
            </div>
            <div style="display: flex; gap: 8px;">
                <button onclick="suspendUser()" class="btn-github btn-github-warning">
                    <i class="fas fa-user-slash"></i> Suspend
                </button>
                <button onclick="unsuspendUser()" class="btn-github btn-github-success">
                    <i class="fas fa-user-check"></i> Unsuspend
                </button>
            </div>
        </div>
        
        
        <div id="user-count" class="count-display">Total Users: 0</div>
        
    <div style="display: grid; grid-template-columns: 1fr auto; gap: 16px; align-items: end; margin-top: 16px;">
        <div class="form-group-github">
            <label for="new-password" class="form-label-github">
                <i class="fas fa-lock"></i> New Password for All Users
            </label>
            <input type="password" id="new-password" class="form-control-github" placeholder="Enter new password for all users" autocomplete="new-password" readonly onfocus="this.removeAttribute('readonly');">
        </div>
        <button onclick="updateAllPasswords()" class="btn-github btn-github-danger">
            <i class="fas fa-key"></i> Update Password (All)
        </button>
        </div>
    </div>
    

    <!-- Activity Log Section -->
    <div class="github-card" style="margin-top: 24px;">
        <div class="github-card-header">
            <h3 class="github-card-title">
                <i class="fas fa-list-alt"></i>
                Activity Log
            </h3>
            <div class="button-row">
                <button onclick="clearLogs()" class="btn-github btn-github-secondary" style="font-size: 12px; padding: 4px 8px;">
                    <i class="fas fa-trash"></i> Clear Logs
                </button>
                <button onclick="copyLogs()" class="btn-github" style="font-size: 12px; padding: 4px 8px;">
                    <i class="fas fa-copy"></i> Copy Logs
                </button>
                <button onclick="downloadLogs()" class="btn-github" style="font-size: 12px; padding: 4px 8px;">
                    <i class="fas fa-download"></i> Download
                </button>
            </div>
        </div>
        
        <div id="activity-log" class="log-display" style="
            background: #f8f9fa; 
            border: 1px solid #e1e4e8; 
            border-radius: 6px; 
            padding: 12px; 
            max-height: 300px; 
            overflow-y: auto; 
            font-family: 'Courier New', monospace; 
            font-size: 12px; 
            line-height: 1.4;
            white-space: pre-wrap;
            word-wrap: break-word;
        ">
            <div style="color: #6a737d; font-style: italic;">
                📝 Activity log will appear here...
            </div>
        </div>
        
        <div style="margin-top: 8px; font-size: 11px; color: #6a737d;">
            <i class="fas fa-info-circle"></i> 
            This log shows all user management activities, API calls, and system messages.
        </div>
    </div>

    <!-- Domain Info
    <div class="section">
        <h3>🌐 Domain Info & Subdomain Utility</h3>
        
        <div class="button-row">
            <button onclick="retrieveDomains()">🔍 Retrieve Domains</button>
            <button onclick="clearDomainDisplay()">🧹 Clear Display</button>
        </div>
        
        <div id="domain-display" class="data-display">
            <p>Click 'Retrieve Domains' to view domains here...</p>
        </div>
    </div> -->

    <!-- Suspended Users -->
<div class="github-card">
    <div class="github-card-header">
        <h3 class="github-card-title">
            <i class="fas fa-user-slash"></i>
            Suspended User Management
        </h3>
    </div>
        
        <div class="button-row">
        <button onclick="loadSuspendedUsers()" class="btn-github btn-github-primary">
            <i class="fas fa-search"></i> Load Suspended Users
        </button>
        <button onclick="copySuspendedUsers()" class="btn-github">
            <i class="fas fa-copy"></i> Copy Selected
        </button>
        <button onclick="refreshSuspendedUsers()" class="btn-github">
            <i class="fas fa-sync-alt"></i> Refresh Status
        </button>
        <button onclick="clearSuspendedUsers()" class="btn-github">
            <i class="fas fa-broom"></i> Clear Display
        </button>
        </div>
        
        <div id="suspended-display" class="data-display">
        <div class="status-info">
            <p><strong><i class="fas fa-user-slash"></i> Suspended User Management</strong></p>
            <p>Click "Load Suspended Users" to check for suspended accounts in your Google Workspace.</p>
            <p><small>This will show all users with suspended status, including their names, emails, and admin privileges.</small></p>
        </div>
    </div>
        
        <div id="suspended-count" class="count-display">Suspended Users: 0</div>
        
</div>
</div>

<!-- Tab 2: User Create/Delete/Domain -->
<div id="tab2" class="tab-content">
    
    <!-- Create Single User -->
    <div class="github-card">
        <div class="github-card-header">
            <h3 class="github-card-title">
                <i class="fas fa-user-plus"></i>
                Create Single User
            </h3>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
            <div class="form-group-github">
                <label for="new-user-first-name" class="form-label-github">
                    <i class="fas fa-user"></i> First Name
                </label>
                <input type="text" id="new-user-first-name" class="form-control-github" placeholder="Enter first name">
        </div>
            <div class="form-group-github">
                <label for="new-user-last-name" class="form-label-github">
                    <i class="fas fa-user"></i> Last Name
                </label>
                <input type="text" id="new-user-last-name" class="form-control-github" placeholder="Enter last name">
            </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
            <div class="form-group-github">
                <label for="new-user-email" class="form-label-github">
                    <i class="fas fa-envelope"></i> Email Address
                </label>
                <input type="email" id="new-user-email" class="form-control-github" placeholder="user@domain.com">
            </div>
            <div class="form-group-github">
                <label for="new-user-password" class="form-label-github">
                    <i class="fas fa-lock"></i> Password
                </label>
                <input type="password" id="new-user-password" class="form-control-github" placeholder="Enter password">
            </div>
        </div>
        <button onclick="createSingleUser()" class="btn-github btn-github-primary">
            <i class="fas fa-plus"></i> Create User
        </button>
    </div>

    <!-- Domain Management -->
    <div class="github-card">
        <div class="github-card-header">
            <h3 class="github-card-title">
                <i class="fas fa-globe"></i>
                Domain Management
            </h3>
        </div>
        <div class="button-row">
            <button onclick="getDomainInfo()" class="btn-github btn-github-primary">
                <i class="fas fa-search"></i> Retrieve Domains
            </button>
            <button onclick="refreshDomainStatus()" class="btn-github" style="margin-left: 8px;">
                <i class="fas fa-sync-alt"></i> Refresh Status
            </button>
            <!-- Auto Change Subdomain button moved to Tab 3 Workflow 2 -->
        </div>
        <div id="domain-info-display" class="data-display">
            <div class="status-info">
                <p><strong><i class="fas fa-globe"></i> Domain Information</strong></p>
                <p>Click "Retrieve Domains" to view domains here...</p>
        </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr auto; gap: 16px; align-items: end; margin-top: 16px;">
            <div class="form-group-github">
                <label for="new-domain-alias" class="form-label-github">
                    <i class="fas fa-plus"></i> New Domain Alias
                </label>
                <input type="text" id="new-domain-alias" class="form-control-github" placeholder="Enter new domain alias">
            </div>
            <button onclick="addDomainAlias()" class="btn-github btn-github-primary">
                <i class="fas fa-plus"></i> Add Domain Alias
            </button>
        </div>
    </div>

    <!-- Create Users from CSV File -->
    <div class="github-card">
        <div class="github-card-header">
            <h3 class="github-card-title">
                <i class="fas fa-file-csv"></i>
                Create Users from CSV File
            </h3>
        </div>
        <div style="display: grid; grid-template-columns: 1fr auto; gap: 16px; align-items: end;">
            <div class="form-group-github">
                <label for="csv-file-input" class="form-label-github">
                    <i class="fas fa-file-upload"></i> Select CSV File
                </label>
                <input type="file" id="csv-file-input" class="form-control-github" accept=".csv">
            </div>
            <button onclick="createUsersFromCSV()" class="btn-github btn-github-primary">
                <i class="fas fa-upload"></i> Create Users from CSV
            </button>
        </div>
    </div>

    <!-- Create Random Users -->
    <div class="github-card">
        <div class="github-card-header">
            <h3 class="github-card-title">
                <i class="fas fa-random"></i>
                Create Random Users
            </h3>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 16px; align-items: end;">
            <div class="form-group-github">
                <label for="random-user-count" class="form-label-github">
                    <i class="fas fa-hashtag"></i> Number of Users
                </label>
                <input type="number" id="random-user-count" class="form-control-github" min="1" max="100" placeholder="e.g., 10">
            </div>
            <div class="form-group-github">
                <label for="random-user-domain" class="form-label-github">
                    <i class="fas fa-globe"></i> Domain
                </label>
                <input type="text" id="random-user-domain" class="form-control-github" placeholder="example.com">
            </div>
            <div class="form-group-github">
                <label for="random-user-password" class="form-label-github">
                    <i class="fas fa-lock"></i> Password
                </label>
                <input type="text" id="random-user-password" class="form-control-github" placeholder="Password for all users">
            </div>
            <button onclick="createRandomUsers()" class="btn-github btn-github-primary">
                <i class="fas fa-random"></i> Create Random Users
            </button>
        </div>
    </div>

    <!-- Create Random Admin Users -->
    <div class="github-card">
        <div class="github-card-header">
            <h3 class="github-card-title">
                <i class="fas fa-user-shield"></i>
                Create Random Admin Users
            </h3>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr auto; gap: 16px; align-items: end;">
            <div class="form-group-github">
                <label for="random-admin-count" class="form-label-github">
                    <i class="fas fa-hashtag"></i> Number of Admins
                </label>
                <input type="number" id="random-admin-count" class="form-control-github" min="1" max="50" placeholder="e.g., 5">
            </div>
            <div class="form-group-github">
                <label for="random-admin-domain" class="form-label-github">
                    <i class="fas fa-globe"></i> Domain
                </label>
                <input type="text" id="random-admin-domain" class="form-control-github" placeholder="example.com">
            </div>
            <div class="form-group-github">
                <label for="random-admin-password" class="form-label-github">
                    <i class="fas fa-lock"></i> Password
                </label>
                <input type="text" id="random-admin-password" class="form-control-github" placeholder="Password for all admins">
            </div>
            <div class="form-group-github">
                <label for="admin-role" class="form-label-github">
                    <i class="fas fa-crown"></i> Admin Role
                </label>
                <select id="admin-role" class="form-control-github">
                    <option value="SUPER_ADMIN">Super Admin (Full Access)</option>
                    <option value="USER_MANAGEMENT_ADMIN">User Management Admin</option>
                    <option value="HELP_DESK_ADMIN">Help Desk Admin</option>
                    <option value="SERVICE_ADMIN">Service Admin</option>
                    <option value="BILLING_ADMIN">Billing Admin</option>
                    <option value="SECURITY_ADMIN">Security Admin</option>
                </select>
            </div>
            <button onclick="createRandomAdminUsers()" class="btn-github btn-github-warning">
                <i class="fas fa-user-shield"></i> Create Admin Users
            </button>
        </div>
        <div style="margin-top: 12px; padding: 12px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px;">
            <i class="fas fa-info-circle" style="color: #f39c12; margin-right: 8px;"></i>
            <span style="color: #856404; font-size: 14px;">
                <strong>Note:</strong> Creates users with basic admin privileges. Specific role assignments require Google Admin Console configuration.
            </span>
        </div>
    </div>

    <!-- Update Passwords for Specific Users -->
    <div class="github-card">
        <div class="github-card-header">
            <h3 class="github-card-title">
                <i class="fas fa-key"></i>
                Update Passwords for Specific Users
            </h3>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 16px; align-items: end;">
            <div class="form-group-github">
                <label for="password-update-users" class="form-label-github">
                    <i class="fas fa-users"></i> Users (one per line)
                </label>
                <textarea id="password-update-users" class="form-control-github" rows="4" placeholder="user1@domain.com&#10;user2@domain.com&#10;user3@domain.com"></textarea>
            </div>
            <div class="form-group-github">
                <label for="password-update-new-password" class="form-label-github">
                    <i class="fas fa-lock"></i> New Password
                </label>
                <input type="text" id="password-update-new-password" class="form-control-github" placeholder="New password for all users">
            </div>
            <button onclick="updateUserPasswords()" class="btn-github btn-github-primary">
                <i class="fas fa-key"></i> Update Passwords
            </button>
        </div>
    </div>

    <!-- Change Domain for Specific Users -->
    <div class="github-card">
        <div class="github-card-header">
            <h3 class="github-card-title">
                <i class="fas fa-exchange-alt"></i>
                Change Domain for Specific Users
            </h3>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
            <div class="form-group-github">
                <label for="old-domain" class="form-label-github">
                    <i class="fas fa-globe"></i> Current Domain
                </label>
                <input type="text" id="old-domain" class="form-control-github" placeholder="old.com">
            </div>
            <div class="form-group-github">
                <label for="new-domain" class="form-label-github">
                    <i class="fas fa-globe"></i> New Domain
                </label>
                <input type="text" id="new-domain" class="form-control-github" placeholder="new.com">
            </div>
        </div>
        <div class="form-group-github" style="margin-bottom: 20px;">
            <label for="domain-change-emails" class="form-label-github">
                <i class="fas fa-envelope"></i> Email Addresses (one per line)
            </label>
            <textarea id="domain-change-emails" class="form-control-github" rows="4" placeholder="user1@old.com&#10;user2@old.com&#10;user3@old.com"></textarea>
        </div>
        <button onclick="changeDomainForUsers()" class="btn-github btn-github-primary">
            <i class="fas fa-exchange-alt"></i> Change Domain for These Users
        </button>
    </div>

    <!-- Delete Specific Users -->
    <div class="github-card">
        <div class="github-card-header">
            <h3 class="github-card-title">
                <i class="fas fa-user-times"></i>
                Delete Specific Users
            </h3>
        </div>
        <div class="form-group-github" style="margin-bottom: 20px;">
            <label for="delete-user-emails" class="form-label-github">
                <i class="fas fa-envelope"></i> Email Addresses to Delete (one per line)
            </label>
            <textarea id="delete-user-emails" class="form-control-github" rows="4" placeholder="user1@domain.com&#10;user2@domain.com&#10;user3@domain.com"></textarea>
        </div>
        <button onclick="deleteSpecificUsers()" class="btn-github btn-github-danger">
            <i class="fas fa-trash"></i> Delete These Users
        </button>
    </div>

    <!-- Results Log -->
    <div class="github-card">
        <div class="github-card-header">
            <h3 class="github-card-title">
                <i class="fas fa-file-alt"></i>
                Results Log
            </h3>
        </div>
        <div style="display: flex; gap: 12px; margin-bottom: 16px;">
            <button onclick="clearResultsLog()" class="btn-github">
                <i class="fas fa-broom"></i> Clear Log
            </button>
            <button onclick="copyResultsLog()" class="btn-github">
                <i class="fas fa-copy"></i> Copy Log
            </button>
        </div>
        <div id="results-log" class="data-display" style="font-family: monospace; font-size: 13px;"></div>
    </div>
</div>
<!-- Tab 3: Bulk Domain Change -->
<div id="tab3" class="tab-content">
    
    <!-- Workflow 1: Change Domain using CSV File -->
    <div class="github-card">
        <div class="github-card-header">
            <h3 class="github-card-title">
                <i class="fas fa-file-csv"></i>
                Workflow 1: Change Domain using CSV File
            </h3>
        </div>
        
        <!-- Step 1.1: Download Current Users to CSV -->
        <div style="margin-bottom: 32px;">
            <h4 style="font-size: 16px; font-weight: 600; color: var(--color-fg-default); margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-download" style="color: var(--color-accent-fg);"></i>
                Step 1.1: Download Current Users to CSV
            </h4>
            <div style="margin-bottom: 16px;">
                <button onclick="downloadAllUsersCSV()" class="btn-github btn-github-primary">
                    <i class="fas fa-download"></i> Download All Users
                </button>
                </div>
            <div style="background-color: rgba(9, 105, 218, 0.1); border: 1px solid var(--color-accent-emphasis); border-radius: 6px; padding: 12px; color: var(--color-accent-fg); font-size: 14px;">
                <i class="fas fa-info-circle"></i>
                CSV will be saved to: <strong id="csv-save-path">Downloads folder</strong>
            </div>
        </div>
        
        <!-- Step 1.2: Select New Domain and Apply to Downloaded CSV -->
        <div style="margin-bottom: 32px;">
            <h4 style="font-size: 16px; font-weight: 600; color: var(--color-fg-default); margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-globe" style="color: var(--color-accent-fg);"></i>
                Step 1.2: Select New Domain and Apply to Downloaded CSV
            </h4>
            <div style="display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 16px;">
                <button onclick="retrieveAvailableDomains()" class="btn-github">
                    <i class="fas fa-search"></i> Retrieve Available Domains
                </button>
                <button onclick="getDomainUsageStats()" class="btn-github" style="background-color: var(--color-success-emphasis); border-color: var(--color-success-emphasis); color: #ffffff;">
                    <i class="fas fa-chart-bar"></i> Domain Usage Stats
                </button>
                <button onclick="clearOldDomainData()" class="btn-github" style="background-color: var(--color-warning-emphasis); border-color: var(--color-warning-emphasis); color: #ffffff;">
                    <i class="fas fa-trash"></i> Clear Old Data
                </button>
                <button onclick="applySelectedDomainToCSV()" class="btn-github btn-github-primary">
                    <i class="fas fa-check"></i> Apply Selected Domain to CSV
                </button>
                <button onclick="debugDomainUsers()" class="btn-github" style="background-color: #6f42c1; border-color: #6f42c1; color: #ffffff;">
                    <i class="fas fa-bug"></i> Debug Domain Users
                </button>
                </div>
                
            <div id="available-domains" class="data-display">
                <div class="status-info">
                    <p><strong><i class="fas fa-globe"></i> Domain Selection</strong></p>
                    <p>Click 'Retrieve Available Domains' to view available domains</p>
                </div>
            </div>
        </div>
        
        <!-- Step 1.3: Process Domain Changes from Modified CSV -->
        <div>
            <h4 style="font-size: 16px; font-weight: 600; color: var(--color-fg-default); margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-cogs" style="color: var(--color-accent-fg);"></i>
                Step 1.3: Process Domain Changes from Modified CSV
            </h4>
            <div style="display: grid; grid-template-columns: 1fr auto; gap: 16px; align-items: end; margin-bottom: 16px;">
                <div class="form-group-github">
                    <label for="csv-file-path" class="form-label-github">
                        <i class="fas fa-file-csv"></i> CSV File Path
                    </label>
                    <input type="text" id="csv-file-path" class="form-control-github" placeholder="CSV file path will appear here after download/apply, or browse manually..." readonly>
                </div>
                <button onclick="browseCSVFile()" class="btn-github">
                    <i class="fas fa-folder-open"></i> Browse Manually...
                </button>
                </div>
            <button onclick="processDomainChangesFromCSV()" class="btn-github btn-github-primary">
                <i class="fas fa-cogs"></i> Process Domain Changes from CSV
            </button>
        </div>
    </div>

    <!-- Workflow 2: Change Domain for All Users (Non-CSV, Excludes Admin) -->
    <div class="github-card">
        <div class="github-card-header">
            <h3 class="github-card-title">
                <i class="fas fa-exchange-alt"></i>
                Workflow 2: Change Domain for All Users (Non-CSV, Excludes Admin)
            </h3>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
            <div class="form-group-github">
                <label for="current-domain-suffix" class="form-label-github">
                    <i class="fas fa-globe"></i> Current Domain Suffix
                </label>
                <input type="text" id="current-domain-suffix" class="form-control-github" placeholder="old-domain.com">
            </div>
            <div class="form-group-github">
                <label for="new-domain-suffix" class="form-label-github">
                    <i class="fas fa-globe"></i> New Domain Suffix
                </label>
                <input type="text" id="new-domain-suffix" class="form-control-github" placeholder="new-domain.com">
            </div>
            </div>
        
        <button onclick="changeDomainForAllUsers()" class="btn-github" style="background-color: var(--color-warning-emphasis); border-color: var(--color-warning-emphasis); color: #ffffff;">
            <i class="fas fa-exchange-alt"></i> Change Domain for ALL Matching Users (Non-Admin)
        </button>
        
        <!-- Auto Change Subdomain button moved here from Domain Management section -->
        <button onclick="autoChangeSubdomain()" class="btn-github" style="margin-left: 8px; background-color: #9C27B0; border-color: #9C27B0; color: white;">
            <i class="fas fa-magic"></i> Auto Change Subdomain
        </button>
        
        <!-- Progress Indicator -->
        <div id="domain-change-progress" class="progress-container" style="display: none; margin-top: 20px;">
            <div class="progress-header">
                <h4 style="margin: 0; color: var(--color-fg-default);">
                    <i class="fas fa-spinner fa-spin"></i> Domain Change Progress
                </h4>
                <span id="progress-percentage" style="color: var(--color-fg-muted);">0%</span>
            </div>
            <div class="progress-bar-container">
                <div id="progress-bar" class="progress-bar" style="width: 0%;"></div>
            </div>
            <div id="progress-message" class="progress-message" style="margin-top: 8px; color: var(--color-fg-muted); font-size: 14px;">
                Initializing...
            </div>
        </div>
    </div>



    <!-- Results Log (Covers Both Workflows) -->
    <div class="github-card">
        <div class="github-card-header">
            <h3 class="github-card-title">
                <i class="fas fa-file-alt"></i>
                Results Log (Covers Both Workflows)
            </h3>
        </div>
        
        <div style="margin-bottom: 16px;">
            <button onclick="clearBulkDomainLog()" class="btn-github">
                <i class="fas fa-broom"></i> Clear Log
            </button>
        </div>
        
        <div id="bulk-domain-results" class="data-display" style="font-family: monospace; font-size: 13px;">
            <div class="status-info">
                <p><strong><i class="fas fa-file-alt"></i> Processing Results</strong></p>
                <p>Processing results will appear here...</p>
            </div>
        </div>
    </div>

    <!-- SMTP Credential Tester -->
    <div class="github-card" style="margin-top: 32px;">
        <div class="github-card-header">
            <h3 class="github-card-title">
                <i class="fas fa-envelope"></i>
                SMTP Credential Tester
            </h3>
        </div>
        
        <div class="form-group-github" style="margin-bottom: 20px;">
            <label for="smtp-credentials" class="form-label-github">
                <i class="fas fa-key"></i> SMTP Credentials (email,password,smtp_server,port)
                <span id="smtp-sync-status" style="margin-left: 8px; font-size: 12px; color: #6a737d;"></span>
            </label>
            <textarea id="smtp-credentials" class="form-control-github" rows="5" placeholder="user1@gmail.com,password123,smtp.gmail.com,587&#10;user2@outlook.com,apppassword456,smtp.outlook.com,587&#10;user3@yahoo.com,secretpass789,smtp.mail.yahoo.com,587" onchange="syncSMTPToAppPasswords()" oninput="autoSyncSMTPCredentials()"></textarea>
            <small style="color: #656d76; font-size: 12px; margin-top: 8px; display: block;">
                <i class="fas fa-info-circle"></i> 
                Credentials are automatically synced to App Password Management. Use format: email,password,smtp_server,port (one per line)
            </small>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-bottom: 20px;">
            <div class="form-group-github">
                <label for="smtp-recipient" class="form-label-github">
                    <i class="fas fa-envelope"></i> Recipient Email
                </label>
                <input type="email" id="smtp-recipient" class="form-control-github" placeholder="test@domain.com">
            </div>
            <div class="form-group-github">
                <label for="smtp-server" class="form-label-github">
                    <i class="fas fa-server"></i> SMTP Server
                </label>
                <input type="text" id="smtp-server" class="form-control-github" value="smtp.gmail.com" placeholder="SMTP Server">
            </div>
            <div class="form-group-github">
                <label for="smtp-port" class="form-label-github">
                    <i class="fas fa-plug"></i> Port
                </label>
                <input type="number" id="smtp-port" class="form-control-github" value="587" placeholder="Port">
            </div>
        </div>
        
        <div style="display: flex; gap: 12px; margin-bottom: 20px;">
            <button onclick="testSMTPCredentials()" class="btn-github btn-github-primary">
                <i class="fas fa-paper-plane"></i> Send Test Emails
            </button>
            <button onclick="syncSMTPToAppPasswords()" class="btn-github" style="background-color: #28a745; border-color: #28a745; color: white;">
                <i class="fas fa-sync"></i> Sync to App Passwords
            </button>
            <button onclick="testSMTPParsing()" class="btn-github" style="background-color: #6f42c1; border-color: #6f42c1; color: white;">
                <i class="fas fa-bug"></i> Test Parsing
            </button>
            <button onclick="interruptSMTPTesting()" class="btn-github" style="background-color: var(--color-warning-emphasis); border-color: var(--color-warning-emphasis); color: #ffffff;">
                <i class="fas fa-stop"></i> Interrupt Sending
            </button>
            <button onclick="clearSMTPResults()" class="btn-github">
                <i class="fas fa-broom"></i> Clear Log / Reset Files
            </button>
        </div>
        
        <div>
            <h4 style="font-size: 16px; font-weight: 600; color: var(--color-fg-default); margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-chart-bar" style="color: var(--color-accent-fg);"></i>
                SMTP Test Results
            </h4>
            <div id="smtp-results-log" class="data-display" style="font-family: monospace; font-size: 13px;">
                <div class="status-info">
                    <p><strong><i class="fas fa-envelope"></i> SMTP Testing Results</strong></p>
                    <p>Test results will appear here...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Generate Sample CSV for User Creation -->
    <div class="github-card" style="margin-top: 24px;">
        <div class="github-card-header">
            <h3 class="github-card-title">
                <i class="fas fa-file-csv"></i>
                Generate Sample CSV for User Creation
            </h3>
            </div>
            
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-bottom: 20px;">
            <div class="form-group-github">
                <label for="csv-num-users" class="form-label-github">
                    <i class="fas fa-hashtag"></i> Number of Users
                </label>
                <input type="number" id="csv-num-users" class="form-control-github" min="1" max="1000" placeholder="e.g., 50">
            </div>
            <div class="form-group-github">
                <label for="csv-domain" class="form-label-github">
                    <i class="fas fa-globe"></i> Domain
                </label>
                <input type="text" id="csv-domain" class="form-control-github" placeholder="yourdomain.com">
            </div>
            <div class="form-group-github">
                <label for="csv-password" class="form-label-github">
                    <i class="fas fa-lock"></i> Default Password
                </label>
                <input type="text" id="csv-password" class="form-control-github" placeholder="Default password for all users">
            </div>
        </div>
        
        <div style="display: flex; gap: 12px; margin-bottom: 20px;">
            <button onclick="generateUserCSV()" class="btn-github btn-github-primary">
                <i class="fas fa-download"></i> Generate CSV File
            </button>
            <button onclick="previewCSV()" class="btn-github">
                <i class="fas fa-eye"></i> Preview CSV
            </button>
        </div>
        
        <div id="csv-download-area" class="data-display"></div>
        
        <div id="csv-preview-area" class="csv-preview"></div>
    </div>

    <!-- Mega Upgrade: Single Account Workflow -->
    <div class="github-card">
        <div class="github-card-header">
            <h3 class="github-card-title">
                <i class="fas fa-rocket"></i>
                    Mega Upgrade: Single Account Workflow
            </h3>
        </div>
        
        <p style="color: #656d76; margin-bottom: 24px; font-size: 14px;">
            Process a single account with automated workflows. Select which features to apply to the account.
        </p>
        
        <button onclick="openMegaUpgradeModal()" class="btn-github btn-github-primary" style="width: 100%; padding: 16px; font-size: 16px;">
            <i class="fas fa-magic"></i> Launch Mega Upgrade Workflow
        </button>
        
    </div>

    <!-- App Password Management -->
    <div class="github-card">
        <div class="github-card-header">
            <h3 class="github-card-title">
                <i class="fas fa-key"></i>
                App Password Management
            </h3>
</div>
        
        <div class="form-group-github">
            <label for="app-passwords-file" class="form-label-github">
                <i class="fas fa-upload"></i> Upload App Passwords File
            </label>
            <input type="file" id="app-passwords-file" class="form-control-github" accept=".txt" 
                   onchange="handleAppPasswordsFile(this)">
            <small class="form-text" style="color: #666; margin-top: 8px;">
                Upload a .txt file with format: user@domain.com:app_password (one per line)<br>
                <strong>💡 You can upload multiple files - all passwords will be stored in one place!</strong>
            </small>
</div>

        <div style="display: flex; gap: 12px; margin-top: 16px;">
            <button onclick="uploadAppPasswords()" class="btn-github btn-github-primary">
                <i class="fas fa-upload"></i> Upload & Store Passwords
            </button>
            <button onclick="downloadAppPasswordsTemplate()" class="btn-github">
                <i class="fas fa-download"></i> Download Template
            </button>
            {% if session.role == 'admin' %}
            <button onclick="clearAppPasswords()" class="btn-github" style="background-color: #dc3545; border-color: #dc3545; color: white;" onmouseover="this.style.backgroundColor='#c82333'" onmouseout="this.style.backgroundColor='#dc3545'">
                <i class="fas fa-trash"></i> Clear All Passwords
            </button>
            {% else %}
            <div style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background-color: #f8f9fa; border: 1px solid #d0d7de; border-radius: 6px; color: #656d76; font-size: 13px;">
                <i class="fas fa-lock"></i>
                <span>Clear All Passwords (Admin Only)</span>
            </div>
            {% endif %}
        </div>
        
        <div id="app-passwords-status" class="count-display" style="margin-top: 16px;">
            <span id="app-passwords-count">No app passwords stored</span>
        </div>
        
        <!-- Advanced App Password Management -->
        <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid #d0d7de;">
            <h4 style="color: #24292f; margin-bottom: 16px; font-size: 16px;">
                <i class="fas fa-cogs"></i> Advanced Management
            </h4>
            
            <!-- Search and Select Users -->
            <div class="form-group-github">
                <label for="search-app-passwords" class="form-label-github">
                    <i class="fas fa-search"></i> Search App Password Users
                </label>
                <input type="text" id="search-app-passwords" class="form-control-github" 
                       placeholder="Search by alias (username)..." 
                       onkeyup="searchAppPasswordUsers()">
                <div style="margin-top: 8px;">
                    <button onclick="debugAppPasswords()" class="btn-github" style="font-size: 12px; padding: 4px 8px;">
                        <i class="fas fa-bug"></i> Debug Search
                    </button>
                </div>
            </div>
            
            <!-- User Selection and Management -->
            <div id="app-passwords-search-results" style="max-height: 200px; overflow-y: auto; border: 1px solid #d0d7de; border-radius: 6px; padding: 12px; margin-bottom: 16px; display: none;">
                <!-- Search results will be populated here -->
            </div>
            
            <!-- Delete Specific Users -->
            <div class="form-group-github">
                <label for="delete-app-passwords" class="form-label-github">
                    <i class="fas fa-trash-alt"></i> Delete Specific Users (one per line)
                </label>
                <textarea id="delete-app-passwords" class="form-control-github" rows="4" 
                          placeholder="Enter usernames or emails to delete (one per line):&#10;user1@domain.com&#10;user2@domain.com&#10;username3"></textarea>
                <div style="display: flex; gap: 8px; margin-top: 8px;">
                    <button onclick="deleteSpecificAppPasswords()" class="btn-github" style="background-color: #dc3545; color: white;">
                        <i class="fas fa-trash"></i> Delete Selected
                    </button>
                    <button onclick="clearDeleteField()" class="btn-github">
                        <i class="fas fa-times"></i> Clear Field
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Automation Authentication Process -->
    <div class="github-card">
        <div class="github-card-header">
            <h3 class="github-card-title">
                <i class="fas fa-robot"></i>
                Automation Authentication Process
            </h3>
        </div>
        
        <div class="form-group-github">
            <label for="automation-accounts-list" class="form-label-github">
                <i class="fas fa-columns"></i> Accounts to Process (one per line)
            </label>
            <textarea id="automation-accounts-list" class="form-control-github" rows="8" 
                      placeholder="user1@domain.com&#10;user2@domain.com&#10;user3@domain.com&#10;..."></textarea>
        </div>
        
        <div style="display: flex; gap: 12px; margin-top: 16px; margin-bottom: 20px;">
            <button onclick="executeAutomationProcess()" class="btn-github btn-github-primary">
                <i class="fas fa-play"></i> Execute Automation Process
            </button>
            <button onclick="clearAutomationList()" class="btn-github">
                <i class="fas fa-trash"></i> Clear List
            </button>
        </div>
        
        <div id="automation-progress" class="progress-container" style="display: none;">
            <div class="progress-bar">
                <div id="automation-progress-bar" class="progress-fill"></div>
            </div>
            <div id="automation-progress-text" class="progress-text">Starting automation process...</div>
        </div>
        
        <div id="automation-results" class="data-display" style="margin-top: 16px; display: none;">
            <h4>Automation Results:</h4>
            <div id="automation-results-content"></div>
        </div>
        
        <div id="automation-users-display" class="github-card" style="margin-top: 16px; display: none;">
            <div class="github-card-header">
                <h3 class="github-card-title">
                    <i class="fas fa-users"></i>
                    Retrieved Users
                </h3>
            </div>
            <div id="automation-users-list" class="user-list" style="max-height: 400px; overflow-y: auto;">
                <!-- Users will be populated here -->
            </div>
            <div style="display: flex; gap: 12px; margin-top: 16px;">
                <button onclick="copyAutomationUsers()" class="btn-github">
                    <i class="fas fa-copy"></i> Copy All Emails
                </button>
                <button onclick="exportAutomationUsers()" class="btn-github">
                    <i class="fas fa-download"></i> Export as CSV
                </button>
            </div>
        </div>
        
        <!-- Users Text Display Field -->
        <div id="automation-users-text-display" class="github-card" style="margin-top: 16px; display: none;">
            <div class="github-card-header" style="
                background: linear-gradient(135deg, #f6f8fa 0%, #e1e8ed 100%);
                border-bottom: 3px solid #0969da;
                border-radius: 8px 8px 0 0;
                padding: 20px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            ">
                <div>
                    <h3 class="github-card-title" style="
                        margin: 0; 
                        color: #24292f; 
                        font-size: 20px; 
                        font-weight: 700;
                        text-shadow: 0 1px 2px rgba(0,0,0,0.1);
                    ">
                        <i class="fas fa-list-alt" style="color: #0969da; margin-right: 10px; font-size: 22px;"></i>
                        Users List (Text Format)
                    </h3>
                    <div id="users-list-stats" style="margin-top: 16px;">
                        <!-- Statistics will be displayed here -->
                    </div>
                </div>
            </div>
            <div class="github-card-body" style="padding: 20px;">
                <div class="form-group-github">
                    <label for="automation-users-text" class="form-label-github" style="font-weight: 600; color: #24292f; margin-bottom: 12px;">
                        <i class="fas fa-file-text" style="color: #0969da; margin-right: 8px;"></i> 
                        Retrieved Users (SMTP Format)
                    </label>
                    <div style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;">
                        <button onclick="copyRetrievedUsersText()" class="btn-github" style="
                            padding: 8px 16px; 
                            font-size: 13px; 
                            font-weight: 500;
                            background: #0969da;
                            color: white;
                            border: 1px solid #0969da;
                            border-radius: 6px;
                            transition: all 0.2s ease;
                            display: flex;
                            align-items: center;
                            gap: 6px;
                        " onmouseover="this.style.background='#0550ae'" onmouseout="this.style.background='#0969da'">
                            <i class="fas fa-copy"></i> Copy Text
                        </button>
                        <button onclick="exportAutomationUsers()" class="btn-github" style="
                            padding: 8px 16px; 
                            font-size: 13px; 
                            font-weight: 500;
                            background: #28a745;
                            color: white;
                            border: 1px solid #28a745;
                            border-radius: 6px;
                            transition: all 0.2s ease;
                            display: flex;
                            align-items: center;
                            gap: 6px;
                        " onmouseover="this.style.background='#1e7e34'" onmouseout="this.style.background='#28a745'">
                            <i class="fas fa-download"></i> Export CSV
                        </button>
                    </div>
                    <div style="position: relative;">
                        <textarea id="automation-users-text" class="form-control-github" rows="15" 
                                  placeholder="Users will appear here after automation process..." readonly
                                  style="
                                    font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
                                    font-size: 13px;
                                    line-height: 1.5;
                                    background: #f6f8fa;
                                    border: 2px solid #d0d7de;
                                    border-radius: 8px;
                                    padding: 16px;
                                    resize: vertical;
                                    min-height: 300px;
                                  "></textarea>
                        <div style="
                            position: absolute;
                            top: 8px;
                            right: 8px;
                            background: rgba(255, 255, 255, 0.9);
                            padding: 4px 8px;
                            border-radius: 4px;
                            font-size: 11px;
                            color: #656d76;
                            font-weight: 500;
                        ">
                            <i class="fas fa-lock"></i> Read-only
                        </div>
                    </div>
                    <div style="margin-top: 12px; padding: 12px; background: #f6f8fa; border-radius: 6px; border-left: 4px solid #0969da;">
                        <div style="display: flex; align-items: center; gap: 8px; color: #656d76; font-size: 12px;">
                            <i class="fas fa-info-circle" style="color: #0969da;"></i>
                            <span><strong>Format:</strong> email,app_password,smtp.gmail.com,587 (one per line)</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
</div>


<script>
function debugAppPasswords() {
    console.log('=== DEBUG APP PASSWORDS ===');
    
    fetch('/api/debug-app-passwords')
        .then(response => response.json())
        .then(data => {
            console.log('Debug API response:', data);
            
            if (data.success) {
                const info = data.debug_info;
                console.log(`Total app passwords in database: ${info.total_count}`);
                console.log('Sample records:', info.sample_records);
                console.log('Recent records:', info.recent_records);
                
                alert(`Debug Info:\n\nTotal records: ${info.total_count}\n\nCheck browser console for detailed information.`);
            } else {
                console.error('Debug API failed:', data.error);
                alert(`Debug failed: ${data.error}`);
            }
        })
        .catch(error => {
            console.error('Debug request failed:', error);
            alert(`Debug request failed: ${error.message}`);
        });
}

// Normalize email to avoid duplicated domain segments like base.base at the end
function normalizeEmail(rawEmail) {
    if (!rawEmail || typeof rawEmail !== 'string') return rawEmail;
    const trimmed = rawEmail.trim();
    const atIndex = trimmed.lastIndexOf('@');
    if (atIndex === -1) return trimmed; // not an email
    const local = trimmed.slice(0, atIndex);
    let domain = trimmed.slice(atIndex + 1);

    // Collapse duplicated trailing domain sequences, e.g.
    // foo@abc.def.ghi.abc.def.ghi -> foo@abc.def.ghi
    // Strategy: find the longest suffix that is repeated twice contiguously
    const labels = domain.split('.');
    for (let windowSize = Math.floor(labels.length / 2); windowSize >= 1; windowSize--) {
        const firstStart = labels.length - 2 * windowSize;
        if (firstStart < 0) continue;
        const left = labels.slice(firstStart, firstStart + windowSize).join('.');
        const right = labels.slice(firstStart + windowSize).join('.');
        if (left === right) {
            domain = labels.slice(0, firstStart + windowSize).join('.');
            break;
        }
    }

    return `${local}@${domain}`;
}

let currentAccount = null;
let isAuthenticated = false;
let selectedAccountFromList = null;
let selectedAccountId = null;
let smtpTesting = false;
let selectedDomain = null;

// Tab switching functionality
function showTab(tabId) {
    console.log('Switching to tab:', tabId);
    
    // Hide all tab contents
    const tabs = document.querySelectorAll('.tab-content');
    tabs.forEach(tab => {
        tab.classList.remove('active');
        tab.style.display = 'none';
    });
    
    // Remove active class from all tab buttons
    const buttons = document.querySelectorAll('.tab-button');
    buttons.forEach(button => {
        button.classList.remove('active');
        // Remove any inline styles to let CSS handle the styling
        button.style.background = '';
        button.style.borderBottom = '';
        button.style.color = '';
        button.style.fontWeight = '';
        button.style.transform = '';
        button.style.boxShadow = '';
    });
    
    // Show selected tab
    const selectedTab = document.getElementById(tabId);
    if (selectedTab) {
        console.log('Found tab element:', selectedTab);
        selectedTab.classList.add('active');
        selectedTab.style.display = 'block';
        selectedTab.style.visibility = 'visible';
        
        selectedTab.style.opacity = '1';
        selectedTab.style.height = 'auto';
        selectedTab.style.overflow = 'visible';
        
        // No special handling needed for 3-tab layout
    } else {
        console.error('Tab not found:', tabId);
    }
    
    // Add active class to clicked button  
    const clickedButton = event ? event.target.closest('.tab-button') : document.querySelector(`[onclick="showTab('${tabId}')"]`);
    if (clickedButton) {
        clickedButton.classList.add('active');
        // Remove any inline styles to let CSS handle the active styling
        clickedButton.style.background = '';
        clickedButton.style.borderBottom = '';
        clickedButton.style.color = '';
        clickedButton.style.fontWeight = '';
        clickedButton.style.transform = '';
        clickedButton.style.boxShadow = '';
    }
    
    // Auto-refresh domain data when domains tab is shown
    checkTabRefresh(tabId);
}

// Initialize tabs on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing tabs...');
    
    // Check if all tabs exist
    for (let i = 1; i <= 4; i++) {
        const tab = document.getElementById(`tab${i}`);
        console.log(`Tab ${i} exists:`, !!tab);
        if (tab) {
            console.log(`Tab ${i} content length:`, tab.innerHTML.length);
        }
    }
    
    // Ensure tab1 is visible by default
    showTab('tab1');
    
    // 3-tab layout is now complete - no special initialization needed
});

async function loadTokenStatusWithLive() {
    try {
        console.log('=== Starting LIVE token status check ===');
        
        // Reset counters
        let totalAccounts = 0;
        let validAccounts = 0;
        let invalidAccounts = 0;
        
        // Get list of accounts first
        const accountItems = document.querySelectorAll('.account-item');
        totalAccounts = accountItems.length;
        
        // Initialize display
        updateAccountStats(totalAccounts, 0, 0, 'Checking...');
        
        // Check each account individually (LIVE UPDATES)
        for (let item of accountItems) {
            // FIX: Clean the account name - remove status symbols
            const itemCopy = item.cloneNode(true);
            const statusSpan = itemCopy.querySelector('.token-status');
            if (statusSpan) {
                statusSpan.remove();
            }
            const accountName = itemCopy.textContent.trim();
            
            try {
                // Show "checking" status
                showAccountChecking(item, accountName);
                
                // Check this specific account
                const isValid = await checkSingleAccountLive(accountName);
                
                // Update visual immediately
                updateAccountVisual(item, accountName, isValid);
                
                // Update counters
                if (isValid) {
                    validAccounts++;
                } else {
                    invalidAccounts++;
                }
                
                // Update stats in real-time
                updateAccountStats(totalAccounts, validAccounts, invalidAccounts, 'Checking...');
                
                // Update dropdown too (with clean name)
                updateDropdownOption(accountName, isValid);
                
            } catch (error) {
                console.error(`Error checking ${accountName}:`, error);
                updateAccountVisual(item, accountName, false);
                invalidAccounts++;
                updateAccountStats(totalAccounts, validAccounts, invalidAccounts, 'Checking...');
            }
        }
        
        // Final update
        updateAccountStats(totalAccounts, validAccounts, invalidAccounts, 'Complete');
        
        // Save results to cache/SFTP for persistence
        await saveTokenStatusResults();
        
        console.log(`✅ Live check complete: ${validAccounts}/${totalAccounts} authenticated`);
        
    } catch (error) {
        console.error('Live token status check failed:', error);
    }
}

// Check single account status
async function checkSingleAccountLive(accountName) {
    try {
        const response = await fetch('/api/check-token-status', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({account_name: accountName})
        });
        
        const data = await response.json();
        return data.success && data.is_valid;
        
    } catch (error) {
        console.error(`Token check failed for ${accountName}:`, error);
        return false;
    }
}

// Show account being checked
function showAccountChecking(item, accountName) {
    const oldStatus = item.querySelector('.token-status');
    if (oldStatus) oldStatus.remove();
    
    const statusSpan = document.createElement('span');
    statusSpan.className = 'token-status checking';
    statusSpan.textContent = ' 🔄';
    statusSpan.style.cssText = 'float: right; margin-left: 10px; color: orange;';
    item.appendChild(statusSpan);
}
// Update account visual status
function updateAccountVisual(item, accountName, isValid) {
    const oldStatus = item.querySelector('.token-status');
    if (oldStatus) oldStatus.remove();
    
    const statusSpan = document.createElement('span');
    statusSpan.className = isValid ? 'token-status valid' : 'token-status invalid';
    statusSpan.textContent = isValid ? ' ✅' : ' ❌';
    statusSpan.style.cssText = 'float: right; margin-left: 10px;';
    item.appendChild(statusSpan);
    
    console.log(`✅ Updated ${accountName}: ${isValid ? 'Valid' : 'Invalid'}`);
}

// Update dropdown option
function updateDropdownOption(accountName, isValid) {
    // Clean account name for selector (escape special characters)
    const cleanAccountName = accountName.replace(/[^a-zA-Z0-9@.\-_]/g, '');
    
    try {
        // Try to find option by value
        const option = document.querySelector(`#account-select option[value="${accountName}"]`);
        if (option) {
            option.textContent = `${accountName} ${isValid ? '✅' : '❌'}`;
        } else {
            // If not found, try finding by text content
            const allOptions = document.querySelectorAll('#account-select option');
            allOptions.forEach(opt => {
                if (opt.value === accountName || opt.textContent.includes(accountName)) {
                    opt.textContent = `${accountName} ${isValid ? '✅' : '❌'}`;
                }
            });
        }
    } catch (error) {
        console.error(`Error updating dropdown for ${accountName}:`, error);
    }
}

// Update stats counter in real-time
function updateAccountStats(total, valid, invalid, status) {
    const statsElement = document.getElementById('account-stats');
    if (statsElement) {
        const checked = valid + invalid;
        statsElement.innerHTML = `
            <span class="stat-item">Total: <strong>${total}</strong></span>
            <span class="stat-item">Checked: <strong>${checked}/${total}</strong></span>
            <span class="stat-item stat-valid">✅ Authenticated: <strong>${valid}</strong></span>
            <span class="stat-item stat-invalid">❌ Need Auth: <strong>${invalid}</strong></span>
            <span class="stat-item" style="color: #007bff;">Status: <strong>${status}</strong></span>
        `;
    }
}

// Save results for persistence (survives restart)
async function saveTokenStatusResults() {
    try {
        // Collect current status with CLEAN account names
        const results = {};
        const accountItems = document.querySelectorAll('.account-item');
        
        accountItems.forEach(item => {
            // Get ONLY the account name text, exclude status symbols
            const accountNameElement = item.cloneNode(true);
            
            // Remove the status span to get clean account name
            const statusSpan = accountNameElement.querySelector('.token-status');
            if (statusSpan) {
                statusSpan.remove();
            }
            
            // Get clean account name
            const accountName = accountNameElement.textContent.trim();
            
            // Get the actual status
            const statusElement = item.querySelector('.token-status');
            
            if (statusElement && accountName) {
                const isValid = statusElement.textContent.includes('✅');
                results[accountName] = {
                    is_valid: isValid,
                    last_checked: new Date().toISOString()
                };
                
                console.log(`Clean save: "${accountName}" = ${isValid}`);
            }
        });
        
        console.log('Saving results for', Object.keys(results).length, 'accounts');
        
        // Save to server for persistence
        const response = await fetch('/api/save-token-status-cache', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({status_results: results})
        });
        
        const data = await response.json();
        console.log('Save response:', data);
        
    } catch (error) {
        console.error('Failed to save token status results:', error);
    }
}

// Load saved results on page load (for persistence)
async function loadSavedTokenStatus() {
    try {
        const response = await fetch('/api/load-token-status-cache', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        
        const data = await response.json();
        
        if (data.success && data.status) {
            console.log('Loading saved token status...');
            displaySavedTokenStatus(data.status);
            return true;
        }
        
        return false;
        
    } catch (error) {
        console.error('Failed to load saved token status:', error);
        return false;
    }
}

// Display saved status from cache
function displaySavedTokenStatus(statusData) {
    const accountItems = document.querySelectorAll('.account-item');
    let totalAccounts = accountItems.length;
    let validAccounts = 0;
    let invalidAccounts = 0;
    
    accountItems.forEach(item => {
        const accountName = item.textContent.trim();
        
        if (statusData[accountName]) {
            const isValid = statusData[accountName].is_valid;
            updateAccountVisual(item, accountName, isValid);
            updateDropdownOption(accountName, isValid);
            
            if (isValid) {
                validAccounts++;
            } else {
                invalidAccounts++;
            }
        }
    });
    
    updateAccountStats(totalAccounts, validAccounts, invalidAccounts, 'Loaded from cache');
    console.log(`Loaded cached status: ${validAccounts}/${totalAccounts} authenticated`);
}

// Main function - use database for token status
async function initializeTokenStatus() {
    console.log('Initializing token status from database...');
    await checkTokenStatusFromDatabase();
}

// Auto-refresh every 8 hours (but user can manually refresh anytime)
setInterval(checkTokenStatusFromDatabase, 8 * 60 * 60 * 1000);

// Load on page load
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(initializeTokenStatus, 1000);
    
    // Check if there's a currently authenticated account in session
    checkCurrentAuthenticationStatus();
});

// Check current authentication status from session
async function checkCurrentAuthenticationStatus() {
    try {
        const response = await fetch('/api/get-account-status', {
            method: 'GET',
            headers: {'Content-Type': 'application/json'}
        });
        
        const data = await response.json();
        
        if (data.success && data.status) {
            const { total, authenticated, need_auth } = data.status;
            
            // Update the auth status display
            if (authenticated > 0) {
                // Get the current authenticated account name
                const currentAccountName = sessionStorage.getItem('current_account_name');
                if (currentAccountName) {
                    updateAuthStatus(currentAccountName, true, `Currently authenticated (${authenticated}/${total} accounts)`);
                }
            }
            
            console.log(`Current authentication status: ${authenticated}/${total} accounts authenticated`);
        }
    } catch (error) {
        console.error('Failed to check current authentication status:', error);
    }
}

    
    // Auto-refresh domain data when domains tab is shown
function checkTabRefresh(tabId) {
    if (tabId === 'tab3' && isAuthenticated) {
        setTimeout(() => {
            retrieveAvailableDomains();
        }, 500);
    }
}

// Results log functions
function logResult(message) {
    const log = document.getElementById('results-log');
    const activityLog = document.getElementById('activity-log');
    const timestamp = new Date().toLocaleTimeString();
    const logEntry = `[${timestamp}] ${message}\n`;
    
    // Log to results log (existing functionality)
    log.textContent += logEntry;
    log.scrollTop = log.scrollHeight;
    
    // Also log to activity log
    if (activityLog) {
        // Remove the placeholder text if it exists
        if (activityLog.textContent.includes('📝 Activity log will appear here...')) {
            activityLog.textContent = '';
        }
        activityLog.textContent += logEntry;
        activityLog.scrollTop = activityLog.scrollHeight;
    }
}

function clearResultsLog() {
    document.getElementById('results-log').textContent = '';
}

// Activity log management functions
function clearLogs() {
    if (confirm('🗑️ Are you sure you want to clear all activity logs?')) {
        document.getElementById('activity-log').textContent = '📝 Activity log cleared. New activities will appear here...';
        logResult('📝 Activity log cleared by user');
    }
}

function copyLogs() {
    const activityLog = document.getElementById('activity-log');
    const logText = activityLog.textContent;
    
    if (!logText || logText.includes('📝 Activity log will appear here...') || logText.includes('📝 Activity log cleared.')) {
        alert('📝 No logs to copy. Perform some actions first.');
        return;
    }
    
    navigator.clipboard.writeText(logText).then(() => {
        logResult('📋 Activity logs copied to clipboard');
    }).catch(err => {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = logText;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        logResult('📋 Activity logs copied to clipboard (fallback method)');
    });
}

function downloadLogs() {
    const activityLog = document.getElementById('activity-log');
    const logText = activityLog.textContent;
    
    if (!logText || logText.includes('📝 Activity log will appear here...') || logText.includes('📝 Activity log cleared.')) {
        alert('📝 No logs to download. Perform some actions first.');
        return;
    }
    
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
    const filename = `gbot-activity-log-${timestamp}.txt`;
    
    const blob = new Blob([logText], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    
    logResult(`💾 Activity logs downloaded as ${filename}`);
}

// App Password Management Functions
function storeAppPassword() {
    const userAlias = document.getElementById('app-password-alias').value.trim();
    const appPassword = document.getElementById('app-password-value').value.trim();
    const domain = document.getElementById('app-password-domain').value.trim();
    
    if (!userAlias) {
        alert('Please enter a user alias');
        return;
    }
    
    if (!appPassword) {
        alert('Please enter an app password');
        return;
    }
    
    if (!userAlias.includes('@')) {
        alert('Please enter a valid email address as user alias');
        return;
    }
    
    logResult(`🔐 Storing app password for user: ${userAlias}...`);
    
    fetch('/api/store-app-password', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ 
            user_alias: userAlias,
            app_password: appPassword,
            domain: domain || null
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            logResult(`✅ ${data.message}`);
            document.getElementById('app-password-alias').value = '';
            document.getElementById('app-password-value').value = '';
            document.getElementById('app-password-domain').value = '';
            // Refresh the display
            loadAllAppPasswords();
        } else {
            logResult(`❌ Failed to store app password: ${data.error}`);
        }
    })
    .catch(error => {
        logResult(`❌ Network error: ${error.message}`);
    });
}

function loadAllAppPasswords() {
    console.log('Loading all app passwords...');
    logResult('🔍 Loading all app passwords...');
    
    fetch('/api/get-all-app-passwords')
    .then(response => {
        console.log('Response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('App passwords response:', data);
        if (data.success) {
            console.log('App passwords data:', data.app_passwords);
            displayAppPasswords(data.app_passwords);
            logResult(`📋 Loaded ${data.total_count} app passwords`);
        } else {
            console.error('Failed to load app passwords:', data.error);
            logResult(`❌ Failed to load app passwords: ${data.error}`);
            document.getElementById('app-passwords-display').innerHTML = `<div class="error-message">❌ Error: ${data.error}</div>`;
        }
    })
    .catch(error => {
        console.error('Network error:', error);
        logResult(`❌ Network error: ${error.message}`);
        document.getElementById('app-passwords-display').innerHTML = `<div class="error-message">❌ Network error: ${error.message}</div>`;
    });
}

function displayAppPasswords(appPasswords) {
    console.log('Displaying app passwords:', appPasswords);
    logResult(`🎨 Displaying ${appPasswords ? appPasswords.length : 0} app passwords`);
    
    if (!appPasswords || appPasswords.length === 0) {
        console.log('No app passwords to display');
        document.getElementById('app-passwords-display').innerHTML = '<div class="status-info"><p>✅ No app passwords stored</p></div>';
        return;
    }
    
    let html = '<div class="app-passwords-list">';
    html += '<h4 style="margin-bottom: 16px; color: #24292f;">🔐 Stored App Passwords</h4>';
    
    appPasswords.forEach(password => {
        html += `
            <div class="app-password-item" style="border: 1px solid #e1e4e8; border-radius: 6px; padding: 12px; margin-bottom: 8px; background: #f8f9fa;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>${password.user_alias}</strong>
                        <div style="color: #666; font-size: 14px; margin-top: 4px;">
                            🔑 App Password: ${password.app_password}
                        </div>
                        ${password.domain ? `<div style="color: #666; font-size: 12px; margin-top: 2px;">🌐 Domain: ${password.domain}</div>` : ''}
                        <div style="color: #666; font-size: 11px; margin-top: 4px;">
                            📅 Updated: ${password.updated_at}
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    document.getElementById('app-passwords-display').innerHTML = html;
    console.log('App passwords display updated');
    logResult('✅ App passwords display updated');
}

// Auto-load app passwords when page loads
function autoLoadAppPasswords() {
    console.log('Auto-loading app passwords...');
    loadAllAppPasswords();
}

// Auto-load when page is ready
document.addEventListener('DOMContentLoaded', function() {
    console.log('Page loaded, auto-loading app passwords...');
    setTimeout(autoLoadAppPasswords, 1000); // Wait 1 second for page to fully load
    loadAppPasswordsStatus(); // Load status immediately
});

function clearAppPasswords() {
    document.getElementById('app-passwords-display').innerHTML = '<div style="color: #6a737d; font-style: italic;">📝 App passwords will appear here...</div>';
    logResult('🧹 App passwords display cleared');
}


// Sync SMTP credentials to App Password Management
function syncSMTPToAppPasswords() {
    const credentials = document.getElementById('smtp-credentials').value.trim();
    
    if (!credentials) {
        alert('Please enter SMTP credentials first');
        return;
    }
    
    console.log('Syncing SMTP credentials to app passwords...');
    logResult('🔄 Syncing SMTP credentials to App Password Management...');
    
    // Update status indicator
    const statusElement = document.getElementById('smtp-sync-status');
    if (statusElement) {
        statusElement.innerHTML = '<i class="fas fa-sync fa-spin"></i> Syncing...';
        statusElement.style.color = '#28a745';
    }
    
    // Parse credentials (format: email,password,smtp_server,port OR email:password)
    const credentialLines = credentials.split('\n').filter(line => line.trim());
    let syncedCount = 0;
    let errorCount = 0;
    
    credentialLines.forEach((line, index) => {
        const trimmedLine = line.trim();
        let email, password, domain;
        
        // Check if it's CSV format (comma-separated)
        if (trimmedLine.includes(',') && !trimmedLine.includes(':')) {
            const parts = trimmedLine.split(',');
            if (parts.length >= 2) {
                email = parts[0].trim();
                password = parts[1].trim();
                domain = email.includes('@') ? email.split('@')[1] : '';
            }
        }
        // Check if it's colon format (email:password)
        else if (trimmedLine.includes(':')) {
            const parts = trimmedLine.split(':');
            if (parts.length >= 2) {
                email = parts[0].trim();
                password = parts.slice(1).join(':').trim(); // Handle passwords with colons
                domain = email.includes('@') ? email.split('@')[1] : '';
            }
        }
        
        if (email && password && email.includes('@')) {
            console.log(`Syncing credential: ${email} -> ${password.substring(0, 4)}...`);
            logResult(`🔄 Syncing: ${email}`);
            
            // Store each credential as an app password
            console.log(`Storing app password for: ${email}`);
            logResult(`📤 Storing: ${email} -> ${password.substring(0, 4)}...`);
            
            fetch('/api/store-app-password', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    user_alias: email,
                    app_password: password,
                    domain: domain || email.split('@')[1] // Use extracted domain or fallback
                })
            })
            .then(response => {
                console.log(`Response for ${email}:`, response.status);
                return response.json();
            })
            .then(data => {
                console.log(`Data for ${email}:`, data);
                if (data.success) {
                    syncedCount++;
                    logResult(`✅ Synced: ${email}`);
                } else {
                    errorCount++;
                    logResult(`❌ Failed to sync ${email}: ${data.error}`);
                }
                
                // If this is the last credential, show summary
                if (index === credentialLines.length - 1) {
                    logResult(`📊 Sync Complete: ${syncedCount} synced, ${errorCount} failed`);
                    
                    // Update status indicator
                    if (statusElement) {
                        if (errorCount === 0) {
                            statusElement.innerHTML = '<i class="fas fa-check"></i> Synced';
                            statusElement.style.color = '#28a745';
                        } else {
                            statusElement.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${syncedCount} synced, ${errorCount} failed`;
                            statusElement.style.color = '#d73a49';
                        }
                    }
                    
                    // Refresh the app passwords display
                    loadAllAppPasswords();
                }
            })
            .catch(error => {
                errorCount++;
                logResult(`❌ Error syncing ${email}: ${error.message}`);
                
                if (index === credentialLines.length - 1) {
                    logResult(`📊 Sync Complete: ${syncedCount} synced, ${errorCount} failed`);
                    
                    // Update status indicator
                    if (statusElement) {
                        if (errorCount === 0) {
                            statusElement.innerHTML = '<i class="fas fa-check"></i> Synced';
                            statusElement.style.color = '#28a745';
                        } else {
                            statusElement.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${syncedCount} synced, ${errorCount} failed`;
                            statusElement.style.color = '#d73a49';
                        }
                    }
                    
                    loadAllAppPasswords();
                }
            });
        } else {
            errorCount++;
            logResult(`❌ Invalid format: ${line}`);
        }
    });
    
    if (credentialLines.length === 0) {
        alert('No valid credentials found. Please use format: email:password');
    }
}

// Auto-sync SMTP credentials with debouncing
let smtpSyncTimeout;
function autoSyncSMTPCredentials() {
    // Clear previous timeout
    if (smtpSyncTimeout) {
        clearTimeout(smtpSyncTimeout);
    }
    
    // Set new timeout for auto-sync (2 seconds delay)
    smtpSyncTimeout = setTimeout(() => {
        const credentials = document.getElementById('smtp-credentials').value.trim();
        
        if (credentials && (credentials.includes(':') || credentials.includes(','))) {
            console.log('Auto-syncing SMTP credentials...');
            syncSMTPToAppPasswords();
        }
    }, 2000);
}

// Test SMTP parsing function
function testSMTPParsing() {
    const credentials = document.getElementById('smtp-credentials').value.trim();
    
    if (!credentials) {
        alert('Please enter SMTP credentials first');
        return;
    }
    
    console.log('Testing SMTP parsing...');
    logResult('🧪 Testing SMTP credential parsing...');
    
    const credentialLines = credentials.split('\n').filter(line => line.trim());
    
    credentialLines.forEach((line, index) => {
        const trimmedLine = line.trim();
        let email, password, domain;
        
        console.log(`Line ${index + 1}: "${trimmedLine}"`);
        logResult(`📝 Line ${index + 1}: "${trimmedLine}"`);
        
        // Check if it's CSV format (comma-separated)
        if (trimmedLine.includes(',') && !trimmedLine.includes(':')) {
            const parts = trimmedLine.split(',');
            console.log(`CSV format detected: ${parts.length} parts`);
            logResult(`📊 CSV format detected: ${parts.length} parts`);
            
            if (parts.length >= 2) {
                email = parts[0].trim();
                password = parts[1].trim();
                domain = email.includes('@') ? email.split('@')[1] : '';
                
                console.log(`Parsed: email=${email}, password=${password.substring(0, 4)}..., domain=${domain}`);
                logResult(`✅ Parsed: ${email} -> ${password.substring(0, 4)}... (${domain})`);
            } else {
                console.log('❌ Not enough parts in CSV format');
                logResult('❌ Not enough parts in CSV format');
            }
        }
        // Check if it's colon format (email:password)
        else if (trimmedLine.includes(':')) {
            const parts = trimmedLine.split(':');
            console.log(`Colon format detected: ${parts.length} parts`);
            logResult(`📊 Colon format detected: ${parts.length} parts`);
            
            if (parts.length >= 2) {
                email = parts[0].trim();
                password = parts.slice(1).join(':').trim();
                domain = email.includes('@') ? email.split('@')[1] : '';
                
                console.log(`Parsed: email=${email}, password=${password.substring(0, 4)}..., domain=${domain}`);
                logResult(`✅ Parsed: ${email} -> ${password.substring(0, 4)}... (${domain})`);
            } else {
                console.log('❌ Not enough parts in colon format');
                logResult('❌ Not enough parts in colon format');
            }
        } else {
            console.log('❌ No recognized format detected');
            logResult('❌ No recognized format detected');
        }
    });
    
    logResult('🧪 Parsing test complete. Check console for detailed output.');
}

function fetchAppPasswordsForWorkflow() {
    logBulkDomain('🔍 Fetching stored app passwords...');
    
    fetch('/api/get-all-app-passwords')
    .then(response => response.json())
    .then(data => {
        if (data.success && data.app_passwords.length > 0) {
            logBulkDomain(`📋 Found ${data.app_passwords.length} stored app passwords:`);
            data.app_passwords.forEach(password => {
                logBulkDomain(`   🔑 ${password.user_alias} - ${password.app_password} ${password.domain ? `(${password.domain})` : ''}`);
            });
            
            // Display in the App Passwords Display field
            displayWorkflowAppPasswords(data.app_passwords);
        } else {
            logBulkDomain('⚠️ No app passwords found in storage');
            logBulkDomain('💡 Tip: Store app passwords in the App Password Management section first');
        }
    })
    .catch(error => {
        logBulkDomain(`❌ Error fetching app passwords: ${error.message}`);
    });
}

function storeAppPasswordsForWorkflow(accounts) {
    logBulkDomain('💾 Storing app passwords for workflow...');
    
    // Generate sample app passwords for each account
    accounts.forEach(account => {
        const username = account.split('@')[0];
        const domain = account.split('@')[1];
        
        // Generate a random app password
        const appPassword = generateRandomPassword(16);
        
        // Store the app password
        fetch('/api/store-app-password', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                user_alias: account,
                app_password: appPassword,
                domain: domain
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                logBulkDomain(`✅ Stored app password for ${account}`);
            } else {
                logBulkDomain(`❌ Failed to store app password for ${account}: ${data.error}`);
            }
        })
        .catch(error => {
            logBulkDomain(`❌ Error storing app password for ${account}: ${error.message}`);
        });
    });
}
function storeAndDisplayAppPasswordsForWorkflow(accounts) {
    logBulkDomain('💾 Storing and displaying app passwords for workflow...');
    logBulkDomain('🔄 REFACTORED: Enhanced app password retrieval with new subdomains');
    
    // CRITICAL: Use the EXACT subdomain that was actually changed during Mega Upgrade
    if (window.megaUpgradeChangedSubdomain) {
        logBulkDomain(`🎯 Using ACTUAL Mega Upgrade subdomain: ${window.megaUpgradeChangedSubdomain}`);
        logBulkDomain(`✅ This is the EXACT subdomain that was changed during the process`);
        generateAppPasswordsWithTargetDomain(accounts, window.megaUpgradeChangedSubdomain);
        return;
    }
    
    // If no detected subdomain, we need to find the ACTUAL changed subdomain
    logBulkDomain('🔍 No detected subdomain, finding the ACTUAL changed subdomain...');
    
    fetch('/api/retrieve-domains', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            batched: true
        })
    })
    .then(response => response.json())
    .then(data => {
            if (data.success && data.domains && data.domains.length > 0) {
            logBulkDomain(`✅ Retrieved ${data.domains.length} domains`);
            
            // Debug: Log all domains to understand the structure
            logBulkDomain(`🔍 Debug: Analyzing ${data.domains.length} domains...`);
            data.domains.forEach((domain, index) => {
                logBulkDomain(`   Domain ${index + 1}: ${JSON.stringify(domain)}`);
            });
            
            // Find the ACTUAL subdomain that was changed (look for the one with the most recent activity)
            let targetDomain = null;
            
            // PRIORITY 1: Look for domains that were just changed (IN USE with users)
            const inUseDomains = data.domains.filter(domain => 
                (domain.status === 'in_use' || domain.status_text === 'IN USE') && 
                domain.user_count > 0 && 
                (domain.domainName || domain.domain_name) && 
                (domain.domainName || domain.domain_name) !== 'undefined'
            );
            
            logBulkDomain(`🔍 Found ${inUseDomains.length} IN USE domains with users`);
            
            if (inUseDomains.length > 0) {
                // Build a base->newSubdomain map by comparing IN USE vs AVAILABLE per base
                const availableByBase = {};
                data.domains
                    .filter(d => (d.status === 'available' || d.status_text === 'AVAILABLE'))
                    .forEach(d => {
                        const dn = d.domainName || d.domain_name;
                        if (!dn) return;
                        const parts = dn.split('.');
                        if (parts.length < 2) return;
                        const base = parts.slice(1).join('.');
                        if (!availableByBase[base]) availableByBase[base] = [];
                        availableByBase[base].push(dn);
                    });

                const baseToNewSubdomainMap = {};
                inUseDomains.forEach(d => {
                    const dn = d.domainName || d.domain_name;
                    if (!dn) return;
                    const parts = dn.split('.');
                    if (parts.length < 2) return;
                    const base = parts.slice(1).join('.');
                    const candidates = availableByBase[base] || [];
                    if (candidates.length > 0) {
                        // Choose the lexicographically next available as the new subdomain target
                        candidates.sort();
                        baseToNewSubdomainMap[base] = candidates[0];
                    } else {
                        // Fallback to current in-use if no available found
                        baseToNewSubdomainMap[base] = dn;
                    }
                });

                // Save map globally for formatter
                window.baseToNewSubdomainMap = baseToNewSubdomainMap;

                // Also pick one representative for logging/legacy path
                const firstBase = Object.keys(baseToNewSubdomainMap)[0];
                targetDomain = baseToNewSubdomainMap[firstBase];
                logBulkDomain(`🎯 Using NEXT subdomain mapping per base: ${JSON.stringify(baseToNewSubdomainMap)}`);
            } else {
                // PRIORITY 2: Look for any domain with users (fallback)
                const domainsWithUsers = data.domains.filter(domain => 
                    domain.user_count > 0 && 
                    (domain.domainName || domain.domain_name) && 
                    (domain.domainName || domain.domain_name) !== 'undefined'
                );
                
                logBulkDomain(`🔍 Found ${domainsWithUsers.length} domains with users`);
                
                if (domainsWithUsers.length > 0) {
                    const selectedDomain = domainsWithUsers.reduce((prev, current) => 
                        (current.user_count > prev.user_count) ? current : prev
                    );
                    targetDomain = selectedDomain.domainName || selectedDomain.domain_name;
                    const userCount = selectedDomain.user_count;
                    logBulkDomain(`🎯 Found domain with users: ${targetDomain} (${userCount} users)`);
                } else {
                    // PRIORITY 3: Look for any domain with a valid domainName
                    const validDomains = data.domains.filter(domain => 
                        (domain.domainName || domain.domain_name) && 
                        (domain.domainName || domain.domain_name) !== 'undefined' &&
                        (domain.domainName || domain.domain_name).length > 0
                    );
                    
                    logBulkDomain(`🔍 Found ${validDomains.length} domains with valid names`);
                    
                    if (validDomains.length > 0) {
                        targetDomain = validDomains[0].domainName || validDomains[0].domain_name;
                        logBulkDomain(`🎯 Using first valid domain: ${targetDomain}`);
                    } else {
                        logBulkDomain(`❌ No valid domains found - cannot proceed`);
                        return;
                    }
                }
            }
            
            if (targetDomain) {
                logBulkDomain(`🌐 Using ACTUAL changed subdomain: ${targetDomain}`);
                logBulkDomain(`✅ This is the EXACT subdomain that was changed during the process`);
                
                // Save the ACTUAL subdomain
                window.selectedSubdomain = targetDomain;
                window.megaUpgradeChangedSubdomain = targetDomain;
                logBulkDomain(`💾 Saved ACTUAL subdomain: ${targetDomain}`);
                
                generateAppPasswordsWithTargetDomain(accounts, targetDomain);
            } else {
                logBulkDomain(`❌ No suitable ACTUAL subdomain found`);
                logBulkDomain(`⚠️ Cannot proceed without the actual changed subdomain`);
                logBulkDomain(`🔄 Attempting manual domain fallback...`);
                
                // Try manual domain fallback
                generateAppPasswordsWithManualDomainChange(accounts);
            }
        } else {
            logBulkDomain(`❌ Failed to retrieve domains`);
            logBulkDomain(`⚠️ Cannot proceed without domain information`);
        }
    })
    .catch(error => {
        logBulkDomain(`❌ Error retrieving domains: ${error.message}`);
        logBulkDomain(`⚠️ Cannot proceed without domain information`);
    });
}

function generateAppPasswordsWithTargetDomain(accounts, targetDomain) {
    logBulkDomain(`🔑 Preparing SMTP lines using stored app passwords`);
    window.currentTargetDomain = targetDomain;
    window.megaUpgradeChangedSubdomain = targetDomain;

    fetch('/api/get-all-app-passwords')
        .then(r => r.json())
        .then(data => {
            if (!data.success) {
                logBulkDomain(`❌ Failed to load stored app passwords: ${data.error || 'unknown error'}`);
                return;
            }

            const rows = data.app_passwords || [];
            if (rows.length === 0) {
                logBulkDomain('ℹ️ No stored app passwords found');
                return;
            }

            const output = [];
            // Support multi-base processing: use global base-to-subdomain map if available
            const baseMap = window.baseToNewSubdomainMap || null;
            // Extract new subdomain label and target base from single detected domain
            const targetParts = (targetDomain || '').split('.');
            const newSubLabelSingle = targetParts.length > 0 ? targetParts[0] : '';
            const targetBaseSingle = targetParts.length > 1 ? targetParts.slice(1).join('.') : '';
            
            logBulkDomain(`🔍 Total stored app passwords: ${rows.length}`);
            logBulkDomain(`🔍 Processing all stored passwords (aliases and passwords are static)`);
            
            rows.forEach(row => {
                const alias = row.user_alias || '';
                const pwd = row.app_password || '';
                if (!alias || !pwd) return;

                const [username, aliasDomain] = alias.includes('@') ? alias.split('@') : [alias, ''];
                if (!aliasDomain) return;

                // Compute base of alias (everything after the first dot)
                const aliasParts = aliasDomain.split('.');
                if (aliasParts.length < 2) return; // not a subdomain; skip
                const aliasBase = aliasParts.slice(1).join('.');

                // Determine mapped domain for this base
                let newDomainForAlias = '';
                if (baseMap && baseMap[aliasBase]) {
                    newDomainForAlias = baseMap[aliasBase];
                } else if (targetBaseSingle) {
                    if (aliasBase !== targetBaseSingle) return; // not part of processed base
                    newDomainForAlias = `${newSubLabelSingle}.${targetBaseSingle}`;
                } else {
                    return;
                }
                
                // Filter by alias and app password (both static) - include all stored passwords
                // No domain filtering since aliases and passwords are static
                logBulkDomain(`🔍 Including alias: ${alias} (base: ${aliasBase}) - aliases and passwords are static`);

                const line = `${username}@${newDomainForAlias},${pwd},smtp.gmail.com,587`;
                output.push(line);
            });

            if (output.length === 0) {
                logBulkDomain('ℹ️ No stored app passwords found to format');
                return;
            }

            const display = document.getElementById('app-passwords-display');
            display.value = output.join('\n');
            logBulkDomain(`📋 ${output.length} SMTP lines displayed (alias+password kept static)`);
        })
        .catch(err => {
            logBulkDomain(`❌ Error building SMTP lines: ${err.message}`);
        });
}

function generateAppPasswordsWithManualDomainChange(accounts) {
    logBulkDomain(`🔑 Generating app passwords with manual domain change...`);
    logBulkDomain(`🔄 This is a fallback when automatic domain detection fails`);
    
    const appPasswords = [];
    let completedAccounts = 0;
    const totalAccounts = accounts.length;
    
    // Get subdomain prefix from input field
    const subdomainPrefix = document.getElementById('mega-subdomain-prefix').value.trim();
    
    accounts.forEach((account, index) => {
        // Get the original domain from the account
        const originalDomain = account.split('@')[1];
        
        // MANUALLY change the domain from .giize.com to .mywire.org
        let updatedDomain = originalDomain;
        if (originalDomain.includes('.giize.com')) {
            updatedDomain = originalDomain.replace('.giize.com', '.mywire.org');
            logBulkDomain(`🔄 MANUAL DOMAIN CHANGE: ${originalDomain} → ${updatedDomain}`);
        }
        
        // Create the new subdomain format with custom or random subdomain
        const subdomain = subdomainPrefix || generateRandomSubdomain(16);
        const newDomain = `${subdomain}.${updatedDomain}`;
        
        logBulkDomain(`🔄 Creating new subdomain: ${newDomain} for account: ${account}`);
        logBulkDomain(`✅ Using manual subdomain: ${newDomain}`);
        
        // Store the manual subdomain globally
        window.megaUpgradeChangedSubdomain = newDomain;
        window.currentTargetDomain = newDomain;
        
        // Retrieve all users from the account and process them
        retrieveAllUsersForWorkflow(account, newDomain, appPasswords, () => {
            completedAccounts++;
            if (completedAccounts >= totalAccounts) {
                logBulkDomain(`✅ Completed manual domain change for all accounts`);
                displayAppPasswordsInWorkflow(appPasswords);
            }
        });
    });
}

function retrieveAllUsersForWorkflow(account, newDomain, appPasswords, onComplete) {
    logBulkDomain(`👥 REFACTORED: Retrieving all users from account: ${account}`);
    logBulkDomain(`🌐 Using new subdomain: ${newDomain}`);
    
    // Retrieve all users from the account
    fetch('/api/retrieve-users', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            domain: account.split('@')[1],
            batched: true
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.users && data.users.length > 0) {
            logBulkDomain(`✅ Retrieved ${data.users.length} users from ${account}`);
            logBulkDomain(`🔄 Processing users with new subdomain: ${newDomain}`);
            
    // Build SMTP lines for each user from stored passwords without changing them
    const alias_domain_map = {};
    data.users.forEach(u => {
        const user = (u.email || '').split('@')[0];
        alias_domain_map[u.email] = newDomain; // map full alias to new domain
        alias_domain_map[user] = newDomain;    // also map by username
    });
    fetch('/api/retrieve-app-passwords', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ alias_domain_map })
    })
    .then(r => r.json())
    .then(resp => {
        if (resp.success && Array.isArray(resp.app_passwords)) {
            // Append to appPasswords list used by displayAppPasswordsInWorkflow
            resp.app_passwords.forEach(line => appPasswords.push(line));
        } else if (!resp.success) {
            logBulkDomain(`❌ Failed to retrieve stored app passwords: ${resp.error}`);
        }
        onComplete();
    })
    .catch(err => {
        logBulkDomain(`❌ Error retrieving stored passwords: ${err.message}`);
        onComplete();
    });
        } else {
            logBulkDomain(`⚠️ No users found for account ${account}, using admin account only`);
            
            // Fallback to admin account only
            const username = account.split('@')[0];
            const appPassword = generateRandomPassword(16);
            const newAccount = `${username}@${newDomain}`;
            
            storeAppPasswordForUser(newAccount, appPassword, newDomain, appPasswords, onComplete);
        }
    })
    .catch(error => {
        logBulkDomain(`❌ Error retrieving users from ${account}: ${error.message}`);
        
        // Fallback to admin account only
        const username = account.split('@')[0];
        const appPassword = generateRandomPassword(16);
        const newAccount = `${username}@${newDomain}`;
        
        storeAppPasswordForUser(newAccount, appPassword, newDomain, appPasswords, onComplete);
    });
}

function generateAppPasswordsForUsers(users, newDomain, appPasswords, onComplete) {
    logBulkDomain(`🔑 REFACTORED: Generating app passwords for ${users.length} users`);
    logBulkDomain(`🌐 Using new subdomain: ${newDomain}`);
    
    let completedUsers = 0;
    const totalUsers = users.length;
    
    if (totalUsers === 0) {
        logBulkDomain(`⚠️ No users to process`);
        onComplete();
        return;
    }
    
    logBulkDomain(`👥 Processing ${totalUsers} users with new subdomain`);
    
    users.forEach((user, userIndex) => {
        const username = user.email.split('@')[0];
        const appPassword = generateRandomPassword(16);
        const newAccount = `${username}@${newDomain}`;
        
        logBulkDomain(`👤 Processing user ${userIndex + 1}/${totalUsers}: ${username}`);
        logBulkDomain(`🌐 Creating account: ${newAccount}`);
        
        storeAppPasswordForUser(newAccount, appPassword, newDomain, appPasswords, () => {
            completedUsers++;
            if (completedUsers >= totalUsers) {
                logBulkDomain(`✅ Completed processing ${totalUsers} users with new subdomain`);
                onComplete();
            }
        });
    });
}

function storeAppPasswordForUser(newAccount, appPassword, newDomain, appPasswords, onComplete) {
    // CRITICAL: Use the ACTUAL subdomain that was changed during Mega Upgrade
    const targetDomain = window.megaUpgradeChangedSubdomain || window.currentTargetDomain || newDomain;
    
    // Update the account to use the ACTUAL subdomain
    const username = newAccount.split('@')[0];
    const updatedAccount = `${username}@${targetDomain}`;
    
    logBulkDomain(`💾 Storing app password for ${updatedAccount} (using ACTUAL subdomain: ${targetDomain})`);
    logBulkDomain(`✅ This is the EXACT subdomain that was changed during Mega Upgrade`);
    
    // Store the app password with the saved subdomain
    fetch('/api/store-app-password', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            user_alias: updatedAccount,
            app_password: appPassword,
            domain: targetDomain
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            logBulkDomain(`✅ Stored app password for ${updatedAccount}`);
            
            // Add to display format with the saved subdomain
            appPasswords.push(`${updatedAccount},${appPassword},smtp.gmail.com,587`);
        } else {
            logBulkDomain(`❌ Failed to store app password for ${updatedAccount}: ${data.error}`);
        }
        
        onComplete();
    })
    .catch(error => {
        logBulkDomain(`❌ Error storing app password for ${updatedAccount}: ${error.message}`);
        onComplete();
    });
}

function generateAppPasswordsWithUpdatedDomain(accounts, updatedDomain) {
    logBulkDomain(`🔑 Generating app passwords with updated domain: ${updatedDomain}`);
    
    const appPasswords = [];
    let completedAccounts = 0;
    const totalAccounts = accounts.length;
    
    // Get subdomain prefix from input field
    const subdomainPrefix = document.getElementById('mega-subdomain-prefix').value.trim();
    
    accounts.forEach((account, index) => {
        // Create the new subdomain format with custom or random subdomain
        const subdomain = subdomainPrefix || generateRandomSubdomain(16);
        const newDomain = `${subdomain}.${updatedDomain}`;
        
        logBulkDomain(`🔄 Creating new subdomain: ${newDomain} for account: ${account}`);
        
        // Retrieve all users from the account and process them
        retrieveAllUsersForWorkflow(account, newDomain, appPasswords, () => {
            completedAccounts++;
            if (completedAccounts >= totalAccounts) {
                displayAppPasswordsInWorkflow(appPasswords);
            }
        });
    });
}

function displayAppPasswordsInWorkflow(appPasswords) {
    logBulkDomain(`📋 REFACTORED: Displaying ${appPasswords.length} app passwords with new subdomains`);
    logBulkDomain(`🔄 Enhanced display for Mega Upgrade workflow`);
    
    if (!appPasswords || appPasswords.length === 0) {
        logBulkDomain(`⚠️ No app passwords to display`);
        return;
    }
    
    // Display in the App Passwords Display field
    const display = document.getElementById('app-passwords-display');
    if (display) {
        const passwordText = appPasswords.join('\n');
        display.value = passwordText;
        logBulkDomain('✅ App passwords displayed in App Passwords Display field');
        logBulkDomain(`📝 Content: ${passwordText}`);
        
        // Also trigger a change event to ensure the display updates
        display.dispatchEvent(new Event('change', { bubbles: true }));
        
        // Force focus and scroll to the display field
        display.focus();
        display.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        logBulkDomain(`🎯 Display field updated with ${appPasswords.length} app passwords`);
    } else {
        logBulkDomain('❌ App Passwords Display field not found!');
        logBulkDomain('🔍 Searching for alternative display fields...');
        
        // Try alternative field names
        const altDisplay = document.getElementById('app-passwords-display') || 
                          document.getElementById('app-passwords-display-field') ||
                          document.querySelector('textarea[placeholder*="app password"]') ||
                          document.querySelector('textarea[placeholder*="App Password"]');
        
        if (altDisplay) {
            const passwordText = appPasswords.join('\n');
            altDisplay.value = passwordText;
            logBulkDomain('✅ App passwords displayed in alternative field');
            logBulkDomain(`📝 Content: ${passwordText}`);
        } else {
            logBulkDomain('❌ No suitable display field found!');
        }
    }
    
    // Also log each password for reference
    appPasswords.forEach((password, index) => {
        logBulkDomain(`   ${index + 1}. ${password}`);
    });
    
    // Show success message
    logBulkDomain(`🎉 SUCCESS: ${appPasswords.length} app passwords generated and displayed`);
    logBulkDomain(`✅ All users now have app passwords with the new subdomains`);
}

// Function to manually select and save a subdomain
function selectAndSaveSubdomain() {
    logBulkDomain('🔍 Retrieving available domains for manual selection...');
    
    fetch('/api/retrieve-domains', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            batched: true
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.domains && data.domains.length > 0) {
            logBulkDomain(`✅ Retrieved ${data.domains.length} domains`);
            
            // PRIORITY 1: Look for IN USE domains (these have users and should be updated)
            const inUseDomains = data.domains.filter(domain => domain.status === 'in_use' && domain.user_count > 0);
            let selectedDomain = null;
            
            if (inUseDomains.length > 0) {
                // Select the IN USE domain with the most users
                selectedDomain = inUseDomains.reduce((prev, current) => 
                    (current.user_count > prev.user_count) ? current : prev
                ).domainName;
                const userCount = inUseDomains.find(d => d.domainName === selectedDomain).user_count;
                logBulkDomain(`🎯 Selected IN USE domain: ${selectedDomain} (${userCount} users)`);
            } else {
                // PRIORITY 2: Look for any domain with users
                const domainsWithUsers = data.domains.filter(domain => domain.user_count > 0);
                if (domainsWithUsers.length > 0) {
                    selectedDomain = domainsWithUsers.reduce((prev, current) => 
                        (current.user_count > prev.user_count) ? current : prev
                    ).domainName;
                    const userCount = domainsWithUsers.find(d => d.domainName === selectedDomain).user_count;
                    logBulkDomain(`🎯 Selected domain with users: ${selectedDomain} (${userCount} users)`);
                } else {
                    // PRIORITY 3: Fallback to available domains
                    const availableDomains = data.domains.filter(domain => domain.status === 'available');
                    if (availableDomains.length > 0) {
                        selectedDomain = availableDomains[0].domainName;
                        logBulkDomain(`🎯 Selected AVAILABLE domain: ${selectedDomain}`);
                    }
                }
            }
            
            if (selectedDomain) {
                // Save the selected subdomain
                window.selectedSubdomain = selectedDomain;
                window.currentTargetDomain = selectedDomain;
                
                logBulkDomain(`💾 Saved selected subdomain: ${selectedDomain}`);
                logBulkDomain(`🔄 This subdomain will be used for updating users and app passwords`);
                
                // Update the subdomain prefix input field
                const subdomainPrefix = document.getElementById('mega-subdomain-prefix');
                if (subdomainPrefix) {
                    const subdomainPart = selectedDomain.split('.')[0];
                    subdomainPrefix.value = subdomainPart;
                    logBulkDomain(`📝 Updated subdomain prefix field: ${subdomainPart}`);
                }
            } else {
                logBulkDomain(`⚠️ No suitable domains found for selection`);
            }
        } else {
            logBulkDomain(`❌ Failed to retrieve domains`);
        }
    })
    .catch(error => {
        logBulkDomain(`❌ Error retrieving domains: ${error.message}`);
    });
}

// Function to update users and generate app passwords with the selected IN USE subdomain
function updateUsersWithSelectedSubdomain() {
    if (!window.selectedSubdomain) {
        logBulkDomain(`❌ No subdomain selected. Please run selectAndSaveSubdomain() first.`);
        return;
    }
    
    logBulkDomain(`🔄 Updating users with selected subdomain: ${window.selectedSubdomain}`);
    
    // Get the current account from the Mega Upgrade modal
    const accountEmail = document.getElementById('mega-single-account').value.trim();
    if (!accountEmail) {
        logBulkDomain(`❌ No account email found. Please enter an account email first.`);
        return;
    }
    
    const accounts = [accountEmail];
    logBulkDomain(`📧 Processing account: ${accountEmail}`);
    
    // Generate app passwords with the selected IN USE subdomain
    generateAppPasswordsWithTargetDomain(accounts, window.selectedSubdomain);
}

function generateRandomPassword(length) {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    let result = '';
    for (let i = 0; i < length; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
}

function generateRandomSubdomain(length) {
    const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
    let result = '';
    for (let i = 0; i < length; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
}

function displayWorkflowAppPasswords(appPasswords) {
    const display = document.getElementById('app-passwords-display');
    if (!display) return;
    
    let html = '<div class="workflow-app-passwords">';
    html += '<h4 style="margin-bottom: 16px; color: #24292f;">🔐 App Passwords for Workflow</h4>';
    
    appPasswords.forEach(password => {
        html += `
            <div class="workflow-password-item" style="border: 1px solid #28a745; border-radius: 6px; padding: 12px; margin-bottom: 8px; background: #d4edda;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong style="color: #155724;">${password.user_alias}</strong>
                        <div style="color: #155724; font-size: 14px; margin-top: 4px;">
                            🔑 ${password.app_password}
                        </div>
                        ${password.domain ? `<div style="color: #155724; font-size: 12px; margin-top: 2px;">🌐 ${password.domain}</div>` : ''}
                    </div>
                    <div style="color: #28a745; font-size: 12px;">
                        ✅ Ready
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    display.innerHTML = html;
}

async function copyToClipboard(text) {
    try {
        // Try modern clipboard API first
        if (navigator.clipboard && window.isSecureContext) {
            await navigator.clipboard.writeText(text);
            return true;
        } else {
            // Fallback method for HTTP sites
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            const successful = document.execCommand('copy');
            document.body.removeChild(textArea);
            return successful;
        }
    } catch (err) {
        console.error('Copy failed:', err);
        return false;
    }
}

function enterAuthorizationCode() {
    const accountName = document.getElementById('account-select').value;
    
    if (!accountName) {
        alert('Please select an account first');
        return;
    }
    
    // Get the account ID from the selected option
    const selectedOption = document.querySelector(`#account-select option[value="${accountName}"]`);
    const accountId = selectedOption ? selectedOption.getAttribute('data-account-id') : null;
    
    if (!accountId) {
        alert('Account ID not found. Please refresh the page and try again.');
        return;
    }
    
    const authCode = prompt('Paste the authorization code from the authentication page:');
    
    if (!authCode) {
        return;
    }
    
    // Complete authentication with code
    fetch('/api/complete-oauth', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            auth_code: authCode.trim(),
            account_id: accountId,
            account_name: accountName
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('✅ Authentication completed successfully!');
            
            // Store the authenticated account in sessionStorage for persistence
            sessionStorage.setItem('current_account_name', accountName);
            
            updateAccountStatusAfterAuth(accountName, true);
        } else {
            alert('❌ Authentication failed: ' + data.error);
        }
    })
    .catch(error => {
        alert('❌ Network error: ' + error);
    });
}

function copyResultsLog() {
    const logContent = document.getElementById('results-log').textContent;
    if (logContent.trim()) {
        copyToClipboard(logContent).then(success => {
            if (success) {
                alert('📋 Log copied to clipboard!');
            } else {
                alert('❌ Copy failed - please try manually selecting the text');
            }
        });
    } else {
        alert('No log content to copy');
    }
}

function updateAuthStatus(account, authenticated, message) {
    const statusBox = document.getElementById('auth-status');
    currentAccount = account;
    isAuthenticated = authenticated;
    
    if (authenticated) {
        statusBox.innerHTML = `<p style="color: green;">✅ Authenticated as: ${account}</p>`;
        statusBox.className = 'status-box success';
    } else {
        statusBox.innerHTML = `<p style="color: red;">❌ ${message || 'Not authenticated'}</p>`;
        statusBox.className = 'status-box error';
    }
}
function authenticateAccount() {
    const select = document.getElementById('account-select');
    const accountName = select.value;
    
    if (!accountName) {
        alert('Please select an account first');
        return;
    }
    
    // Get the account ID from the selected option
    const selectedOption = select.querySelector(`option[value="${accountName}"]`);
    const accountId = selectedOption ? selectedOption.getAttribute('data-account-id') : null;
    
    if (!accountId) {
        alert('Account ID not found. Please refresh the page and try again.');
        return;
    }
    
    console.log('DEBUG: Authenticating account:', accountName, 'ID:', accountId);
    updateAuthStatus(accountName, false, 'Authenticating...');
    
    fetch('/api/authenticate', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({account_id: accountId, account_name: accountName})
    })
    .then(response => response.json())
    .then(data => {
        console.log('DEBUG: API response:', data);
        
        if (data.success) {
            updateAuthStatus(accountName, true, data.message);
            
            // Store the authenticated account in sessionStorage for persistence
            sessionStorage.setItem('current_account_name', accountName);
            
            // UPDATE THE VISUAL STATUS IMMEDIATELY
            updateAccountStatusAfterAuth(accountName, true);
            
        } else if (data.oauth_required && data.oauth_url) {
            console.log('DEBUG: OAuth URL received:', data.oauth_url);
            updateAuthStatus(accountName, false, 'OAuth URL generated - opening...');
            
            // Show OAuth modal with the URL
            showOAuthModal(data.oauth_url);
            
        } else {
            console.error('DEBUG: Authentication failed:', data.error);
            updateAuthStatus(accountName, false, data.error || 'Authentication failed');
        }
    })
    .catch(error => {
        console.error('DEBUG: Network error:', error);
        updateAuthStatus(accountName, false, 'Network error: ' + error);
    });
}

function completeOAuthWithCode() {
    const authCode = prompt('Paste the authorization code from the OAuth success page:');
    const accountName = document.getElementById('account-select').value;
    
    if (!authCode || !accountName) {
        alert('Code and account selection required');
        return;
    }
    
    fetch('/api/complete-oauth', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            auth_code: authCode.trim(),
            account_name: accountName
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('✅ Authentication completed successfully!');
            updateAccountStatusAfterAuth(accountName, true);
        } else {
            alert('❌ Authentication failed: ' + data.error);
        }
    })
    .catch(error => {
        alert('❌ Network error: ' + error);
    });
}


// OAuth Modal functions
function showOAuthModal(authUrl) {
    const modal = document.getElementById('oauthModal');
    const urlDiv = document.getElementById('oauthUrl');
    
    urlDiv.textContent = authUrl;
    modal.style.display = 'block';
    
    // Store URL globally for copying
    window.currentOAuthUrl = authUrl;
}

function closeOAuthModal() {
    document.getElementById('oauthModal').style.display = 'none';
}

function copyOAuthUrl() {
    if (window.currentOAuthUrl) {
        copyToClipboard(window.currentOAuthUrl).then(success => {
            if (success) {
                alert('✅ OAuth URL copied to clipboard!');
            } else {
                alert('❌ Copy failed - please select and copy manually');
            }
        });
    }
}

function openOAuthUrl() {
    if (window.currentOAuthUrl) {
        window.open(window.currentOAuthUrl, '_blank');
    }
}

// Update existing window click handler
window.onclick = function(event) {
    const modal = document.getElementById('oauthModal');
    if (event.target === modal) {
        closeOAuthModal();
    }
}

function retrieveUsers() {
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    document.getElementById('user-display').innerHTML = `
        <div class="status-info" style="background: #fff3cd; border-color: #ffeaa7;">
            <p><strong>📊 Loading Users</strong></p>
            <p>Retrieving user data from Google Admin API...</p>
            <p><small>This may take up to 2 minutes for large user bases (10k+ users).</small></p>
            <div style="margin-top: 10px;">
                <div class="progress-bar" style="width: 100%; background-color: #f0f0f0; border-radius: 5px; overflow: hidden;">
                    <div class="progress-fill" style="width: 0%; height: 20px; background-color: #007bff; transition: width 0.3s ease;"></div>
                </div>
                <p style="margin-top: 5px; font-size: 12px; color: #666;">Please wait while we retrieve all users...</p>
            </div>
        </div>`;
    
    // Batched retrieval to avoid 504 timeouts
    const allUsers = [];
    let nextToken = null;
    let batches = 0;
    const progressFill = document.querySelector('.progress-fill');

    const fetchBatch = async () => {
        const payload = { mode: 'batched', max_pages: 6 };
        if (nextToken) payload.page_token = nextToken;
        const resp = await fetch('/api/retrieve-users', {
        method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        const text = await resp.text();
        let data;
        try { data = JSON.parse(text); } catch (e) { throw new Error('SERVER_HTML:' + text.slice(0,200)); }
        if (!data.success) throw new Error(data.error || 'Unknown error');
        allUsers.push(...data.users);
        nextToken = data.next_page_token || null;
        batches += 1;
        if (progressFill) progressFill.style.width = Math.min(95, 10 + batches * 8) + '%';
        if (nextToken) {
            await new Promise(r => setTimeout(r, 150));
            return fetchBatch();
        }
        if (progressFill) progressFill.style.width = '100%';
        return allUsers;
    };

    fetchBatch().then(users => {
        const activeUsers = users.filter(user => !user.suspended).length;
        const suspendedUsers = users.filter(user => user.suspended).length;
        const adminUsers = users.filter(user => user.admin).length;
            let html = `<div class="status-summary">
            <div class="status-item"><span class="status-label">📊 Total Users:</span><span class="status-value">${users.length}</span></div>
            <div class="status-item"><span class="status-label">✅ Active Users:</span><span class="status-value">${activeUsers}</span></div>
            <div class="status-item"><span class="status-label">🚫 Suspended Users:</span><span class="status-value">${suspendedUsers}</span></div>
            <div class="status-item"><span class="status-label">👑 Admin Users:</span><span class="status-value">${adminUsers}</span></div>
            </div>`;
        users.forEach(user => {
            const statusBadge = user.suspended ? '<span class="badge suspended">🚫 Suspended</span>' : '<span class="badge active">✅ Active</span>';
                html += `<div class="user-item ${user.suspended ? 'suspended-user-item' : ''}">
                    <span class="email">${user.email}</span>
                    <span class="name">${user.first_name} ${user.last_name}</span>
                <span class="status-badges">${user.admin ? '<span class="badge admin">👑 Admin</span>' : ''}${statusBadge}</span>
                </div>`;
            });
            document.getElementById('user-display').innerHTML = html;
        document.getElementById('user-count').textContent = `Total Users: ${users.length}`;
        setTimeout(() => { loadSuspendedUsers(); }, 500);
    })
    .catch(error => {
        let errorMessage = 'Failed to connect to the server';
        let errorDetails = 'Please check your connection and try again.';
        
        if (error.name === 'TimeoutError' || error.message.includes('timeout')) {
            errorMessage = 'Request Timeout';
            errorDetails = 'The request took longer than 2 minutes. For very large user bases (10k+ users), this is normal. Please try again.';
        } else if (error.name === 'AbortError') {
            errorMessage = 'Request Aborted';
            errorDetails = 'The request was cancelled. Please try again.';
        } else {
            errorMessage = 'Network Error';
            errorDetails = `Failed to connect to the server: ${error.message}`;
        }
        
        if (error.message && error.message.startsWith('SERVER_HTML:')) {
            const snippet = error.message.replace('SERVER_HTML:', '');
            document.getElementById('user-display').innerHTML = `
                <div class="status-info" style="background: #f8d7da; border-color: #f5c6cb;">
                    <p><strong>❌ Server Error</strong></p>
                    <p>The server returned an HTML error page instead of JSON. This usually means a timeout or crash upstream.</p>
                    <pre style="white-space: pre-wrap; max-height: 160px; overflow:auto; background:#fff; padding:8px; border:1px solid #eee;">${snippet}</pre>
                </div>`;
        } else {
        document.getElementById('user-display').innerHTML = `
            <div class="status-info" style="background: #f8d7da; border-color: #f5c6cb;">
                    <p><strong>❌ ${errorMessage}</strong></p>
                    <p>${errorDetails}</p>
                    <p><small>If you have a very large user base (10k+ users), this may be a timeout. We've raised server timeouts to handle this.</small></p>
            </div>`;
        }
    });
}

function clearUserList() {
    document.getElementById('user-display').innerHTML = `
        <div class="status-info">
            <p><strong>👥 User Management</strong></p>
            <p>Click "📊 Retrieve All Users" to load and display all users from your Google Workspace.</p>
            <p><small>This will show user status (Active/Suspended), admin privileges, and provide options for bulk operations.</small></p>
        </div>`;
    document.getElementById('user-count').textContent = 'Total Users: 0';
}

function copyAllUsers() {
    const userElements = document.querySelectorAll('.user-item');
    if (userElements.length === 0) {
        alert('No users to copy');
        return;
    }
    
    const emails = Array.from(userElements).map(element => {
        const emailElement = element.querySelector('.email');
        return emailElement ? emailElement.textContent.trim() : '';
    }).filter(email => email);
    
    const emailText = emails.join('\n');
    
    copyToClipboard(emailText).then(success => {
        if (success) {
            alert(`✅ Copied ${emails.length} user emails to clipboard`);
            logResult(`📋 Copied ${emails.length} user emails to clipboard`);
        } else {
            alert('❌ Copy failed - please try manually selecting the text');
        }
    });
}

function updateAllPasswords() {
    const password = document.getElementById('new-password').value;
    
    // Validation
    if (!password || password.length < 8) {
        alert('Password must be at least 8 characters');
        return;
    }
    
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    // Get emails from the displayed user items
    const userItems = document.querySelectorAll('.user-item .email');
    
    if (userItems.length === 0) {
        alert('No users found in the list. Please retrieve users first using "📊 Retrieve All Users" button.');
        return;
    }
    
    // Extract emails from the user display
    const userEmails = Array.from(userItems).map(item => item.textContent.trim());
    
    // Confirmation
    if (!confirm(`Update password for ALL ${userEmails.length} users?\n\nThis action cannot be undone.\n\nNew password: ${password}`)) {
        return;
    }
    
    // Show loading state
    const button = event.target;
    const originalText = button.textContent;
    button.textContent = '🔄 Updating Passwords...';
    button.disabled = true;
    
    // Make API request
    fetch('/api/update-all-passwords', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            password: password,
            user_emails: userEmails
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let message = data.message + '\n\n';
            
            if (data.successful_emails.length > 0) {
                message += `✅ Successfully updated (${data.successful_emails.length}):\n`;
                message += data.successful_emails.slice(0, 10).join('\n');
                if (data.successful_emails.length > 10) {
                    message += `\n... and ${data.successful_emails.length - 10} more`;
                }
                message += '\n\n';
            }
            
            if (data.failed_details.length > 0) {
                message += `❌ Failed updates (${data.failed_details.length}):\n`;
                data.failed_details.slice(0, 5).forEach(failure => {
                    message += `${failure.email}: ${failure.error}\n`;
                });
                if (data.failed_details.length > 5) {
                    message += `... and ${data.failed_details.length - 5} more failures`;
                }
            }
            
            alert(message);
            
            // Clear password field
            document.getElementById('new-password').value = '';
            
        } else {
            alert('❌ Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Network error:', error);
        alert('❌ Network error: ' + error.message);
    })
    .finally(() => {
        // Restore button state
        button.textContent = originalText;
        button.disabled = false;
    });
}

function retrieveDomains() {
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    document.getElementById('domain-display').innerHTML = `
        <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 5px; margin: 10px 0;">
            <p><strong>🔍 Loading Domains</strong></p>
            <p>Retrieving domain data from Google Admin API...</p>
            <p><small>This may take a moment for large domain lists (500+ domains).</small></p>
            <div style="margin-top: 10px;">
                <div class="progress-bar" style="width: 100%; background-color: #f0f0f0; border-radius: 5px; overflow: hidden;">
                    <div class="progress-fill" style="width: 0%; height: 20px; background-color: #007bff; transition: width 0.3s ease;"></div>
                </div>
                <p style="margin-top: 5px; font-size: 12px; color: #666;">Please wait while we retrieve all domains...</p>
            </div>
        </div>`;
    
    // Batched retrieval to avoid timeouts with large domain lists
    const allDomains = [];
    let nextToken = null;
    let batches = 0;
    const progressFill = document.querySelector('.progress-fill');

    const fetchBatch = async () => {
        const payload = { mode: 'batched' };
        if (nextToken) payload.page_token = nextToken;
        
        const resp = await fetch('/api/retrieve-domains', {
        method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        
        const text = await resp.text();
        let data;
        try { data = JSON.parse(text); } catch(e) { throw new Error('SERVER_HTML:' + text.slice(0,200)); }
        
        if (!data.success) throw new Error(data.error || 'Unknown error');
        
        allDomains.push(...data.domains);
        nextToken = data.next_page_token || null;
        batches += 1;
        
        if (progressFill) progressFill.style.width = Math.min(95, 10 + batches * 15) + '%';
        
        if (nextToken) {
            await new Promise(r => setTimeout(r, 200));
            return fetchBatch();
        }
        
        if (progressFill) progressFill.style.width = '100%';
        return allDomains;
    };

    fetchBatch().then(domains => {
            let html = '';
        domains.forEach(domain => {
            // Extract domain information
            const domainName = domain.domainName || domain.domain_name || domain.domain || 'Unknown Domain';
            const isVerified = domain.verified || domain.isVerified || domain.is_verified || false;
            const userCount = domain.user_count || 0;
            const status = domain.status || 'available';
            const statusText = domain.status_text || 'AVAILABLE';
            const statusColor = domain.status_color || '#4CAF50';
            
            // Create status badge based on domain status
            let statusBadge = '';
            if (status === 'in_use') {
                statusBadge = `<span class="badge in-use" style="background-color: #9C27B0; color: white;">🟣 IN USE</span>`;
            } else if (status === 'used') {
                statusBadge = `<span class="badge used" style="background-color: #FF9800; color: white;">🟠 USED</span>`;
            } else {
                statusBadge = `<span class="badge available" style="background-color: #4CAF50; color: white;">🟢 AVAILABLE</span>`;
            }
            
                html += `<div class="domain-item">
                <span class="domain-name">${domainName}</span>
                <span class="user-count">${userCount} users</span>
                ${isVerified ? '<span class="badge verified">✅ Verified</span>' : '<span class="badge unverified">❌ Not Verified</span>'}
                ${statusBadge}
                </div>`;
            });
            document.getElementById('domain-display').innerHTML = html;
    })
    .catch(error => {
        if (error.message && error.message.startsWith('SERVER_HTML:')) {
            const snippet = error.message.replace('SERVER_HTML:', '');
            document.getElementById('domain-display').innerHTML = `<div class="domain-error">❌ Server Error: HTML error page returned<pre style="white-space: pre-wrap; max-height: 160px; overflow:auto; background:#fff; padding:8px; border:1px solid #eee;">${snippet}</pre></div>`;
        } else {
        document.getElementById('domain-display').innerHTML = `<p style="color: red;">Network error: ${error}</p>`;
        }
    });
}

function clearDomainDisplay() {
    document.getElementById('domain-display').innerHTML = '<p>Click \'Retrieve Domains\' to view domains here...</p>';
}

function loadSuspendedUsers() {
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    document.getElementById('suspended-display').innerHTML = `
        <div class="status-info" style="background: #fff3cd; border-color: #ffeaa7;">
            <p><strong>🔍 Loading Suspended Users</strong></p>
            <p>Retrieving user data from Google Admin API...</p>
            <p><small>This may take a few moments depending on the number of users.</small></p>
        </div>`;
    
    fetch('/api/load-suspended-users', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        console.log('Suspended users API response:', data); // Debug log
        if (data.success) {
            if (data.users && data.users.length > 0) {
                let html = `<div class="status-info">
                    <p><strong>📊 Found ${data.total_count} suspended user(s):</strong></p>
                    ${data.debug_info ? `<p><small>Debug: Raw count: ${data.debug_info.raw_suspended_count}, Formatted: ${data.debug_info.formatted_count}</small></p>` : ''}
                </div>`;
                
                data.users.forEach(user => {
                    const fullName = user.full_name || `${user.first_name} ${user.last_name}`.trim() || 'No Name';
                    const adminBadge = user.admin ? '<span class="badge admin">👑 Admin</span>' : '';
                    const suspendedBadge = '<span class="badge suspended">🚫 Suspended</span>';
                    
                    html += `<div class="suspended-user">
                        <div class="user-info">
                            <span class="email">${user.email}</span>
                            <span class="name">${fullName}</span>
                            ${adminBadge}
                            ${suspendedBadge}
                        </div>
                    </div>`;
                });
                
                document.getElementById('suspended-display').innerHTML = html;
            } else {
                document.getElementById('suspended-display').innerHTML = `
                    <div class="status-info">
                        <p><strong>✅ No Suspended Users Found</strong></p>
                        <p>All users in this account are currently active.</p>
                        ${data.debug_info ? `<p><small>Debug: Raw count: ${data.debug_info.raw_suspended_count}, Formatted: ${data.debug_info.formatted_count}</small></p>` : ''}
                    </div>`;
            }
        } else {
            console.error('Suspended users API error:', data); // Debug log
            document.getElementById('suspended-display').innerHTML = `
                <div class="status-info" style="background: #f8d7da; border-color: #f5c6cb;">
                    <p><strong>❌ Error Loading Suspended Users</strong></p>
                    <p>${data.error || 'Unknown error occurred'}</p>
                    <p><small>Please try refreshing or re-authenticating your account.</small></p>
                    <button onclick="debugAuthStatus()" class="btn-github" style="margin-top: 10px;">
                        🔍 Debug Authentication Status
                    </button>
                    <button onclick="testSuspendedQuery()" class="btn-github" style="margin-top: 10px; margin-left: 10px;">
                        🧪 Test Suspended Query
                    </button>
                    <button onclick="console.log('Full API response:', ${JSON.stringify(data)})" class="btn-github" style="margin-top: 10px; margin-left: 10px;">
                        📋 Log Full Response
                    </button>
                </div>`;
        }
    })
    .catch(error => {
        document.getElementById('suspended-display').innerHTML = `
            <div class="status-info" style="background: #f8d7da; border-color: #f5c6cb;">
                <p><strong>❌ Network Error</strong></p>
                <p>Failed to connect to the server: ${error}</p>
                <p><small>Please check your connection and try again.</small></p>
            </div>`;
    });
}


function refreshSuspendedUsers() {
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    // Clear current display and reload
    document.getElementById('suspended-display').innerHTML = `
        <div class="status-info" style="background: #fff3cd; border-color: #ffeaa7;">
            <p><strong>🔄 Refreshing Suspended Users</strong></p>
            <p>Updating user status from Google Admin API...</p>
            <p><small>Please wait while we refresh the data.</small></p>
        </div>`;
    
    // Reload after a short delay to show the refresh message
    setTimeout(() => {
        loadSuspendedUsers();
    }, 1000);
}

function clearSuspendedUsers() {
    document.getElementById('suspended-display').innerHTML = `
        <div class="status-info">
            <p><strong>⛔ Suspended User Management</strong></p>
            <p>Click "🔍 Load Suspended Users" to check for suspended accounts in your Google Workspace.</p>
            <p><small>This will show all users with suspended status, including their names, emails, and admin privileges.</small></p>
        </div>`;
}

function debugAuthStatus() {
    fetch('/api/debug-auth-status')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const debugInfo = data.debug_info;
            const debugHtml = `
                <div class="status-info" style="background: #e7f3ff; border-color: #b3d9ff;">
                    <p><strong>🔍 Authentication Debug Information</strong></p>
                    <p><strong>Current Account:</strong> ${debugInfo.current_account || 'None'}</p>
                    <p><strong>Service Available:</strong> ${debugInfo.service_available ? '✅ Yes' : '❌ No'}</p>
                    <p><strong>Token Valid:</strong> ${debugInfo.token_valid ? '✅ Yes' : '❌ No'}</p>
                    <p><strong>Session ID:</strong> ${debugInfo.session_id || 'None'}</p>
                    <p><strong>Session Keys:</strong> ${debugInfo.session_keys.join(', ') || 'None'}</p>
                    <button onclick="clearSuspendedUsers()" class="btn-github" style="margin-top: 10px;">
                        🔙 Back to Suspended Users
                    </button>
                </div>`;
            document.getElementById('suspended-display').innerHTML = debugHtml;
        } else {
            alert('Debug failed: ' + data.error);
        }
    })
    .catch(error => {
        alert('Debug request failed: ' + error);
    });
}

function testSuspendedQuery() {
    document.getElementById('suspended-display').innerHTML = `
        <div class="status-info" style="background: #fff3cd; border-color: #ffeaa7;">
            <p><strong>🧪 Testing Suspended User Queries</strong></p>
            <p>Running diagnostic tests...</p>
        </div>`;
    
    fetch('/api/test-suspended-query', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        console.log('Test suspended query response:', data);
        if (data.success) {
            const results = data.results;
            let html = `
                <div class="status-info" style="background: #e7f3ff; border-color: #b3d9ff;">
                    <p><strong>🧪 Suspended Query Test Results</strong></p>
                    <p><strong>Account:</strong> ${data.account}</p>
            `;
            
            // Direct suspended query results
            if (results.direct_suspended_query.success) {
                html += `
                    <p><strong>Direct Suspended Query:</strong> ✅ Success</p>
                    <p><strong>Found:</strong> ${results.direct_suspended_query.count} suspended users</p>
                `;
                if (results.direct_suspended_query.users.length > 0) {
                    html += `<p><strong>Users:</strong></p><ul>`;
                    results.direct_suspended_query.users.forEach(user => {
                        html += `<li>${user.email} (suspended: ${user.suspended})</li>`;
                    });
                    html += `</ul>`;
                }
            } else {
                html += `
                    <p><strong>Direct Suspended Query:</strong> ❌ Failed</p>
                    <p><strong>Error:</strong> ${results.direct_suspended_query.error}</p>
                `;
            }
            
            // All users filter results
            if (results.all_users_filter.success) {
                html += `
                    <p><strong>All Users Filter:</strong> ✅ Success</p>
                    <p><strong>Total Users:</strong> ${results.all_users_filter.total_users}</p>
                    <p><strong>Suspended Users:</strong> ${results.all_users_filter.suspended_count}</p>
                `;
                if (results.all_users_filter.users.length > 0) {
                    html += `<p><strong>All Users (first 10):</strong></p><ul>`;
                    results.all_users_filter.users.forEach(user => {
                        html += `<li>${user.email} (suspended: ${user.suspended})</li>`;
                    });
                    html += `</ul>`;
                }
            } else {
                html += `
                    <p><strong>All Users Filter:</strong> ❌ Failed</p>
                    <p><strong>Error:</strong> ${results.all_users_filter.error}</p>
                `;
            }
            
            html += `
                <button onclick="clearSuspendedUsers()" class="btn-github" style="margin-top: 10px;">
                    🔙 Back to Suspended Users
                </button>
            </div>`;
            
            document.getElementById('suspended-display').innerHTML = html;
        } else {
            alert('Test failed: ' + data.error);
        }
    })
    .catch(error => {
        alert('Test request failed: ' + error);
    });
}

function refreshAccounts() {
    // Simply reload the page to refresh accounts from database
    location.reload();
}

// Modal functions
function openAddAccountModal() {
    document.getElementById('addAccountModal').style.display = 'block';
}

function closeAddAccountModal() {
    document.getElementById('addAccountModal').style.display = 'none';
    document.getElementById('addAccountForm').reset();
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('addAccountModal');
    if (event.target == modal) {
        closeAddAccountModal();
    }
}

// Save new account
function saveNewAccount() {
    const email = document.getElementById('new-account-email').value;
    const clientId = document.getElementById('new-client-id').value;
    const clientSecret = document.getElementById('new-client-secret').value;
    
    if (!email || !clientId || !clientSecret) {
        alert('All fields are required');
        return;
    }
    
    if (!email.includes('@')) {
        alert('Please enter a valid email address');
        return;
    }
    
    fetch('/api/add-account', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            account_name: email,
            client_id: clientId,
            client_secret: clientSecret
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('✅ Account added successfully!');
            closeAddAccountModal();
            location.reload(); // Reload to show new account
        } else {
            alert('❌ Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('❌ Network error: ' + error);
    });
}

// Account list functions
function selectAccountFromList(accountName, accountId) {
    // Remove previous selection
    document.querySelectorAll('.account-item').forEach(item => {
        item.classList.remove('selected');
    });
    
    // Select clicked item
    event.target.classList.add('selected');
    selectedAccountFromList = accountName;
    selectedAccountId = accountId;
    
    // Also update dropdown
    document.getElementById('account-select').value = accountName;
}

function filterAccounts() {
    const searchTerm = document.getElementById('account-search').value.toLowerCase();
    const accountItems = document.querySelectorAll('.account-item');
    
    accountItems.forEach(item => {
        const accountName = item.textContent.toLowerCase();
        if (accountName.includes(searchTerm)) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
}

function authenticateFromList() {
    if (!selectedAccountFromList || !selectedAccountId) {
        alert('Please select an account from the list first');
        return;
    }
    
    // Set the dropdown to selected account and authenticate
    document.getElementById('account-select').value = selectedAccountFromList;
    
    // Call the updated authenticate function
    authenticateAccount();
}
function deleteFromList() {
    if (!selectedAccountFromList || !selectedAccountId) {
        alert('Please select an account from the list first');
        return;
    }
    
    if (!confirm(`Are you sure you want to delete account: ${selectedAccountFromList}?`)) {
        return;
    }
    
    // Delete directly using the stored account ID
    fetch('/api/delete-account', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({account_id: selectedAccountId})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('✅ Account deleted successfully!');
            selectedAccountFromList = null;
            selectedAccountId = null;
            location.reload(); // Reload to refresh the display
        } else {
            alert('❌ Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Delete error:', error);
        alert('❌ Error: ' + error.message);
    });
}

// Bulk Delete Functions
function openBulkDeleteModal() {
    // Admin check is handled by the backend, so we can proceed directly
    // The button is only shown to admins via server-side template logic
    
    // Clear previous data
    document.getElementById('bulkDeleteAccounts').value = '';
    document.getElementById('bulkDeleteProgress').style.display = 'none';
    document.getElementById('bulkDeleteResults').style.display = 'none';
    document.getElementById('bulkDeleteExecuteBtn').disabled = false;
    
    // Show modal
    document.getElementById('bulkDeleteModal').style.display = 'block';
}

function closeBulkDeleteModal() {
    document.getElementById('bulkDeleteModal').style.display = 'none';
}

function executeBulkDelete() {
    const accountsText = document.getElementById('bulkDeleteAccounts').value.trim();
    
    if (!accountsText) {
        alert('❌ Please enter at least one account name to delete.');
        return;
    }
    
    // Parse account names
    const accountNames = accountsText.split('\n')
        .map(name => name.trim())
        .filter(name => name.length > 0);
    
    if (accountNames.length === 0) {
        alert('❌ Please enter valid account names.');
        return;
    }
    
    // Confirm deletion
    if (!confirm(`Are you sure you want to delete ${accountNames.length} accounts?\n\nThis action cannot be undone!`)) {
        return;
    }
    
    // Show progress
    document.getElementById('bulkDeleteProgress').style.display = 'block';
    document.getElementById('bulkDeleteResults').style.display = 'none';
    document.getElementById('bulkDeleteExecuteBtn').disabled = true;
    
    // Update progress
    updateBulkDeleteProgress(0, accountNames.length, 'Starting bulk deletion...');
    
    // Execute bulk delete
    fetch('/api/bulk-delete-accounts', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({account_names: accountNames})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateBulkDeleteProgress(accountNames.length, accountNames.length, 'Bulk deletion completed!');
            showBulkDeleteResults(data.results, accountNames.length);
            
            // Reload page after 3 seconds to refresh the account list
            setTimeout(() => {
                location.reload();
            }, 3000);
        } else {
            updateBulkDeleteProgress(0, accountNames.length, 'Bulk deletion failed!');
            showBulkDeleteResults([{success: false, account: 'All', error: data.error}], 0);
        }
    })
    .catch(error => {
        console.error('Bulk delete error:', error);
        updateBulkDeleteProgress(0, accountNames.length, 'Network error occurred!');
        showBulkDeleteResults([{success: false, account: 'All', error: error.message}], 0);
    })
    .finally(() => {
        document.getElementById('bulkDeleteExecuteBtn').disabled = false;
    });
}

function updateBulkDeleteProgress(completed, total, status) {
    const percentage = total > 0 ? (completed / total) * 100 : 0;
    
    document.getElementById('bulkDeleteStatus').textContent = status;
    document.getElementById('bulkDeleteCount').textContent = `${completed}/${total}`;
    document.getElementById('bulkDeleteProgressBar').style.width = percentage + '%';
}

function showBulkDeleteResults(results, totalAccounts) {
    const resultsContainer = document.getElementById('bulkDeleteResultsContent');
    let html = '';
    
    let successful = 0;
    let failed = 0;
    
    results.forEach(result => {
        if (result.success) {
            successful++;
            html += `<div style="color: #2da44e; margin-bottom: 4px;">✅ ${result.account} - Deleted successfully</div>`;
        } else {
            failed++;
            html += `<div style="color: #da3633; margin-bottom: 4px;">❌ ${result.account} - ${result.error}</div>`;
        }
    });
    
    // Add summary
    html = `<div style="font-weight: 600; margin-bottom: 8px; color: #24292f;">
                Summary: ${successful} successful, ${failed} failed out of ${totalAccounts} total
            </div>` + html;
    
    resultsContainer.innerHTML = html;
    document.getElementById('bulkDeleteResults').style.display = 'block';
}

function refreshAccountsDisplay() {
    // Simply reload the page to refresh accounts from database
            location.reload();
}

// Admin-only manual token status check
function forceTokenStatusCheck() {
    if (confirm('🔍 Force token status check for all accounts?\n\nThis will check the database for current token status.')) {
        console.log('Admin triggered manual token status check');
        
        // Update status display
        updateAccountStats(0, 0, 0, 'Admin check starting...');
        
        // Use database API instead of JSON
        checkTokenStatusFromDatabase();
    }
}

// Check token status from database (replaces JSON-based approach)
async function checkTokenStatusFromDatabase() {
    try {
        console.log('=== Starting DATABASE token status check ===');
        
        // Get token status from database API
        const response = await fetch('/api/check-token-status', {
            method: 'GET',
            headers: {'Content-Type': 'application/json'}
        });
        
        const data = await response.json();
        
        if (data.success && data.token_status) {
            console.log('Database token status received:', data.token_status);
            
            // Update visual status for each account
            let totalAccounts = data.token_status.length;
            let validAccounts = 0;
            let invalidAccounts = 0;
            
            data.token_status.forEach(accountStatus => {
                const accountName = accountStatus.account_name;
                const hasTokens = accountStatus.has_tokens;
                const tokenValid = accountStatus.token_valid;
                
                // Find the account item in the UI
                const accountItems = document.querySelectorAll('.account-item');
                accountItems.forEach(item => {
                    const itemAccountName = item.textContent.trim().split('\n')[0].trim();
                    if (itemAccountName === accountName) {
                        // Remove old status
                        const oldStatus = item.querySelector('.token-status');
                        if (oldStatus) oldStatus.remove();
                        
                        // Add new status
                        const statusSpan = document.createElement('span');
                        statusSpan.className = 'token-status';
                        statusSpan.textContent = tokenValid ? ' ✅' : ' ❌';
                        statusSpan.style.cssText = 'float: right; margin-left: 10px;';
                        item.appendChild(statusSpan);
                        
                        // Update dropdown
                        updateDropdownOption(accountName, tokenValid);
                        
                        // Count accounts
                        if (tokenValid) {
                            validAccounts++;
                        } else {
                            invalidAccounts++;
                        }
                    }
                });
            });
            
            // Update stats
            updateAccountStats(totalAccounts, validAccounts, invalidAccounts, 'Database check complete');
            console.log(`✅ Database check complete: ${validAccounts}/${totalAccounts} authenticated`);
            
        } else {
            console.error('Failed to get token status from database:', data.error);
            updateAccountStats(0, 0, 0, 'Database check failed');
        }
        
    } catch (error) {
        console.error('Database token status check failed:', error);
        updateAccountStats(0, 0, 0, 'Database check failed');
    }
}

function updateAccountStatusAfterAuth(accountName, isAuthenticated) {
    // Update the account in the list
    const accountItems = document.querySelectorAll('.account-item');
    
    accountItems.forEach(item => {
        const itemAccountName = item.textContent.trim().split('\n')[0].trim();
        
        if (itemAccountName === accountName) {
            // Remove old status
            const oldStatus = item.querySelector('.token-status');
            if (oldStatus) oldStatus.remove();
            
            // Add new status
            const statusSpan = document.createElement('span');
            statusSpan.className = isAuthenticated ? 'token-status valid' : 'token-status invalid';
            statusSpan.textContent = isAuthenticated ? ' ✅' : ' ❌';
            statusSpan.style.cssText = 'float: right; margin-left: 10px;';
            item.appendChild(statusSpan);
            
            console.log(`Updated ${accountName} status to: ${isAuthenticated ? 'Valid' : 'Invalid'}`);
        }
    });
    
    // Update dropdown
    const option = document.querySelector(`#account-select option[value="${accountName}"]`);
    if (option) {
        option.textContent = `${accountName} ${isAuthenticated ? '✅' : '❌'}`;
    }
    
    // Update counter
    updateCountersAfterChange();
}

function updateCountersAfterChange() {
    const accountItems = document.querySelectorAll('.account-item');
    let totalAccounts = accountItems.length;
    let validAccounts = 0;
    let invalidAccounts = 0;
    
    accountItems.forEach(item => {
        const statusElement = item.querySelector('.token-status');
        if (statusElement) {
            if (statusElement.textContent.includes('✅')) {
                validAccounts++;
            } else {
                invalidAccounts++;
            }
        }
    });
    
    updateAccountStats(totalAccounts, validAccounts, invalidAccounts, 'Updated');
}

function addFromServerJSON() {
    // Create a modal dialog instead of simple prompt
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    `;
    
    const dialog = document.createElement('div');
    dialog.style.cssText = `
        background: white;
        padding: 30px;
        border-radius: 10px;
        width: 600px;
        max-width: 90vw;
        max-height: 80vh;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        color: #333;
    `;
    
    dialog.innerHTML = `
        <h3 style="margin-bottom: 20px; color: #007bff;">📁 Add Accounts from Server JSON</h3>
        
        <p style="margin-bottom: 15px; color: #666;">
            Enter Google Workspace admin email addresses below (one per line).<br>
            The system will search for corresponding JSON credential files on the server.
        </p>
        
        <div style="margin-bottom: 15px;">
            <label style="font-weight: bold; display: block; margin-bottom: 5px;">Email Addresses:</label>
            <textarea id="emailInput" placeholder="admin@domain1.com&#10;admin@domain2.com&#10;admin@domain3.com&#10;..." 
                style="width: 100%; height: 250px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-family: monospace; resize: vertical;"></textarea>
        </div>
        
        <div style="margin-bottom: 20px; padding: 10px; background: #f8f9fa; border-radius: 5px; border-left: 4px solid #007bff;">
            <strong>💡 Tips:</strong>
            <ul style="margin: 5px 0 0 20px; color: #666;">
                <li>Enter one email address per line</li>
                <li>You can paste multiple emails at once</li>
                <li>Empty lines will be ignored</li>
                <li>Files must be named exactly: <code>&lt;email&gt;.json</code></li>
            </ul>
        </div>
        
        <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button id="cancelBtn" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">
                ❌ Cancel
            </button>
            <button id="searchBtn" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;" disabled>
                🔍 Search & Add Accounts
            </button>
        </div>
    `;
    
    modal.appendChild(dialog);
    document.body.appendChild(modal);
    
    // Get elements
    const emailInput = dialog.querySelector('#emailInput');
    const searchBtn = dialog.querySelector('#searchBtn');
    const cancelBtn = dialog.querySelector('#cancelBtn');
    
    // Update button state as user types
    function updateButtonState() {
        const text = emailInput.value.trim();
        if (!text) {
            searchBtn.disabled = true;
            return;
        }
        
        const emails = text.split('\n')
            .map(email => email.trim())
            .filter(email => email && email.includes('@'));
        
        searchBtn.disabled = emails.length === 0;
    }
    
    // Add event listeners
    emailInput.addEventListener('input', updateButtonState);
    emailInput.addEventListener('paste', () => setTimeout(updateButtonState, 10));
    
    cancelBtn.addEventListener('click', () => {
        document.body.removeChild(modal);
    });
    
    searchBtn.addEventListener('click', () => {
        const emails = emailInput.value.trim()
            .split('\n')
            .map(email => email.trim())
            .filter(email => email && email.includes('@'));
        
        if (emails.length === 0) {
            alert('No valid email addresses found');
            return;
        }
        
        // Close modal
        document.body.removeChild(modal);
        
        // Show confirmation
        if (!confirm(`Search for JSON credential files for ${emails.length} email address(es)?`)) {
            return;
        }
        
        // Process the search using server configuration
        processServerJSONSearch(emails);
    });
    
    // Close modal when clicking outside
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            document.body.removeChild(modal);
        }
    });
    
    // Focus on textarea
    setTimeout(() => emailInput.focus(), 100);
}

// Separate function to handle the actual API call using server configuration
function processServerJSONSearch(emails) {
    // Show loading in some button (you can modify this)
    const button = document.querySelector('[onclick="addFromServerJSON()"]');
    const originalText = button.textContent;
    button.textContent = '🔍 Searching...';
    button.disabled = true;
    
    // Make API request using server configuration
    fetch('/api/add-from-server-json', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({emails: emails})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let message = data.message + '\n\n';
            
            if (data.added_accounts && data.added_accounts.length > 0) {
                message += `✅ Successfully added:\n${data.added_accounts.join('\n')}\n\n`;
            }
            
            if (data.failed_accounts && data.failed_accounts.length > 0) {
                message += `❌ Failed accounts:\n`;
                for (const failed of data.failed_accounts) {
                    message += `${failed.email}: ${failed.error}\n`;
                }
            }
            
            alert(message);
            
            // Refresh the account list if any were added
            if (data.added_accounts && data.added_accounts.length > 0) {
                refreshAccountsDisplay();
            }
        } else {
            alert('❌ Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Network error:', error);
        alert('❌ Network error: ' + error.message);
    })
    .finally(() => {
        // Restore button state
        button.textContent = originalText;
        button.disabled = false;
    });
}

function debugSFTPFiles() {
    fetch('/api/debug-sftp-files', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let message = "SFTP Directory Contents:\n\n";
            
            if (data.directories.shared_credentials) {
                if (data.directories.shared_credentials.error) {
                    message += `❌ shared_credentials: ${data.directories.shared_credentials.error}\n\n`;
                } else {
                    message += `📁 shared_credentials (${data.directories.shared_credentials.total_count} files):\n`;
                    message += data.directories.shared_credentials.files.join('\n') + '\n\n';
                }
            }
            
            if (data.directories.account) {
                if (data.directories.account.error) {
                    message += `❌ account: ${data.directories.account.error}\n\n`;
                } else {
                    message += `📁 account (${data.directories.account.total_count} files):\n`;
                    message += data.directories.account.files.join('\n');
                }
            }
            
            alert(message);
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('Network error: ' + error);
    });
}

// Placeholder functions for buttons that need implementation

function backupFiles() {
    alert('Backup Files feature coming soon!');
}

// Update the existing refreshAccounts function
function refreshAccounts() {
    refreshAccountsDisplay();
}

// Tab 2 Functions

function createUsersFromCSV() {
    const fileInput = document.getElementById('csv-file-input');
    if (!fileInput.files.length) {
        alert('Please select a CSV file first');
        return;
    }
    
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    logResult('📥 Starting CSV user creation...');
    
    const formData = new FormData();
    formData.append('csv_file', fileInput.files[0]);
    
    fetch('/api/create-users-from-csv', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            logResult(`✅ CSV processing completed. Created ${data.created_count} users.`);
            if (data.results) {
                data.results.forEach(result => {
                    if (result.success) {
                        logResult(`✅ Created: ${result.email}`);
                    } else {
                        logResult(`❌ Failed: ${result.email} - ${result.error}`);
                    }
                });
            }
        } else {
            logResult(`❌ CSV creation failed: ${data.error}`);
        }
    })
    .catch(error => {
        logResult(`❌ Network error: ${error}`);
    });
}

function createRandomUsers() {
    const count = document.getElementById('random-user-count').value;
    const domain = document.getElementById('random-user-domain').value;
    const password = document.getElementById('random-user-password').value;
    
    if (!count || count <= 0) {
        alert('Please enter a valid number of users');
        return;
    }
    
    if (!domain || !domain.includes('.')) {
        alert('Please enter a valid domain');
        return;
    }
    
    if (!password || password.length < 8) {
        alert('Please enter a password (minimum 8 characters)');
        return;
    }
    
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    logResult(`🎲 Creating ${count} random users for ${domain} with password...`);
    
    fetch('/api/create-random-users', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            num_users: parseInt(count),
            domain: domain,
            password: password
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            logResult(`✅ Random user creation completed. Password: ${data.password}`);
            if (data.results) {
                let successCount = 0;
                let failureCount = 0;
                
                data.results.forEach(result => {
                    if (result.result.success) {
                        logResult(`✅ Created: ${result.email}`);
                        successCount++;
                    } else {
                        // Handle different error types for random users
                        if (result.result.error_type === 'domain_limit') {
                            logResult(`🚫 DOMAIN LIMIT: ${result.email} - ${result.result.error}`);
                            logResult(`💡 Solution: Upgrade to paid Google Workspace subscription`);
                        } else if (result.result.error_type === 'duplicate_user') {
                            logResult(`👤 DUPLICATE: ${result.email} - ${result.result.error}`);
                            logResult(`💡 Solution: User already exists, skipping`);
                        } else {
                            logResult(`❌ Failed: ${result.email} - ${result.result.error}`);
                        }
                        failureCount++;
                    }
                });
                
                logResult(`📊 Summary: ${successCount} successful, ${failureCount} failed`);
                
                if (failureCount > 0) {
                    logResult(`💡 Note: Some users failed due to domain limits or duplicates`);
                }
            }
        } else {
            // Handle overall failure
            if (data.error_type === 'domain_limit') {
                logResult(`🚫 DOMAIN LIMIT REACHED: ${data.error}`);
                logResult(`💡 Solution: Upgrade to a paid Google Workspace subscription`);
                logResult(`📊 Target domain: ${domain}`);
            } else {
                logResult(`❌ Random user creation failed: ${data.error}`);
            }
        }
    })
    .catch(error => {
        logResult(`❌ Network error: ${error.message}`);
        logResult(`💡 Solution: Check your internet connection and try again`);
    });
}

function createRandomAdminUsers() {
    const count = document.getElementById('random-admin-count').value;
    const domain = document.getElementById('random-admin-domain').value;
    const password = document.getElementById('random-admin-password').value;
    const adminRole = document.getElementById('admin-role').value;
    
    if (!count || count <= 0) {
        alert('Please enter a valid number of admin users');
        return;
    }
    
    if (!domain || !domain.includes('.')) {
        alert('Please enter a valid domain');
        return;
    }
    
    if (!password || password.length < 8) {
        alert('Please enter a password (minimum 8 characters)');
        return;
    }
    
    if (!adminRole) {
        alert('Please select an admin role');
        return;
    }
    
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    // Confirm admin creation due to elevated permissions
    if (!confirm(`⚠️ WARNING: You are about to create ${count} admin users with ${adminRole} permissions.\n\nThis will give them elevated access to your Google Workspace.\n\nAre you sure you want to continue?`)) {
        return;
    }
    
    logResult(`👑 Creating ${count} random admin users for ${domain} with ${adminRole} permissions...`);
    
    fetch('/api/create-random-admin-users', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            num_users: parseInt(count),
            domain: domain,
            password: password,
            admin_role: adminRole
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            logResult(`✅ Random admin user creation completed. Password: ${data.password}`);
            if (data.results) {
                let successCount = 0;
                let failureCount = 0;
                
                data.results.forEach(result => {
                    if (result.result.success) {
                        logResult(`✅ Created Admin: ${result.email} (${result.admin_role})`);
                        logResult(`📝 Note: ${result.result.message}`);
                        successCount++;
                    } else {
                        if (result.result.error_type === 'domain_limit') {
                            logResult(`🚫 DOMAIN LIMIT: ${result.email} - ${result.result.error}`);
                            logResult(`💡 Solution: Upgrade to paid Google Workspace subscription`);
                        } else if (result.result.error_type === 'duplicate_user') {
                            logResult(`👤 DUPLICATE: ${result.email} - ${result.result.error}`);
                            logResult(`💡 Solution: User already exists, skipping`);
                        } else if (result.result.error_type === 'admin_permission_error') {
                            logResult(`🔒 ADMIN PERMISSION ERROR: ${result.email} - ${result.result.error}`);
                            logResult(`💡 Solution: Check if you have permission to assign admin roles`);
                        } else {
                            logResult(`❌ Failed: ${result.email} - ${result.result.error}`);
                        }
                        failureCount++;
                    }
                });
                
                logResult(`📊 Summary: ${successCount} admin users created, ${failureCount} failed`);
                
                if (successCount > 0) {
                    logResult(`⚠️ IMPORTANT: Admin users have been created with elevated permissions!`);
                    logResult(`🔐 Please ensure these accounts are properly secured and monitored.`);
                }
                
                if (failureCount > 0) {
                    logResult(`💡 Note: Some admin users failed due to domain limits, duplicates, or permission issues`);
                }
            }
        } else {
            if (data.error_type === 'domain_limit') {
                logResult(`🚫 DOMAIN LIMIT REACHED: ${data.error}`);
                logResult(`💡 Solution: Upgrade to a paid Google Workspace subscription`);
            } else if (data.error_type === 'admin_permission_error') {
                logResult(`🔒 ADMIN PERMISSION ERROR: ${data.error}`);
                logResult(`💡 Solution: Ensure you have permission to create admin users`);
            } else {
                logResult(`❌ Random admin user creation failed: ${data.error}`);
            }
        }
    })
    .catch(error => {
        logResult(`❌ Network error: ${error.message}`);
        logResult(`💡 Solution: Check your internet connection and try again`);
    });
}
function updateUserPasswords() {
    const usersText = document.getElementById('password-update-users').value;
    const newPassword = document.getElementById('password-update-new-password').value;
    
    if (!usersText.trim()) {
        alert('Please enter user email addresses');
        return;
    }
    
    if (!newPassword || newPassword.length < 8) {
        alert('Please enter a password (minimum 8 characters)');
        return;
    }
    
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    // Parse users from textarea (one per line)
    const users = usersText.split('\n')
        .map(line => line.trim())
        .filter(line => line.length > 0);
    
    if (users.length === 0) {
        alert('Please enter at least one valid email address');
        return;
    }
    
    logResult(`🔑 Updating passwords for ${users.length} users...`);
    
    fetch('/api/update-user-passwords', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            users: users,
            new_password: newPassword
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            logResult(`✅ Password update completed!`);
            if (data.results) {
                let successCount = 0;
                let failureCount = 0;
                
                data.results.forEach(result => {
                    if (result.success) {
                        logResult(`✅ Updated: ${result.email}`);
                        successCount++;
                    } else {
                        logResult(`❌ Failed: ${result.email} - ${result.error}`);
                        failureCount++;
                    }
                });
                
                logResult(`📊 Summary: ${successCount} successful, ${failureCount} failed`);
            }
        } else {
            logResult(`❌ Password update failed: ${data.error}`);
        }
    })
    .catch(error => {
        logResult(`❌ Network error: ${error.message}`);
        logResult(`💡 Solution: Check your internet connection and try again`);
    });
}

// User Suspension Functions
function suspendUser() {
    const email = document.getElementById('suspend-user-email').value.trim();
    
    if (!email) {
        alert('Please enter an email address');
        return;
    }
    
    if (!email.includes('@')) {
        alert('Please enter a valid email address');
        return;
    }
    
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    if (!confirm(`⚠️ Are you sure you want to suspend user: ${email}?\n\nThis will prevent them from accessing their account.`)) {
        return;
    }
    
    logResult(`🚫 Suspending user: ${email}...`);
    
    fetch('/api/suspend-user', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ email: email })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            logResult(`✅ ${data.message}`);
            document.getElementById('suspend-user-email').value = '';
        } else {
            logResult(`❌ Failed to suspend user: ${data.error}`);
        }
    })
    .catch(error => {
        logResult(`❌ Network error: ${error.message}`);
    });
}

function unsuspendUser() {
    const email = document.getElementById('unsuspend-user-email').value.trim();
    
    if (!email) {
        alert('Please enter an email address');
        return;
    }
    
    if (!email.includes('@')) {
        alert('Please enter a valid email address');
        return;
    }
    
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    if (!confirm(`✅ Are you sure you want to unsuspend user: ${email}?\n\nThis will restore their account access.`)) {
        return;
    }
    
    logResult(`✅ Unsuspending user: ${email}...`);
    
    fetch('/api/unsuspend-user', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ email: email })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            logResult(`✅ ${data.message}`);
            document.getElementById('unsuspend-user-email').value = '';
        } else {
            logResult(`❌ Failed to unsuspend user: ${data.error}`);
        }
    })
    .catch(error => {
        logResult(`❌ Network error: ${error.message}`);
    });
}


function loadSuspendedUsers() {
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    logResult('🔍 Loading suspended users...');
    
    fetch('/api/get-suspended-users')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displaySuspendedUsers(data.suspended_users);
            document.getElementById('suspended-count').textContent = `Suspended Users: ${data.total_count}`;
            logResult(`✅ Loaded ${data.total_count} suspended users`);
        } else {
            logResult(`❌ Failed to load suspended users: ${data.error}`);
            document.getElementById('suspended-display').innerHTML = `<div class="error-message">❌ Error: ${data.error}</div>`;
        }
    })
    .catch(error => {
        logResult(`❌ Network error: ${error.message}`);
        document.getElementById('suspended-display').innerHTML = `<div class="error-message">❌ Network error: ${error.message}</div>`;
    });
}

function displaySuspendedUsers(users) {
    if (!users || users.length === 0) {
        document.getElementById('suspended-display').innerHTML = '<div class="status-info"><p>✅ No suspended users found</p></div>';
        return;
    }
    
    let html = '<div class="suspended-users-list">';
    html += '<h4 style="margin-bottom: 16px; color: #d73a49;">🚫 Suspended Users</h4>';
    
    users.forEach(user => {
        const adminBadge = user.isAdmin ? '<span class="badge admin">👑 Admin</span>' : '';
        const lastLogin = user.lastLoginTime === 'Never' ? 'Never' : new Date(user.lastLoginTime).toLocaleDateString();
        
        // Standard suspended user styling
        const cardStyle = 'border: 1px solid #d73a49; background: #ffeaea;';
        const statusColor = '#d73a49';
        const statusIcon = '🚫';
        
        html += `
            <div class="suspended-user-item" style="${cardStyle} border-radius: 6px; padding: 12px; margin-bottom: 8px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>${user.name || user.firstName + ' ' + user.lastName}</strong>
                        <div style="color: #666; font-size: 14px;">${user.email}</div>
                        <div style="color: ${statusColor}; font-size: 12px; margin-top: 4px;">
                            ${statusIcon} Suspended | Last Login: ${lastLogin}
                        </div>
                        <div style="color: #666; font-size: 12px; margin-top: 2px;">
                            Reason: ${user.suspensionReason}
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        ${adminBadge}
                        <button onclick="unsuspendUserFromList('${user.email}')" class="btn-github btn-github-success" style="font-size: 12px; padding: 4px 8px;">
                            <i class="fas fa-user-check"></i> Unsuspend
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    document.getElementById('suspended-display').innerHTML = html;
}

function unsuspendUserFromList(email) {
    if (!confirm(`✅ Are you sure you want to unsuspend user: ${email}?`)) {
        return;
    }
    
    logResult(`✅ Unsuspending user: ${email}...`);
    
    fetch('/api/unsuspend-user', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ email: email })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            logResult(`✅ ${data.message}`);
            // Refresh the suspended users list
            loadSuspendedUsers();
        } else {
            logResult(`❌ Failed to unsuspend user: ${data.error}`);
        }
    })
    .catch(error => {
        logResult(`❌ Network error: ${error.message}`);
    });
}




function copySuspendedUsers() {
    const display = document.getElementById('suspended-display');
    
    // Check if there are any suspended users loaded
    if (!display || display.textContent.includes('📝 Activity log will appear here...') || 
        display.textContent.includes('No suspended users found') ||
        display.textContent.includes('Click "Load Suspended Users"')) {
        alert('No suspended users loaded. Please click "Load Suspended Users" first.');
        return;
    }
    
    const userItems = display.querySelectorAll('.suspended-user-item');
    
    if (userItems.length === 0) {
        alert('No suspended users to copy');
        return;
    }
    
    let emails = [];
    userItems.forEach(item => {
        // Extract only the email address from the item
        const emailElement = item.querySelector('div[style*="color: #666"]');
        
        if (emailElement) {
            const email = emailElement.textContent.trim();
            if (email && email.includes('@')) {
                emails.push(email);
            }
        }
    });
    
    if (emails.length > 0) {
        const textToCopy = emails.join('\n');
        
        // Try modern clipboard API first
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(textToCopy).then(() => {
                logResult(`📋 Copied ${emails.length} suspended user emails to clipboard`);
                alert(`✅ Copied ${emails.length} suspended user emails to clipboard!`);
            }).catch(() => {
                // Fallback method
                copyToClipboardFallback(textToCopy, emails.length);
            });
        } else {
            // Fallback for older browsers
            copyToClipboardFallback(textToCopy, emails.length);
        }
    } else {
        alert('No valid email addresses found to copy');
    }
}

function copyToClipboardFallback(text, count) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        const successful = document.execCommand('copy');
        if (successful) {
            logResult(`📋 Copied ${count} suspended user emails to clipboard (fallback method)`);
            alert(`✅ Copied ${count} suspended user emails to clipboard!`);
        } else {
            throw new Error('Copy command failed');
        }
    } catch (err) {
        logResult(`❌ Failed to copy to clipboard: ${err.message}`);
        alert('❌ Copy failed. Please try manually selecting the text.');
    } finally {
        document.body.removeChild(textArea);
    }
}

function refreshSuspendedUsers() {
    loadSuspendedUsers();
}

function clearSuspendedUsers() {
    document.getElementById('suspended-display').innerHTML = `
        <div class="status-info">
            <p><strong><i class="fas fa-user-slash"></i> Suspended User Management</strong></p>
            <p>Click "Load Suspended Users" to check for suspended accounts in your Google Workspace.</p>
            <p><small>This will show all users with suspended status, including their names, emails, and admin privileges.</small></p>
        </div>
    `;
    document.getElementById('suspended-count').textContent = 'Suspended Users: 0';
}

function changeDomainForUsers() {
    const oldDomain = document.getElementById('old-domain').value;
    const newDomain = document.getElementById('new-domain').value;
    const emailsText = document.getElementById('domain-change-emails').value;
    
    if (!oldDomain || !newDomain) {
        alert('Please enter both old and new domains');
        return;
    }
    
    if (!emailsText.trim()) {
        alert('Please enter email addresses');
        return;
    }
    
    const emails = emailsText.split('\n').map(e => e.trim()).filter(e => e);
    
    if (emails.length === 0) {
        alert('No valid email addresses found');
        return;
    }
    
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    logResult(`🔄 Changing domain from ${oldDomain} to ${newDomain} for ${emails.length} users...`);
    
    fetch('/api/change-domain', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            old_domain: oldDomain,
            new_domain: newDomain,
            user_emails: emails
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            logResult(`✅ Domain change completed for ${emails.length} users.`);
            if (data.results) {
                data.results.forEach(result => {
                    if (result.success) {
                        logResult(`✅ Changed: ${result.old_email} → ${result.new_email}`);
                    } else {
                        logResult(`❌ Failed: ${result.email} - ${result.error}`);
                    }
                });
            }
        } else {
            logResult(`❌ Domain change failed: ${data.error}`);
        }
    })
    .catch(error => {
        logResult(`❌ Network error: ${error}`);
    });
}

function deleteSpecificUsers() {
    const emailsText = document.getElementById('delete-user-emails').value;
    
    if (!emailsText.trim()) {
        alert('Please enter email addresses to delete');
        return;
    }
    
    const emails = emailsText.split('\n').map(e => e.trim()).filter(e => e);
    
    if (emails.length === 0) {
        alert('No valid email addresses found');
        return;
    }
    
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    if (!confirm(`⚠️ Are you sure you want to DELETE ${emails.length} users? This cannot be undone!`)) {
        return;
    }
    
    logResult(`❌ Deleting ${emails.length} users...`);
    
    fetch('/api/delete-users', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            user_emails: emails
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            logResult(`✅ User deletion completed for ${emails.length} users.`);
            if (data.results) {
                data.results.forEach(result => {
                    if (result.result.success) {
                        logResult(`✅ Deleted: ${result.email}`);
                    } else {
                        logResult(`❌ Failed to delete: ${result.email} - ${result.result.error}`);
                    }
                });
            }
        } else {
            logResult(`❌ User deletion failed: ${data.error}`);
        }
    })
    .catch(error => {
        console.error('Delete users error:', error);
        logResult(`❌ Network error: ${error.message || error}`);
    });
}

function createSingleUser() {
    const firstName = document.getElementById('new-user-first-name').value;
    const lastName = document.getElementById('new-user-last-name').value;
    const email = document.getElementById('new-user-email').value;
    const password = document.getElementById('new-user-password').value;

    if (!firstName || !lastName || !email || !password) {
        alert('Please fill in all fields for the new user.');
        return;
    }

    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }

    logResult(`➕ Creating user: ${email}...`);

    fetch('/api/create-gsuite-user', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            first_name: firstName,
            last_name: lastName,
            email: email,
            password: password
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            logResult(`✅ User ${email} created successfully.`);
            // Clear the form after successful creation
            document.getElementById('new-user-first-name').value = '';
            document.getElementById('new-user-last-name').value = '';
            document.getElementById('new-user-email').value = '';
            document.getElementById('new-user-password').value = '';
        } else {
            // Handle different error types with specific messages
            if (data.error_type === 'domain_limit') {
                logResult(`🚫 DOMAIN LIMIT REACHED: ${data.error}`);
                logResult(`💡 Solution: Upgrade to a paid Google Workspace subscription`);
                logResult(`📊 Current domain: ${email.split('@')[1]}`);
            } else if (data.error_type === 'auth_error') {
                logResult(`🔐 AUTHENTICATION ERROR: ${data.error}`);
                logResult(`💡 Solution: Please re-authenticate your account`);
            } else if (data.error_type === 'duplicate_user') {
                logResult(`👤 DUPLICATE USER: ${data.error}`);
                logResult(`💡 Solution: Use a different email address`);
            } else if (data.error_type === 'invalid_domain') {
                logResult(`🌐 INVALID DOMAIN: ${data.error}`);
                logResult(`💡 Solution: Check the domain name and try again`);
            } else {
                logResult(`❌ Failed to create user ${email}: ${data.error}`);
            }
            
            // Show raw error for debugging if available
            if (data.raw_error) {
                logResult(`🔍 Technical details: ${data.raw_error}`);
            }
        }
    })
    .catch(error => {
        logResult(`❌ Network error: ${error.message}`);
        logResult(`💡 Solution: Check your internet connection and try again`);
    });
}

function getDomainInfo() {
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }

    logResult('🔍 Retrieving domain info...');
    const display = document.getElementById('domain-info-display');
    display.innerHTML = '<p>Loading domains...</p>';

    fetch('/api/get-domain-info')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let html = '';
            if (data.domains.length > 0) {
                data.domains.forEach(domain => {
                    html += `<div class="domain-item">
                        <span>${domain.domainName}</span>
                        <button class="delete-button" onclick="deleteDomain('${domain.domainName}')">Delete</button>
                    </div>`;
                });
            } else {
                html = '<p>No domains found.</p>';
            }
            display.innerHTML = html;
            logResult(`✅ Domain info retrieved successfully.`);
        } else {
            display.innerHTML = `<p style="color: red;">Error: ${data.error}</p>`;
            logResult(`❌ Failed to retrieve domain info: ${data.error}`);
        }
    })
    .catch(error => {
        display.innerHTML = `<p style="color: red;">Network error: ${error}</p>`;
        logResult(`❌ Network error: ${error}`);
    });
}

function addDomainAlias() {
    const domainAlias = document.getElementById('new-domain-alias').value;

    if (!domainAlias) {
        alert('Please enter a domain alias.');
        return;
    }

    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }

    logResult(`➕ Adding domain alias: ${domainAlias}...`);

    fetch('/api/add-domain-alias', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ domain_alias: domainAlias })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            logResult(`✅ Domain alias ${domainAlias} added successfully.`);
            getDomainInfo(); // Refresh the domain list
        } else {
            logResult(`❌ Failed to add domain alias ${domainAlias}: ${data.error}`);
        }
    })
    .catch(error => {
        logResult(`❌ Network error: ${error}`);
    });
}

function deleteDomain(domainName) {
    if (!confirm(`Are you sure you want to delete the domain: ${domainName}?`)) {
        return;
    }

    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }

    logResult(`❌ Deleting domain: ${domainName}...`);

    fetch('/api/delete-domain', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ domain_name: domainName })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            logResult(`✅ Domain ${domainName} deleted successfully.`);
            getDomainInfo(); // Refresh the domain list
        } else {
            logResult(`❌ Failed to delete domain ${domainName}: ${data.error}`);
        }
    })
    .catch(error => {
        logResult(`❌ Network error: ${error}`);
    });
}




function retrieveAppPasswords() {
    const domain = document.getElementById('retrieve-domain').value.trim();
    
    if (!domain) {
        alert('Please enter a domain');
        return;
    }
    
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Retrieving...';
    button.disabled = true;
    
    fetch('/api/retrieve-app-passwords', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ domain: domain })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const display = document.getElementById('app-passwords-display');
            if (data.app_passwords.length > 0) {
                display.value = data.app_passwords.join('\n');
                logBulkDomain(`✅ ${data.message}`);
                logBulkDomain(`🔄 Domain updated: All usernames now use ${domain}`);
                logBulkDomain(`📧 SMTP format: user@domain,app_password,smtp.gmail.com,587`);
                if (data.optimization) {
                    logBulkDomain(`⚡ Optimization: ${data.optimization}`);
                }
            } else {
                display.value = `No app passwords found for domain: ${domain}`;
                logBulkDomain(`ℹ️ No app passwords found for domain ${domain}`);
            }
        } else {
            logBulkDomain(`❌ Retrieve failed: ${data.error}`);
            alert(`❌ Retrieve failed: ${data.error}`);
        }
    })
    .catch(error => {
        logBulkDomain(`❌ Network error: ${error}`);
        alert(`❌ Network error: ${error.message}`);
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

function copyAppPasswords() {
    const display = document.getElementById('app-passwords-display');
    
    if (!display.value.trim()) {
        alert('No app passwords to copy');
        return;
    }
    
    display.select();
    document.execCommand('copy');
    
    // Show feedback
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-check"></i> Copied!';
    button.style.backgroundColor = '#2da44e';
    
    setTimeout(() => {
        button.innerHTML = originalText;
        button.style.backgroundColor = '';
    }, 2000);
    
    logBulkDomain('📋 SMTP configuration copied to clipboard');
}

function clearAppPasswordsDisplay() {
    const display = document.getElementById('app-passwords-display');
    display.value = '';
    logBulkDomain('🧹 SMTP configuration display cleared');
}

function deleteAllAppPasswords() {
    // Double confirmation for admin-only permanent deletion
    const confirm1 = confirm('⚠️ ADMIN ONLY: This will PERMANENTLY DELETE ALL app passwords from the database!\n\nThis action cannot be undone!\n\nAre you sure you want to continue?');
    
    if (!confirm1) {
        return;
    }
    
    const confirm2 = confirm('🚨 FINAL CONFIRMATION 🚨\n\nYou are about to PERMANENTLY DELETE ALL app passwords!\n\nType "DELETE ALL" in the next prompt to confirm.');
    
    if (!confirm2) {
        return;
    }
    
    const finalConfirm = prompt('Type "DELETE ALL" to permanently delete all app passwords:');
    
    if (finalConfirm !== 'DELETE ALL') {
        alert('❌ Deletion cancelled. You must type "DELETE ALL" exactly.');
        return;
    }
    
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
    button.disabled = true;
    
    fetch('/api/delete-all-app-passwords', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Clear the display
            document.getElementById('app-passwords-display').value = '';
            logBulkDomain(`🗑️ ${data.message}`);
            alert(`✅ ${data.message}`);
        } else {
            logBulkDomain(`❌ Delete failed: ${data.error}`);
            alert(`❌ Delete failed: ${data.error}`);
        }
    })
    .catch(error => {
        logBulkDomain(`❌ Network error: ${error}`);
        alert(`❌ Network error: ${error.message}`);
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
}
// Tab 3 Functions - Bulk Domain Change (Desktop App Style)


function downloadAllUsersCSV() {
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    logBulkDomain('📥 Starting download of all users to CSV...');
    
    fetch('/api/download-users-csv', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.csv_data) {
            // Create download
            const blob = new Blob([data.csv_data], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `all_users_${new Date().toISOString().slice(0,10)}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            // Update path display
            document.getElementById('csv-file-path').value = a.download;
            
            logBulkDomain(`✅ Downloaded ${data.user_count} users to CSV: ${a.download}`);
        } else {
            logBulkDomain(`❌ Download failed: ${data.error}`);
            alert('Download failed: ' + data.error);
        }
    })
    .catch(error => {
        logBulkDomain(`❌ Network error: ${error}`);
        alert('Network error: ' + error);
    });
}

function retrieveAvailableDomains() {
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    logBulkDomain('🔍 Retrieving available domains...');
    
    // Show loading state
    const domainList = document.getElementById('available-domains');
    domainList.innerHTML = '<div class="domain-loading">Retrieving domains from Google API... (This may take a moment for large domain lists)</div>';
    
    // Batched retrieval to avoid timeouts with large domain lists
    const allDomains = [];
    let nextToken = null;
    let batches = 0;

    const fetchBatch = async () => {
        const payload = { mode: 'batched' };
        if (nextToken) payload.page_token = nextToken;
        
        const resp = await fetch('/api/retrieve-domains', {
        method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        
        const text = await resp.text();
        let data;
        try { data = JSON.parse(text); } catch(e) { throw new Error('SERVER_HTML:' + text.slice(0,200)); }
        
        if (!data.success) throw new Error(data.error || 'Unknown error');
        
        allDomains.push(...data.domains);
        nextToken = data.next_page_token || null;
        batches += 1;
        
        if (nextToken) {
            await new Promise(r => setTimeout(r, 200));
            return fetchBatch();
        }
        
        return allDomains;
    };

    fetchBatch().then(domains => {
        if (domains && domains.length > 0) {
            // First display domains with basic info (no user counts to avoid timeout)
            displayAvailableDomains(domains);
            logBulkDomain(`✅ Retrieved ${domains.length} domains (calculating user counts...)`);
            
            // Then calculate user counts separately to avoid timeout
            calculateUserCounts(domains);
        } else {
            logBulkDomain(`❌ No domains found`);
            domainList.innerHTML = `<div class="domain-error">❌ No domains found</div>`;
        }
    })
    .catch(error => {
        if (error.message && error.message.startsWith('SERVER_HTML:')) {
            const snippet = error.message.replace('SERVER_HTML:', '');
            logBulkDomain(`❌ Server Error: HTML error page returned`);
            domainList.innerHTML = `<div class="domain-error">❌ Server Error: HTML error page returned<pre style="white-space: pre-wrap; max-height: 160px; overflow:auto; background:#fff; padding:8px; border:1px solid #eee;">${snippet}</pre></div>`;
        } else {
        logBulkDomain(`❌ Network error: ${error}`);
        domainList.innerHTML = `<div class="domain-error">❌ Network error: ${error}</div>`;
        }
    });
}

function getDomainUsageStats() {
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    logBulkDomain('📊 Retrieving domain usage statistics for current account...');
    
    // Show loading state
    const domainList = document.getElementById('available-domains');
    domainList.innerHTML = '<div class="domain-loading">Retrieving domain usage statistics for current account...</div>';
    
    // First get fresh domain data from the authenticated account
    fetch('/api/retrieve-domains', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.domains) {
            // Display the domain data with new three-state system
            const inUseDomains = data.domains.filter(d => d.status === 'in_use').length;
            const usedDomains = data.domains.filter(d => d.status === 'used').length;
            const availableDomains = data.domains.filter(d => d.status === 'available').length;
            
            displayDomainUsageStats({
                total_domains: data.domains.length,
                in_use_domains: inUseDomains,
                used_domains: usedDomains,
                available_domains: availableDomains,
                total_users: data.domains.reduce((sum, d) => sum + (d.user_count || 0), 0),
                domains: data.domains.map(d => ({
                    domain_name: d.domain_name,
                    user_count: d.user_count || 0,
                    is_verified: d.verified || false,
                    is_used: d.is_used || false,
                    status: d.status || 'available',
                    status_text: d.status_text || 'AVAILABLE',
                    status_color: d.status_color || 'green',
                    ever_used: d.ever_used || false,
                    last_updated: new Date().toISOString()
                }))
            });
            logBulkDomain(`✅ Retrieved domain usage statistics for current account`);
        } else {
            logBulkDomain(`❌ Failed to retrieve domain stats: ${data.error}`);
            domainList.innerHTML = `<div class="domain-error">❌ Failed to retrieve domain stats: ${data.error}</div>`;
            alert('Failed to retrieve domain stats: ' + data.error);
        }
    })
    .catch(error => {
        logBulkDomain(`❌ Network error: ${error}`);
        domainList.innerHTML = `<div class="domain-error">❌ Network error: ${error}</div>`;
        alert('Network error: ' + error);
    });
}



function calculateUserCounts(domains) {
    // Calculate user counts for domains separately to avoid timeout
    if (!domains || domains.length === 0) return;
    
    // Extract domain names
    const domainNames = domains.map(d => d.domain_name || d.domainName).filter(name => name);
    
    if (domainNames.length === 0) return;
    
    logBulkDomain(`🔍 Calculating user counts for ${domainNames.length} domains...`);
    
    // Show loading indicator
    const domainList = document.getElementById('available-domains');
    const loadingDiv = document.createElement('div');
    loadingDiv.id = 'user-count-loading';
    loadingDiv.innerHTML = '<div style="background: #f0f8ff; padding: 10px; margin: 10px 0; border-radius: 5px; text-align: center;"><span style="color: #0066cc;">🔄 Calculating user counts...</span></div>';
    domainList.appendChild(loadingDiv);
    
    // Call the separate user count calculation API
    fetch('/api/calculate-domain-users', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ domains: domainNames })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.domain_user_counts) {
            // Update domains with user counts
            const updatedDomains = domains.map(domain => {
                const domainName = domain.domain_name || domain.domainName;
                const userCount = data.domain_user_counts[domainName] || 0;
                
                // Update status based on user count
                let status, status_text, status_color;
                if (userCount > 0) {
                    status = 'in_use';
                    status_text = 'IN USE';
                    status_color = '#9C27B0';
                } else if (domain.ever_used) {
                    status = 'used';
                    status_text = 'USED';
                    status_color = '#FF9800';
                } else {
                    status = 'available';
                    status_text = 'AVAILABLE';
                    status_color = '#4CAF50';
                }
                
                return {
                    ...domain,
                    user_count: userCount,
                    status: status,
                    status_text: status_text,
                    status_color: status_color
                };
            });
            
            // Remove loading indicator
            const loadingDiv = document.getElementById('user-count-loading');
            if (loadingDiv) loadingDiv.remove();
            
            // Update display with user counts
            displayAvailableDomains(updatedDomains);
            logBulkDomain(`✅ Updated ${updatedDomains.length} domains with user counts`);
        } else {
            logBulkDomain(`❌ Failed to calculate user counts: ${data.error || 'Unknown error'}`);
            const loadingDiv = document.getElementById('user-count-loading');
            if (loadingDiv) {
                loadingDiv.innerHTML = '<div style="background: #ffe6e6; padding: 10px; margin: 10px 0; border-radius: 5px; text-align: center;"><span style="color: #cc0000;">❌ Failed to calculate user counts</span></div>';
            }
        }
    })
    .catch(error => {
        logBulkDomain(`❌ Error calculating user counts: ${error}`);
        const loadingDiv = document.getElementById('user-count-loading');
        if (loadingDiv) {
            loadingDiv.innerHTML = '<div style="background: #ffe6e6; padding: 10px; margin: 10px 0; border-radius: 5px; text-align: center;"><span style="color: #cc0000;">❌ Error calculating user counts</span></div>';
        }
    });
}

function clearOldDomainData() {
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    if (!confirm('⚠️ This will reset all "used" domains back to "available" status. Continue?')) {
        return;
    }
    
    logBulkDomain('🗑️ Resetting domain statuses from "used" to "available"...');
    
    fetch('/api/clear-old-domain-data', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            logBulkDomain(`✅ ${data.message}`);
            logBulkDomain(`📊 Reset ${data.reset_count} domains to available status`);
            alert(`✅ ${data.message}\n📊 Reset ${data.reset_count} domains to available status`);
            // Refresh the display
            setTimeout(() => {
                getDomainUsageStats();
                retrieveAvailableDomains(); // Also refresh the domain list
            }, 500);
        } else {
            logBulkDomain(`❌ Failed to reset domain statuses: ${data.error}`);
            alert('Failed to reset domain statuses: ' + data.error);
        }
    })
    .catch(error => {
        logBulkDomain(`❌ Network error: ${error}`);
        alert('Network error: ' + error);
    });
}

function debugDomainUsers() {
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    const currentDomain = document.getElementById('current-domain-suffix').value.trim();
    if (!currentDomain) {
        alert('Please enter a domain in the "Current Domain Suffix" field first');
        return;
    }
    
    logBulkDomain(`🐛 Debugging users for domain: ${currentDomain}`);
    
    fetch('/api/debug-domain-users', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({domain: currentDomain})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            logBulkDomain(`🐛 Debug Results for ${data.domain}:`);
            logBulkDomain(`   Total users found: ${data.total_users_found}`);
            logBulkDomain(`   Users with domain ${data.domain}: ${data.domain_users_found}`);
            
            if (data.domain_users && data.domain_users.length > 0) {
                logBulkDomain(`   Domain users:`);
                data.domain_users.forEach(user => {
                    logBulkDomain(`     - ${user.email} (Admin: ${user.isAdmin}, Suspended: ${user.suspended})`);
                });
            } else {
                logBulkDomain(`   ❌ No users found with domain ${data.domain}`);
            }
        } else {
            logBulkDomain(`❌ Debug failed: ${data.error}`);
            alert('Debug failed: ' + data.error);
        }
    })
    .catch(error => {
        logBulkDomain(`❌ Network error: ${error}`);
        alert('Network error: ' + error);
    });
}

function displayDomainUsageStats(stats) {
    const domainList = document.getElementById('available-domains');
    
    let html = `
        <div class="stats-summary" style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <h3 style="margin: 0 0 15px 0; color: #333;">📊 Domain Usage Summary</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                <div style="text-align: center; padding: 10px; background: white; border-radius: 5px;">
                    <div style="font-size: 24px; font-weight: bold; color: #2196F3;">${stats.total_domains}</div>
                    <div style="font-size: 12px; color: #666;">Total Domains</div>
                </div>
                <div style="text-align: center; padding: 10px; background: white; border-radius: 5px;">
                    <div style="font-size: 24px; font-weight: bold; color: #4CAF50;">${stats.available_domains || 0}</div>
                    <div style="font-size: 12px; color: #666;">Available</div>
                </div>
                <div style="text-align: center; padding: 10px; background: white; border-radius: 5px;">
                    <div style="font-size: 24px; font-weight: bold; color: #FF9800;">${stats.used_domains || 0}</div>
                    <div style="font-size: 12px; color: #666;">Used</div>
                </div>
                <div style="text-align: center; padding: 10px; background: white; border-radius: 5px;">
                    <div style="font-size: 24px; font-weight: bold; color: #9C27B0;">${stats.in_use_domains || 0}</div>
                    <div style="font-size: 12px; color: #666;">In Use</div>
                </div>
                <div style="text-align: center; padding: 10px; background: white; border-radius: 5px;">
                    <div style="font-size: 24px; font-weight: bold; color: #666;">${stats.total_users}</div>
                    <div style="font-size: 12px; color: #666;">Total Users</div>
                </div>
            </div>
        </div>
    `;
    
    if (stats.domains.length === 0) {
        html += '<p class="placeholder-text">No domains found in database</p>';
    } else {
        html += '<h4 style="margin: 20px 0 10px 0; color: #333;">Domain Details:</h4>';
        html += stats.domains.map(domain => {
            // New three-state system
            let statusColor, statusText, domainClass, domainNameColor;
            
            if (domain.status === 'in_use') {
                // Purple - currently has users
                statusColor = '#9C27B0';
                statusText = 'IN USE';
                domainClass = 'domain-item in-use-domain';
                domainNameColor = '#9C27B0';
            } else if (domain.status === 'used') {
                // Orange - previously used but no current users
                statusColor = '#FF9800';
                statusText = 'USED';
                domainClass = 'domain-item used-domain';
                domainNameColor = '#FF9800';
            } else {
                // Green - never been used (available)
                statusColor = '#4CAF50';
                statusText = 'AVAILABLE';
                domainClass = 'domain-item';
                domainNameColor = 'black';
            }
            
            return `<div class="${domainClass}">
                <strong style="color: ${domainNameColor};">${domain.domain_name}</strong>
                <span style="float: right; color: #666;">${domain.user_count} users</span>
                <div style="margin-top: 5px;">
                    ${domain.is_verified ? '<span style="color: green;">✅ Verified</span>' : '<span style="color: red;">❌ Not Verified</span>'}
                    <span style="color: ${statusColor}; margin-left: 10px; font-weight: bold;">${statusText}</span>
                </div>
                ${domain.last_updated ? `<div style="font-size: 11px; color: #999; margin-top: 3px;">Last updated: ${new Date(domain.last_updated).toLocaleString()}</div>` : ''}
            </div>`;
        }).join('');
    }
    
    domainList.innerHTML = html;
}

function displayAvailableDomains(domains) {
    const domainList = document.getElementById('available-domains');
    
    if (domains.length === 0) {
        domainList.innerHTML = '<p class="placeholder-text">No domains found</p>';
        return;
    }
    
    // Add summary at the top with new three-state system
    const totalDomains = domains.length;
    const availableDomains = domains.filter(d => d.status === 'available').length;
    const usedDomains = domains.filter(d => d.status === 'used').length;
    const inUseDomains = domains.filter(d => d.status === 'in_use').length;
    const totalUsers = domains.reduce((sum, d) => sum + d.user_count, 0);
    
    let html = `
        <div class="stats-summary">
            <h3>📊 Domain Summary</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
                <div style="text-align: center; padding: 8px; background: white; border-radius: 5px;">
                    <div style="font-size: 20px; font-weight: bold; color: #2196F3;">${totalDomains}</div>
                    <div style="font-size: 11px; color: #666;">Total</div>
                </div>
                <div style="text-align: center; padding: 8px; background: white; border-radius: 5px;">
                    <div style="font-size: 20px; font-weight: bold; color: #4CAF50;">${availableDomains}</div>
                    <div style="font-size: 11px; color: #666;">Available</div>
                </div>
                <div style="text-align: center; padding: 8px; background: white; border-radius: 5px;">
                    <div style="font-size: 20px; font-weight: bold; color: #FF9800;">${usedDomains}</div>
                    <div style="font-size: 11px; color: #666;">Used</div>
                </div>
                <div style="text-align: center; padding: 8px; background: white; border-radius: 5px;">
                    <div style="font-size: 20px; font-weight: bold; color: #9C27B0;">${inUseDomains}</div>
                    <div style="font-size: 11px; color: #666;">In Use</div>
                </div>
                <div style="text-align: center; padding: 8px; background: white; border-radius: 5px;">
                    <div style="font-size: 20px; font-weight: bold; color: #666;">${totalUsers}</div>
                    <div style="font-size: 11px; color: #666;">Users</div>
                </div>
            </div>
        </div>
        <h4 style="margin: 15px 0 10px 0; color: #333;">Domain Details:</h4>
    `;
    
    html += domains.map(domain => {
        // New three-state system
        let statusColor, statusText, domainClass, clickHandler, domainNameColor;
        
        if (domain.status === 'in_use') {
            // Purple - currently has users
            statusColor = '#9C27B0';  // Purple
            statusText = 'IN USE';
            domainClass = 'domain-item in-use-domain';
            clickHandler = '';  // Not selectable
            domainNameColor = '#9C27B0';
        } else if (domain.status === 'used') {
            // Orange - previously used but no current users
            statusColor = '#FF9800';  // Orange
            statusText = 'USED';
            domainClass = 'domain-item used-domain';
            clickHandler = '';  // Not selectable
            domainNameColor = '#FF9800';
        } else {
            // Green - never been used (available)
            statusColor = '#4CAF50';  // Green
            statusText = 'AVAILABLE';
            domainClass = 'domain-item';
            clickHandler = `onclick="selectDomain('${domain.domain_name}')"`;
            domainNameColor = 'black';
        }
        
        return `<div class="${domainClass}" ${clickHandler}>
            <strong style="color: ${domainNameColor};">${domain.domain_name}</strong>
            <span style="float: right; color: #666; font-weight: bold;">${domain.user_count} users</span>
            <div style="margin-top: 5px;">
                ${domain.verified ? '<span style="color: green;">✅ Verified</span>' : '<span style="color: red;">❌ Not Verified</span>'}
                <span style="color: ${statusColor}; margin-left: 10px; font-weight: bold;">${statusText}</span>
            </div>
        </div>`;
    }).join('');
    
    domainList.innerHTML = html;
}

function selectDomain(domainName) {
    // Check if domain is used
    const domainElement = event.target.closest('.domain-item');
    if (domainElement.classList.contains('used-domain')) {
        alert('❌ This domain has already been used and cannot be selected again.');
        return;
    }
    
    // Remove previous selection
    document.querySelectorAll('.domain-item').forEach(item => {
        item.classList.remove('selected');
    });
    
    // Select clicked domain
    domainElement.classList.add('selected');
    selectedDomain = domainName;
    
    logBulkDomain(`📌 Selected domain: ${domainName}`);
}

function applySelectedDomainToCSV() {
    if (!selectedDomain) {
        alert('Please select a domain first');
        return;
    }
    
    const csvPath = document.getElementById('csv-file-path').value;
    if (!csvPath) {
        alert('Please download users CSV first');
        return;
    }
    
    logBulkDomain(`✅ Applying domain ${selectedDomain} to CSV...`);
    
    fetch('/api/apply-domain-to-csv', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            selected_domain: selectedDomain,
            csv_path: csvPath
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Domain status is automatically updated by the apply-domain-to-csv endpoint
            // Update CSV path to modified version
            document.getElementById('csv-file-path').value = data.modified_csv_path;
            logBulkDomain(`✅ Domain applied successfully. Modified CSV: ${data.modified_csv_path}`);
            logBulkDomain(`📊 ${data.modified_count} users will be updated to ${selectedDomain}`);
        } else {
            logBulkDomain(`❌ Failed to apply domain: ${data.error}`);
            alert('Failed to apply domain: ' + data.error);
        }
    })
    .catch(error => {
        logBulkDomain(`❌ Network error: ${error}`);
        alert('Network error: ' + error);
    });
}

function browseCSVFile() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.csv';
    input.onchange = function(e) {
        const file = e.target.files[0];
        if (file) {
            document.getElementById('csv-file-path').value = file.name;
            logBulkDomain(`📁 Selected CSV file: ${file.name}`);
        }
    };
    input.click();
}

function processDomainChangesFromCSV() {
    const csvPath = document.getElementById('csv-file-path').value;
    
    if (!csvPath) {
        alert('Please select or specify a CSV file first');
        return;
    }
    
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    if (!confirm('⚠️ Process domain changes from CSV?\n\nThis will update user domains as specified in the CSV file.\n\nThis action cannot be easily undone!')) {
        return;
    }
    
    logBulkDomain(`⚙️ Processing domain changes from CSV: ${csvPath}`);
    
    fetch('/api/process-csv-domain-changes', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            csv_path: csvPath
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            logBulkDomain(`✅ CSV processing completed!`);
            logBulkDomain(`📊 Results: ${data.successful} successful, ${data.failed} failed, ${data.skipped} skipped`);
            
            if (data.results) {
                data.results.forEach(result => {
                    if (result.success) {
                        logBulkDomain(`✅ Updated: ${result.old_email} → ${result.new_email}`);
                    } else {
                        logBulkDomain(`❌ Failed: ${result.email} - ${result.error}`);
                    }
                });
            }
        } else {
            logBulkDomain(`❌ CSV processing failed: ${data.error}`);
            alert('CSV processing failed: ' + data.error);
        }
    })
    .catch(error => {
        logBulkDomain(`❌ Network error: ${error}`);
        alert('Network error: ' + error);
    });
}

function changeDomainForAllUsers() {
    const currentDomain = document.getElementById('current-domain-suffix').value.trim();
    const newDomain = document.getElementById('new-domain-suffix').value.trim();
    
    if (!currentDomain || !newDomain) {
        alert('Please enter both current and new domain suffixes');
        return;
    }
    
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    if (!confirm(`⚠️ Change domain for ALL users?\n\n${currentDomain} → ${newDomain}\n\nThis will affect ALL non-admin users with the current domain.\nThis action cannot be easily undone!\n\nContinue?`)) {
        return;
    }
    
    // Show progress indicator
    const progressContainer = document.getElementById('domain-change-progress');
    const progressBar = document.getElementById('progress-bar');
    const progressPercentage = document.getElementById('progress-percentage');
    const progressMessage = document.getElementById('progress-message');
    
    progressContainer.style.display = 'block';
    progressBar.style.width = '0%';
    progressPercentage.textContent = '0%';
    progressMessage.textContent = 'Starting domain change process...';
    
    logBulkDomain(`🔄 Starting bulk domain change: ${currentDomain} → ${newDomain}`);
    
    // Start domain change process (using working synchronous function)
    console.log(`Starting domain change: ${currentDomain} -> ${newDomain}`);
    
    // Start progress animation
    let progress = 0;
    const progressInterval = setInterval(() => {
        progress += Math.random() * 15; // Random progress increments
        if (progress > 90) progress = 90; // Don't go to 100% until done
        progressBar.style.width = `${progress}%`;
        progressPercentage.textContent = `${Math.round(progress)}%`;
        progressMessage.textContent = `Processing domain change... ${Math.round(progress)}%`;
    }, 500);
    
    fetch('/api/change-domain-all-users', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            current_domain: currentDomain,
            new_domain: newDomain,
            exclude_admin: true
        })
    })
    .then(response => {
        console.log(`Domain change response status: ${response.status}`);
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            throw new Error(`Server returned HTML instead of JSON. Status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log(`Domain change response data:`, data);
        // Clear progress animation
        clearInterval(progressInterval);
        
        if (data.success) {
            // Domain change completed successfully
            logBulkDomain(`✅ ${data.message || 'Domain change completed successfully!'}`);
            progressBar.style.width = '100%';
            progressPercentage.textContent = '100%';
            progressMessage.textContent = 'Domain change completed successfully!';
            
            // Hide progress indicator after 3 seconds
            setTimeout(() => {
                progressContainer.style.display = 'none';
            }, 3000);
                    } else {
            throw new Error(data.error || 'Failed to change domains');
        }
    })
    .catch(error => {
        console.error('Domain change start error:', error);
        // Clear progress animation
        clearInterval(progressInterval);
        logBulkDomain(`❌ Failed to start domain change: ${error.message}`);
        progressContainer.style.display = 'none';
    });
}

function pollProgress(taskId) {
    const progressBar = document.getElementById('progress-bar');
    const progressPercentage = document.getElementById('progress-percentage');
    const progressMessage = document.getElementById('progress-message');
    const progressContainer = document.getElementById('domain-change-progress');
    
    const poll = () => {
        console.log(`Polling for task: ${taskId}`);
        fetch(`/api/progress/${taskId}`)
        .then(response => {
            console.log(`Progress response status: ${response.status}`);
            return response.json();
        })
        .then(data => {
            console.log(`Progress response data:`, data);
            if (data.success && data.progress) {
                const progress = data.progress;
                console.log(`Progress status: ${progress.status}, message: ${progress.message}`);
                
                // Update progress bar
                progressBar.style.width = `${progress.percentage}%`;
                progressPercentage.textContent = `${progress.percentage}%`;
                progressMessage.textContent = progress.message;
                
                // Update log with progress
                if (progress.status === 'processing') {
                    logBulkDomain(`🔄 ${progress.message} (${progress.percentage}%)`);
                } else if (progress.status === 'completed') {
                    logBulkDomain(`✅ ${progress.message}`);
                    progressContainer.style.display = 'none';
                    return; // Stop polling
                } else if (progress.status === 'error') {
                    logBulkDomain(`❌ ${progress.message}`);
                    progressContainer.style.display = 'none';
                    return; // Stop polling
                } else if (progress.status === 'not_found') {
                    logBulkDomain(`❌ Task not found: ${progress.message}`);
                    progressContainer.style.display = 'none';
                    return; // Stop polling
                }
                
                // Continue polling if still processing
                if (progress.status === 'processing' || progress.status === 'starting') {
                    setTimeout(poll, 1000); // Poll every second
        } else {
                    // If we get an unexpected status, log it and stop polling
                    logBulkDomain(`❌ Unexpected status: ${progress.status} - ${progress.message}`);
                    progressContainer.style.display = 'none';
                }
            } else {
                logBulkDomain(`❌ Failed to get progress: ${data.error || 'Unknown error'}`);
                progressContainer.style.display = 'none';
        }
    })
    .catch(error => {
            console.error('Progress polling error:', error);
            logBulkDomain(`❌ Progress polling failed: ${error.message}`);
            progressContainer.style.display = 'none';
        });
    };
    
    // Start polling
    poll();
}

function logBulkDomain(message) {
    const log = document.getElementById('bulk-domain-results');
    const timestamp = new Date().toLocaleTimeString();
    
    if (log.querySelector('.placeholder-text')) {
        log.innerHTML = '';
    }
    
    log.textContent += `[${timestamp}] ${message}\n`;
    log.scrollTop = log.scrollHeight;
}

function clearBulkDomainLog() {
    document.getElementById('bulk-domain-results').innerHTML = '<p class="placeholder-text">Processing results will appear here...</p>';
}
function autoChangeSubdomain() {
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    // Confirm the action
    if (!confirm('🔄 Auto Change Subdomain\n\nThis will automatically change all users from the current in-use domain to the next available domain (ascending order).\n\nThis action cannot be easily undone!\n\nContinue?')) {
        return;
    }
    
    logBulkDomain('🔄 Starting automated subdomain change...');
    
    // Show progress indicator
    const progressContainer = document.getElementById('domain-change-progress');
    const progressBar = document.getElementById('progress-bar');
    const progressMessage = document.getElementById('progress-message');
    const progressPercentage = document.getElementById('progress-percentage');
    
    progressContainer.style.display = 'block';
    progressBar.style.width = '0%';
    progressPercentage.textContent = '0%';
    progressMessage.textContent = 'Initializing automated subdomain change...';
    
    // Show progress indicator on button
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Changing...';
    button.disabled = true;
    
    // Simulate progress updates
    let progress = 0;
    const progressInterval = setInterval(() => {
        progress += 2;
        if (progress <= 90) {
            progressBar.style.width = progress + '%';
            progressPercentage.textContent = progress + '%';
            progressMessage.textContent = `Processing domain change... ${progress}%`;
        }
    }, 200);
    
    fetch('/api/auto-change-subdomain', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        clearInterval(progressInterval);
        progressBar.style.width = '100%';
        progressPercentage.textContent = '100%';
        
        if (data.success) {
            logBulkDomain(`✅ ${data.message}`);
            logBulkDomain(`📊 Successfully changed ${data.successful_changes}/${data.total_users} users`);
            logBulkDomain(`🔄 Domain change: ${data.current_domain} → ${data.next_domain}`);
            logBulkDomain(`📋 Available domains: ${data.available_domains.join(', ')}`);
            
            if (data.failed_changes > 0) {
                logBulkDomain(`⚠️ ${data.failed_changes} users failed to change`);
                if (data.failed_details && data.failed_details.length > 0) {
                    data.failed_details.forEach(failed => {
                        logBulkDomain(`❌ Failed: ${failed.email} - ${failed.error}`);
                    });
                }
            }
            
            progressMessage.textContent = 'Automated subdomain change completed successfully!';
            
            // Refresh domain display
            getDomainInfo();
            
            // Auto-retrieve app passwords for the new domain
            setTimeout(() => {
                document.getElementById('retrieve-domain').value = data.next_domain;
                retrieveAppPasswords();
            }, 1000);
            
            // Show success message
            alert(`✅ Automated subdomain change completed!\n\n${data.message}\n\nChanged ${data.successful_changes}/${data.total_users} users from ${data.current_domain} to ${data.next_domain}`);
            
        } else {
            logBulkDomain(`❌ Auto change subdomain failed: ${data.error}`);
            progressMessage.textContent = `Failed: ${data.error}`;
            alert(`❌ Failed to change subdomain: ${data.error}`);
        }
    })
    .catch(error => {
        clearInterval(progressInterval);
        logBulkDomain(`❌ Network error: ${error}`);
        progressMessage.textContent = `Network error: ${error.message}`;
        alert(`❌ Network error: ${error.message}`);
    })
    .finally(() => {
        // Restore button
        button.innerHTML = originalText;
        button.disabled = false;
        
        // Hide progress after 3 seconds
        setTimeout(() => {
            progressContainer.style.display = 'none';
        }, 3000);
    });
}

function refreshDomainStatus() {
    
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
    button.disabled = true;
    
    fetch('/api/refresh-domain-status', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`✅ Domain status refreshed successfully!\n\n${data.message}\n\nUpdated domains:\n${data.updated_domains.join('\n')}`);
            // Refresh the domain display
            getDomainInfo();
        } else {
            alert('❌ Failed to refresh domain status: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Refresh domain status error:', error);
        alert('❌ Network error: ' + error.message);
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

// Tab 4 Functions - SMTP & CSV

function testSMTPCredentials() {
    const credentials = document.getElementById('smtp-credentials').value.trim();
    const recipient = document.getElementById('smtp-recipient').value.trim();
    const server = document.getElementById('smtp-server').value.trim();
    const port = document.getElementById('smtp-port').value;
    
    if (!credentials) {
        alert('Please enter SMTP credentials');
        return;
    }
    
    if (!recipient || !recipient.includes('@')) {
        alert('Please enter a valid recipient email');
        return;
    }
    
    smtpTesting = true;
    clearSMTPResults();
    logSMTPResult('🚀 Starting SMTP credential testing...');
    logSMTPResult(`📧 Recipient: ${recipient}`);
    logSMTPResult(`🖥️ Server: ${server}:${port}`);
    logSMTPResult('─'.repeat(50));
    
    // Start SMTP testing with progress tracking
    fetch('/api/test-smtp-progress', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            credentials: credentials,
            recipient_email: recipient,
            smtp_server: server,
            smtp_port: parseInt(port)
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const taskId = data.task_id;
            logSMTPResult(`📊 Testing ${credentials.split('\n').filter(line => line.trim()).length} credentials...`);
            
            // Poll for progress updates
            const progressInterval = setInterval(() => {
                fetch(`/api/smtp-progress/${taskId}`)
                .then(response => response.json())
                .then(progressData => {
                    if (progressData.success) {
                        const progress = progressData.progress;
                        
                        // Update progress message
                        if (progress.current_email) {
                            logSMTPResult(`🔄 [${progress.progress}/${progress.total}] Testing ${progress.current_email}...`);
                        } else {
                            logSMTPResult(`🔄 [${progress.progress}/${progress.total}] ${progress.message}`);
                        }
                        
                        // Show results as they come in
                        if (progress.results && progress.results.length > 0) {
                            const latestResult = progress.results[progress.results.length - 1];
                            if (latestResult.status === 'success') {
                                logSMTPResult(`✅ [${progress.progress}/${progress.total}] ${latestResult.email}: ${latestResult.message || 'Success'}`);
                            } else {
                                logSMTPResult(`❌ [${progress.progress}/${progress.total}] ${latestResult.email}: ${latestResult.error}`);
                            }
                        }
                        
                        // Check if completed
                        if (progress.status === 'completed') {
                            clearInterval(progressInterval);
                            smtpTesting = false;
                            logSMTPResult('─'.repeat(50));
                            logSMTPResult(`📈 Final Summary: ${progress.success_count}/${progress.total} credentials working`);
                        } else if (progress.status === 'error') {
                            clearInterval(progressInterval);
                            smtpTesting = false;
                            logSMTPResult(`❌ SMTP testing failed: ${progress.message}`);
                        }
                    } else {
                        clearInterval(progressInterval);
                        smtpTesting = false;
                        logSMTPResult(`❌ Progress tracking failed: ${progressData.error}`);
                    }
                })
                .catch(error => {
                    clearInterval(progressInterval);
                    smtpTesting = false;
                    logSMTPResult(`❌ Progress check error: ${error.message}`);
                });
            }, 1000); // Check every second
            
        } else {
            smtpTesting = false;
            logSMTPResult(`❌ Failed to start SMTP testing: ${data.error}`);
        }
    })
    .catch(error => {
        smtpTesting = false;
        logSMTPResult(`❌ Error: ${error.message}`);
        console.error('SMTP Test Error:', error);
    });
}

function interruptSMTPTesting() {
    if (smtpTesting) {
        smtpTesting = false;
        logSMTPResult('⏹️ SMTP testing interrupted by user');
        alert('SMTP testing interrupted');
    } else {
        alert('No SMTP testing in progress');
    }
}

function clearSMTPResults() {
    document.getElementById('smtp-results-log').textContent = '';
}

function logSMTPResult(message) {
    const log = document.getElementById('smtp-results-log');
    const timestamp = new Date().toLocaleTimeString();
    log.textContent += `[${timestamp}] ${message}\n`;
    log.scrollTop = log.scrollHeight;
}

function generateUserCSV() {
    const numUsers = document.getElementById('csv-num-users').value;
    const domain = document.getElementById('csv-domain').value.trim();
    const password = document.getElementById('csv-password').value.trim();
    
    if (!numUsers || numUsers <= 0) {
        alert('Please enter a valid number of users');
        return;
    }
    
    if (!domain || !domain.includes('.')) {
        alert('Please enter a valid domain');
        return;
    }
    
    if (!password) {
        alert('Please enter a default password');
        return;
    }
    
    logResult(`📝 Generating CSV with ${numUsers} users for ${domain}...`);
    
    fetch('/api/generate-csv', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            num_users: parseInt(numUsers),
            domain: domain,
            password: password
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.csv_data) {
            // Create download link
            const blob = new Blob([data.csv_data], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const filename = `users_${domain}_${numUsers}.csv`;
            
            document.getElementById('csv-download-area').innerHTML = `
                <a href="${url}" download="${filename}" class="download-btn">
                    📥 Download ${filename} (${numUsers} users)
                </a>
            `;
            
            logResult(`✅ CSV file generated successfully: ${filename}`);
        } else {
            logResult(`❌ CSV generation failed: ${data.error}`);
            alert('Failed to generate CSV: ' + data.error);
        }
    })
    .catch(error => {
        logResult(`❌ Network error: ${error}`);
        alert('Network error: ' + error);
    });
}


function previewCSV() {
    const numUsers = Math.min(document.getElementById('csv-num-users').value || 5, 10); // Preview max 10
    const domain = document.getElementById('csv-domain').value.trim() || 'example.com';
    const password = document.getElementById('csv-password').value.trim() || 'DefaultPass123';
    
    fetch('/api/preview-csv', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            num_users: parseInt(numUsers),
            domain: domain,
            password: password
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.preview) {
            document.getElementById('csv-preview-area').innerHTML = `
                <h4>📋 CSV Preview (first ${numUsers} rows):</h4>
                <pre>${data.preview}</pre>
            `;
        } else {
            alert('Failed to preview CSV: ' + data.error);
        }
    })
    .catch(error => {
        alert('Network error: ' + error);
    });
}



/*

// COMMENTED OUT - Email Template Functions
function generateEmailTemplate() {
    const subject = document.getElementById('email-subject').value.trim();
    const body = document.getElementById('email-body').value.trim();
    
    if (!subject || !body) {
        alert('Please enter both subject and body');
        return;
    }
    
    // Sample data for template preview
    const sampleData = {
        email: 'john.doe@example.com',
        password: 'TempPass123',
        first_name: 'John',
        last_name: 'Doe'
    };
    
    let previewSubject = subject;
    let previewBody = body;
    
    // Replace placeholders
    Object.keys(sampleData).forEach(key => {
        const placeholder = `{${key}}`;
        previewSubject = previewSubject.replace(new RegExp(placeholder, 'g'), sampleData[key]);
        previewBody = previewBody.replace(new RegExp(placeholder, 'g'), sampleData[key]);
    });
    
    document.getElementById('email-template-preview').innerHTML = `
        <h4>📧 Email Template Preview:</h4>
        <div style="border: 1px solid #ddd; padding: 1rem; background: white;">
            <div><strong>Subject:</strong> ${previewSubject}</div>
            <hr>
            <div style="white-space: pre-wrap;">${previewBody}</div>
        </div>
        <p><small>📝 Sample data used: ${JSON.stringify(sampleData, null, 2)}</small></p>
    `;
}

// COMMENTED OUT - Email Template Functions
function testEmailTemplate() {
    alert('Email template testing feature coming soon!');
}
*/

// Mega Upgrade Functions
function openMegaUpgradeModal() {
    console.log('Opening mega upgrade modal...');
    const modal = document.getElementById('megaUpgradeModal');
    if (modal) {
        modal.style.display = 'block';
        console.log('Modal opened successfully');
    } else {
        console.error('Modal not found!');
        alert('Modal not found. Please refresh the page.');
    }
}

function closeMegaUpgradeModal() {
    document.getElementById('megaUpgradeModal').style.display = 'none';
}

function startMegaUpgrade() {
    console.log('Starting mega upgrade...');
    const accountInput = document.getElementById('mega-single-account');

    let accounts = [];
    if (accountInput) {
        const accountText = (accountInput.value || '').trim();
        if (!accountText) {
            alert('Please enter at least one account email address');
        return;
    }
    
        // Parse accounts (one per line)
        accounts = accountText
            .split('\n')
        .map(line => line.trim())
            .filter(line => line && line.includes('@'));
    }
    
    if (accounts.length === 0) {
        alert('Please provide at least one valid account (one per line).');
        return;
    }
    
    // Get selected features
    const features = {
        authenticate: document.getElementById('feature-authenticate').checked,
        changeSubdomain: document.getElementById('feature-change-subdomain').checked
    };
    
    console.log('Selected features:', features);
    console.log('Accounts to process:', accounts);
    
    // Show progress section
    document.getElementById('megaUpgradeProgress').style.display = 'block';
    document.getElementById('megaStartBtn').style.display = 'none';
    document.getElementById('megaStopBtn').style.display = 'inline-block';
    
    // Reset log counter for new process
    window.lastLoggedCount = 0;
    
    // Start mega upgrade process
    runMegaUpgradeWorkflow(accounts, features);
}

function stopMegaUpgrade() {
    // Stop the process (implementation depends on backend)
    document.getElementById('megaStartBtn').style.display = 'inline-block';
    document.getElementById('megaStopBtn').style.display = 'none';
    logBulkDomain('⏹️ Mega upgrade process stopped by user');
}

function clearMegaUpgradeResults() {
    document.getElementById('app-passwords-display').value = '';
    logBulkDomain('🧹 Mega upgrade results cleared');
}

function updateMegaProgress(percentage, message) {
    const progressBar = document.getElementById('megaProgressBar');
    const progressPercent = document.getElementById('megaProgressPercent');
    const progressText = document.getElementById('megaProgressText');
    
    if (progressBar && progressPercent && progressText) {
        progressBar.style.width = percentage + '%';
        progressPercent.textContent = percentage + '%';
        progressText.textContent = message;
    }
}


function debugMegaUpgrade() {
    const accountsText = document.getElementById('mega-accounts-list').value.trim();
    
    if (!accountsText) {
        alert('Please enter at least one account');
        return;
    }
    
    // Parse accounts from textarea (one per line)
    const accounts = accountsText.split('\n')
        .map(line => line.trim())
        .filter(line => line && line.includes('@')); // Filter out empty lines and invalid emails
    
    if (accounts.length === 0) {
        alert('Please enter valid email addresses (one per line)');
        return;
    }
    
    // Get selected features
    const features = {
        authenticate: document.getElementById('feature-authenticate').checked,
        changeSubdomain: document.getElementById('feature-change-subdomain').checked
    };
    
    logBulkDomain('🐛 Starting DEBUG Mega Upgrade...');
    logBulkDomain(`📊 Debugging ${accounts.length} accounts with selected features`);
    logBulkDomain(`🔧 Features: ${Object.keys(features).filter(k => features[k]).join(', ')}`);
    logBulkDomain('─'.repeat(50));
    
    // Test the debug endpoint
    fetch('/api/debug-mega-upgrade', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            accounts: accounts,
            features: features
        })
    })
    .then(response => {
        logBulkDomain(`🔍 Response status: ${response.status}`);
        logBulkDomain(`🔍 Response headers: ${JSON.stringify(Object.fromEntries(response.headers))}`);
        return response.json();
    })
    .then(data => {
        if (data.success) {
            logBulkDomain(`✅ DEBUG completed successfully: ${data.message}`);
            logBulkDomain(`📊 Accounts received: ${data.accounts_received}`);
            logBulkDomain(`🔧 Features received: ${JSON.stringify(data.features_received)}`);
            logBulkDomain(`🗄️ Database accounts: ${data.database_accounts}`);
            logBulkDomain(`🔍 Debug info: ${data.debug_info}`);
            logBulkDomain('─'.repeat(50));
            logBulkDomain('🎉 DEBUG completed - All systems operational!');
        } else {
            logBulkDomain(`❌ DEBUG failed: ${data.error}`);
            if (data.traceback) {
                logBulkDomain(`🔍 Traceback: ${data.traceback}`);
            }
        }
    })
    .catch(error => {
        logBulkDomain(`❌ DEBUG error: ${error.message}`);
        console.error('DEBUG Error:', error);
    });
}
function runMegaUpgradeWorkflow(accounts, features) {
    logBulkDomain('🚀 Starting Mega Upgrade Workflow...');
    logBulkDomain(`📊 Processing ${accounts.length} accounts with selected features`);
    logBulkDomain(`🔧 Features: ${Object.keys(features).filter(k => features[k]).join(', ')}`);
    logBulkDomain('─'.repeat(50));
    
    // Show detailed processing for each account
    accounts.forEach((account, index) => {
        logBulkDomain(`📧 Account ${index + 1}: ${account}`);
    });
    logBulkDomain('─'.repeat(50));
    
    // Update progress indicator
    updateMegaProgress(0, 'Initializing...');
    
    // Show processing message with more detail
    logBulkDomain('⏳ Starting automated processing...');
    updateMegaProgress(10, 'Looking up accounts in database...');
    logBulkDomain('🔍 Step 1: Looking up accounts in database...');
    
    updateMegaProgress(20, 'Authenticating accounts...');
    logBulkDomain('🔐 Step 2: Authenticating accounts...');
    
    updateMegaProgress(30, 'Changing subdomains...');
    logBulkDomain('🔄 Step 3: Changing subdomains...');
    
    updateMegaProgress(40, 'Preparing for server request...');
    logBulkDomain('🔑 Step 4: Preparing app password generation...');
    logBulkDomain('⏰ Note: Processing multiple accounts may take 10-30 minutes depending on user count');
    
    updateMegaProgress(50, 'Sending request to server...');
    
    // Start the mega upgrade process with extended timeout
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 25 * 60 * 1000); // 25 minutes timeout
    
    fetch('/api/mega-upgrade', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            accounts: accounts,
            features: features
        }),
        signal: controller.signal
    })
    .then(response => {
        clearTimeout(timeoutId); // Clear the timeout since we got a response
        updateMegaProgress(70, 'Processing server response...');
        logBulkDomain(`📡 Response received: ${response.status} ${response.statusText}`);
        return response.json();
    })
    .then(data => {
        updateMegaProgress(80, 'Analyzing results...');
        logBulkDomain('─'.repeat(50));
        logBulkDomain('📋 PROCESSING RESULTS:');
        
        if (data.success) {
            updateMegaProgress(90, 'Finalizing results...');
            logBulkDomain(`✅ Mega upgrade completed successfully!`);
            logBulkDomain(`📊 Results: ${data.successful_accounts} successful, ${data.failed_accounts} failed`);
            logBulkDomain(`📋 Total accounts processed: ${data.total_accounts}`);
            
            // Display detailed results for each account
            if (data.final_results && data.final_results.length > 0) {
                logBulkDomain('─'.repeat(50));
                logBulkDomain('✅ SUCCESSFUL ACCOUNTS:');
                data.final_results.forEach((result, index) => {
                    logBulkDomain(`  ${index + 1}. Account: ${result.account}`);
                    logBulkDomain(`     New Name: ${result.new_account_name}`);
                    logBulkDomain(`     App Password: ${result.app_password}`);
                    logBulkDomain(`     Status: ${result.status}`);
                });
            }

            // Save next-domain map for precise subdomain mapping per base
            if (data.next_domain_map) {
                window.baseToNewSubdomainMap = data.next_domain_map;
                logBulkDomain(`🧭 Next-domain map from server: ${JSON.stringify(data.next_domain_map)}`);
            }

            // Display SMTP results if available
            if (data.smtp_results && data.smtp_results.length > 0) {
                logBulkDomain('─'.repeat(50));
                logBulkDomain('📧 SMTP CONFIGURATION RESULTS:');
                data.smtp_results.forEach((smtp, index) => {
                    logBulkDomain(`  ${index + 1}. ${smtp}`);
                });
                
                const display = document.getElementById('app-passwords-display');
                display.value = data.smtp_results.join('\n');
                logBulkDomain(`📋 ${data.smtp_results.length} SMTP results displayed in textarea`);
            } else if (features.retrievePasswords) {
                // If enabled but backend returned none, attempt client-side generation using detected domain
                // Prefer precise per-base mapping if present; otherwise fall back to detected domain
                const targetDomain = (window.baseToNewSubdomainMap && Object.values(window.baseToNewSubdomainMap)[0])
                    || window.megaUpgradeChangedSubdomain || window.currentTargetDomain;
                if (targetDomain) {
                    logBulkDomain('ℹ️ No SMTP results from server, generating client-side using detected domain');
                    generateAppPasswordsWithTargetDomain(accounts, targetDomain);
                } else {
                    logBulkDomain('⚠️ No SMTP results and no detected domain');
                }
            }

            // Display failed details if any
            if (data.failed_details && data.failed_details.length > 0) {
                logBulkDomain('─'.repeat(50));
                logBulkDomain('❌ FAILED ACCOUNTS DETAILS:');
                data.failed_details.forEach((detail, index) => {
                    logBulkDomain(`  ${index + 1}. Account: ${detail.account}`);
                    logBulkDomain(`     Step: ${detail.step}`);
                    logBulkDomain(`     Error: ${detail.error}`);
                });
            }

            updateMegaProgress(100, 'Completed successfully!');
            logBulkDomain('─'.repeat(50));
            logBulkDomain('🎉 Mega Upgrade Workflow Finished!');
            
            // Hide progress after 2 seconds
            setTimeout(() => {
                document.getElementById('megaUpgradeProgress').style.display = 'none';
            }, 2000);
        } else {
            updateMegaProgress(100, 'Failed');
            document.getElementById('megaStartBtn').style.display = 'inline-block';
            document.getElementById('megaStopBtn').style.display = 'none';
            logBulkDomain(`❌ Mega upgrade failed: ${data.error}`);
            
            // Check for partial results
            if (data.partial_results) {
                logBulkDomain('─'.repeat(50));
                logBulkDomain('📊 PARTIAL RESULTS:');
                logBulkDomain(`✅ Successful accounts: ${data.partial_results.successful_accounts}`);
                logBulkDomain(`❌ Failed accounts: ${data.partial_results.failed_accounts}`);
                
                if (data.partial_results.failed_details && data.partial_results.failed_details.length > 0) {
                    logBulkDomain('📋 Failed account details:');
                    data.partial_results.failed_details.forEach((detail, index) => {
                        logBulkDomain(`  ${index + 1}. Account: ${detail.account}`);
                        logBulkDomain(`     Step: ${detail.step}`);
                        logBulkDomain(`     Error: ${detail.error}`);
                    });
                }
                
                if (data.partial_results.next_domain_map && Object.keys(data.partial_results.next_domain_map).length > 0) {
                    logBulkDomain('🌐 Domain changes completed:');
                    Object.entries(data.partial_results.next_domain_map).forEach(([base, new_domain]) => {
                        logBulkDomain(`  ${base} → ${new_domain}`);
                    });
                }
            }
            
            logBulkDomain('─'.repeat(50));
            logBulkDomain('🔍 Check server logs for more details');
        }
    })
    .catch(error => {
        clearTimeout(timeoutId); // Clear timeout on error
        updateMegaProgress(100, 'Network Error');
        document.getElementById('megaStartBtn').style.display = 'inline-block';
        document.getElementById('megaStopBtn').style.display = 'none';
        
        if (error.name === 'AbortError') {
            logBulkDomain(`⏰ Request timeout after 25 minutes - process may still be running on server`);
            logBulkDomain('─'.repeat(50));
            logBulkDomain('🔍 Check server logs to see if processing completed');
            logBulkDomain('💡 Try refreshing the page and checking domain status');
        } else {
        logBulkDomain(`❌ Network Error: ${error.message}`);
        logBulkDomain('─'.repeat(50));
        logBulkDomain('🔍 Check server connection and logs');
        }
        console.error('Mega Upgrade Error:', error);
        
    // Even if server times out, find the ACTUAL changed subdomain
    logBulkDomain('─'.repeat(50));
    logBulkDomain('🔑 Server timeout - finding ACTUAL changed subdomain...');
    logBulkDomain('🔄 Detecting the subdomain that was actually changed...');
    
    // Try to detect the ACTUAL subdomain change by checking domains
    logBulkDomain('🔍 Detecting ACTUAL subdomain change from domain list...');
    
    fetch('/api/retrieve-domains', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            batched: true
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.domains && data.domains.length > 0) {
            logBulkDomain(`✅ Retrieved ${data.domains.length} domains despite timeout`);
            
            // Debug: Log all domains to understand the structure
            logBulkDomain(`🔍 Debug: Analyzing ${data.domains.length} domains after timeout...`);
            data.domains.forEach((domain, index) => {
                logBulkDomain(`   Domain ${index + 1}: ${JSON.stringify(domain)}`);
            });
            
            // Find the ACTUAL subdomain that was changed (IN USE with users)
            const inUseDomains = data.domains.filter(domain => 
                (domain.status === 'in_use' || domain.status_text === 'IN USE') && 
                domain.user_count > 0 && 
                (domain.domainName || domain.domain_name) && 
                (domain.domainName || domain.domain_name) !== 'undefined'
            );
            
            logBulkDomain(`🔍 Found ${inUseDomains.length} IN USE domains with users after timeout`);
            
            if (inUseDomains.length > 0) {
                const selectedDomain = inUseDomains.reduce((prev, current) => 
                    (current.user_count > prev.user_count) ? current : prev
                );
                const targetDomain = selectedDomain.domainName || selectedDomain.domain_name;
                const userCount = selectedDomain.user_count;
                
                window.megaUpgradeChangedSubdomain = targetDomain;
                logBulkDomain(`🎯 Detected ACTUAL changed subdomain: ${targetDomain} (${userCount} users)`);
                logBulkDomain(`✅ This is the EXACT subdomain that was changed during Mega Upgrade`);
            } else {
                // Fallback to any domain with users
                const domainsWithUsers = data.domains.filter(domain => 
                    domain.user_count > 0 && 
                    (domain.domainName || domain.domain_name) && 
                    (domain.domainName || domain.domain_name) !== 'undefined'
                );
                
                logBulkDomain(`🔍 Found ${domainsWithUsers.length} domains with users after timeout`);
                
                if (domainsWithUsers.length > 0) {
                    const selectedDomain = domainsWithUsers.reduce((prev, current) => 
                        (current.user_count > prev.user_count) ? current : prev
                    );
                    const targetDomain = selectedDomain.domainName || selectedDomain.domain_name;
                    const userCount = selectedDomain.user_count;
                    
                    window.megaUpgradeChangedSubdomain = targetDomain;
                    logBulkDomain(`🎯 Detected changed subdomain: ${targetDomain} (${userCount} users)`);
                } else {
                    // Final fallback: any domain with valid name
                    const validDomains = data.domains.filter(domain => 
                        (domain.domainName || domain.domain_name) && 
                        (domain.domainName || domain.domain_name) !== 'undefined' &&
                        (domain.domainName || domain.domain_name).length > 0
                    );
                    
                    if (validDomains.length > 0) {
                        const targetDomain = validDomains[0].domainName || validDomains[0].domain_name;
                        window.megaUpgradeChangedSubdomain = targetDomain;
                        logBulkDomain(`🎯 Using first valid domain: ${targetDomain}`);
                    } else {
                        logBulkDomain(`❌ No valid domains found after timeout`);
                    }
                }
            }
        }
        
        // If requested, generate/display app passwords using detected domain
        if (features.retrievePasswords) {
            logBulkDomain('🔑 Generating app passwords with ACTUAL target domain...');
            const targetDomain = window.megaUpgradeChangedSubdomain || window.currentTargetDomain;
            if (targetDomain) {
                generateAppPasswordsWithTargetDomain(accounts, targetDomain);
            } else {
                logBulkDomain('⚠️ No detected domain for password retrieval');
            }
        } else {
            logBulkDomain('ℹ️ Password retrieval not selected - skipping');
        }
    })
    .catch(error => {
        logBulkDomain(`❌ Error detecting ACTUAL subdomain change: ${error.message}`);
        logBulkDomain(`⚠️ Cannot proceed without the actual changed subdomain`);
    });
    });
}

// ===== APP PASSWORD MANAGEMENT FUNCTIONS (REFACTORED) =====

// Global state for app password management
const AppPasswordManager = {
    currentFile: null,
    isUploading: false
};

// Handle file selection
function handleAppPasswordsFile(input) {
    const file = input.files[0];
    if (!file) {
        AppPasswordManager.currentFile = null;
        console.log('No file selected');
        return;
    }
    
    // Validate file type
    if (!file.name.endsWith('.txt')) {
        alert('Please select a .txt file');
        input.value = '';
        AppPasswordManager.currentFile = null;
        return;
    }
    
    AppPasswordManager.currentFile = file;
    console.log(`File selected: ${file.name} (${file.size} bytes)`);
}

// Upload app passwords with better error handling
function uploadAppPasswords() {
    // Check if already uploading
    if (AppPasswordManager.isUploading) {
        alert('Upload already in progress...');
        return;
    }
    
    // Check if file is selected
    if (!AppPasswordManager.currentFile) {
        alert('Please select a file first');
        return;
    }
    
    // Get the button element
    const button = event.target || document.querySelector('button[onclick*="uploadAppPasswords"]');
    const originalHTML = button.innerHTML;
    
    // Set uploading state
    AppPasswordManager.isUploading = true;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
    
    // Create form data
    const formData = new FormData();
    formData.append('file', AppPasswordManager.currentFile);
    
    console.log(`Uploading file: ${AppPasswordManager.currentFile.name}`);
    
    // Perform upload
    fetch('/api/upload-app-passwords', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        console.log(`Upload response status: ${response.status}`);
        console.log(`Upload response headers:`, response.headers);
        
        // Check if response is ok
        if (!response.ok) {
            return response.text().then(text => {
                console.error('Server error response:', text);
                throw new Error(`Server error ${response.status}: ${text}`);
            });
        }
        
        // Check if response is JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            return response.text().then(text => {
                console.error('Non-JSON response:', text);
                throw new Error(`Expected JSON response but got: ${contentType}`);
            });
        }
        
        return response.json();
    })
    .then(data => {
        console.log('Upload response data:', data);
        
        if (data.success) {
            const count = data.count || 0;
            const added = data.added || 0;
            const updated = data.updated || 0;
            const errors = data.errors || 0;
            
            let message = `✅ Successfully processed ${count} app passwords from this file!\n\n`;
            message += `📊 Details:\n`;
            message += `• Added: ${added} new passwords\n`;
            message += `• Updated: ${updated} existing passwords\n`;
            if (errors > 0) {
                message += `• Errors: ${errors} failed to process\n`;
            }
            
            alert(message);
            
            // Clear file input but keep the ability to upload more files
            const fileInput = document.getElementById('app-passwords-file');
            if (fileInput) fileInput.value = '';
            AppPasswordManager.currentFile = null;
            
            // Reload status to show total count
            loadAppPasswordsStatus();
        } else {
            const errorMsg = data.error || 'Unknown error occurred';
            alert(`❌ Upload failed: ${errorMsg}`);
        }
    })
    .catch(error => {
        console.error('Upload error:', error);
        alert(`❌ Upload error: ${error.message}`);
    })
    .finally(() => {
        // Reset button state
        AppPasswordManager.isUploading = false;
        button.disabled = false;
        button.innerHTML = originalHTML;
    });
}

// Clear all app passwords with confirmation
function clearAppPasswords() {
    if (!confirm('Are you sure you want to clear all app passwords?\nThis action cannot be undone.')) {
        return;
    }
    
    console.log('Clearing all app passwords...');
    
    fetch('/api/clear-app-passwords', {
        method: 'DELETE'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`Server error ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Clear response:', data);
        
        if (data.success) {
            alert('✅ All app passwords cleared successfully!');
            loadAppPasswordsStatus();
        } else {
            alert(`❌ Error: ${data.error || 'Failed to clear passwords'}`);
        }
    })
    .catch(error => {
        console.error('Clear error:', error);
        alert(`❌ Error clearing passwords: ${error.message}`);
    });
}

// Download template file
function downloadAppPasswordsTemplate() {
    console.log('Downloading template...');
    
    const template = [
        '# App Passwords Template',
        '# Format: email:password',
        '# One entry per line',
        '',
        'user1@example.com:app_password_1',
        'user2@example.com:app_password_2',
        'admin@company.com:app_password_3',
        'john.doe@domain.com:app_password_4'
    ].join('\n');
    
    const blob = new Blob([template], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const link = document.createElement('a');
    
    link.href = url;
    link.download = 'app_passwords_template.txt';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    window.URL.revokeObjectURL(url);
    
    console.log('Template downloaded');
}

// Test API endpoint
function testAppPasswordsAPI() {
    console.log('Testing App Password API...');
    
    fetch('/api/test-app-passwords')
        .then(response => {
            console.log(`Test API status: ${response.status}`);
            
            if (!response.ok) {
                throw new Error(`API test failed with status ${response.status}`);
            }
            
            return response.json();
        })
        .then(data => {
            console.log('Test API response:', data);
            
            if (data.success) {
                alert(`✅ API Test Passed!\n\nDatabase count: ${data.database_count || 0}\nTest operations: ${data.test_passed ? 'Success' : 'Failed'}`);
            } else {
                alert(`❌ API Test Failed!\n\nError: ${data.error || 'Unknown error'}\nMessage: ${data.message || ''}`);
            }
        })
        .catch(error => {
            console.error('Test API error:', error);
            alert(`❌ API Test Error: ${error.message}`);
        });
}


// Debug app password matching for specific email
function debugAppPasswordMatching(email) {
    if (!email) {
        email = prompt('Enter email to debug matching:');
        if (!email) return;
    }
    
    console.log(`=== DEBUGGING APP PASSWORD MATCHING FOR: ${email} ===`);
    
    fetch('/api/debug-app-password-matching', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({email: email})
    })
    .then(response => response.json())
    .then(data => {
        console.log('Debug matching response:', data);
        
        if (data.success && data.debug_info) {
            const info = data.debug_info;
            let message = `Debug Results for: ${info.email}\n\n`;
            message += `Username: ${info.username}\n`;
            message += `Domain: ${info.domain}\n\n`;
            
            message += 'Matching Strategies:\n';
            info.matches.forEach(match => {
                if (match.found) {
                    message += `✅ ${match.strategy}: ${match.username}@${match.domain}\n`;
                } else {
                    message += `❌ ${match.strategy}: Not found\n`;
                }
            });
            
            if (info.similar_records.length > 0) {
                message += '\nSimilar Records in Database:\n';
                info.similar_records.forEach(record => {
                    message += `- ${record.username}@${record.domain}\n`;
                });
            }
            
            alert(message);
        } else {
            alert(`Debug failed: ${data.error || 'Unknown error'}`);
        }
    })
    .catch(error => {
        console.error('Debug matching error:', error);
        alert(`Debug Error: ${error.message}`);
    });
}

// Load and display app passwords status
function loadAppPasswordsStatus() {
    console.log('Loading app passwords status...');
    
    fetch('/api/app-passwords-status')
        .then(response => {
            if (!response.ok) {
                throw new Error(`Status API failed with status ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Status response:', data);
            
            const statusElement = document.getElementById('app-passwords-count');
            if (!statusElement) {
                console.error('Status element not found');
                return;
            }
            
            if (data.success) {
                const count = data.count || 0;
                statusElement.textContent = `${count} app passwords stored (from all uploaded files)`;
                
                // Log sample data if available
                if (data.sample_data && data.sample_data.length > 0) {
                    console.log('Sample stored passwords:', data.sample_data);
                }
                
                // Show additional info if there are passwords
                if (count > 0) {
                    console.log(`Total app passwords in database: ${count}`);
                }
            } else {
                statusElement.textContent = 'Error loading status';
                console.error('Status error:', data.error);
            }
        })
        .catch(error => {
            console.error('Status loading error:', error);
            const statusElement = document.getElementById('app-passwords-count');
            if (statusElement) {
                statusElement.textContent = 'Error loading status';
            }
        });
}

// Advanced App Password Management Functions

// Debug app passwords
function debugAppPasswords() {
    console.log('=== DEBUG APP PASSWORDS ===');
    
    fetch('/api/debug-app-passwords')
        .then(response => response.json())
        .then(data => {
            console.log('Debug API response:', data);
            
            if (data.success) {
                const info = data.debug_info;
                console.log(`Total app passwords in database: ${info.total_count}`);
                console.log('Sample records:', info.sample_records);
                console.log('Recent records:', info.recent_records);
                
                alert(`Debug Info:\n\nTotal records: ${info.total_count}\n\nCheck browser console for detailed information.`);
            } else {
                console.error('Debug API failed:', data.error);
                alert(`Debug failed: ${data.error}`);
            }
        })
        .catch(error => {
            console.error('Debug request failed:', error);
            alert(`Debug request failed: ${error.message}`);
        });
}

// Search app password users
function searchAppPasswordUsers() {
    const searchTerm = document.getElementById('search-app-passwords').value.trim();
    const resultsDiv = document.getElementById('app-passwords-search-results');
    
    if (!searchTerm) {
        resultsDiv.style.display = 'none';
        return;
    }
    
    console.log('Searching app password users:', searchTerm);
    
    fetch('/api/list-app-passwords')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Search API response:', data);
            
            if (data.success && data.users && Array.isArray(data.users)) {
                const searchLower = searchTerm.toLowerCase();
                const filteredUsers = data.users.filter(user => {
                    if (!user || !user.username || !user.domain) {
                        console.log('Invalid user record:', user);
                        return false;
                    }
                    
                    const username = user.username.toLowerCase();
                    const domain = user.domain.toLowerCase();
                    const fullEmail = `${username}@${domain}`;
                    
                    // Enhanced search logic
                    const matchesUsername = username.includes(searchLower);
                    const matchesDomain = domain.includes(searchLower);
                    const matchesFullEmail = fullEmail.includes(searchLower);
                    const exactEmailMatch = searchLower.includes('@') && fullEmail === searchLower;
                    
                    const matches = matchesUsername || matchesDomain || matchesFullEmail || exactEmailMatch;
                    
                    if (matches) {
                        console.log(`Match found: ${username}@${domain} (search: ${searchLower})`);
                    }
                    
                    return matches;
                });
                
                console.log(`Found ${filteredUsers.length} matching users out of ${data.users.length} total:`, filteredUsers);
                displaySearchResults(filteredUsers);
            } else {
                console.log('No users data in response');
                resultsDiv.innerHTML = '<div style="color: #6a737d; font-style: italic;">No users found</div>';
                resultsDiv.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error searching app password users:', error);
            resultsDiv.innerHTML = '<div style="color: #dc3545;">Error searching users</div>';
            resultsDiv.style.display = 'block';
        });
}

// Display search results
function displaySearchResults(users) {
    const resultsDiv = document.getElementById('app-passwords-search-results');
    
    if (users.length === 0) {
        resultsDiv.innerHTML = '<div style="color: #6a737d; font-style: italic;">No matching users found</div>';
        resultsDiv.style.display = 'block';
        return;
    }
    
    let html = '<div style="font-size: 14px;">';
    html += `<div style="margin-bottom: 8px; font-weight: bold; color: #24292f;">Found ${users.length} user(s):</div>`;
    
    users.forEach((user, index) => {
        const email = user.domain === '*' ? user.username : `${user.username}@${user.domain}`;
        html += `<div style="padding: 8px; border: 1px solid #d0d7de; border-radius: 4px; margin-bottom: 4px; background: #f6f8fa;">`;
        html += `<div style="display: flex; justify-content: space-between; align-items: center;">`;
        html += `<div><strong>${email}</strong><br><small style="color: #656d76;">Password: ${user.app_password ? '••••••••' : 'Not set'}</small></div>`;
        html += `<div style="display: flex; gap: 4px;">`;
        html += `<button onclick="editAppPasswordUser('${user.username}', '${user.domain}')" class="btn-github" style="padding: 4px 8px; font-size: 12px;"><i class="fas fa-edit"></i></button>`;
        html += `<button onclick="deleteAppPasswordUser('${user.username}', '${user.domain}')" class="btn-github" style="padding: 4px 8px; font-size: 12px; background-color: #dc3545; color: white;"><i class="fas fa-trash"></i></button>`;
        html += `<button onclick="debugAppPasswordMatching('${email}')" class="btn-github" style="padding: 4px 8px; font-size: 12px; background-color: #17a2b8; color: white;"><i class="fas fa-bug"></i></button>`;
        html += `</div></div></div>`;
    });
    
    html += '</div>';
    resultsDiv.innerHTML = html;
    resultsDiv.style.display = 'block';
}

// Edit app password user
function editAppPasswordUser(username, domain) {
    const newPassword = prompt(`Edit app password for ${username}@${domain}:`, '');
    if (newPassword === null) return;
    
    if (!newPassword.trim()) {
        alert('Password cannot be empty');
        return;
    }
    
    fetch('/api/update-app-password', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            username: username,
            domain: domain,
            app_password: newPassword.trim()
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('✅ App password updated successfully');
            searchAppPasswordUsers(); // Refresh search results
            loadAppPasswordsStatus(); // Refresh status
        } else {
            alert(`❌ Error updating app password: ${data.error}`);
        }
    })
    .catch(error => {
        console.error('Error updating app password:', error);
        alert(`❌ Error updating app password: ${error.message}`);
    });
}

// Delete single app password user
function deleteAppPasswordUser(username, domain) {
    if (!confirm(`Are you sure you want to delete the app password for ${username}@${domain}?`)) {
        return;
    }
    
    fetch('/api/delete-app-password', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            username: username,
            domain: domain
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('✅ App password deleted successfully');
            searchAppPasswordUsers(); // Refresh search results
            loadAppPasswordsStatus(); // Refresh status
        } else {
            alert(`❌ Error deleting app password: ${data.error}`);
        }
    })
    .catch(error => {
        console.error('Error deleting app password:', error);
        alert(`❌ Error deleting app password: ${error.message}`);
    });
}
// Delete specific app passwords
function deleteSpecificAppPasswords() {
    const deleteField = document.getElementById('delete-app-passwords');
    const usersToDelete = deleteField.value.trim();
    
    if (!usersToDelete) {
        alert('Please enter users to delete (one per line)');
        return;
    }
    
    const userList = usersToDelete.split('\n').filter(line => line.trim());
    if (userList.length === 0) {
        alert('Please enter at least one user to delete');
        return;
    }
    
    if (!confirm(`Are you sure you want to delete ${userList.length} app password(s)?\n\nThis action cannot be undone!`)) {
        return;
    }
    
    console.log('Deleting specific app passwords:', userList);
    
    fetch('/api/delete-specific-app-passwords', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            users: userList
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`✅ Successfully deleted ${data.deleted_count} app password(s)`);
            deleteField.value = ''; // Clear the field
            loadAppPasswordsStatus(); // Refresh status
        } else {
            alert(`❌ Error deleting app passwords: ${data.error}`);
        }
    })
    .catch(error => {
        console.error('Error deleting specific app passwords:', error);
        alert(`❌ Error deleting app passwords: ${error.message}`);
    });
}

// Clear delete field
function clearDeleteField() {
    document.getElementById('delete-app-passwords').value = '';
}

// Update users list statistics
function updateUsersListStats(users) {
    const statsDiv = document.getElementById('users-list-stats');
    if (!statsDiv || !users) return;
    
    // Filter out admin accounts for statistics
    const filteredUsers = users.filter(user => {
        const email = user.email || user.primaryEmail || 'N/A';
        const sourceAccount = user.source_account || 'Unknown';
        
        // Check if this is an admin account by comparing email with source account
        if (email && sourceAccount && email.toLowerCase() === sourceAccount.toLowerCase()) {
            return false; // Exclude admin account
        }
        
        // Also check for common admin patterns
        const isAdminAccount = email.toLowerCase().includes('admin') || 
                              email.toLowerCase().includes('support') || 
                              email.toLowerCase().includes('noreply') ||
                              email.toLowerCase().includes('postmaster') ||
                              email.toLowerCase().includes('abuse') ||
                              email.toLowerCase().includes('webmaster');
        
        return !isAdminAccount; // Exclude if it's an admin account
    });
    
    let totalUsers = filteredUsers.length;
    let usersWithPasswords = 0;
    let usersWithoutPasswords = 0;
    
    filteredUsers.forEach(user => {
        if (user.app_password && user.app_password !== 'No app password') {
            usersWithPasswords++;
        } else {
            usersWithoutPasswords++;
        }
    });
    
    const passwordPercentage = totalUsers > 0 ? Math.round((usersWithPasswords / totalUsers) * 100) : 0;
    
    // Enhanced statistics with better styling
    const html = `
        <div style="
            display: flex; 
            gap: 16px; 
            flex-wrap: wrap; 
            align-items: center;
            padding: 16px;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        ">
            <div style="
                display: flex; 
                align-items: center; 
                gap: 8px; 
                padding: 10px 16px; 
                background: linear-gradient(135deg, #f6f8fa 0%, #e9ecef 100%); 
                border-radius: 20px; 
                border: 2px solid #d0d7de;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            ">
                <i class="fas fa-users" style="color: #0969da; font-size: 16px;"></i>
                <span style="color: #24292f; font-weight: 700; font-size: 14px;">Total: ${totalUsers}</span>
            </div>
            <div style="
                display: flex; 
                align-items: center; 
                gap: 8px; 
                padding: 10px 16px; 
                background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); 
                border-radius: 20px; 
                border: 2px solid #10b981;
                box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
            ">
                <i class="fas fa-check-circle" style="color: #059669; font-size: 16px;"></i>
                <span style="color: #065f46; font-weight: 700; font-size: 14px;">With Passwords: ${usersWithPasswords}</span>
            </div>
            <div style="
                display: flex; 
                align-items: center; 
                gap: 8px; 
                padding: 10px 16px; 
                background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); 
                border-radius: 20px; 
                border: 2px solid #ef4444;
                box-shadow: 0 2px 4px rgba(239, 68, 68, 0.2);
            ">
                <i class="fas fa-exclamation-triangle" style="color: #dc2626; font-size: 16px;"></i>
                <span style="color: #991b1b; font-weight: 700; font-size: 14px;">Missing: ${usersWithoutPasswords}</span>
            </div>
            <div style="
                display: flex; 
                align-items: center; 
                gap: 8px; 
                padding: 10px 16px; 
                background: ${passwordPercentage >= 80 ? 'linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%)' : passwordPercentage >= 60 ? 'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)' : 'linear-gradient(135deg, #fee2e2 0%, #fecaca 100%)'}; 
                border-radius: 20px; 
                border: 2px solid ${passwordPercentage >= 80 ? '#3b82f6' : passwordPercentage >= 60 ? '#f59e0b' : '#ef4444'};
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            ">
                <i class="fas fa-percentage" style="color: ${passwordPercentage >= 80 ? '#1d4ed8' : passwordPercentage >= 60 ? '#d97706' : '#dc2626'}; font-size: 16px;"></i>
                <span style="color: ${passwordPercentage >= 80 ? '#1e3a8a' : passwordPercentage >= 60 ? '#92400e' : '#991b1b'}; font-weight: 700; font-size: 14px;">Coverage: ${passwordPercentage}%</span>
            </div>
        </div>
    `;
    
    statsDiv.innerHTML = html;
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Load status when page loads
    setTimeout(() => {
        console.log('Initializing App Password Manager...');
        loadAppPasswordsStatus();
    }, 500);
});

// ===== SIMPLIFIED AUTOMATION AUTHENTICATION FUNCTIONS =====

// Execute the complete automation process
function executeAutomationProcess() {
    const accountsList = document.getElementById('automation-accounts-list').value.trim();
    
    if (!accountsList) {
        alert('Please enter at least one account to process');
        return;
    }
    
    // Parse accounts list (one per line)
    const accounts = accountsList.split('\n').map(line => line.trim()).filter(line => line);
    
    if (accounts.length === 0) {
        alert('Please enter valid accounts (one per line)');
        return;
    }
    
    // Show progress
    document.getElementById('automation-progress').style.display = 'block';
    document.getElementById('automation-progress-bar').style.width = '0%';
    document.getElementById('automation-progress-text').textContent = 'Starting automation process...';
    
    // Show users display areas immediately
    document.getElementById('automation-users-display').style.display = 'block';
    document.getElementById('automation-users-text-display').style.display = 'block';
    
    // Clear previous results
    document.getElementById('automation-users-list').innerHTML = '<div class="no-users-message"><i class="fas fa-spinner fa-spin"></i><p>Processing users...</p></div>';
    document.getElementById('automation-users-text').value = 'Processing users...';
    
    // Load app passwords status
    loadAppPasswordsStatus();
    
    // Execute automation process
    fetch('/api/execute-automation-process', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            accounts: accounts
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('automation-progress-bar').style.width = '100%';
            document.getElementById('automation-progress-text').textContent = 'Automation completed!';
            
            // Show results
            showAutomationResults(data);
            
            setTimeout(() => {
                document.getElementById('automation-progress').style.display = 'none';
            }, 3000);
        } else {
            alert('Error in automation process: ' + data.error);
            document.getElementById('automation-progress').style.display = 'none';
        }
    })
    .catch(error => {
        console.error('Error executing automation process:', error);
        alert('Error executing automation process');
        document.getElementById('automation-progress').style.display = 'none';
    });
}

// Show automation results
function showAutomationResults(data) {
    const resultsDiv = document.getElementById('automation-results');
    const contentDiv = document.getElementById('automation-results-content');
    
    let html = `
        <div style="margin-bottom: 16px;">
            <strong>Processed Accounts:</strong> ${data.processed_count || 0}<br>
            <strong>Successfully Authenticated:</strong> ${data.authenticated_count || 0}<br>
            <strong>Users Retrieved:</strong> ${data.users_retrieved || 0}
        </div>
    `;
    
    if (data.results && data.results.length > 0) {
        html += '<div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; background: #f9f9f9;">';
        data.results.forEach(result => {
            const status = result.success ? '✅' : '❌';
            html += `<div style="margin-bottom: 8px;">
                ${status} <strong>${result.account}</strong> - ${result.message}
            </div>`;
        });
        html += '</div>';
    }
    
    contentDiv.innerHTML = html;
    resultsDiv.style.display = 'block';
    
    // If users were retrieved, display them directly from the response
    if (data.users_retrieved > 0 && data.all_users) {
        displayAutomationUsers(data.all_users);
    }
}

// Fetch and display users from the last authenticated account
function fetchAndDisplayAutomationUsers() {
    fetch('/api/retrieve-users', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.users && data.users.length > 0) {
            displayAutomationUsers(data.users);
        } else {
            console.log('No users found or error retrieving users');
        }
    })
    .catch(error => {
        console.error('Error fetching users:', error);
    });
}

// Display users in the automation users list
function displayAutomationUsers(users) {
    const usersListDiv = document.getElementById('automation-users-list');
    const usersTextArea = document.getElementById('automation-users-text');
    const usersDisplayDiv = document.getElementById('automation-users-display');
    const usersTextDisplayDiv = document.getElementById('automation-users-text-display');
    
    console.log('Displaying users:', users);
    
    if (!users || users.length === 0) {
        usersListDiv.innerHTML = '<div class="no-users-message"><i class="fas fa-info-circle"></i><p>No users found</p></div>';
        usersTextArea.value = 'No users found';
        usersDisplayDiv.style.display = 'block';
        usersTextDisplayDiv.style.display = 'block';
        return;
    }
    
    // First, detect user types using the API
    detectUserTypes(users, (userTypes) => {
        // Populate the list view with user types
        let html = '';
        let emailsList = [];
        let filteredUsers = []; // For text area (exclude admins)
        
        users.forEach((user, index) => {
            const email = user.email || user.primaryEmail || 'N/A';
            const name = user.first_name && user.last_name ? `${user.first_name} ${user.last_name}` : (user.first_name || user.name?.fullName || user.name?.givenName || 'N/A');
            const status = user.suspended ? 'Suspended' : 'Active';
            const sourceAccount = user.source_account || 'Unknown';
            const appPassword = user.app_password || 'No app password';
            
            // Get user type from API response
            const userTypeInfo = userTypes.find(ut => ut.email === email);
            const userType = userTypeInfo ? userTypeInfo.user_type : 'user';
            
            console.log(`User: ${email}, Type: ${userType}, App Password: ${appPassword}`);
            
            // Display all users in the visual list (including admins) with elegant styling
            html += `
                <div class="user-item github-card" style="margin-bottom: 16px; border: 1px solid #d0d7de; border-radius: 8px; overflow: hidden; transition: all 0.2s ease;">
                    <div class="github-card-header" style="padding: 16px; background: ${userType === 'admin' ? '#fff8e1' : '#f6f8fa'}; border-bottom: 1px solid #d0d7de;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                    <div class="email" style="font-weight: 600; font-size: 16px; color: #24292f; line-height: 1.25;">${email}</div>
                                    <span class="user-type-badge" style="
                                        padding: 4px 8px; 
                                        border-radius: 12px; 
                                        font-size: 12px; 
                                        font-weight: 600; 
                                        text-transform: uppercase;
                                        background: ${userType === 'admin' ? '#ff9800' : '#28a745'};
                                        color: white;
                                        letter-spacing: 0.5px;
                                    ">${userType}</span>
                                </div>
                                <div class="name" style="color: #656d76; font-size: 14px; margin-bottom: 4px;">${name}</div>
                                <div class="source-account" style="color: #8b949e; font-size: 12px; display: flex; align-items: center; gap: 4px;">
                                    <i class="fas fa-user-circle"></i>
                                    From: ${sourceAccount}
                                </div>
                            </div>
                            <div class="user-status" style="
                                padding: 6px 12px; 
                                border-radius: 16px; 
                                font-size: 12px; 
                                font-weight: 500;
                                background: ${status === 'Active' ? '#d4edda' : '#f8d7da'};
                                color: ${status === 'Active' ? '#155724' : '#721c24'};
                                border: 1px solid ${status === 'Active' ? '#c3e6cb' : '#f5c6cb'};
                            ">
                                <i class="fas fa-${status === 'Active' ? 'check-circle' : 'exclamation-circle'}"></i>
                                ${status}
                            </div>
                        </div>
                    </div>
                    <div class="github-card-body" style="padding: 16px; background: white;">
                        <div style="display: flex; align-items: center; gap: 8px; color: #656d76; font-size: 13px;">
                            <i class="fas fa-info-circle"></i>
                            <span>User Type: <strong style="color: ${userType === 'admin' ? '#ff9800' : '#28a745'};">${userType.toUpperCase()}</strong></span>
                            ${userType === 'admin' ? '<span style="color: #ff9800; font-weight: 500;">• Administrative Account</span>' : '<span style="color: #28a745; font-weight: 500;">• Regular User</span>'}
                        </div>
                    </div>
                </div>
            `;
            
            emailsList.push(email);
            
            // Only add non-admin users to the text area
            if (userType !== 'admin') {
                filteredUsers.push(user);
            }
        });
        
        usersListDiv.innerHTML = html;
        
        // Create the SMTP format for the text area: user,app-password,smtp.gmail.com,587 (only non-admin users)
        let smtpFormatList = [];
        filteredUsers.forEach(user => {
            const rawEmail = user.email || user.primaryEmail || 'N/A';
            const email = normalizeEmail(rawEmail);
            let appPassword = user.app_password || 'No app password';
            
            // Remove SMTP part if it's already included in the app password
            if (appPassword.endsWith(',smtp.gmail.com,587')) {
                appPassword = appPassword.slice(0, -',smtp.gmail.com,587'.length);
                console.log(`Removed SMTP part from app password: ${appPassword}`);
            } else if (appPassword.endsWith(',smtp.gmail.com,587,smtp.gmail.com,587')) {
                appPassword = appPassword.slice(0, -',smtp.gmail.com,587,smtp.gmail.com,587'.length);
                console.log(`Removed duplicated SMTP part from app password: ${appPassword}`);
            }
            
            // Always append host:port exactly once
            const smtpLine = `${email},${appPassword},smtp.gmail.com,587`;
            smtpFormatList.push(smtpLine);
        });
        
        usersTextArea.value = smtpFormatList.join('\n');
        usersDisplayDiv.style.display = 'block';
        usersTextDisplayDiv.style.display = 'block';
        
        // Update statistics display (only for non-admin users)
        updateUsersListStats(filteredUsers);
    });
}

// Detect user types using API
function detectUserTypes(users, callback) {
    console.log('Detecting user types for', users.length, 'users');
    
    // Debug: Log the first user to see what fields are available
    if (users.length > 0) {
        console.log('Sample user data:', users[0]);
        console.log('isAdmin field:', users[0].isAdmin);
        console.log('All user fields:', Object.keys(users[0]));
    }
    
    fetch('/api/detect-user-types', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({users: users})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('User types detected:', data.user_types);
            // Debug: Log the detection results
            data.user_types.forEach(ut => {
                if (ut.user_type === 'admin') {
                    console.log(`Admin detected: ${ut.email}, isAdmin API: ${ut.is_admin_api}`);
                }
            });
            callback(data.user_types);
        } else {
            console.error('Error detecting user types:', data.error);
            // Fallback: treat all as users
            const fallbackTypes = users.map(user => ({
                email: user.email || user.primaryEmail || 'N/A',
                user_type: 'user',
                source_account: user.source_account || 'Unknown'
            }));
            callback(fallbackTypes);
        }
    })
    .catch(error => {
        console.error('Error calling user type detection API:', error);
        // Fallback: treat all as users
        const fallbackTypes = users.map(user => ({
            email: user.email || user.primaryEmail || 'N/A',
            user_type: 'user',
            source_account: user.source_account || 'Unknown'
        }));
        callback(fallbackTypes);
    });
}

// Copy all automation users
function copyAutomationUsers() {
    const userElements = document.querySelectorAll('#automation-users-list .user-item .email');
    if (userElements.length === 0) {
        alert('No users to copy');
        return;
    }
    
    const emails = Array.from(userElements).map(element => element.textContent.trim());
    const emailText = emails.join('\n');
    
    navigator.clipboard.writeText(emailText).then(() => {
        alert(`✅ Copied ${emails.length} user emails to clipboard`);
    }).catch(() => {
        alert('❌ Copy failed - please try manually selecting the text');
    });
}

// Copy retrieved users text content
function copyRetrievedUsersText() {
    const textArea = document.getElementById('automation-users-text');
    if (!textArea) {
        console.error('Text area not found');
        alert('❌ Text area not found');
        return;
    }

    const raw = textArea.value.trim();
    if (!raw) {
        alert('❌ No text content to copy');
        return;
    }

    // Filter out lines with missing app passwords
    const lines = raw.split('\n');
    const filtered = [];
    lines.forEach(line => {
        if (!line.trim()) return;
        const parts = line.split(',').map(p => p.trim());
        if (parts.length < 2) return; // malformed
        const appPwd = (parts[1] || '').toLowerCase();
        if (!appPwd || appPwd === 'no app password' || appPwd === 'no-app-password') return;

        // Normalize to exactly 4 columns: email, app_password, smtp.gmail.com, 587
        const email = parts[0];
        let appPassword = parts[1];
        
        // Remove SMTP part if it's already included in the app password
        if (appPassword.endsWith(',smtp.gmail.com,587')) {
            appPassword = appPassword.slice(0, -',smtp.gmail.com,587'.length);
        } else if (appPassword.endsWith(',smtp.gmail.com,587,smtp.gmail.com,587')) {
            appPassword = appPassword.slice(0, -',smtp.gmail.com,587,smtp.gmail.com,587'.length);
        }
        
        const smtp = parts[2] && parts[2].length ? parts[2] : 'smtp.gmail.com';
        const port = parts[3] && parts[3].length ? parts[3] : '587';
        filtered.push([email, appPassword, smtp, port].join(','));
    });

    if (filtered.length === 0) {
        alert('❌ No users with app passwords to copy');
        return;
    }

    const content = filtered.join('\n');
    console.log('Copying filtered text (lines):', filtered.length);

    // Try modern clipboard API first
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(content).then(() => {
            console.log('✅ Text copied to clipboard successfully');
            alert(`✅ Copied ${filtered.length} user(s) with app passwords to clipboard`);
        }).catch(err => {
            console.error('Clipboard API failed:', err);
            // Fallback to legacy method using a temporary textarea
            const temp = document.createElement('textarea');
            temp.value = content;
            document.body.appendChild(temp);
            copyTextFallback(temp);
            document.body.removeChild(temp);
        });
    } else {
        // Fallback for older browsers or non-secure contexts
        const temp = document.createElement('textarea');
        temp.value = content;
        document.body.appendChild(temp);
        copyTextFallback(temp);
        document.body.removeChild(temp);
    }
}

// Fallback copy method for older browsers
function copyTextFallback(textArea) {
    try {
        textArea.select();
        textArea.setSelectionRange(0, 99999); // For mobile devices
        
        const successful = document.execCommand('copy');
        if (successful) {
            console.log('✅ Text copied using fallback method');
            alert('✅ Copied retrieved users text to clipboard');
        } else {
            console.error('❌ Fallback copy failed');
            alert('❌ Copy failed - please try manually selecting the text');
        }
    } catch (err) {
        console.error('❌ Copy fallback error:', err);
        alert('❌ Copy failed - please try manually selecting the text');
    }
}

// Export automation users as CSV
function exportAutomationUsers() {
    console.log('Starting CSV export...');
    
    // First try to get users from the visual list
    const userElements = document.querySelectorAll('#automation-users-list .user-item');
    console.log('Found visual user elements:', userElements.length);
    
    let csvContent = 'Email,Name,Status,Source Account,App Password,SMTP Config\n';
    let userCount = 0;
    
    if (userElements.length > 0) {
        // Export from visual list
        userElements.forEach(element => {
            const email = element.querySelector('.email')?.textContent.trim() || '';
            const name = element.querySelector('.name')?.textContent.trim() || '';
            const status = element.querySelector('.user-status')?.textContent.trim() || '';
            const sourceAccount = element.querySelector('.source-account')?.textContent.replace('From: ', '').trim() || '';
            
            // Extract app password and SMTP config from the SMTP info section
            const smtpInfo = element.querySelector('.smtp-info div:last-child')?.textContent.trim() || '';
            const smtpParts = smtpInfo.split(',');
            const appPassword = smtpParts.length > 1 ? smtpParts[1] : 'No app password';
            const smtpConfig = smtpInfo || `${email},No app password,smtp.gmail.com,587`;
            
            csvContent += `"${email}","${name}","${status}","${sourceAccount}","${appPassword}","${smtpConfig}"\n`;
            userCount++;
        });
    } else {
        // Fallback: try to get users from text area
        const textArea = document.getElementById('automation-users-text');
        if (textArea && textArea.value.trim()) {
            console.log('Using text area content for export');
            const lines = textArea.value.trim().split('\n');
            lines.forEach(line => {
                if (line.trim()) {
                    const parts = line.split(',');
                    if (parts.length >= 4) {
                        const email = parts[0];
                        const appPassword = parts[1];
                        const smtpServer = parts[2];
                        const smtpPort = parts[3];
                        csvContent += `"${email}","","","","${appPassword}","${email},${appPassword},${smtpServer},${smtpPort}"\n`;
                        userCount++;
                    }
                }
            });
        }
    }
    
    if (userCount === 0) {
        alert('❌ No users to export');
        return;
    }
    
    console.log(`Exporting ${userCount} users to CSV`);
    
    try {
        // Create and download CSV file
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `bulk_automation_users_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.csv`;
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        console.log('✅ CSV file downloaded successfully');
        alert(`✅ CSV file downloaded successfully (${userCount} users exported)`);
    } catch (error) {
        console.error('❌ CSV export failed:', error);
        alert('❌ CSV export failed: ' + error.message);
    }
}

// Clear automation list
function clearAutomationList() {
    if (confirm('Are you sure you want to clear the accounts list?')) {
        document.getElementById('automation-accounts-list').value = '';
        document.getElementById('automation-results').style.display = 'none';
        document.getElementById('automation-users-display').style.display = 'none';
        document.getElementById('automation-users-text-display').style.display = 'none';
    }
}

</script>

<!-- Mega Upgrade Modal -->
<div id="megaUpgradeModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 1200px; width: 95%;">
        <div class="modal-header">
            <h2><i class="fas fa-rocket"></i> Mega Upgrade: Single Account Workflow</h2>
            <span class="close" onclick="closeMegaUpgradeModal()">&times;</span>
        </div>
        
        <div class="modal-body">
            <!-- Feature Selection -->
            <div style="margin-bottom: 24px;">
                <h3 style="margin-bottom: 16px; color: #24292f;">
                    <i class="fas fa-cogs"></i> Select Features to Apply
                </h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
                    <label class="checkbox-container">
                        <input type="checkbox" id="feature-authenticate" checked>
                        <span class="checkmark"></span>
                        <i class="fas fa-key"></i> Authenticate Accounts
                    </label>
                    <label class="checkbox-container">
                        <input type="checkbox" id="feature-change-subdomain" checked>
                        <span class="checkmark"></span>
                        <i class="fas fa-exchange-alt"></i> Auto Change Subdomain
                    </label>
                </div>
            </div>
            
            <!-- Account Input -->
            <div style="margin-bottom: 24px;">
                <h3 style="margin-bottom: 16px; color: #24292f;">
                    <i class="fas fa-users"></i> Account Processing
                </h3>
                <div class="form-group-github">
                    <label for="mega-single-account" class="form-label-github">
                        <i class="fas fa-envelope"></i> Account Emails (one per line)
                    </label>
                    <textarea id="mega-single-account" class="form-control-github" rows="6"
                              placeholder="support@domain1.com\ninfo@domain2.com\nadmin@domain3.com"
                              style="font-family: monospace; font-size: 13px; resize: vertical;"></textarea>
                    <small style="color: #656d76; font-size: 12px;">
                        Enter one or multiple account emails (one per line). The system will process them in parallel with up to 6 concurrent workers.
                    </small>
                </div>
                
                <div class="form-group-github">
                    <label for="mega-subdomain-prefix" class="form-label-github">
                        <i class="fas fa-globe"></i> Subdomain Prefix (Optional)
                    </label>
                    <input type="text" id="mega-subdomain-prefix" class="form-control-github" 
                           placeholder="5fgckso88gxtvm5a (leave empty for random)"
                           style="font-family: monospace; font-size: 13px;">
                    <small style="color: #656d76; font-size: 12px;">
                        Enter a custom subdomain prefix or leave empty for random generation. Format: prefix.domain.com
                    </small>
                </div>
            </div>
            
            <!-- Progress Section -->
            <div id="megaUpgradeProgress" style="display: none; margin-bottom: 24px;">
                <h3 style="margin-bottom: 16px; color: #24292f;">
                    <i class="fas fa-tasks"></i> Progress
                </h3>
                <div style="background: #f6f8fa; border: 1px solid #d0d7de; border-radius: 6px; padding: 16px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span id="megaProgressText">Initializing...</span>
                        <span id="megaProgressPercent">0%</span>
                    </div>
                    <div style="background: #d0d7de; border-radius: 3px; height: 8px; overflow: hidden;">
                        <div id="megaProgressBar" style="background: #2da44e; height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div style="display: flex; gap: 12px; justify-content: center;">
                <button onclick="startMegaUpgrade()" class="btn-github btn-github-primary" id="megaStartBtn">
                    <i class="fas fa-play"></i> Run Mega Upgrade
                </button>
                <button onclick="debugMegaUpgrade()" class="btn-github" style="background-color: #6f42c1; border-color: #6f42c1; color: white;">
                    <i class="fas fa-bug"></i> Debug Mega Upgrade
                </button>
                <button onclick="stopMegaUpgrade()" class="btn-github" style="background-color: #d73a49; border-color: #d73a49; color: white;" id="megaStopBtn" style="display: none;">
                    <i class="fas fa-stop"></i> Stop Process
                </button>
                <button onclick="clearMegaUpgradeResults()" class="btn-github">
                    <i class="fas fa-broom"></i> Clear Results
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

<style>
/* Modal Styles */
.modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    display: flex;
    justify-content: center;
    align-items: center;
}

.modal-content {
    background-color: #fefefe;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    max-height: 90vh;
    overflow-y: auto;
}

.modal-header {
    padding: 20px;
    border-bottom: 1px solid #e1e4e8;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h2 {
    margin: 0;
    color: #24292f;
}

.close {
    color: #aaa;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close:hover {
    color: #000;
}

.modal-body {
    padding: 20px;
}
/* Checkbox Styles */
.checkbox-container {
    display: block;
    position: relative;
    padding-left: 35px;
    margin-bottom: 12px;
    cursor: pointer;
    font-size: 14px;
    user-select: none;
}

.checkbox-container input {
    position: absolute;
    opacity: 0;
    cursor: pointer;
    height: 0;
    width: 0;
}

.checkmark {
    position: absolute;
    top: 0;
    left: 0;
    height: 20px;
    width: 20px;
    background-color: #eee;
    border-radius: 4px;
    border: 1px solid #d0d7de;
}

.checkbox-container:hover input ~ .checkmark {
    background-color: #f6f8fa;
}

.checkbox-container input:checked ~ .checkmark {
    background-color: #2da44e;
    border-color: #2da44e;
}

.checkmark:after {
    content: "";
    position: absolute;
    display: none;
}

.checkbox-container input:checked ~ .checkmark:after {
    display: block;
}

.checkbox-container .checkmark:after {
    left: 6px;
    top: 2px;
    width: 6px;
    height: 10px;
    border: solid white;
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
}
</style>