
{% extends "base.html" %}
{% block title %}Dashboard - GBot Web{% endblock %}

{% block content %}
<!-- Tab Navigation -->
<div class="tab-navigation">
    <button class="tab-button active" onclick="showTab('tab1')">ğŸ‘¤ Account & User Mgmt</button>
    <button class="tab-button" onclick="showTab('tab2')">â•âœï¸ User Create/Delete/Domain</button>
    <button class="tab-button" onclick="showTab('tab3')">ğŸ”„ Bulk Domain Change</button>
    <button class="tab-button" onclick="showTab('tab4')">âœ‰ï¸ SMTP & CSV Gen</button>
</div>

<!-- Tab 1: Account & User Management (existing content) -->
<div id="tab1" class="tab-content active">    
<!-- Account Selection & Authentication -->
<div class="section">
    <h3>ğŸ‘¤ Account Selection & Authentication</h3>
    
    <div class="form-row">
        <label for="account-select">Select Account:</label>
        <select id="account-select">
            <option value="">Choose an account...</option>
            {% for account_name in accounts %}
            <option value="{{ account_name }}">{{ account_name }}</option>
            {% endfor %}
        </select>
        <button onclick="authenticateAccount()">ğŸ”‘ Authenticate Selected</button>
        <button onclick="openAddAccountModal()">â• Add Manually</button>
    </div>
    
    <div class="form-row">
        <button onclick="refreshAccounts()">ğŸ”„ Refresh List</button>
        <button onclick="addFromServerJSON()">ğŸ“ Add from Server JSON</button>
        <button onclick="backupFiles()">ğŸ’¾ Backup Files</button>
    </div>
    
    <!-- Search and Account List Area -->
    <div class="account-management-area">
        <div class="search-and-list">
            <input type="text" id="account-search" placeholder="Search accounts in list..." 
                   oninput="filterAccounts()" class="search-input">
            
            <div id="account-list-area" class="account-list">
                {% for account_name in accounts %}
                <div class="account-item" onclick="selectAccountFromList('{{ account_name }}')">
                    {{ account_name }}
                </div>
                {% endfor %}
            </div>
        </div>
        
        <div class="account-actions">
            <button onclick="authenticateFromList()" class="action-button">
                ğŸ”‘ Authenticate<br>(List Selection)
            </button>
            <button onclick="deleteFromList()" class="action-button delete-button">
                ğŸ—‘ï¸ Delete Account<br>(List Selection)
            </button>
        </div>
    </div>
    
    <div id="auth-status" class="status-box">
        <p>No account authenticated</p>
    </div>
</div>

<!-- Add Account Modal -->
<div id="addAccountModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeAddAccountModal()">&times;</span>
        <h3>Add Account Manually</h3>
        <form id="addAccountForm">
            <div class="form-group">
                <label for="new-account-email">Account Email:</label>
                <input type="email" id="new-account-email" required placeholder="admin@yourdomain.com">
            </div>
            <div class="form-group">
                <label for="new-client-id">Client ID:</label>
                <input type="text" id="new-client-id" required placeholder="123456789-abcdef.apps.googleusercontent.com">
            </div>
            <div class="form-group">
                <label for="new-client-secret">Client Secret:</label>
                <input type="password" id="new-client-secret" required placeholder="GOCSPX-your_client_secret">
            </div>
            <div class="form-buttons">
                <button type="button" onclick="saveNewAccount()">ğŸ’¾ Save Account</button>
                <button type="button" onclick="closeAddAccountModal()">âŒ Cancel</button>
            </div>
        </form>
    </div>
</div>

    <!-- User Listing & Actions -->
    <div class="section">
        <h3>ğŸ§‘â€ğŸ’» User Listing & Basic Actions</h3>
        
        <div class="button-row">
            <button onclick="retrieveUsers()">ğŸ“Š Retrieve All Users</button>
            <button onclick="clearUserList()">ğŸ§¹ Clear List</button>
            <button onclick="copyAllUsers()">ğŸ“‹ Copy All</button>
        </div>
        
        <div id="user-display" class="data-display">
            <p>Click 'Retrieve All Users' to view users here...</p>
        </div>
        
        <div id="user-count" class="count-display">Total Users: 0</div>
        
        <div class="form-row">
            <input type="password" id="new-password" placeholder="New password for all users">
            <button onclick="updateAllPasswords()">ğŸ”‘ Update Password (All)</button>
        </div>
    </div>

    <!-- Domain Info -->
    <div class="section">
        <h3>ğŸŒ Domain Info & Subdomain Utility</h3>
        
        <div class="button-row">
            <button onclick="retrieveDomains()">ğŸ” Retrieve Domains</button>
            <button onclick="clearDomainDisplay()">ğŸ§¹ Clear Display</button>
        </div>
        
        <div id="domain-display" class="data-display">
            <p>Click 'Retrieve Domains' to view domains here...</p>
        </div>
    </div>

    <!-- Suspended Users -->
    <div class="section">
        <h3>â›” Suspended User Management</h3>
        
        <div class="button-row">
            <button onclick="loadSuspendedUsers()">ğŸ” Load Suspended Users</button>
            <button onclick="copySuspendedUsers()">ğŸ“‹ Copy Selected</button>
        </div>
        
        <div id="suspended-display" class="data-display">
            <p>Load suspended users to view here...</p>
        </div>
    </div>
</div>
</div>

<!-- Tab 2: User Create/Delete/Domain -->
<div id="tab2" class="tab-content">
    <h2>User Create/Delete/Domain</h2>
    
    <!-- Create Users from CSV File -->
    <div class="section">
        <h3>ğŸ“¥ Create Users from CSV File</h3>
        <div class="form-row">
            <input type="file" id="csv-file-input" accept=".csv">
            <button onclick="createUsersFromCSV()">ğŸ“¥ Create Users from CSV</button>
        </div>
    </div>

    <!-- Create Random Users -->
    <div class="section">
        <h3>ğŸ² Create Random Users</h3>
        <div class="form-row">
            <input type="number" id="random-user-count" min="1" max="100" placeholder="Number of users">
            <input type="text" id="random-user-domain" placeholder="Domain (e.g., example.com)">
            <button onclick="createRandomUsers()">ğŸ² Create Random Users</button>
        </div>
    </div>

    <!-- Change Domain for Specific Users -->
    <div class="section">
        <h3>ğŸ”„ Change Domain for Specific Users</h3>
        <div class="form-row">
            <input type="text" id="old-domain" placeholder="Current Domain (e.g., old.com)">
            <input type="text" id="new-domain" placeholder="New Domain (e.g., new.com)">
        </div>
        <textarea id="domain-change-emails" rows="4" placeholder="Enter email addresses, one per line"></textarea>
        <button onclick="changeDomainForUsers()">ğŸ”„ Change Domain for These Users</button>
    </div>

    <!-- Delete Specific Users -->
    <div class="section">
        <h3>âŒ Delete Specific Users</h3>
        <textarea id="delete-user-emails" rows="4" placeholder="Enter email addresses to delete, one per line"></textarea>
        <button onclick="deleteSpecificUsers()" class="delete-button">âŒ Delete These Users</button>
    </div>

    <!-- Results Log -->
    <div class="section">
        <h3>ğŸ“ Results Log</h3>
        <div class="log-controls">
            <button onclick="clearResultsLog()">ğŸ§¹ Clear Log</button>
            <button onclick="copyResultsLog()">ğŸ“‹ Copy Log</button>
        </div>
        <div id="results-log" class="results-log"></div>
    </div>
</div>

<!-- Tab 3: Placeholder -->
<div id="tab3" class="tab-content">
    <h2>Bulk Domain Change</h2>
    <!-- Workflow 1: Change Domain using CSV File -->
    <div class="section">
        <h3>ğŸ“‹ Workflow 1: Change Domain using CSV File</h3>
        
        <!-- Step 1.1: Download Current Users to CSV -->
        <div class="workflow-step">
            <h4>Step 1.1: Download Current Users to CSV</h4>
            <div class="step-content">
                <button onclick="downloadAllUsersCSV()" class="primary-button">ğŸ“¥ Download All Users</button>
                <div class="info-text">
                    CSV will be saved to: <span id="csv-save-path">Downloads folder</span>
                </div>
            </div>
        </div>
        
        <!-- Step 1.2: Select New Domain and Apply to Downloaded CSV -->
        <div class="workflow-step">
            <h4>Step 1.2: Select New Domain and Apply to Downloaded CSV</h4>
            <div class="step-content">
                <div class="form-row">
                    <button onclick="retrieveAvailableDomains()" class="secondary-button">ğŸ” Retrieve Available Domains</button>
                    <button onclick="applySelectedDomainToCSV()" class="primary-button">âœ… Apply Selected Domain to CSV</button>
                </div>
                
                <div class="domain-selection-area">
                    <div id="available-domains" class="domain-list">
                        <p class="placeholder-text">Click 'Retrieve Available Domains' to view domains</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Step 1.3: Process Domain Changes from Modified CSV -->
        <div class="workflow-step">
            <h4>Step 1.3: Process Domain Changes from Modified CSV</h4>
            <div class="step-content">
                <div class="form-row">
                    <input type="text" id="csv-file-path" placeholder="CSV file path will appear here after download/apply, or browse manually..." readonly>
                    <button onclick="browseCSVFile()" class="secondary-button">ğŸ“ Browse Manually...</button>
                </div>
                <div class="form-row">
                    <button onclick="processDomainChangesFromCSV()" class="primary-button">âš™ï¸ Process Domain Changes from CSV</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Workflow 2: Change Domain for All Users (Non-CSV, Excludes Admin) -->
    <div class="section">
        <h3>ğŸ”„ Workflow 2: Change Domain for All Users (Non-CSV, Excludes Admin)</h3>
        
        <div class="workflow-step">
            <div class="form-row">
                <label for="current-domain-suffix">Current Domain Suffix:</label>
                <input type="text" id="current-domain-suffix" placeholder="e.g., old-domain.com">
            </div>
            <div class="form-row">
                <label for="new-domain-suffix">New Domain Suffix:</label>
                <input type="text" id="new-domain-suffix" placeholder="e.g., new-domain.com">
            </div>
            <div class="form-row">
                <button onclick="changeDomainForAllUsers()" class="warning-button">ğŸ”„ Change Domain for ALL Matching Users (Non-Admin)</button>
            </div>
        </div>
    </div>

    <!-- Results Log (Covers Both Workflows) -->
    <div class="section">
        <h3>ğŸ“ Results Log (Covers Both Workflows)</h3>
        
        <div class="log-controls">
            <button onclick="clearBulkDomainLog()" class="secondary-button">ğŸ§¹ Clear Log</button>
        </div>
        
        <div id="bulk-domain-results" class="results-log">
            <p class="placeholder-text">Processing results will appear here...</p>
        </div>
    </div>
</div>
</div>

<!-- Tab 4: Placeholder -->
<div id="tab4" class="tab-content">
    <h2>SMTP & CSV Generation</h2>
    <!-- SMTP Credential Tester -->
    <div class="section">
        <h3>âœ‰ï¸ SMTP Credential Tester</h3>
        
        <div class="form-row">
            <label for="smtp-credentials">SMTP Credentials (email:password, one per line):</label>
        </div>
        <textarea id="smtp-credentials" rows="5" placeholder="user1@gmail.com:password123&#10;user2@outlook.com:apppassword456&#10;user3@yahoo.com:secretpass789"></textarea>
        
        <div class="smtp-settings">
            <div class="form-row">
                <input type="email" id="smtp-recipient" placeholder="Recipient email (test@domain.com)">
                <input type="text" id="smtp-server" value="smtp.gmail.com" placeholder="SMTP Server">
                <input type="number" id="smtp-port" value="587" placeholder="Port">
            </div>
        </div>
        
        <div class="button-row">
            <button onclick="testSMTPCredentials()">âœ‰ï¸ Send Test Emails</button>
            <button onclick="interruptSMTPTesting()" class="button-warning">â¹ï¸ Interrupt Sending</button>
            <button onclick="clearSMTPResults()">ğŸ§¹ Clear Log / Reset Files</button>
        </div>
        
        <div class="smtp-results">
            <h4>ğŸ“Š SMTP Test Results:</h4>
            <div id="smtp-results-log" class="results-log"></div>
        </div>
    </div>

    <!-- Generate Sample CSV for User Creation -->
    <div class="section">
        <h3>ğŸ“ Generate Sample CSV for User Creation</h3>
        
        <div class="csv-form">
            <div class="form-row">
                <input type="number" id="csv-num-users" min="1" max="1000" placeholder="Number of users (e.g., 50)">
                <input type="text" id="csv-domain" placeholder="Domain (e.g., yourdomain.com)">
                <input type="text" id="csv-password" placeholder="Default password for all users">
            </div>
            
            <div class="button-row">
                <button onclick="generateUserCSV()">ğŸ“¥ Generate CSV File</button>
                <button onclick="previewCSV()">ğŸ‘ï¸ Preview CSV</button>
            </div>
        </div>
        
        <div id="csv-download-area" class="download-area"></div>
        
        <div id="csv-preview-area" class="csv-preview"></div>
    </div>

    <!-- COMMENTED OUT - Email Template Generator 
    <div class="section">
        <h3>ğŸ“§ Email Template Generator</h3>
        
        <div class="template-form">
            <div class="form-row">
                <input type="text" id="email-subject" placeholder="Email Subject">
            </div>
            
            <textarea id="email-body" rows="8" placeholder="Email body template...&#10;&#10;Use placeholders:&#10;{email} - User's email&#10;{password} - User's password&#10;{first_name} - User's first name&#10;{last_name} - User's last name"></textarea>
            
            <div class="button-row">
                <button onclick="generateEmailTemplate()">ğŸ“§ Generate Template</button>
                <button onclick="testEmailTemplate()">ğŸ§ª Test Template</button>
            </div>
        </div>
        
        <div id="email-template-preview" class="template-preview"></div>
    </div>
    -->
</div>

<script>
let currentAccount = null;
let isAuthenticated = false;
let selectedAccountFromList = null;
let smtpTesting = false;
let selectedDomain = null;

// Tab switching function
function showTab(tabId) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remove active class from all buttons
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById(tabId).classList.add('active');
    
    // Mark button as active
    event.target.classList.add('active');
}

// Results log functions
function logResult(message) {
    const log = document.getElementById('results-log');
    const timestamp = new Date().toLocaleTimeString();
    log.textContent += `[${timestamp}] ${message}\n`;
    log.scrollTop = log.scrollHeight;
}

function clearResultsLog() {
    document.getElementById('results-log').textContent = '';
}

function copyResultsLog() {
    const logContent = document.getElementById('results-log').textContent;
    if (logContent.trim()) {
        copyToClipboard(logContent).then(success => {
            if (success) {
                alert('ğŸ“‹ Log copied to clipboard!');
            } else {
                alert('âŒ Copy failed - please try manually selecting the text');
            }
        });
    } else {
        alert('No log content to copy');
    }
}

function updateAuthStatus(account, authenticated, message) {
    const statusBox = document.getElementById('auth-status');
    currentAccount = account;
    isAuthenticated = authenticated;
    
    if (authenticated) {
        statusBox.innerHTML = `<p style="color: green;">âœ… Authenticated as: ${account}</p>`;
        statusBox.className = 'status-box success';
    } else {
        statusBox.innerHTML = `<p style="color: red;">âŒ ${message || 'Not authenticated'}</p>`;
        statusBox.className = 'status-box error';
    }
}

function authenticateAccount() {
    const select = document.getElementById('account-select');
    const accountName = select.value;
    
    if (!accountName) {
        alert('Please select an account first');
        return;
    }
    
    updateAuthStatus(accountName, false, 'Authenticating...');
    
    fetch('/api/authenticate', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({account_name: accountName})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateAuthStatus(accountName, true, data.message);
        } else if (data.oauth_required) {
            updateAuthStatus(accountName, false, 'OAuth required');
            const message = `Manual authentication required for ${accountName}\n\nPlease visit this URL to authenticate:\n${data.oauth_url}\n\nAfter completing authentication, try again.`;
            alert(message);
            // Copy URL to clipboard if possible
            if (navigator.clipboard) {
                navigator.clipboard.writeText(data.oauth_url);
                alert('OAuth URL copied to clipboard!');
            }
        } else {
            updateAuthStatus(accountName, false, data.error);
        }
    })
    .catch(error => {
        updateAuthStatus(accountName, false, 'Network error: ' + error);
    });
}

function retrieveUsers() {
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    document.getElementById('user-display').innerHTML = '<p>Loading users...</p>';
    
    fetch('/api/retrieve-users', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let html = '';
            data.users.forEach(user => {
                html += `<div class="user-item">
                    <span class="email">${user.email}</span>
                    <span class="name">${user.first_name} ${user.last_name}</span>
                    ${user.admin ? '<span class="badge admin">ğŸ‘‘ Admin</span>' : ''}
                    ${user.suspended ? '<span class="badge suspended">ğŸš« Suspended</span>' : ''}
                </div>`;
            });
            document.getElementById('user-display').innerHTML = html;
            document.getElementById('user-count').textContent = `Total Users: ${data.total_count}`;
        } else {
            document.getElementById('user-display').innerHTML = `<p style="color: red;">Error: ${data.error}</p>`;
        }
    })
    .catch(error => {
        document.getElementById('user-display').innerHTML = `<p style="color: red;">Network error: ${error}</p>`;
    });
}

function clearUserList() {
    document.getElementById('user-display').innerHTML = '<p>Click \'Retrieve All Users\' to view users here...</p>';
    document.getElementById('user-count').textContent = 'Total Users: 0';
}

function copyAllUsers() {
    const userElements = document.querySelectorAll('.user-item');
    if (userElements.length === 0) {
        alert('No users to copy');
        return;
    }
    
    const emails = Array.from(userElements).map(element => {
        const emailElement = element.querySelector('.user-email');
        return emailElement ? emailElement.textContent.trim() : '';
    }).filter(email => email);
    
    const emailText = emails.join('\n');
    
    copyToClipboard(emailText).then(success => {
        if (success) {
            alert(`âœ… Copied ${emails.length} user emails to clipboard`);
            logResult(`ğŸ“‹ Copied ${emails.length} user emails to clipboard`);
        } else {
            alert('âŒ Copy failed - please try manually selecting the text');
        }
    });
}

function updateAllPasswords() {
    const password = document.getElementById('new-password').value;
    if (!password || password.length < 8) {
        alert('Password must be at least 8 characters');
        return;
    }
    
    if (!confirm('Update password for ALL users? This cannot be undone.')) {
        return;
    }
    
    // This would need to be implemented in the backend
    alert('Password update feature coming soon');
}

function retrieveDomains() {
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    document.getElementById('domain-display').innerHTML = '<p>Loading domains...</p>';
    
    fetch('/api/retrieve-domains', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let html = '';
            data.domains.forEach(domain => {
                html += `<div class="domain-item">
                    <span class="domain-name">${domain.domain_name}</span>
                    <span class="user-count">${domain.user_count} users</span>
                    ${domain.verified ? '<span class="badge verified">âœ… Verified</span>' : '<span class="badge unverified">âŒ Not Verified</span>'}
                </div>`;
            });
            document.getElementById('domain-display').innerHTML = html;
        } else {
            document.getElementById('domain-display').innerHTML = `<p style="color: red;">Error: ${data.error}</p>`;
        }
    })
    .catch(error => {
        document.getElementById('domain-display').innerHTML = `<p style="color: red;">Network error: ${error}</p>`;
    });
}

function clearDomainDisplay() {
    document.getElementById('domain-display').innerHTML = '<p>Click \'Retrieve Domains\' to view domains here...</p>';
}

function loadSuspendedUsers() {
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    document.getElementById('suspended-display').innerHTML = '<p>Loading suspended users...</p>';
    
    fetch('/api/load-suspended-users', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (data.users.length > 0) {
                let html = '';
                data.users.forEach(email => {
                    html += `<div class="suspended-user">${email}</div>`;
                });
                document.getElementById('suspended-display').innerHTML = html;
            } else {
                document.getElementById('suspended-display').innerHTML = '<p>No suspended users found</p>';
            }
        } else {
            document.getElementById('suspended-display').innerHTML = `<p style="color: red;">Error: ${data.error}</p>`;
        }
    })
    .catch(error => {
        document.getElementById('suspended-display').innerHTML = `<p style="color: red;">Network error: ${error}</p>`;
    });
}

function copySuspendedUsers() {
    const suspendedItems = document.querySelectorAll('.suspended-user');
    const emails = Array.from(suspendedItems).map(item => item.textContent);
    
    if (emails.length > 0) {
        copyToClipboard(emails.join('\n')).then(success => {
            if (success) {
                alert(`âœ… Copied ${emails.length} suspended email addresses to clipboard!`);
            } else {
                alert('âŒ Copy failed - please try manually selecting the text');
            }
        });
    } else {
        alert('No suspended users to copy');
    }
}

function refreshAccounts() {
    fetch('/api/refresh-accounts', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload(); // Reload page to show new accounts
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('Network error: ' + error);
    });
}

// Modal functions
function openAddAccountModal() {
    document.getElementById('addAccountModal').style.display = 'block';
}

function closeAddAccountModal() {
    document.getElementById('addAccountModal').style.display = 'none';
    document.getElementById('addAccountForm').reset();
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('addAccountModal');
    if (event.target == modal) {
        closeAddAccountModal();
    }
}

// Save new account
function saveNewAccount() {
    const email = document.getElementById('new-account-email').value;
    const clientId = document.getElementById('new-client-id').value;
    const clientSecret = document.getElementById('new-client-secret').value;
    
    if (!email || !clientId || !clientSecret) {
        alert('All fields are required');
        return;
    }
    
    if (!email.includes('@')) {
        alert('Please enter a valid email address');
        return;
    }
    
    fetch('/api/add-account', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            account_name: email,
            client_id: clientId,
            client_secret: clientSecret
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('âœ… Account added successfully!');
            closeAddAccountModal();
            refreshAccountsDisplay();
        } else {
            alert('âŒ Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('âŒ Network error: ' + error);
    });
}

// Account list functions
function selectAccountFromList(accountName) {
    // Remove previous selection
    document.querySelectorAll('.account-item').forEach(item => {
        item.classList.remove('selected');
    });
    
    // Select clicked item
    event.target.classList.add('selected');
    selectedAccountFromList = accountName;
    
    // Also update dropdown
    document.getElementById('account-select').value = accountName;
}

function filterAccounts() {
    const searchTerm = document.getElementById('account-search').value.toLowerCase();
    const accountItems = document.querySelectorAll('.account-item');
    
    accountItems.forEach(item => {
        const accountName = item.textContent.toLowerCase();
        if (accountName.includes(searchTerm)) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
}

function authenticateFromList() {
    if (!selectedAccountFromList) {
        alert('Please select an account from the list first');
        return;
    }
    
    // Set the dropdown to selected account and authenticate
    document.getElementById('account-select').value = selectedAccountFromList;
    authenticateAccount();
}

function deleteFromList() {
    if (!selectedAccountFromList) {
        alert('Please select an account from the list first');
        return;
    }
    
    if (!confirm(`Are you sure you want to delete account: ${selectedAccountFromList}?`)) {
        return;
    }
    
    fetch('/api/delete-account', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({account_name: selectedAccountFromList})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('âœ… Account deleted successfully!');
            selectedAccountFromList = null;
            refreshAccountsDisplay();
        } else {
            alert('âŒ Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('âŒ Network error: ' + error);
    });
}

function refreshAccountsDisplay() {
    fetch('/api/refresh-accounts', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reload the page to show updated accounts
            location.reload();
        } else {
            alert('âŒ Error refreshing: ' + data.error);
        }
    })
    .catch(error => {
        alert('âŒ Network error: ' + error);
    });
}

// Placeholder functions for buttons that need implementation
function addFromServerJSON() {
    alert('Add from Server JSON feature coming soon!');
}

function backupFiles() {
    alert('Backup Files feature coming soon!');
}

// Update the existing refreshAccounts function
function refreshAccounts() {
    refreshAccountsDisplay();
}

// Tab 2 Functions

function createUsersFromCSV() {
    const fileInput = document.getElementById('csv-file-input');
    if (!fileInput.files.length) {
        alert('Please select a CSV file first');
        return;
    }
    
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    logResult('ğŸ“¥ Starting CSV user creation...');
    
    const formData = new FormData();
    formData.append('csv_file', fileInput.files[0]);
    
    fetch('/api/create-users-from-csv', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            logResult(`âœ… CSV processing completed. Created ${data.created_count} users.`);
            if (data.results) {
                data.results.forEach(result => {
                    if (result.success) {
                        logResult(`âœ… Created: ${result.email}`);
                    } else {
                        logResult(`âŒ Failed: ${result.email} - ${result.error}`);
                    }
                });
            }
        } else {
            logResult(`âŒ CSV creation failed: ${data.error}`);
        }
    })
    .catch(error => {
        logResult(`âŒ Network error: ${error}`);
    });
}

function createRandomUsers() {
    const count = document.getElementById('random-user-count').value;
    const domain = document.getElementById('random-user-domain').value;
    
    if (!count || count <= 0) {
        alert('Please enter a valid number of users');
        return;
    }
    
    if (!domain || !domain.includes('.')) {
        alert('Please enter a valid domain');
        return;
    }
    
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    logResult(`ğŸ² Creating ${count} random users for ${domain}...`);
    
    fetch('/api/create-random-users', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            num_users: parseInt(count),
            domain: domain
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            logResult(`âœ… Random user creation completed. Password: ${data.password}`);
            if (data.results) {
                data.results.forEach(result => {
                    if (result.result.success) {
                        logResult(`âœ… Created: ${result.email}`);
                    } else {
                        logResult(`âŒ Failed: ${result.email} - ${result.result.error}`);
                    }
                });
            }
        } else {
            logResult(`âŒ Random user creation failed: ${data.error}`);
        }
    })
    .catch(error => {
        logResult(`âŒ Network error: ${error}`);
    });
}

function changeDomainForUsers() {
    const oldDomain = document.getElementById('old-domain').value;
    const newDomain = document.getElementById('new-domain').value;
    const emailsText = document.getElementById('domain-change-emails').value;
    
    if (!oldDomain || !newDomain) {
        alert('Please enter both old and new domains');
        return;
    }
    
    if (!emailsText.trim()) {
        alert('Please enter email addresses');
        return;
    }
    
    const emails = emailsText.split('\n').map(e => e.trim()).filter(e => e);
    
    if (emails.length === 0) {
        alert('No valid email addresses found');
        return;
    }
    
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    logResult(`ğŸ”„ Changing domain from ${oldDomain} to ${newDomain} for ${emails.length} users...`);
    
    fetch('/api/change-domain', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            old_domain: oldDomain,
            new_domain: newDomain,
            user_emails: emails
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            logResult(`âœ… Domain change completed for ${emails.length} users.`);
            if (data.results) {
                data.results.forEach(result => {
                    if (result.success) {
                        logResult(`âœ… Changed: ${result.old_email} â†’ ${result.new_email}`);
                    } else {
                        logResult(`âŒ Failed: ${result.email} - ${result.error}`);
                    }
                });
            }
        } else {
            logResult(`âŒ Domain change failed: ${data.error}`);
        }
    })
    .catch(error => {
        logResult(`âŒ Network error: ${error}`);
    });
}

function deleteSpecificUsers() {
    const emailsText = document.getElementById('delete-user-emails').value;
    
    if (!emailsText.trim()) {
        alert('Please enter email addresses to delete');
        return;
    }
    
    const emails = emailsText.split('\n').map(e => e.trim()).filter(e => e);
    
    if (emails.length === 0) {
        alert('No valid email addresses found');
        return;
    }
    
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    if (!confirm(`âš ï¸ Are you sure you want to DELETE ${emails.length} users? This cannot be undone!`)) {
        return;
    }
    
    logResult(`âŒ Deleting ${emails.length} users...`);
    
    fetch('/api/delete-users', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            user_emails: emails
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            logResult(`âœ… User deletion completed for ${emails.length} users.`);
            if (data.results) {
                data.results.forEach(result => {
                    if (result.result.success) {
                        logResult(`âœ… Deleted: ${result.email}`);
                    } else {
                        logResult(`âŒ Failed to delete: ${result.email} - ${result.result.error}`);
                    }
                });
            }
        } else {
            logResult(`âŒ User deletion failed: ${data.error}`);
        }
    })
    .catch(error => {
        logResult(`âŒ Network error: ${error}`);
    });
}

// Tab 3 Functions - Bulk Domain Change (Desktop App Style)


function downloadAllUsersCSV() {
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    logBulkDomain('ğŸ“¥ Starting download of all users to CSV...');
    
    fetch('/api/download-users-csv', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.csv_data) {
            // Create download
            const blob = new Blob([data.csv_data], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `all_users_${new Date().toISOString().slice(0,10)}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            // Update path display
            document.getElementById('csv-file-path').value = a.download;
            
            logBulkDomain(`âœ… Downloaded ${data.user_count} users to CSV: ${a.download}`);
        } else {
            logBulkDomain(`âŒ Download failed: ${data.error}`);
            alert('Download failed: ' + data.error);
        }
    })
    .catch(error => {
        logBulkDomain(`âŒ Network error: ${error}`);
        alert('Network error: ' + error);
    });
}

function retrieveAvailableDomains() {
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    logBulkDomain('ğŸ” Retrieving available domains...');
    
    fetch('/api/retrieve-domains', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.domains) {
            displayAvailableDomains(data.domains);
            logBulkDomain(`âœ… Retrieved ${data.domains.length} available domains`);
        } else {
            logBulkDomain(`âŒ Failed to retrieve domains: ${data.error}`);
            alert('Failed to retrieve domains: ' + data.error);
        }
    })
    .catch(error => {
        logBulkDomain(`âŒ Network error: ${error}`);
        alert('Network error: ' + error);
    });
}

function displayAvailableDomains(domains) {
    const domainList = document.getElementById('available-domains');
    
    if (domains.length === 0) {
        domainList.innerHTML = '<p class="placeholder-text">No domains found</p>';
        return;
    }
    
    domainList.innerHTML = domains.map(domain => {
        const isUsed = domain.is_used || false;
        const domainClass = isUsed ? 'domain-item used-domain' : 'domain-item';
        const clickHandler = isUsed ? '' : `onclick="selectDomain('${domain.domain_name}')"`;
        const statusText = isUsed ? 'USED' : 'AVAILABLE';
        const statusColor = isUsed ? 'red' : 'green';
        
        return `<div class="${domainClass}" ${clickHandler}>
            <strong style="color: ${isUsed ? 'red' : 'black'};">${domain.domain_name}</strong>
            <span style="float: right; color: #666;">${domain.user_count} users</span>
            <div style="margin-top: 5px;">
                ${domain.verified ? '<span style="color: green;">âœ… Verified</span>' : '<span style="color: red;">âŒ Not Verified</span>'}
                <span style="color: ${statusColor}; margin-left: 10px; font-weight: bold;">${statusText}</span>
            </div>
        </div>`;
    }).join('');
}

function selectDomain(domainName) {
    // Check if domain is used
    const domainElement = event.target.closest('.domain-item');
    if (domainElement.classList.contains('used-domain')) {
        alert('âŒ This domain has already been used and cannot be selected again.');
        return;
    }
    
    // Remove previous selection
    document.querySelectorAll('.domain-item').forEach(item => {
        item.classList.remove('selected');
    });
    
    // Select clicked domain
    domainElement.classList.add('selected');
    selectedDomain = domainName;
    
    logBulkDomain(`ğŸ“Œ Selected domain: ${domainName}`);
}

function applySelectedDomainToCSV() {
    if (!selectedDomain) {
        alert('Please select a domain first');
        return;
    }
    
    const csvPath = document.getElementById('csv-file-path').value;
    if (!csvPath) {
        alert('Please download users CSV first');
        return;
    }
    
    logBulkDomain(`âœ… Applying domain ${selectedDomain} to CSV...`);
    
    fetch('/api/apply-domain-to-csv', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            selected_domain: selectedDomain,
            csv_path: csvPath
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            fetch('/api/mark-domain-used', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({domain: selectedDomain})
            });
            // Update CSV path to modified version
            document.getElementById('csv-file-path').value = data.modified_csv_path;
            logBulkDomain(`âœ… Domain applied successfully. Modified CSV: ${data.modified_csv_path}`);
            logBulkDomain(`ğŸ“Š ${data.modified_count} users will be updated to ${selectedDomain}`);
        } else {
            logBulkDomain(`âŒ Failed to apply domain: ${data.error}`);
            alert('Failed to apply domain: ' + data.error);
        }
    })
    .catch(error => {
        logBulkDomain(`âŒ Network error: ${error}`);
        alert('Network error: ' + error);
    });
}

function browseCSVFile() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.csv';
    input.onchange = function(e) {
        const file = e.target.files[0];
        if (file) {
            document.getElementById('csv-file-path').value = file.name;
            logBulkDomain(`ğŸ“ Selected CSV file: ${file.name}`);
        }
    };
    input.click();
}

function processDomainChangesFromCSV() {
    const csvPath = document.getElementById('csv-file-path').value;
    
    if (!csvPath) {
        alert('Please select or specify a CSV file first');
        return;
    }
    
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    if (!confirm('âš ï¸ Process domain changes from CSV?\n\nThis will update user domains as specified in the CSV file.\n\nThis action cannot be easily undone!')) {
        return;
    }
    
    logBulkDomain(`âš™ï¸ Processing domain changes from CSV: ${csvPath}`);
    
    fetch('/api/process-csv-domain-changes', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            csv_path: csvPath
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            logBulkDomain(`âœ… CSV processing completed!`);
            logBulkDomain(`ğŸ“Š Results: ${data.successful} successful, ${data.failed} failed, ${data.skipped} skipped`);
            
            if (data.results) {
                data.results.forEach(result => {
                    if (result.success) {
                        logBulkDomain(`âœ… Updated: ${result.old_email} â†’ ${result.new_email}`);
                    } else {
                        logBulkDomain(`âŒ Failed: ${result.email} - ${result.error}`);
                    }
                });
            }
        } else {
            logBulkDomain(`âŒ CSV processing failed: ${data.error}`);
            alert('CSV processing failed: ' + data.error);
        }
    })
    .catch(error => {
        logBulkDomain(`âŒ Network error: ${error}`);
        alert('Network error: ' + error);
    });
}

function changeDomainForAllUsers() {
    const currentDomain = document.getElementById('current-domain-suffix').value.trim();
    const newDomain = document.getElementById('new-domain-suffix').value.trim();
    
    if (!currentDomain || !newDomain) {
        alert('Please enter both current and new domain suffixes');
        return;
    }
    
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    if (!confirm(`âš ï¸ Change domain for ALL users?\n\n${currentDomain} â†’ ${newDomain}\n\nThis will affect ALL non-admin users with the current domain.\nThis action cannot be easily undone!\n\nContinue?`)) {
        return;
    }
    
    logBulkDomain(`ğŸ”„ Starting bulk domain change: ${currentDomain} â†’ ${newDomain}`);
    logBulkDomain(`ğŸ“‹ Targeting all non-admin users with domain: ${currentDomain}`);
    
    fetch('/api/change-domain-all-users', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            current_domain: currentDomain,
            new_domain: newDomain,
            exclude_admin: true
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (data.successful > 0) {
                fetch('/api/mark-domain-used', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({domain: newDomain})
                });
            }
            logBulkDomain(`âœ… Bulk domain change completed!`);
            logBulkDomain(`ğŸ“Š Results: ${data.successful} successful, ${data.failed} failed, ${data.skipped} skipped (admin users)`);
            
            if (data.results) {
                data.results.forEach(result => {
                    if (result.success) {
                        logBulkDomain(`âœ… Updated: ${result.old_email} â†’ ${result.new_email}`);
                    } else if (result.skipped) {
                        logBulkDomain(`â­ï¸ Skipped: ${result.email} (admin user)`);
                    } else {
                        logBulkDomain(`âŒ Failed: ${result.email} - ${result.error}`);
                    }
                });
            }
        } else {
            logBulkDomain(`âŒ Bulk domain change failed: ${data.error}`);
            alert('Bulk domain change failed: ' + data.error);
        }
    })
    .catch(error => {
        logBulkDomain(`âŒ Network error: ${error}`);
        alert('Network error: ' + error);
    });
}

function logBulkDomain(message) {
    const log = document.getElementById('bulk-domain-results');
    const timestamp = new Date().toLocaleTimeString();
    
    if (log.querySelector('.placeholder-text')) {
        log.innerHTML = '';
    }
    
    log.textContent += `[${timestamp}] ${message}\n`;
    log.scrollTop = log.scrollHeight;
}

function clearBulkDomainLog() {
    document.getElementById('bulk-domain-results').innerHTML = '<p class="placeholder-text">Processing results will appear here...</p>';
}

// Tab 4 Functions - SMTP & CSV

function testSMTPCredentials() {
    const credentials = document.getElementById('smtp-credentials').value.trim();
    const recipient = document.getElementById('smtp-recipient').value.trim();
    const server = document.getElementById('smtp-server').value.trim();
    const port = document.getElementById('smtp-port').value;
    
    if (!credentials) {
        alert('Please enter SMTP credentials');
        return;
    }
    
    if (!recipient || !recipient.includes('@')) {
        alert('Please enter a valid recipient email');
        return;
    }
    
    smtpTesting = true;
    clearSMTPResults();
    logSMTPResult('ğŸš€ Starting SMTP credential testing...');
    logSMTPResult(`ğŸ“§ Recipient: ${recipient}`);
    logSMTPResult(`ğŸ–¥ï¸ Server: ${server}:${port}`);
    logSMTPResult('â”€'.repeat(50));
    
    fetch('/api/test-smtp', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            credentials: credentials,
            recipient_email: recipient,
            smtp_server: server,
            smtp_port: parseInt(port)
        })
    })
    .then(response => response.json())
    .then(data => {
        smtpTesting = false;
        
        if (data.success && data.results) {
            logSMTPResult(`ğŸ“Š Testing completed for ${data.results.length} credentials:`);
            logSMTPResult('â”€'.repeat(50));
            
            let successCount = 0;
            let failCount = 0;
            
            data.results.forEach(result => {
                if (result.status === 'success') {
                    logSMTPResult(`âœ… ${result.email}: ${result.message || 'Success'}`);
                    successCount++;
                } else {
                    logSMTPResult(`âŒ ${result.email}: ${result.error}`);
                    failCount++;
                }
            });
            
            logSMTPResult('â”€'.repeat(50));
            logSMTPResult(`ğŸ“ˆ Summary: ${successCount} successful, ${failCount} failed`);
        } else {
            logSMTPResult(`âŒ SMTP testing failed: ${data.error}`);
        }
    })
    .catch(error => {
        smtpTesting = false;
        logSMTPResult(`âŒ Network error: ${error}`);
    });
}

function interruptSMTPTesting() {
    if (smtpTesting) {
        smtpTesting = false;
        logSMTPResult('â¹ï¸ SMTP testing interrupted by user');
        alert('SMTP testing interrupted');
    } else {
        alert('No SMTP testing in progress');
    }
}

function clearSMTPResults() {
    document.getElementById('smtp-results-log').textContent = '';
}

function logSMTPResult(message) {
    const log = document.getElementById('smtp-results-log');
    const timestamp = new Date().toLocaleTimeString();
    log.textContent += `[${timestamp}] ${message}\n`;
    log.scrollTop = log.scrollHeight;
}

function generateUserCSV() {
    const numUsers = document.getElementById('csv-num-users').value;
    const domain = document.getElementById('csv-domain').value.trim();
    const password = document.getElementById('csv-password').value.trim();
    
    if (!numUsers || numUsers <= 0) {
        alert('Please enter a valid number of users');
        return;
    }
    
    if (!domain || !domain.includes('.')) {
        alert('Please enter a valid domain');
        return;
    }
    
    if (!password) {
        alert('Please enter a default password');
        return;
    }
    
    logResult(`ğŸ“ Generating CSV with ${numUsers} users for ${domain}...`);
    
    fetch('/api/generate-csv', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            num_users: parseInt(numUsers),
            domain: domain,
            password: password
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.csv_data) {
            // Create download link
            const blob = new Blob([data.csv_data], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const filename = `users_${domain}_${numUsers}.csv`;
            
            document.getElementById('csv-download-area').innerHTML = `
                <a href="${url}" download="${filename}" class="download-btn">
                    ğŸ“¥ Download ${filename} (${numUsers} users)
                </a>
            `;
            
            logResult(`âœ… CSV file generated successfully: ${filename}`);
        } else {
            logResult(`âŒ CSV generation failed: ${data.error}`);
            alert('Failed to generate CSV: ' + data.error);
        }
    })
    .catch(error => {
        logResult(`âŒ Network error: ${error}`);
        alert('Network error: ' + error);
    });
}

function previewCSV() {
    const numUsers = Math.min(document.getElementById('csv-num-users').value || 5, 10); // Preview max 10
    const domain = document.getElementById('csv-domain').value.trim() || 'example.com';
    const password = document.getElementById('csv-password').value.trim() || 'DefaultPass123';
    
    fetch('/api/preview-csv', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            num_users: parseInt(numUsers),
            domain: domain,
            password: password
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.preview) {
            document.getElementById('csv-preview-area').innerHTML = `
                <h4>ğŸ“‹ CSV Preview (first ${numUsers} rows):</h4>
                <pre>${data.preview}</pre>
            `;
        } else {
            alert('Failed to preview CSV: ' + data.error);
        }
    })
    .catch(error => {
        alert('Network error: ' + error);
    });
}

/*

// COMMENTED OUT - Email Template Functions
function generateEmailTemplate() {
    const subject = document.getElementById('email-subject').value.trim();
    const body = document.getElementById('email-body').value.trim();
    
    if (!subject || !body) {
        alert('Please enter both subject and body');
        return;
    }
    
    // Sample data for template preview
    const sampleData = {
        email: 'john.doe@example.com',
        password: 'TempPass123',
        first_name: 'John',
        last_name: 'Doe'
    };
    
    let previewSubject = subject;
    let previewBody = body;
    
    // Replace placeholders
    Object.keys(sampleData).forEach(key => {
        const placeholder = `{${key}}`;
        previewSubject = previewSubject.replace(new RegExp(placeholder, 'g'), sampleData[key]);
        previewBody = previewBody.replace(new RegExp(placeholder, 'g'), sampleData[key]);
    });
    
    document.getElementById('email-template-preview').innerHTML = `
        <h4>ğŸ“§ Email Template Preview:</h4>
        <div style="border: 1px solid #ddd; padding: 1rem; background: white;">
            <div><strong>Subject:</strong> ${previewSubject}</div>
            <hr>
            <div style="white-space: pre-wrap;">${previewBody}</div>
        </div>
        <p><small>ğŸ“ Sample data used: ${JSON.stringify(sampleData, null, 2)}</small></p>
    `;
}

// COMMENTED OUT - Email Template Functions
function testEmailTemplate() {
    alert('Email template testing feature coming soon!');
}
*/

</script>
{% endblock %}
