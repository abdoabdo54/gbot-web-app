
{% extends "base.html" %}
{% block title %}Dashboard - GBot Web{% endblock %}

{% block content %}
<!-- Tab Navigation -->
<div class="tab-navigation">
    <nav>
        <button class="tab-button active" onclick="showTab('tab1')">
            <i class="fas fa-user-friends"></i>
            <span>Account & User Mgmt</span>
        </button>
        <button class="tab-button" onclick="showTab('tab2')">
            <i class="fas fa-user-plus"></i>
            <span>User Create/Delete/Domain</span>
        </button>
        <button class="tab-button" onclick="showTab('tab3')">
            <i class="fas fa-mail-bulk"></i>
            <span>SMTP Tester</span>
        </button>
        <button class="tab-button" onclick="showTab('tab4')">
            <i class="fas fa-envelope"></i>
            <span>SMTP & CSV Gen</span>
        </button>

    </nav>
</div>

<!-- Tab 1: Account & User Management (existing content) -->
<div id="tab1" class="tab-content active">    
<!-- Account Selection & Authentication -->
<div class="github-card">
    <div class="github-card-header">
        <h3 class="github-card-title">
            <i class="fas fa-user-friends"></i>
            Account Selection & Authentication
        </h3>
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr auto; gap: 16px; align-items: end; margin-bottom: 20px;">
        <div class="form-group-github">
            <label for="account-select" class="form-label-github">
                <i class="fas fa-user-circle"></i> Select Account
            </label>
            <select id="account-select" class="form-control-github">
            <option value="">Choose an account...</option>
                {% for account in accounts %}
                <option value="{{ account.account_name }}" data-account-id="{{ account.id }}">{{ account.account_name }}</option>
            {% endfor %}
        </select>
        </div>
        <button onclick="authenticateAccount()" class="btn-github btn-github-primary">
            <i class="fas fa-key"></i> Authenticate Selected
        </button>
    </div>
    
    <div style="display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 20px;">
        {% if session.role != 'mailer' %}
        <button onclick="openAddAccountModal()" class="btn-github">
            <i class="fas fa-plus"></i> Add Manually
        </button>
        <button onclick="addFromServerJSON()" class="btn-github">
            <i class="fas fa-folder-open"></i> Add from Server JSON
        </button>
        {% endif %}
        {% if session.role == 'admin' %}
        <button onclick="forceTokenStatusCheck()" class="btn-github" style="background-color: var(--color-warning-emphasis); border-color: var(--color-warning-emphasis); color: #ffffff;">
            <i class="fas fa-search"></i> Check Token Status Now (Admin)
        </button>
        {% endif %}    
        <button onclick="enterAuthorizationCode()" class="btn-github">
            <i class="fas fa-code"></i> Enter Authorization Code
        </button>
    </div>
    
    <!-- Search and Account List Area -->
    <div class="account-management-area">
        <div class="search-and-list">
            <input type="text" id="account-search" placeholder="Search accounts in list..." 
                    oninput="filterAccounts()" class="search-input" 
                    autocomplete="off" autocomplete="nope" readonly onfocus="this.removeAttribute('readonly');">
            
            <div id="account-list-area" class="account-list">
                {% for account in accounts %}
                <div class="account-item" data-account-name="{{ account.account_name }}" data-account-id="{{ account.id }}" onclick="selectAccountFromList(this.dataset.accountName, this.dataset.accountId)">
                    {{ account.account_name }}
                </div>
                {% endfor %}
            </div>
        </div>
        
        <div class="account-actions">
            <button onclick="authenticateFromList()" class="action-button">
                üîë Authenticate<br>(List Selection)
            </button>
            <button onclick="deleteFromList()" class="action-button delete-button">
                üóëÔ∏è Delete Account<br>(List Selection)
            </button>
        </div>
    </div>
    <div id="account-count-display" class="count-display">
        <span id="account-stats">Loading account statistics...</span>
    </div>
    <div id="auth-status" class="status-box">
        <p>No account authenticated</p>
    </div>
</div>

<!-- Add Account Modal -->
<div id="addAccountModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">
                <i class="fas fa-plus"></i> Add Account Manually
            </h3>
            <button type="button" class="btn-github" onclick="closeAddAccountModal()" style="margin-left: auto;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
        <form id="addAccountForm">
                <div class="form-group-github">
                    <label for="new-account-email" class="form-label-github">
                        <i class="fas fa-envelope"></i> Account Email
                    </label>
                    <input type="email" id="new-account-email" class="form-control-github" required placeholder="admin@yourdomain.com">
            </div>
                <div class="form-group-github">
                    <label for="new-client-id" class="form-label-github">
                        <i class="fas fa-key"></i> Client ID
                    </label>
                    <input type="text" id="new-client-id" class="form-control-github" required placeholder="123456789-abcdef.apps.googleusercontent.com">
            </div>
                <div class="form-group-github">
                    <label for="new-client-secret" class="form-label-github">
                        <i class="fas fa-lock"></i> Client Secret
                    </label>
                    <input type="password" id="new-client-secret" class="form-control-github" required placeholder="GOCSPX-your_client_secret">
            </div>
        </form>
        </div>
        <div class="modal-footer">
            <button type="button" onclick="saveNewAccount()" class="btn-github btn-github-primary">
                <i class="fas fa-save"></i> Save Account
            </button>
            <button type="button" onclick="closeAddAccountModal()" class="btn-github">
                <i class="fas fa-times"></i> Cancel
            </button>
        </div>
    </div>
</div>



<!-- OAuth Authorization Modal -->
<div id="oauthModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">
                <i class="fas fa-link"></i> OAuth Authorization Required
            </h3>
            <button type="button" class="btn-github" onclick="closeOAuthModal()" style="margin-left: auto;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <p>Please copy this link and open it in your browser to authorize the account:</p>
            <div id="oauthUrl" class="data-display" style="font-family: monospace; word-break: break-all; margin: 16px 0;"></div>
            <div style="background-color: rgba(9, 105, 218, 0.1); border: 1px solid var(--color-accent-emphasis); border-radius: 6px; padding: 12px; color: var(--color-accent-fg); font-size: 14px;">
                <i class="fas fa-lightbulb"></i>
                <strong>Tip:</strong> You can copy this link to use in another browser or app for authorization.
            </div>
        </div>
        <div class="modal-footer">
            <button onclick="copyOAuthUrl()" class="btn-github">
                <i class="fas fa-copy"></i> Copy Link
            </button>
            <button onclick="openOAuthUrl()" class="btn-github btn-github-primary">
                <i class="fas fa-external-link-alt"></i> Open Link
            </button>
            <button onclick="closeOAuthModal()" class="btn-github">
                <i class="fas fa-times"></i> Close
            </button>
        </div>
    </div>
</div>

    <!-- User Listing & Actions -->
<div class="github-card">
    <div class="github-card-header">
        <h3 class="github-card-title">
            <i class="fas fa-users"></i>
            User Listing & Basic Actions
        </h3>
    </div>
        
        <div class="button-row">
        <button onclick="retrieveUsers()" class="btn-github btn-github-primary">
            <i class="fas fa-chart-bar"></i> Retrieve All Users
        </button>
        <button onclick="clearUserList()" class="btn-github">
            <i class="fas fa-broom"></i> Clear List
        </button>
        <button onclick="copyAllUsers()" class="btn-github">
            <i class="fas fa-copy"></i> Copy All
        </button>
        </div>
        
        <div id="user-display" class="data-display">
        <div class="status-info">
            <p><strong><i class="fas fa-users"></i> User Management</strong></p>
            <p>Click "Retrieve All Users" to load and display all users from your Google Workspace.</p>
            <p><small>This will show user status (Active/Suspended), admin privileges, and provide options for bulk operations.</small></p>
        </div>
        </div>
        
        <div id="user-count" class="count-display">Total Users: 0</div>
        
    <div style="display: grid; grid-template-columns: 1fr auto; gap: 16px; align-items: end; margin-top: 16px;">
        <div class="form-group-github">
            <label for="new-password" class="form-label-github">
                <i class="fas fa-lock"></i> New Password for All Users
            </label>
            <input type="password" id="new-password" class="form-control-github" placeholder="Enter new password for all users" autocomplete="new-password" readonly onfocus="this.removeAttribute('readonly');">
        </div>
        <button onclick="updateAllPasswords()" class="btn-github btn-github-danger">
            <i class="fas fa-key"></i> Update Password (All)
        </button>
        </div>
    </div>

    <!-- Domain Info
    <div class="section">
        <h3>üåê Domain Info & Subdomain Utility</h3>
        
        <div class="button-row">
            <button onclick="retrieveDomains()">üîç Retrieve Domains</button>
            <button onclick="clearDomainDisplay()">üßπ Clear Display</button>
        </div>
        
        <div id="domain-display" class="data-display">
            <p>Click 'Retrieve Domains' to view domains here...</p>
        </div>
    </div> -->

    <!-- Suspended Users -->
<div class="github-card">
    <div class="github-card-header">
        <h3 class="github-card-title">
            <i class="fas fa-user-slash"></i>
            Suspended User Management
        </h3>
    </div>
        
        <div class="button-row">
        <button onclick="loadSuspendedUsers()" class="btn-github btn-github-primary">
            <i class="fas fa-search"></i> Load Suspended Users
        </button>
        <button onclick="copySuspendedUsers()" class="btn-github">
            <i class="fas fa-copy"></i> Copy Selected
        </button>
        <button onclick="refreshSuspendedUsers()" class="btn-github">
            <i class="fas fa-sync-alt"></i> Refresh Status
        </button>
        <button onclick="clearSuspendedUsers()" class="btn-github">
            <i class="fas fa-broom"></i> Clear Display
        </button>
        </div>
        
        <div id="suspended-display" class="data-display">
        <div class="status-info">
            <p><strong><i class="fas fa-user-slash"></i> Suspended User Management</strong></p>
            <p>Click "Load Suspended Users" to check for suspended accounts in your Google Workspace.</p>
            <p><small>This will show all users with suspended status, including their names, emails, and admin privileges.</small></p>
        </div>
    </div>
</div>
</div>

<!-- Tab 2: User Create/Delete/Domain -->
<div id="tab2" class="tab-content">
    
    <!-- Create Single User -->
    <div class="github-card">
        <div class="github-card-header">
            <h3 class="github-card-title">
                <i class="fas fa-user-plus"></i>
                Create Single User
            </h3>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
            <div class="form-group-github">
                <label for="new-user-first-name" class="form-label-github">
                    <i class="fas fa-user"></i> First Name
                </label>
                <input type="text" id="new-user-first-name" class="form-control-github" placeholder="Enter first name">
        </div>
            <div class="form-group-github">
                <label for="new-user-last-name" class="form-label-github">
                    <i class="fas fa-user"></i> Last Name
                </label>
                <input type="text" id="new-user-last-name" class="form-control-github" placeholder="Enter last name">
            </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
            <div class="form-group-github">
                <label for="new-user-email" class="form-label-github">
                    <i class="fas fa-envelope"></i> Email Address
                </label>
                <input type="email" id="new-user-email" class="form-control-github" placeholder="user@domain.com">
            </div>
            <div class="form-group-github">
                <label for="new-user-password" class="form-label-github">
                    <i class="fas fa-lock"></i> Password
                </label>
                <input type="password" id="new-user-password" class="form-control-github" placeholder="Enter password">
            </div>
        </div>
        <button onclick="createSingleUser()" class="btn-github btn-github-primary">
            <i class="fas fa-plus"></i> Create User
        </button>
    </div>

    <!-- Domain Management -->
    <div class="github-card">
        <div class="github-card-header">
            <h3 class="github-card-title">
                <i class="fas fa-globe"></i>
                Domain Management
            </h3>
        </div>
        <div class="button-row">
            <button onclick="getDomainInfo()" class="btn-github btn-github-primary">
                <i class="fas fa-search"></i> Retrieve Domains
            </button>
        </div>
        <div id="domain-info-display" class="data-display">
            <div class="status-info">
                <p><strong><i class="fas fa-globe"></i> Domain Information</strong></p>
                <p>Click "Retrieve Domains" to view domains here...</p>
        </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr auto; gap: 16px; align-items: end; margin-top: 16px;">
            <div class="form-group-github">
                <label for="new-domain-alias" class="form-label-github">
                    <i class="fas fa-plus"></i> New Domain Alias
                </label>
                <input type="text" id="new-domain-alias" class="form-control-github" placeholder="Enter new domain alias">
            </div>
            <button onclick="addDomainAlias()" class="btn-github btn-github-primary">
                <i class="fas fa-plus"></i> Add Domain Alias
            </button>
        </div>
    </div>

    <!-- Create Users from CSV File -->
    <div class="github-card">
        <div class="github-card-header">
            <h3 class="github-card-title">
                <i class="fas fa-file-csv"></i>
                Create Users from CSV File
            </h3>
        </div>
        <div style="display: grid; grid-template-columns: 1fr auto; gap: 16px; align-items: end;">
            <div class="form-group-github">
                <label for="csv-file-input" class="form-label-github">
                    <i class="fas fa-file-upload"></i> Select CSV File
                </label>
                <input type="file" id="csv-file-input" class="form-control-github" accept=".csv">
            </div>
            <button onclick="createUsersFromCSV()" class="btn-github btn-github-primary">
                <i class="fas fa-upload"></i> Create Users from CSV
            </button>
        </div>
    </div>

    <!-- Create Random Users -->
    <div class="github-card">
        <div class="github-card-header">
            <h3 class="github-card-title">
                <i class="fas fa-random"></i>
                Create Random Users
            </h3>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 16px; align-items: end;">
            <div class="form-group-github">
                <label for="random-user-count" class="form-label-github">
                    <i class="fas fa-hashtag"></i> Number of Users
                </label>
                <input type="number" id="random-user-count" class="form-control-github" min="1" max="100" placeholder="e.g., 10">
            </div>
            <div class="form-group-github">
                <label for="random-user-domain" class="form-label-github">
                    <i class="fas fa-globe"></i> Domain
                </label>
                <input type="text" id="random-user-domain" class="form-control-github" placeholder="example.com">
            </div>
            <button onclick="createRandomUsers()" class="btn-github btn-github-primary">
                <i class="fas fa-random"></i> Create Random Users
            </button>
        </div>
    </div>

    <!-- Change Domain for Specific Users -->
    <div class="github-card">
        <div class="github-card-header">
            <h3 class="github-card-title">
                <i class="fas fa-exchange-alt"></i>
                Change Domain for Specific Users
            </h3>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
            <div class="form-group-github">
                <label for="old-domain" class="form-label-github">
                    <i class="fas fa-globe"></i> Current Domain
                </label>
                <input type="text" id="old-domain" class="form-control-github" placeholder="old.com">
            </div>
            <div class="form-group-github">
                <label for="new-domain" class="form-label-github">
                    <i class="fas fa-globe"></i> New Domain
                </label>
                <input type="text" id="new-domain" class="form-control-github" placeholder="new.com">
            </div>
        </div>
        <div class="form-group-github" style="margin-bottom: 20px;">
            <label for="domain-change-emails" class="form-label-github">
                <i class="fas fa-envelope"></i> Email Addresses (one per line)
            </label>
            <textarea id="domain-change-emails" class="form-control-github" rows="4" placeholder="user1@old.com&#10;user2@old.com&#10;user3@old.com"></textarea>
        </div>
        <button onclick="changeDomainForUsers()" class="btn-github btn-github-primary">
            <i class="fas fa-exchange-alt"></i> Change Domain for These Users
        </button>
    </div>

    <!-- Delete Specific Users -->
    <div class="github-card">
        <div class="github-card-header">
            <h3 class="github-card-title">
                <i class="fas fa-user-times"></i>
                Delete Specific Users
            </h3>
        </div>
        <div class="form-group-github" style="margin-bottom: 20px;">
            <label for="delete-user-emails" class="form-label-github">
                <i class="fas fa-envelope"></i> Email Addresses to Delete (one per line)
            </label>
            <textarea id="delete-user-emails" class="form-control-github" rows="4" placeholder="user1@domain.com&#10;user2@domain.com&#10;user3@domain.com"></textarea>
        </div>
        <button onclick="deleteSpecificUsers()" class="btn-github btn-github-danger">
            <i class="fas fa-trash"></i> Delete These Users
        </button>
    </div>

    <!-- Results Log -->
    <div class="github-card">
        <div class="github-card-header">
            <h3 class="github-card-title">
                <i class="fas fa-file-alt"></i>
                Results Log
            </h3>
        </div>
        <div style="display: flex; gap: 12px; margin-bottom: 16px;">
            <button onclick="clearResultsLog()" class="btn-github">
                <i class="fas fa-broom"></i> Clear Log
            </button>
            <button onclick="copyResultsLog()" class="btn-github">
                <i class="fas fa-copy"></i> Copy Log
            </button>
        </div>
        <div id="results-log" class="data-display" style="font-family: monospace; font-size: 13px;"></div>
    </div>
</div>

<!-- Tab 3: Advanced SMTP Account Tester -->
<div id="tab3" class="tab-content">
    <!-- SMTP Provider Configuration -->
    <div class="github-card">
        <div class="github-card-header">
            <h3 class="github-card-title">
                <i class="fas fa-server"></i>
                SMTP Provider Configuration
            </h3>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
            <div class="form-group-github">
                <label for="smtp-provider-select-tab3" class="form-label-github">
                    <i class="fas fa-network-wired"></i> SMTP Provider
                </label>
                <select id="smtp-provider-select-tab3" class="form-control-github" onchange="updateSMTPSettingsTab3()">
                    <option value="gmail" selected>Gmail (smtp.gmail.com:587)</option>
                    <option value="outlook">Outlook/Hotmail (smtp-mail.outlook.com:587)</option>
                    <option value="yahoo">Yahoo (smtp.mail.yahoo.com:587)</option>
                    <option value="icloud">iCloud (smtp.mail.me.com:587)</option>
                    <option value="zoho">Zoho (smtp.zoho.com:587)</option>
                    <option value="protonmail">ProtonMail (smtp.protonmail.com:587)</option>
                    <option value="custom">Custom SMTP Server</option>
                </select>
            </div>
            <div class="form-group-github">
                <label for="smtp-security-mode-tab3" class="form-label-github">
                    <i class="fas fa-shield-alt"></i> Security Mode
                </label>
                <select id="smtp-security-mode-tab3" class="form-control-github">
                    <option value="tls" selected>STARTTLS (Recommended)</option>
                    <option value="ssl">SSL/TLS</option>
                    <option value="none">None (Not Recommended)</option>
                </select>
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 16px; margin-bottom: 16px;">
            <div class="form-group-github">
                <label for="smtp-server-advanced-tab3" class="form-label-github">
                    <i class="fas fa-server"></i> SMTP Server
                </label>
                <input type="text" id="smtp-server-advanced-tab3" class="form-control-github" value="smtp.gmail.com" placeholder="SMTP Server Address">
            </div>
            <div class="form-group-github">
                <label for="smtp-port-advanced-tab3" class="form-label-github">
                    <i class="fas fa-plug"></i> Port
                </label>
                <input type="number" id="smtp-port-advanced-tab3" class="form-control-github" value="587" placeholder="Port">
            </div>
            <div class="form-group-github">
                <label for="smtp-timeout-tab3" class="form-label-github">
                    <i class="fas fa-clock"></i> Timeout (sec)
                </label>
                <input type="number" id="smtp-timeout-tab3" class="form-control-github" value="30" min="5" max="120">
            </div>
        </div>
    </div>

    <!-- Account Credentials Management -->
    <div class="github-card">
        <div class="github-card-header">
            <h3 class="github-card-title">
                <i class="fas fa-key"></i>
                SMTP Account Credentials
            </h3>
        </div>
        
        <div class="form-group-github" style="margin-bottom: 16px;">
            <label for="smtp-accounts-list-tab3" class="form-label-github">
                <i class="fas fa-list"></i> SMTP Accounts (email:password or email:app_password, one per line)
            </label>
            <textarea id="smtp-accounts-list-tab3" class="form-control-github" rows="4" 
                placeholder="user1@gmail.com:app_password_here&#10;user2@outlook.com:regular_password&#10;user3@yahoo.com:app_specific_password&#10;&#10;For Gmail: Use App Passwords (not regular password)&#10;For Outlook: Use regular password or App Password&#10;For Yahoo: Use App Password if 2FA enabled"></textarea>
        </div>
        
        <div style="display: flex; gap: 12px; margin-bottom: 16px;">
            <button onclick="validateAccountFormatTab3()" class="btn-github">
                <i class="fas fa-check-circle"></i> Validate Format
            </button>
            <button onclick="saveAccountsToLocalTab3()" class="btn-github">
                <i class="fas fa-save"></i> Save to Browser
            </button>
            <button onclick="loadAccountsFromLocalTab3()" class="btn-github">
                <i class="fas fa-upload"></i> Load Saved
            </button>
            <button onclick="clearSavedAccountsTab3()" class="btn-github" style="background-color: var(--color-warning-emphasis); border-color: var(--color-warning-emphasis); color: #ffffff;">
                <i class="fas fa-trash"></i> Clear Saved
            </button>
        </div>
        
        <div id="account-validation-results-tab3" class="data-display" style="min-height: 60px; font-size: 13px;">
            <div class="status-info">
                <p><strong><i class="fas fa-info-circle"></i> Account Validation</strong></p>
                <p>Enter accounts above and click 'Validate Format' to check syntax</p>
            </div>
        </div>
    </div>

    <!-- Recipient Management -->
    <div class="github-card">
        <div class="github-card-header">
            <h3 class="github-card-title">
                <i class="fas fa-address-book"></i>
                Recipient Management
            </h3>
        </div>
        
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 16px; margin-bottom: 16px;">
            <div class="form-group-github">
                <label for="test-recipients-tab3" class="form-label-github">
                    <i class="fas fa-envelope-open"></i> Test Recipients (one per line)
                </label>
                <textarea id="test-recipients-tab3" class="form-control-github" rows="3" 
                    placeholder="test1@example.com&#10;test2@example.com&#10;admin@yourdomain.com"></textarea>
            </div>
            <div class="form-group-github">
                <label class="form-label-github">
                    <i class="fas fa-list-ul"></i> Saved Recipients
                </label>
                <select id="saved-recipients-select-tab3" class="form-control-github" size="4" multiple>
                    <!-- Saved recipients will appear here -->
                </select>
            </div>
        </div>
        
        <div style="display: flex; gap: 12px; margin-bottom: 16px;">
            <button onclick="addCurrentRecipientsTab3()" class="btn-github btn-github-primary">
                <i class="fas fa-plus"></i> Add to Saved
            </button>
            <button onclick="loadSelectedRecipientsTab3()" class="btn-github">
                <i class="fas fa-arrow-left"></i> Load Selected
            </button>
            <button onclick="clearRecipientsTab3()" class="btn-github">
                <i class="fas fa-eraser"></i> Clear Current
            </button>
            <button onclick="deleteSelectedSavedTab3()" class="btn-github" style="background-color: var(--color-danger-emphasis); border-color: var(--color-danger-emphasis); color: #ffffff;">
                <i class="fas fa-trash"></i> Delete Selected
            </button>
        </div>
    </div>

    <!-- Email Content Configuration -->
    <div class="github-card">
        <div class="github-card-header">
            <h3 class="github-card-title">
                <i class="fas fa-envelope-square"></i>
                Test Email Configuration
            </h3>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
            <div class="form-group-github">
                <label for="test-email-subject-tab3" class="form-label-github">
                    <i class="fas fa-tag"></i> Email Subject
                </label>
                <input type="text" id="test-email-subject-tab3" class="form-control-github" 
                    value="SMTP Test Email - {timestamp}" placeholder="Test email subject">
            </div>
            <div class="form-group-github">
                <label for="test-email-priority-tab3" class="form-label-github">
                    <i class="fas fa-exclamation-triangle"></i> Priority
                </label>
                <select id="test-email-priority-tab3" class="form-control-github">
                    <option value="normal" selected>Normal</option>
                    <option value="high">High</option>
                    <option value="low">Low</option>
                </select>
            </div>
        </div>
        
        <div class="form-group-github" style="margin-bottom: 16px;">
            <label for="test-email-body-tab3" class="form-label-github">
                <i class="fas fa-align-left"></i> Email Body Template
            </label>
            <textarea id="test-email-body-tab3" class="form-control-github" rows="5" 
                placeholder="This is a test email sent at {timestamp}&#10;&#10;SMTP Server: {server}:{port}&#10;From Account: {sender}&#10;Security: {security}&#10;&#10;If you received this email, the SMTP configuration is working correctly.&#10;&#10;Test ID: {test_id}">This is a test email sent at {timestamp}

SMTP Server: {server}:{port}
From Account: {sender}
Security: {security}

If you received this email, the SMTP configuration is working correctly.

Test ID: {test_id}</textarea>
        </div>
    </div>

    <!-- Testing Controls & Advanced Options -->
    <div class="github-card">
        <div class="github-card-header">
            <h3 class="github-card-title">
                <i class="fas fa-play-circle"></i>
                Testing Controls & Advanced Options
            </h3>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-bottom: 16px;">
            <div class="form-group-github">
                <label for="test-mode-tab3" class="form-label-github">
                    <i class="fas fa-cogs"></i> Test Mode
                </label>
                <select id="test-mode-tab3" class="form-control-github">
                    <option value="connection_only">Connection Test Only</option>
                    <option value="send_emails" selected>Full Email Send Test</option>
                    <option value="batch_test">Batch Account Test</option>
                </select>
            </div>
            <div class="form-group-github">
                <label for="test-delay-tab3" class="form-label-github">
                    <i class="fas fa-hourglass-half"></i> Delay Between Tests (ms)
                </label>
                <input type="number" id="test-delay-tab3" class="form-control-github" value="1000" min="0" max="10000">
            </div>
            <div class="form-group-github">
                <label for="max-concurrent-tab3" class="form-label-github">
                    <i class="fas fa-layer-group"></i> Max Concurrent
                </label>
                <input type="number" id="max-concurrent-tab3" class="form-control-github" value="3" min="1" max="10">
            </div>
        </div>
        
        <div style="display: flex; gap: 12px; margin-bottom: 16px;">
            <button onclick="startAdvancedSMTPTestTab3()" class="btn-github btn-github-primary" style="font-weight: 600;">
                <i class="fas fa-rocket"></i> Start SMTP Test
            </button>
            <button onclick="stopSMTPTestTab3()" class="btn-github" style="background-color: var(--color-warning-emphasis); border-color: var(--color-warning-emphasis); color: #ffffff;">
                <i class="fas fa-stop"></i> Stop Testing
            </button>
            <button onclick="testSingleAccountTab3()" class="btn-github">
                <i class="fas fa-user-check"></i> Test Single Account
            </button>
            <button onclick="exportTestResultsTab3()" class="btn-github">
                <i class="fas fa-download"></i> Export Results
            </button>
            <button onclick="clearAllTestDataTab3()" class="btn-github" style="background-color: var(--color-danger-emphasis); border-color: var(--color-danger-emphasis); color: #ffffff;">
                <i class="fas fa-broom"></i> Clear All Data
            </button>
        </div>
    </div>

    <!-- Real-time Test Status -->
    <div class="github-card">
        <div class="github-card-header">
            <h3 class="github-card-title">
                <i class="fas fa-chart-line"></i>
                Real-time Test Status
            </h3>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 16px; margin-bottom: 16px;">
            <div style="text-align: center; padding: 12px; background-color: var(--color-canvas-subtle); border-radius: 6px;">
                <div style="font-size: 24px; font-weight: bold; color: var(--color-accent-fg);" id="total-accounts-count-tab3">0</div>
                <div style="font-size: 12px; color: var(--color-fg-muted);">Total Accounts</div>
            </div>
            <div style="text-align: center; padding: 12px; background-color: var(--color-success-subtle); border-radius: 6px;">
                <div style="font-size: 24px; font-weight: bold; color: var(--color-success-fg);" id="successful-tests-count-tab3">0</div>
                <div style="font-size: 12px; color: var(--color-fg-muted);">Successful</div>
            </div>
            <div style="text-align: center; padding: 12px; background-color: var(--color-danger-subtle); border-radius: 6px;">
                <div style="font-size: 24px; font-weight: bold; color: var(--color-danger-fg);" id="failed-tests-count-tab3">0</div>
                <div style="font-size: 12px; color: var(--color-fg-muted);">Failed</div>
            </div>
            <div style="text-align: center; padding: 12px; background-color: var(--color-warning-subtle); border-radius: 6px;">
                <div style="font-size: 24px; font-weight: bold; color: var(--color-warning-fg);" id="testing-progress-tab3">0%</div>
                <div style="font-size: 12px; color: var(--color-fg-muted);">Progress</div>
            </div>
        </div>
        
        <div id="current-test-status-tab3" style="padding: 12px; background-color: var(--color-canvas-subtle); border-radius: 6px; font-family: monospace; font-size: 13px; margin-bottom: 16px; min-height: 40px;">
            <strong>Status:</strong> Ready to start testing...
        </div>
    </div>

    <!-- Comprehensive Error & Success Log -->
    <div class="github-card">
        <div class="github-card-header">
            <h3 class="github-card-title">
                <i class="fas fa-list-alt"></i>
                Comprehensive Test Results & Error Log
            </h3>
        </div>
        
        <div style="display: flex; gap: 12px; margin-bottom: 16px;">
            <button onclick="filterLogByTypeTab3('all')" class="btn-github btn-github-primary log-filter-btn-tab3" data-filter="all">
                <i class="fas fa-list"></i> All
            </button>
            <button onclick="filterLogByTypeTab3('success')" class="btn-github log-filter-btn-tab3" data-filter="success">
                <i class="fas fa-check-circle"></i> Success
            </button>
            <button onclick="filterLogByTypeTab3('error')" class="btn-github log-filter-btn-tab3" data-filter="error">
                <i class="fas fa-exclamation-triangle"></i> Errors
            </button>
            <button onclick="filterLogByTypeTab3('warning')" class="btn-github log-filter-btn-tab3" data-filter="warning">
                <i class="fas fa-exclamation-circle"></i> Warnings
            </button>
            <button onclick="filterLogByTypeTab3('info')" class="btn-github log-filter-btn-tab3" data-filter="info">
                <i class="fas fa-info-circle"></i> Info
            </button>
            <button onclick="clearTestLogTab3()" class="btn-github" style="background-color: var(--color-warning-emphasis); border-color: var(--color-warning-emphasis); color: #ffffff;">
                <i class="fas fa-eraser"></i> Clear Log
            </button>
            <label class="form-label-github" style="display: flex; align-items: center; gap: 8px; margin: 0;">
                <input type="checkbox" id="auto-scroll-log-tab3" checked> Auto-scroll
            </label>
        </div>
        
        <div id="smtp-test-log-tab3" class="data-display" 
            style="font-family: monospace; font-size: 12px; max-height: 400px; overflow-y: auto; background-color: var(--color-canvas-default); border: 1px solid var(--color-border-default);">
            <div class="status-info">
                <p><strong><i class="fas fa-terminal"></i> SMTP Test Log</strong></p>
                <p>Detailed test results and error messages will appear here...</p>
                <p><em>Tip: Use the filter buttons above to view specific types of messages</em></p>
            </div>
        </div>
    </div>

    <!-- Test Results Summary -->
    <div class="github-card">
        <div class="github-card-header">
            <h3 class="github-card-title">
                <i class="fas fa-chart-bar"></i>
                Test Results Summary
            </h3>
        </div>
        
        <div id="test-results-summary-tab3" class="data-display" style="min-height: 150px;">
            <div class="status-info">
                <p><strong><i class="fas fa-clipboard-list"></i> Test Summary</strong></p>
                <p>After running tests, a detailed summary will appear here with:</p>
                <ul style="margin: 8px 0; padding-left: 20px;">
                    <li>Working SMTP accounts</li>
                    <li>Failed accounts with error details</li>
                    <li>Performance metrics</li>
                    <li>Provider-specific recommendations</li>
                </ul>
            </div>
        </div>
    </div>
</div>
</div>

<!-- Tab 4: SMTP & CSV Generation -->
<div id="tab4" class="tab-content">
    <!-- SMTP Credential Tester -->
    <div class="github-card">
        <div class="github-card-header">
            <h3 class="github-card-title">
                <i class="fas fa-envelope"></i>
                SMTP Credential Tester
            </h3>
        </div>
        
        <div class="form-group-github" style="margin-bottom: 12px;">
            <label for="smtp-credentials" class="form-label-github">
                <i class="fas fa-key"></i> SMTP Credentials (email:password, one per line)
            </label>
            <textarea id="smtp-credentials" class="form-control-github" rows="3" placeholder="user1@gmail.com:password123&#10;user2@outlook.com:apppassword456&#10;user3@yahoo.com:secretpass789"></textarea>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 12px;">
            <div class="form-group-github">
                <label for="smtp-recipient" class="form-label-github">
                    <i class="fas fa-envelope"></i> Recipient Email
                </label>
                <input type="email" id="smtp-recipient" class="form-control-github" placeholder="test@domain.com">
            </div>
            <div class="form-group-github">
                <label for="smtp-server" class="form-label-github">
                    <i class="fas fa-server"></i> SMTP Server
                </label>
                <input type="text" id="smtp-server" class="form-control-github" value="smtp.gmail.com" placeholder="SMTP Server">
            </div>
            <div class="form-group-github">
                <label for="smtp-port" class="form-label-github">
                    <i class="fas fa-plug"></i> Port
                </label>
                <input type="number" id="smtp-port" class="form-control-github" value="587" placeholder="Port">
            </div>
        </div>
        
        <div style="display: flex; gap: 8px; margin-bottom: 12px;">
            <button onclick="testSMTPCredentials()" class="btn-github btn-github-primary">
                <i class="fas fa-paper-plane"></i> Send Test Emails
            </button>
            <button onclick="interruptSMTPTesting()" class="btn-github" style="background-color: var(--color-warning-emphasis); border-color: var(--color-warning-emphasis); color: #ffffff;">
                <i class="fas fa-stop"></i> Interrupt Sending
            </button>
            <button onclick="clearSMTPResults()" class="btn-github">
                <i class="fas fa-broom"></i> Clear Log / Reset Files
            </button>
        </div>
        
        <div>
            <h4 style="font-size: 16px; font-weight: 600; color: var(--color-fg-default); margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-chart-bar" style="color: var(--color-accent-fg);"></i>
                SMTP Test Results
            </h4>
            <div id="smtp-results-log" class="data-display" style="font-family: monospace; font-size: 13px;">
                <div class="status-info">
                    <p><strong><i class="fas fa-envelope"></i> SMTP Testing Results</strong></p>
                    <p>Test results will appear here...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Generate Sample CSV for User Creation -->
    <div class="github-card">
        <div class="github-card-header">
            <h3 class="github-card-title">
                <i class="fas fa-file-csv"></i>
                Generate Sample CSV for User Creation
            </h3>
            </div>
            
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-bottom: 20px;">
            <div class="form-group-github">
                <label for="csv-num-users" class="form-label-github">
                    <i class="fas fa-hashtag"></i> Number of Users
                </label>
                <input type="number" id="csv-num-users" class="form-control-github" min="1" max="1000" placeholder="e.g., 50">
            </div>
            <div class="form-group-github">
                <label for="csv-domain" class="form-label-github">
                    <i class="fas fa-globe"></i> Domain
                </label>
                <input type="text" id="csv-domain" class="form-control-github" placeholder="yourdomain.com">
            </div>
            <div class="form-group-github">
                <label for="csv-password" class="form-label-github">
                    <i class="fas fa-lock"></i> Default Password
                </label>
                <input type="text" id="csv-password" class="form-control-github" placeholder="Default password for all users">
            </div>
        </div>
        
        <div style="display: flex; gap: 12px; margin-bottom: 20px;">
            <button onclick="generateUserCSV()" class="btn-github btn-github-primary">
                <i class="fas fa-download"></i> Generate CSV File
            </button>
            <button onclick="previewCSV()" class="btn-github">
                <i class="fas fa-eye"></i> Preview CSV
            </button>
        </div>
        
        <div id="csv-download-area" class="data-display"></div>
        
        <div id="csv-preview-area" class="csv-preview"></div>
    </div>

    <!-- COMMENTED OUT - Email Template Generator 
    <div class="section">
        <h3>üìß Email Template Generator</h3>
        
        <div class="template-form">
            <div class="form-row">
                <input type="text" id="email-subject" placeholder="Email Subject">
            </div>
            
            <textarea id="email-body" rows="8" placeholder="Email body template...&#10;&#10;Use placeholders:&#10;{email} - User's email&#10;{password} - User's password&#10;{first_name} - User's first name&#10;{last_name} - User's last name"></textarea>
            
            <div class="button-row">
                <button onclick="generateEmailTemplate()">üìß Generate Template</button>
                <button onclick="testEmailTemplate()">üß™ Test Template</button>
            </div>
        </div>
        
        <div id="email-template-preview" class="template-preview"></div>
    </div>
    -->

</div>

<!-- Tab 5: Advanced SMTP Account Tester -->
<div id="tab5" class="tab-content">
    <!-- SMTP Provider Configuration -->
    <div class="github-card">
        <div class="github-card-header">
            <h3 class="github-card-title">
                <i class="fas fa-server"></i>
                SMTP Provider Configuration
            </h3>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
            <div class="form-group-github">
                <label for="smtp-provider-select" class="form-label-github">
                    <i class="fas fa-network-wired"></i> SMTP Provider
                </label>
                <select id="smtp-provider-select" class="form-control-github" onchange="updateSMTPSettings()">
                    <option value="gmail" selected>Gmail (smtp.gmail.com:587)</option>
                    <option value="outlook">Outlook/Hotmail (smtp-mail.outlook.com:587)</option>
                    <option value="yahoo">Yahoo (smtp.mail.yahoo.com:587)</option>
                    <option value="icloud">iCloud (smtp.mail.me.com:587)</option>
                    <option value="zoho">Zoho (smtp.zoho.com:587)</option>
                    <option value="protonmail">ProtonMail (smtp.protonmail.com:587)</option>
                    <option value="custom">Custom SMTP Server</option>
                </select>
            </div>
            <div class="form-group-github">
                <label for="smtp-security-mode" class="form-label-github">
                    <i class="fas fa-shield-alt"></i> Security Mode
                </label>
                <select id="smtp-security-mode" class="form-control-github">
                    <option value="tls" selected>STARTTLS (Recommended)</option>
                    <option value="ssl">SSL/TLS</option>
                    <option value="none">None (Not Recommended)</option>
                </select>
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 16px; margin-bottom: 16px;">
            <div class="form-group-github">
                <label for="smtp-server-advanced" class="form-label-github">
                    <i class="fas fa-server"></i> SMTP Server
                </label>
                <input type="text" id="smtp-server-advanced" class="form-control-github" value="smtp.gmail.com" placeholder="SMTP Server Address">
            </div>
            <div class="form-group-github">
                <label for="smtp-port-advanced" class="form-label-github">
                    <i class="fas fa-plug"></i> Port
                </label>
                <input type="number" id="smtp-port-advanced" class="form-control-github" value="587" placeholder="Port">
            </div>
            <div class="form-group-github">
                <label for="smtp-timeout" class="form-label-github">
                    <i class="fas fa-clock"></i> Timeout (sec)
                </label>
                <input type="number" id="smtp-timeout" class="form-control-github" value="30" min="5" max="120">
            </div>
        </div>
    </div>

    <!-- Account Credentials Management -->
    <div class="github-card">
        <div class="github-card-header">
            <h3 class="github-card-title">
                <i class="fas fa-key"></i>
                SMTP Account Credentials
            </h3>
        </div>
        
        <div class="form-group-github" style="margin-bottom: 16px;">
            <label for="smtp-accounts-list" class="form-label-github">
                <i class="fas fa-list"></i> SMTP Accounts (email:password or email:app_password, one per line)
            </label>
            <textarea id="smtp-accounts-list" class="form-control-github" rows="4" 
                placeholder="user1@gmail.com:app_password_here&#10;user2@outlook.com:regular_password&#10;user3@yahoo.com:app_specific_password&#10;&#10;For Gmail: Use App Passwords (not regular password)&#10;For Outlook: Use regular password or App Password&#10;For Yahoo: Use App Password if 2FA enabled"></textarea>
        </div>
        
        <div style="display: flex; gap: 12px; margin-bottom: 16px;">
            <button onclick="validateAccountFormat()" class="btn-github">
                <i class="fas fa-check-circle"></i> Validate Format
            </button>
            <button onclick="saveAccountsToLocal()" class="btn-github">
                <i class="fas fa-save"></i> Save to Browser
            </button>
            <button onclick="loadAccountsFromLocal()" class="btn-github">
                <i class="fas fa-upload"></i> Load Saved
            </button>
            <button onclick="clearSavedAccounts()" class="btn-github" style="background-color: var(--color-warning-emphasis); border-color: var(--color-warning-emphasis); color: #ffffff;">
                <i class="fas fa-trash"></i> Clear Saved
            </button>
        </div>
        
        <div id="account-validation-results" class="data-display" style="min-height: 60px; font-size: 13px;">
            <div class="status-info">
                <p><strong><i class="fas fa-info-circle"></i> Account Validation</strong></p>
                <p>Enter accounts above and click 'Validate Format' to check syntax</p>
            </div>
        </div>
    </div>

    <!-- Recipient Management -->
    <div class="github-card">
        <div class="github-card-header">
            <h3 class="github-card-title">
                <i class="fas fa-address-book"></i>
                Recipient Management
            </h3>
        </div>
        
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 16px; margin-bottom: 16px;">
            <div class="form-group-github">
                <label for="test-recipients" class="form-label-github">
                    <i class="fas fa-envelope-open"></i> Test Recipients (one per line)
                </label>
                <textarea id="test-recipients" class="form-control-github" rows="3" 
                    placeholder="test1@example.com&#10;test2@example.com&#10;admin@yourdomain.com"></textarea>
            </div>
            <div class="form-group-github">
                <label class="form-label-github">
                    <i class="fas fa-list-ul"></i> Saved Recipients
                </label>
                <select id="saved-recipients-select" class="form-control-github" size="4" multiple>
                    <!-- Saved recipients will appear here -->
                </select>
            </div>
        </div>
        
        <div style="display: flex; gap: 12px; margin-bottom: 16px;">
            <button onclick="addCurrentRecipients()" class="btn-github btn-github-primary">
                <i class="fas fa-plus"></i> Add to Saved
            </button>
            <button onclick="loadSelectedRecipients()" class="btn-github">
                <i class="fas fa-arrow-left"></i> Load Selected
            </button>
            <button onclick="clearRecipients()" class="btn-github">
                <i class="fas fa-eraser"></i> Clear Current
            </button>
            <button onclick="deleteSelectedSaved()" class="btn-github" style="background-color: var(--color-danger-emphasis); border-color: var(--color-danger-emphasis); color: #ffffff;">
                <i class="fas fa-trash"></i> Delete Selected
            </button>
        </div>
    </div>

    <!-- Email Content Configuration -->
    <div class="github-card">
        <div class="github-card-header">
            <h3 class="github-card-title">
                <i class="fas fa-envelope-square"></i>
                Test Email Configuration
            </h3>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
            <div class="form-group-github">
                <label for="test-email-subject" class="form-label-github">
                    <i class="fas fa-tag"></i> Email Subject
                </label>
                <input type="text" id="test-email-subject" class="form-control-github" 
                    value="SMTP Test Email - {timestamp}" placeholder="Test email subject">
            </div>
            <div class="form-group-github">
                <label for="test-email-priority" class="form-label-github">
                    <i class="fas fa-exclamation-triangle"></i> Priority
                </label>
                <select id="test-email-priority" class="form-control-github">
                    <option value="normal" selected>Normal</option>
                    <option value="high">High</option>
                    <option value="low">Low</option>
                </select>
            </div>
        </div>
        
        <div class="form-group-github" style="margin-bottom: 16px;">
            <label for="test-email-body" class="form-label-github">
                <i class="fas fa-align-left"></i> Email Body Template
            </label>
            <textarea id="test-email-body" class="form-control-github" rows="5" 
                placeholder="This is a test email sent at {timestamp}&#10;&#10;SMTP Server: {server}:{port}&#10;From Account: {sender}&#10;Security: {security}&#10;&#10;If you received this email, the SMTP configuration is working correctly.&#10;&#10;Test ID: {test_id}">This is a test email sent at {timestamp}

SMTP Server: {server}:{port}
From Account: {sender}
Security: {security}

If you received this email, the SMTP configuration is working correctly.

Test ID: {test_id}</textarea>
        </div>
    </div>

    <!-- Testing Controls & Advanced Options -->
    <div class="github-card">
        <div class="github-card-header">
            <h3 class="github-card-title">
                <i class="fas fa-play-circle"></i>
                Testing Controls & Advanced Options
            </h3>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-bottom: 16px;">
            <div class="form-group-github">
                <label for="test-mode" class="form-label-github">
                    <i class="fas fa-cogs"></i> Test Mode
                </label>
                <select id="test-mode" class="form-control-github">
                    <option value="connection_only">Connection Test Only</option>
                    <option value="send_emails" selected>Full Email Send Test</option>
                    <option value="batch_test">Batch Account Test</option>
                </select>
            </div>
            <div class="form-group-github">
                <label for="test-delay" class="form-label-github">
                    <i class="fas fa-hourglass-half"></i> Delay Between Tests (ms)
                </label>
                <input type="number" id="test-delay" class="form-control-github" value="1000" min="0" max="10000">
            </div>
            <div class="form-group-github">
                <label for="max-concurrent" class="form-label-github">
                    <i class="fas fa-layer-group"></i> Max Concurrent
                </label>
                <input type="number" id="max-concurrent" class="form-control-github" value="3" min="1" max="10">
            </div>
        </div>
        
        <div style="display: flex; gap: 12px; margin-bottom: 16px;">
            <button onclick="startAdvancedSMTPTest()" class="btn-github btn-github-primary" style="font-weight: 600;">
                <i class="fas fa-rocket"></i> Start SMTP Test
            </button>
            <button onclick="stopSMTPTest()" class="btn-github" style="background-color: var(--color-warning-emphasis); border-color: var(--color-warning-emphasis); color: #ffffff;">
                <i class="fas fa-stop"></i> Stop Testing
            </button>
            <button onclick="testSingleAccount()" class="btn-github">
                <i class="fas fa-user-check"></i> Test Single Account
            </button>
            <button onclick="exportTestResults()" class="btn-github">
                <i class="fas fa-download"></i> Export Results
            </button>
            <button onclick="clearAllTestData()" class="btn-github" style="background-color: var(--color-danger-emphasis); border-color: var(--color-danger-emphasis); color: #ffffff;">
                <i class="fas fa-broom"></i> Clear All Data
            </button>
        </div>
    </div>

    <!-- Real-time Test Status -->
    <div class="github-card">
        <div class="github-card-header">
            <h3 class="github-card-title">
                <i class="fas fa-chart-line"></i>
                Real-time Test Status
            </h3>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 16px; margin-bottom: 16px;">
            <div style="text-align: center; padding: 12px; background-color: var(--color-canvas-subtle); border-radius: 6px;">
                <div style="font-size: 24px; font-weight: bold; color: var(--color-accent-fg);" id="total-accounts-count">0</div>
                <div style="font-size: 12px; color: var(--color-fg-muted);">Total Accounts</div>
            </div>
            <div style="text-align: center; padding: 12px; background-color: var(--color-success-subtle); border-radius: 6px;">
                <div style="font-size: 24px; font-weight: bold; color: var(--color-success-fg);" id="successful-tests-count">0</div>
                <div style="font-size: 12px; color: var(--color-fg-muted);">Successful</div>
            </div>
            <div style="text-align: center; padding: 12px; background-color: var(--color-danger-subtle); border-radius: 6px;">
                <div style="font-size: 24px; font-weight: bold; color: var(--color-danger-fg);" id="failed-tests-count">0</div>
                <div style="font-size: 12px; color: var(--color-fg-muted);">Failed</div>
            </div>
            <div style="text-align: center; padding: 12px; background-color: var(--color-warning-subtle); border-radius: 6px;">
                <div style="font-size: 24px; font-weight: bold; color: var(--color-warning-fg);" id="testing-progress">0%</div>
                <div style="font-size: 12px; color: var(--color-fg-muted);">Progress</div>
            </div>
        </div>
        
        <div id="current-test-status" style="padding: 12px; background-color: var(--color-canvas-subtle); border-radius: 6px; font-family: monospace; font-size: 13px; margin-bottom: 16px; min-height: 40px;">
            <strong>Status:</strong> Ready to start testing...
        </div>
    </div>

    <!-- Comprehensive Error & Success Log -->
    <div class="github-card">
        <div class="github-card-header">
            <h3 class="github-card-title">
                <i class="fas fa-list-alt"></i>
                Comprehensive Test Results & Error Log
            </h3>
        </div>
        
        <div style="display: flex; gap: 12px; margin-bottom: 16px;">
            <button onclick="filterLogByType('all')" class="btn-github btn-github-primary log-filter-btn" data-filter="all">
                <i class="fas fa-list"></i> All
            </button>
            <button onclick="filterLogByType('success')" class="btn-github log-filter-btn" data-filter="success">
                <i class="fas fa-check-circle"></i> Success
            </button>
            <button onclick="filterLogByType('error')" class="btn-github log-filter-btn" data-filter="error">
                <i class="fas fa-exclamation-triangle"></i> Errors
            </button>
            <button onclick="filterLogByType('warning')" class="btn-github log-filter-btn" data-filter="warning">
                <i class="fas fa-exclamation-circle"></i> Warnings
            </button>
            <button onclick="filterLogByType('info')" class="btn-github log-filter-btn" data-filter="info">
                <i class="fas fa-info-circle"></i> Info
            </button>
            <button onclick="clearTestLog()" class="btn-github" style="background-color: var(--color-warning-emphasis); border-color: var(--color-warning-emphasis); color: #ffffff;">
                <i class="fas fa-eraser"></i> Clear Log
            </button>
            <label class="form-label-github" style="display: flex; align-items: center; gap: 8px; margin: 0;">
                <input type="checkbox" id="auto-scroll-log" checked> Auto-scroll
            </label>
        </div>
        
        <div id="smtp-test-log" class="data-display" 
            style="font-family: monospace; font-size: 12px; max-height: 400px; overflow-y: auto; background-color: var(--color-canvas-default); border: 1px solid var(--color-border-default);">
            <div class="status-info">
                <p><strong><i class="fas fa-terminal"></i> SMTP Test Log</strong></p>
                <p>Detailed test results and error messages will appear here...</p>
                <p><em>Tip: Use the filter buttons above to view specific types of messages</em></p>
            </div>
        </div>
    </div>

    <!-- Test Results Summary -->
    <div class="github-card">
        <div class="github-card-header">
            <h3 class="github-card-title">
                <i class="fas fa-chart-bar"></i>
                Test Results Summary
            </h3>
        </div>
        
        <div id="test-results-summary" class="data-display" style="min-height: 150px;">
            <div class="status-info">
                <p><strong><i class="fas fa-clipboard-list"></i> Test Summary</strong></p>
                <p>After running tests, a detailed summary will appear here with:</p>
                <ul style="margin: 8px 0; padding-left: 20px;">
                    <li>Working SMTP accounts</li>
                    <li>Failed accounts with error details</li>
                    <li>Performance metrics</li>
                    <li>Provider-specific recommendations</li>
                </ul>
            </div>
        </div>
    </div>
</div>
</div>

<script>
let currentAccount = null;
let isAuthenticated = false;
let selectedAccountFromList = null;
let selectedAccountId = null;
let smtpTesting = false;

// Advanced SMTP Testing Variables
let smtpTestResults = [];
let currentLogFilter = 'all';
let testCounter = 0;
let testStartTime = null;

// SMTP Provider configurations
const smtpProviders = {
    gmail: { 
        server: 'smtp.gmail.com', 
        port: 587, 
        security: 'tls',
        instructions: 'Use App Passwords for Gmail accounts with 2FA enabled'
    },
    outlook: { 
        server: 'smtp-mail.outlook.com', 
        port: 587, 
        security: 'tls',
        instructions: 'Use regular password or App Password for Outlook/Hotmail'
    },
    yahoo: { 
        server: 'smtp.mail.yahoo.com', 
        port: 587, 
        security: 'tls',
        instructions: 'Use App Password if 2FA is enabled on Yahoo'
    },
    icloud: { 
        server: 'smtp.mail.me.com', 
        port: 587, 
        security: 'tls',
        instructions: 'Use App-specific password for iCloud accounts'
    },
    zoho: { 
        server: 'smtp.zoho.com', 
        port: 587, 
        security: 'tls',
        instructions: 'Use regular password or App Password for Zoho'
    },
    protonmail: { 
        server: 'smtp.protonmail.com', 
        port: 587, 
        security: 'tls',
        instructions: 'Requires ProtonMail Bridge for SMTP access'
    }
};

// Update SMTP settings based on provider selection
function updateSMTPSettings() {
    const provider = document.getElementById('smtp-provider-select').value;
    const serverInput = document.getElementById('smtp-server-advanced');
    const portInput = document.getElementById('smtp-port-advanced');
    const securitySelect = document.getElementById('smtp-security-mode');
    
    if (provider !== 'custom' && smtpProviders[provider]) {
        const config = smtpProviders[provider];
        serverInput.value = config.server;
        portInput.value = config.port;
        securitySelect.value = config.security;
        
        // Show provider-specific instructions
        logMessage('info', `Selected ${provider.toUpperCase()}: ${config.instructions}`);
    } else if (provider === 'custom') {
        logMessage('info', 'Custom SMTP server selected. Please configure manually.');
    }
}

// Validate account format
function validateAccountFormat() {
    const accountsText = document.getElementById('smtp-accounts-list').value;
    const resultDiv = document.getElementById('account-validation-results');
    
    if (!accountsText.trim()) {
        resultDiv.innerHTML = `
            <div class="status-error">
                <p><strong><i class="fas fa-exclamation-triangle"></i> No Accounts Entered</strong></p>
                <p>Please enter SMTP accounts in the format: email:password</p>
            </div>
        `;
        return;
    }
    
    const lines = accountsText.split('\n').filter(line => line.trim());
    const validAccounts = [];
    const invalidAccounts = [];
    
    lines.forEach((line, index) => {
        const trimmed = line.trim();
        if (!trimmed) return;
        
        const parts = trimmed.split(':');
        if (parts.length >= 2) {
            const email = parts[0].trim();
            const password = parts.slice(1).join(':').trim(); // Handle passwords with colons
            
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (emailRegex.test(email) && password.length > 0) {
                validAccounts.push({ email, password, line: index + 1 });
            } else {
                invalidAccounts.push({ line: index + 1, content: trimmed, issue: 'Invalid email format or empty password' });
            }
        } else {
            invalidAccounts.push({ line: index + 1, content: trimmed, issue: 'Missing colon separator' });
        }
    });
    
    let html = `<div style="font-size: 13px;">`;
    
    if (validAccounts.length > 0) {
        html += `
            <div style="background-color: var(--color-success-subtle); padding: 8px; border-radius: 4px; margin-bottom: 8px;">
                <strong><i class="fas fa-check-circle"></i> Valid Accounts (${validAccounts.length})</strong>
                <ul style="margin: 4px 0; padding-left: 20px;">
        `;
        validAccounts.forEach(acc => {
            html += `<li>Line ${acc.line}: ${acc.email}</li>`;
        });
        html += `</ul></div>`;
    }
    
    if (invalidAccounts.length > 0) {
        html += `
            <div style="background-color: var(--color-danger-subtle); padding: 8px; border-radius: 4px;">
                <strong><i class="fas fa-exclamation-triangle"></i> Invalid Accounts (${invalidAccounts.length})</strong>
                <ul style="margin: 4px 0; padding-left: 20px;">
        `;
        invalidAccounts.forEach(acc => {
            html += `<li>Line ${acc.line}: ${acc.issue} - "${acc.content}"</li>`;
        });
        html += `</ul></div>`;
    }
    
    html += `</div>`;
    resultDiv.innerHTML = html;
    
    // Update counters
    document.getElementById('total-accounts-count').textContent = validAccounts.length;
    
    logMessage('info', `Account validation complete: ${validAccounts.length} valid, ${invalidAccounts.length} invalid`);
}

// Save accounts to local storage
function saveAccountsToLocal() {
    const accountsText = document.getElementById('smtp-accounts-list').value;
    if (!accountsText.trim()) {
        logMessage('warning', 'No accounts to save');
        return;
    }
    
    localStorage.setItem('smtp_accounts', accountsText);
    logMessage('success', 'SMTP accounts saved to browser storage');
}

// Load accounts from local storage
function loadAccountsFromLocal() {
    const savedAccounts = localStorage.getItem('smtp_accounts');
    if (savedAccounts) {
        document.getElementById('smtp-accounts-list').value = savedAccounts;
        logMessage('success', 'SMTP accounts loaded from browser storage');
        validateAccountFormat(); // Auto-validate after loading
    } else {
        logMessage('warning', 'No saved accounts found in browser storage');
    }
}

// Clear saved accounts
function clearSavedAccounts() {
    if (confirm('Are you sure you want to clear all saved SMTP accounts?')) {
        localStorage.removeItem('smtp_accounts');
        logMessage('info', 'Saved SMTP accounts cleared from browser storage');
    }
}

// Recipient management functions
function addCurrentRecipients() {
    const recipients = document.getElementById('test-recipients').value
        .split('\n')
        .map(r => r.trim())
        .filter(r => r && r.includes('@'));
    
    if (recipients.length === 0) {
        logMessage('warning', 'No valid recipients to save');
        return;
    }
    
    let savedRecipients = JSON.parse(localStorage.getItem('saved_recipients') || '[]');
    
    recipients.forEach(recipient => {
        if (!savedRecipients.includes(recipient)) {
            savedRecipients.push(recipient);
        }
    });
    
    localStorage.setItem('saved_recipients', JSON.stringify(savedRecipients));
    updateSavedRecipientsSelect();
    logMessage('success', `Added ${recipients.length} recipients to saved list`);
}

function loadSelectedRecipients() {
    const select = document.getElementById('saved-recipients-select');
    const selected = Array.from(select.selectedOptions).map(option => option.value);
    
    if (selected.length === 0) {
        logMessage('warning', 'No recipients selected to load');
        return;
    }
    
    document.getElementById('test-recipients').value = selected.join('\n');
    logMessage('success', `Loaded ${selected.length} recipients`);
}

function clearRecipients() {
    document.getElementById('test-recipients').value = '';
    logMessage('info', 'Current recipients cleared');
}

function deleteSelectedSaved() {
    const select = document.getElementById('saved-recipients-select');
    const selected = Array.from(select.selectedOptions).map(option => option.value);
    
    if (selected.length === 0) {
        logMessage('warning', 'No recipients selected to delete');
        return;
    }
    
    if (confirm(`Delete ${selected.length} saved recipients?`)) {
        let savedRecipients = JSON.parse(localStorage.getItem('saved_recipients') || '[]');
        savedRecipients = savedRecipients.filter(r => !selected.includes(r));
        localStorage.setItem('saved_recipients', JSON.stringify(savedRecipients));
        updateSavedRecipientsSelect();
        logMessage('success', `Deleted ${selected.length} saved recipients`);
    }
}

function updateSavedRecipientsSelect() {
    const select = document.getElementById('saved-recipients-select');
    const savedRecipients = JSON.parse(localStorage.getItem('saved_recipients') || '[]');
    
    select.innerHTML = '';
    savedRecipients.forEach(recipient => {
        const option = document.createElement('option');
        option.value = recipient;
        option.textContent = recipient;
        select.appendChild(option);
    });
}

// Logging functions
function logMessage(type, message, details = null) {
    const timestamp = new Date().toLocaleTimeString();
    const logDiv = document.getElementById('smtp-test-log');
    const testId = ++testCounter;
    
    let iconClass, bgClass;
    switch (type) {
        case 'success':
            iconClass = 'fas fa-check-circle';
            bgClass = 'log-success';
            break;
        case 'error':
            iconClass = 'fas fa-exclamation-triangle';
            bgClass = 'log-error';
            break;
        case 'warning':
            iconClass = 'fas fa-exclamation-circle';
            bgClass = 'log-warning';
            break;
        default:
            iconClass = 'fas fa-info-circle';
            bgClass = 'log-info';
    }
    
    const logEntry = document.createElement('div');
    logEntry.className = `log-entry ${bgClass}`;
    logEntry.setAttribute('data-type', type);
    logEntry.innerHTML = `
        <span style="color: var(--color-fg-muted); font-size: 11px;">[${timestamp}]</span>
        <i class="${iconClass}" style="margin: 0 4px;"></i>
        <strong>${type.toUpperCase()}:</strong> ${message}
        ${details ? `<div style="margin-left: 20px; font-size: 11px; margin-top: 2px;">${details}</div>` : ''}
    `;
    
    // Remove placeholder content if this is the first real log entry
    if (logDiv.querySelector('.status-info')) {
        logDiv.innerHTML = '';
    }
    
    logDiv.appendChild(logEntry);
    
    // Auto-scroll if enabled
    if (document.getElementById('auto-scroll-log').checked) {
        logDiv.scrollTop = logDiv.scrollHeight;
    }
    
    // Update status display
    updateCurrentStatus(message);
    
    // Apply current filter
    filterLogByType(currentLogFilter);
}

function updateCurrentStatus(message) {
    const statusDiv = document.getElementById('current-test-status');
    const timestamp = new Date().toLocaleTimeString();
    statusDiv.innerHTML = `<strong>Status [${timestamp}]:</strong> ${message}`;
}

function filterLogByType(type) {
    currentLogFilter = type;
    const logEntries = document.querySelectorAll('#smtp-test-log .log-entry');
    
    // Update filter button states
    document.querySelectorAll('.log-filter-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.getAttribute('data-filter') === type) {
            btn.classList.add('active');
        }
    });
    
    // Show/hide log entries
    logEntries.forEach(entry => {
        if (type === 'all' || entry.getAttribute('data-type') === type) {
            entry.style.display = 'block';
        } else {
            entry.style.display = 'none';
        }
    });
}

function clearTestLog() {
    const logDiv = document.getElementById('smtp-test-log');
    logDiv.innerHTML = `
        <div class="status-info">
            <p><strong><i class="fas fa-terminal"></i> SMTP Test Log</strong></p>
            <p>Detailed test results and error messages will appear here...</p>
            <p><em>Tip: Use the filter buttons above to view specific types of messages</em></p>
        </div>
    `;
    
    // Reset counters
    document.getElementById('successful-tests-count').textContent = '0';
    document.getElementById('failed-tests-count').textContent = '0';
    document.getElementById('testing-progress').textContent = '0%';
    
    smtpTestResults = [];
    testCounter = 0;
    
    logMessage('info', 'Test log cleared');
}

// Main SMTP testing functions
function startAdvancedSMTPTest() {
    if (smtpTesting) {
        logMessage('warning', 'SMTP testing already in progress');
        return;
    }
    
    // Validate inputs
    const accountsText = document.getElementById('smtp-accounts-list').value;
    const recipientsText = document.getElementById('test-recipients').value;
    
    if (!accountsText.trim()) {
        logMessage('error', 'No SMTP accounts provided');
        return;
    }
    
    if (!recipientsText.trim()) {
        logMessage('error', 'No test recipients provided');
        return;
    }
    
    smtpTesting = true;
    testStartTime = Date.now();
    
    // Parse accounts and recipients
    const accounts = parseAccounts(accountsText);
    const recipients = parseRecipients(recipientsText);
    
    if (accounts.length === 0) {
        logMessage('error', 'No valid SMTP accounts found');
        smtpTesting = false;
        return;
    }
    
    if (recipients.length === 0) {
        logMessage('error', 'No valid recipients found');
        smtpTesting = false;
        return;
    }
    
    logMessage('info', `Starting SMTP test with ${accounts.length} accounts and ${recipients.length} recipients`);
    
    // Reset counters
    document.getElementById('total-accounts-count').textContent = accounts.length;
    document.getElementById('successful-tests-count').textContent = '0';
    document.getElementById('failed-tests-count').textContent = '0';
    document.getElementById('testing-progress').textContent = '0%';
    
    // Start testing process
    performSMTPTests(accounts, recipients);
}

function parseAccounts(accountsText) {
    const lines = accountsText.split('\n').filter(line => line.trim());
    const accounts = [];
    
    lines.forEach(line => {
        const trimmed = line.trim();
        if (!trimmed) return;
        
        const parts = trimmed.split(':');
        if (parts.length >= 2) {
            const email = parts[0].trim();
            const password = parts.slice(1).join(':').trim();
            
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (emailRegex.test(email) && password.length > 0) {
                accounts.push({ email, password });
            }
        }
    });
    
    return accounts;
}

function parseRecipients(recipientsText) {
    return recipientsText.split('\n')
        .map(r => r.trim())
        .filter(r => r && r.includes('@'));
}

async function performSMTPTests(accounts, recipients) {
    const testMode = document.getElementById('test-mode').value;
    const delay = parseInt(document.getElementById('test-delay').value) || 1000;
    const maxConcurrent = parseInt(document.getElementById('max-concurrent').value) || 3;
    
    const emailSubject = document.getElementById('test-email-subject').value || 'SMTP Test Email';
    const emailBody = document.getElementById('test-email-body').value || 'This is a test email.';
    const emailPriority = document.getElementById('test-email-priority').value || 'normal';
    
    let completedTests = 0;
    let successfulTests = 0;
    let failedTests = 0;
    
    for (let i = 0; i < accounts.length && smtpTesting; i += maxConcurrent) {
        const batch = accounts.slice(i, i + maxConcurrent);
        const promises = batch.map(account => testSingleSMTPAccount(account, recipients, testMode, emailSubject, emailBody, emailPriority));
        
        try {
            const results = await Promise.allSettled(promises);
            
            results.forEach((result, index) => {
                completedTests++;
                const account = batch[index];
                
                if (result.status === 'fulfilled' && result.value.success) {
                    successfulTests++;
                    logMessage('success', `Account ${account.email} test completed successfully`, result.value.details);
                } else {
                    failedTests++;
                    const error = result.status === 'rejected' ? result.reason : result.value.error;
                    logMessage('error', `Account ${account.email} test failed`, error);
                }
                
                // Update progress
                const progress = Math.round((completedTests / accounts.length) * 100);
                document.getElementById('testing-progress').textContent = `${progress}%`;
                document.getElementById('successful-tests-count').textContent = successfulTests;
                document.getElementById('failed-tests-count').textContent = failedTests;
            });
            
        } catch (error) {
            logMessage('error', `Batch processing error: ${error.message}`);
        }
        
        // Delay between batches
        if (i + maxConcurrent < accounts.length && smtpTesting) {
            await new Promise(resolve => setTimeout(resolve, delay));
        }
    }
    
    if (smtpTesting) {
        const duration = ((Date.now() - testStartTime) / 1000).toFixed(1);
        logMessage('success', `SMTP testing completed in ${duration}s. Success: ${successfulTests}, Failed: ${failedTests}`);
        generateTestSummary(accounts, successfulTests, failedTests);
    }
    
    smtpTesting = false;
}

async function testSingleSMTPAccount(account, recipients, testMode, subject, body, priority) {
    const server = document.getElementById('smtp-server-advanced').value;
    const port = document.getElementById('smtp-port-advanced').value;
    const security = document.getElementById('smtp-security-mode').value;
    const timeout = document.getElementById('smtp-timeout').value;
    
    // Prepare email content with template variables
    const timestamp = new Date().toLocaleString();
    const testId = Date.now().toString(36);
    
    const processedSubject = subject
        .replace('{timestamp}', timestamp)
        .replace('{test_id}', testId)
        .replace('{sender}', account.email);
    
    const processedBody = body
        .replace('{timestamp}', timestamp)
        .replace('{server}', server)
        .replace('{port}', port)
        .replace('{sender}', account.email)
        .replace('{security}', security)
        .replace('{test_id}', testId);
    
    try {
        const response = await fetch('/api/test-smtp-advanced', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                email: account.email,
                password: account.password,
                recipients: recipients,
                server: server,
                port: parseInt(port),
                security: security,
                timeout: parseInt(timeout),
                test_mode: testMode,
                email_data: {
                    subject: processedSubject,
                    body: processedBody,
                    priority: priority
                }
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            return {
                success: true,
                details: result.message || 'Test completed successfully'
            };
        } else {
            return {
                success: false,
                error: result.error || 'Unknown error occurred'
            };
        }
        
    } catch (error) {
        return {
            success: false,
            error: `Network error: ${error.message}`
        };
    }
}

function stopSMTPTest() {
    if (smtpTesting) {
        smtpTesting = false;
        logMessage('warning', 'SMTP testing stopped by user');
        updateCurrentStatus('Testing stopped by user');
    } else {
        logMessage('info', 'No SMTP testing currently in progress');
    }
}

function testSingleAccount() {
    // Implementation for testing a single account
    logMessage('info', 'Single account test feature - coming soon');
}

function exportTestResults() {
    // Implementation for exporting test results
    logMessage('info', 'Export test results feature - coming soon');
}

function clearAllTestData() {
    if (confirm('Clear all test data including logs and saved settings?')) {
        clearTestLog();
        document.getElementById('smtp-accounts-list').value = '';
        document.getElementById('test-recipients').value = '';
        document.getElementById('account-validation-results').innerHTML = `
            <div class="status-info">
                <p><strong><i class="fas fa-info-circle"></i> Account Validation</strong></p>
                <p>Enter accounts above and click 'Validate Format' to check syntax</p>
            </div>
        `;
        logMessage('info', 'All test data cleared');
    }
}

function generateTestSummary(accounts, successful, failed) {
    const summaryDiv = document.getElementById('test-results-summary');
    const total = successful + failed;
    const successRate = total > 0 ? ((successful / total) * 100).toFixed(1) : 0;
    
    const html = `
        <div style="padding: 16px;">
            <h4 style="margin: 0 0 12px 0; color: var(--color-fg-default);">
                <i class="fas fa-chart-pie"></i> Test Results Summary
            </h4>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                <div style="text-align: center; padding: 8px; background-color: var(--color-canvas-subtle); border-radius: 4px;">
                    <div style="font-size: 20px; font-weight: bold; color: var(--color-accent-fg);">${total}</div>
                    <div style="font-size: 12px;">Total Tested</div>
                </div>
                <div style="text-align: center; padding: 8px; background-color: var(--color-success-subtle); border-radius: 4px;">
                    <div style="font-size: 20px; font-weight: bold; color: var(--color-success-fg);">${successful}</div>
                    <div style="font-size: 12px;">Successful</div>
                </div>
                <div style="text-align: center; padding: 8px; background-color: var(--color-danger-subtle); border-radius: 4px;">
                    <div style="font-size: 20px; font-weight: bold; color: var(--color-danger-fg);">${failed}</div>
                    <div style="font-size: 12px;">Failed</div>
                </div>
            </div>
            
            <div style="margin-bottom: 16px;">
                <strong>Success Rate: ${successRate}%</strong>
                <div style="background-color: var(--color-canvas-subtle); height: 8px; border-radius: 4px; margin-top: 4px;">
                    <div style="background-color: var(--color-success-emphasis); height: 100%; width: ${successRate}%; border-radius: 4px;"></div>
                </div>
            </div>
            
            <div style="font-size: 13px; line-height: 1.4;">
                <p><strong>Recommendations:</strong></p>
                <ul style="margin: 4px 0; padding-left: 20px;">
                    ${successful > 0 ? '<li style="color: var(--color-success-fg);">‚úì Working accounts can be used for email campaigns</li>' : ''}
                    ${failed > 0 ? '<li style="color: var(--color-danger-fg);">‚úó Check failed accounts for credential issues</li>' : ''}
                    <li>Save working account configurations for future use</li>
                    <li>Test periodically as provider settings may change</li>
                </ul>
            </div>
        </div>
    `;
    
    summaryDiv.innerHTML = html;
}

// Initialize the advanced SMTP tester when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Load saved recipients on page load
    updateSavedRecipientsSelect();
    updateSavedRecipientsSelectTab3();
    
    // Set Gmail as default
    updateSMTPSettings();
    updateSMTPSettingsTab3();
    
    console.log('Advanced SMTP Tester initialized');
});

// Tab 3 SMTP Testing Functions (Duplicated and Adapted)
let smtpTestingTab3 = false;
let smtpTestResultsTab3 = [];
let currentLogFilterTab3 = 'all';
let testCounterTab3 = 0;
let testStartTimeTab3 = null;

// Update SMTP settings based on provider selection for Tab 3
function updateSMTPSettingsTab3() {
    const provider = document.getElementById('smtp-provider-select-tab3').value;
    const serverInput = document.getElementById('smtp-server-advanced-tab3');
    const portInput = document.getElementById('smtp-port-advanced-tab3');
    const securitySelect = document.getElementById('smtp-security-mode-tab3');
    
    if (provider !== 'custom' && smtpProviders[provider]) {
        const config = smtpProviders[provider];
        serverInput.value = config.server;
        portInput.value = config.port;
        securitySelect.value = config.security;
        
        // Show provider-specific instructions
        logMessageTab3('info', `Selected ${provider.toUpperCase()}: ${config.instructions}`);
    } else if (provider === 'custom') {
        logMessageTab3('info', 'Custom SMTP server selected. Please configure manually.');
    }
}

// Validate account format for Tab 3
function validateAccountFormatTab3() {
    const accountsText = document.getElementById('smtp-accounts-list-tab3').value;
    const resultDiv = document.getElementById('account-validation-results-tab3');
    
    if (!accountsText.trim()) {
        resultDiv.innerHTML = `
            <div class="status-error">
                <p><strong><i class="fas fa-exclamation-triangle"></i> No Accounts Entered</strong></p>
                <p>Please enter SMTP accounts in the format: email:password</p>
            </div>
        `;
        return;
    }
    
    const lines = accountsText.split('\n').filter(line => line.trim());
    const validAccounts = [];
    const invalidAccounts = [];
    
    lines.forEach((line, index) => {
        const trimmed = line.trim();
        if (!trimmed) return;
        
        const parts = trimmed.split(':');
        if (parts.length >= 2) {
            const email = parts[0].trim();
            const password = parts.slice(1).join(':').trim();
            
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (emailRegex.test(email) && password.length > 0) {
                validAccounts.push({ email, password, line: index + 1 });
            } else {
                invalidAccounts.push({ line: index + 1, content: trimmed, issue: 'Invalid email format or empty password' });
            }
        } else {
            invalidAccounts.push({ line: index + 1, content: trimmed, issue: 'Missing colon separator' });
        }
    });
    
    let html = `<div style="font-size: 13px;">`;
    
    if (validAccounts.length > 0) {
        html += `
            <div style="background-color: var(--color-success-subtle); padding: 8px; border-radius: 4px; margin-bottom: 8px;">
                <strong><i class="fas fa-check-circle"></i> Valid Accounts (${validAccounts.length})</strong>
                <ul style="margin: 4px 0; padding-left: 20px;">
        `;
        validAccounts.forEach(acc => {
            html += `<li>Line ${acc.line}: ${acc.email}</li>`;
        });
        html += `</ul></div>`;
    }
    
    if (invalidAccounts.length > 0) {
        html += `
            <div style="background-color: var(--color-danger-subtle); padding: 8px; border-radius: 4px;">
                <strong><i class="fas fa-exclamation-triangle"></i> Invalid Accounts (${invalidAccounts.length})</strong>
                <ul style="margin: 4px 0; padding-left: 20px;">
        `;
        invalidAccounts.forEach(acc => {
            html += `<li>Line ${acc.line}: ${acc.issue} - "${acc.content}"</li>`;
        });
        html += `</ul></div>`;
    }
    
    html += `</div>`;
    resultDiv.innerHTML = html;
    
    // Update counters
    document.getElementById('total-accounts-count-tab3').textContent = validAccounts.length;
    
    logMessageTab3('info', `Account validation complete: ${validAccounts.length} valid, ${invalidAccounts.length} invalid`);
}

// Save accounts to local storage for Tab 3
function saveAccountsToLocalTab3() {
    const accountsText = document.getElementById('smtp-accounts-list-tab3').value;
    if (!accountsText.trim()) {
        logMessageTab3('warning', 'No accounts to save');
        return;
    }
    
    localStorage.setItem('smtp_accounts_tab3', accountsText);
    logMessageTab3('success', 'SMTP accounts saved to browser storage');
}

// Load accounts from local storage for Tab 3
function loadAccountsFromLocalTab3() {
    const savedAccounts = localStorage.getItem('smtp_accounts_tab3');
    if (savedAccounts) {
        document.getElementById('smtp-accounts-list-tab3').value = savedAccounts;
        logMessageTab3('success', 'SMTP accounts loaded from browser storage');
        validateAccountFormatTab3();
    } else {
        logMessageTab3('warning', 'No saved accounts found in browser storage');
    }
}

// Clear saved accounts for Tab 3
function clearSavedAccountsTab3() {
    if (confirm('Are you sure you want to clear all saved SMTP accounts?')) {
        localStorage.removeItem('smtp_accounts_tab3');
        logMessageTab3('info', 'Saved SMTP accounts cleared from browser storage');
    }
}

// Recipient management functions for Tab 3
function addCurrentRecipientsTab3() {
    const recipients = document.getElementById('test-recipients-tab3').value
        .split('\n')
        .map(r => r.trim())
        .filter(r => r && r.includes('@'));
    
    if (recipients.length === 0) {
        logMessageTab3('warning', 'No valid recipients to save');
        return;
    }
    
    let savedRecipients = JSON.parse(localStorage.getItem('saved_recipients_tab3') || '[]');
    
    recipients.forEach(recipient => {
        if (!savedRecipients.includes(recipient)) {
            savedRecipients.push(recipient);
        }
    });
    
    localStorage.setItem('saved_recipients_tab3', JSON.stringify(savedRecipients));
    updateSavedRecipientsSelectTab3();
    logMessageTab3('success', `Added ${recipients.length} recipients to saved list`);
}

function loadSelectedRecipientsTab3() {
    const select = document.getElementById('saved-recipients-select-tab3');
    const selected = Array.from(select.selectedOptions).map(option => option.value);
    
    if (selected.length === 0) {
        logMessageTab3('warning', 'No recipients selected to load');
        return;
    }
    
    document.getElementById('test-recipients-tab3').value = selected.join('\n');
    logMessageTab3('success', `Loaded ${selected.length} recipients`);
}

function clearRecipientsTab3() {
    document.getElementById('test-recipients-tab3').value = '';
    logMessageTab3('info', 'Current recipients cleared');
}

function deleteSelectedSavedTab3() {
    const select = document.getElementById('saved-recipients-select-tab3');
    const selected = Array.from(select.selectedOptions).map(option => option.value);
    
    if (selected.length === 0) {
        logMessageTab3('warning', 'No recipients selected to delete');
        return;
    }
    
    if (confirm(`Delete ${selected.length} saved recipients?`)) {
        let savedRecipients = JSON.parse(localStorage.getItem('saved_recipients_tab3') || '[]');
        savedRecipients = savedRecipients.filter(r => !selected.includes(r));
        localStorage.setItem('saved_recipients_tab3', JSON.stringify(savedRecipients));
        updateSavedRecipientsSelectTab3();
        logMessageTab3('success', `Deleted ${selected.length} saved recipients`);
    }
}

function updateSavedRecipientsSelectTab3() {
    const select = document.getElementById('saved-recipients-select-tab3');
    const savedRecipients = JSON.parse(localStorage.getItem('saved_recipients_tab3') || '[]');
    
    select.innerHTML = '';
    savedRecipients.forEach(recipient => {
        const option = document.createElement('option');
        option.value = recipient;
        option.textContent = recipient;
        select.appendChild(option);
    });
}

// Logging functions for Tab 3
function logMessageTab3(type, message, details = null) {
    const timestamp = new Date().toLocaleTimeString();
    const logDiv = document.getElementById('smtp-test-log-tab3');
    const testId = ++testCounterTab3;
    
    let iconClass, bgClass;
    switch (type) {
        case 'success':
            iconClass = 'fas fa-check-circle';
            bgClass = 'log-success';
            break;
        case 'error':
            iconClass = 'fas fa-exclamation-triangle';
            bgClass = 'log-error';
            break;
        case 'warning':
            iconClass = 'fas fa-exclamation-circle';
            bgClass = 'log-warning';
            break;
        default:
            iconClass = 'fas fa-info-circle';
            bgClass = 'log-info';
    }
    
    const logEntry = document.createElement('div');
    logEntry.className = `log-entry ${bgClass}`;
    logEntry.setAttribute('data-type', type);
    logEntry.innerHTML = `
        <span style="color: var(--color-fg-muted); font-size: 11px;">[${timestamp}]</span>
        <i class="${iconClass}" style="margin: 0 4px;"></i>
        <strong>${type.toUpperCase()}:</strong> ${message}
        ${details ? `<div style="margin-left: 20px; font-size: 11px; margin-top: 2px;">${details}</div>` : ''}
    `;
    
    // Remove placeholder content if this is the first real log entry
    if (logDiv.querySelector('.status-info')) {
        logDiv.innerHTML = '';
    }
    
    logDiv.appendChild(logEntry);
    
    // Auto-scroll if enabled
    if (document.getElementById('auto-scroll-log-tab3').checked) {
        logDiv.scrollTop = logDiv.scrollHeight;
    }
    
    // Update status display
    updateCurrentStatusTab3(message);
    
    // Apply current filter
    filterLogByTypeTab3(currentLogFilterTab3);
}

function updateCurrentStatusTab3(message) {
    const statusDiv = document.getElementById('current-test-status-tab3');
    const timestamp = new Date().toLocaleTimeString();
    statusDiv.innerHTML = `<strong>Status [${timestamp}]:</strong> ${message}`;
}

function filterLogByTypeTab3(type) {
    currentLogFilterTab3 = type;
    const logEntries = document.querySelectorAll('#smtp-test-log-tab3 .log-entry');
    
    // Update filter button states
    document.querySelectorAll('.log-filter-btn-tab3').forEach(btn => {
        btn.classList.remove('active');
        if (btn.getAttribute('data-filter') === type) {
            btn.classList.add('active');
        }
    });
    
    // Show/hide log entries
    logEntries.forEach(entry => {
        if (type === 'all' || entry.getAttribute('data-type') === type) {
            entry.style.display = 'block';
        } else {
            entry.style.display = 'none';
        }
    });
}

function clearTestLogTab3() {
    const logDiv = document.getElementById('smtp-test-log-tab3');
    logDiv.innerHTML = `
        <div class="status-info">
            <p><strong><i class="fas fa-terminal"></i> SMTP Test Log</strong></p>
            <p>Detailed test results and error messages will appear here...</p>
            <p><em>Tip: Use the filter buttons above to view specific types of messages</em></p>
        </div>
    `;
    
    // Reset counters
    document.getElementById('successful-tests-count-tab3').textContent = '0';
    document.getElementById('failed-tests-count-tab3').textContent = '0';
    document.getElementById('testing-progress-tab3').textContent = '0%';
    
    smtpTestResultsTab3 = [];
    testCounterTab3 = 0;
    
    logMessageTab3('info', 'Test log cleared');
}

// Main SMTP testing functions for Tab 3
function startAdvancedSMTPTestTab3() {
    if (smtpTestingTab3) {
        logMessageTab3('warning', 'SMTP testing already in progress');
        return;
    }
    
    // Validate inputs
    const accountsText = document.getElementById('smtp-accounts-list-tab3').value;
    const recipientsText = document.getElementById('test-recipients-tab3').value;
    
    if (!accountsText.trim()) {
        logMessageTab3('error', 'No SMTP accounts provided');
        return;
    }
    
    if (!recipientsText.trim()) {
        logMessageTab3('error', 'No test recipients provided');
        return;
    }
    
    smtpTestingTab3 = true;
    testStartTimeTab3 = Date.now();
    
    // Parse accounts and recipients
    const accounts = parseAccountsTab3(accountsText);
    const recipients = parseRecipientsTab3(recipientsText);
    
    if (accounts.length === 0) {
        logMessageTab3('error', 'No valid SMTP accounts found');
        smtpTestingTab3 = false;
        return;
    }
    
    if (recipients.length === 0) {
        logMessageTab3('error', 'No valid recipients found');
        smtpTestingTab3 = false;
        return;
    }
    
    logMessageTab3('info', `Starting SMTP test with ${accounts.length} accounts and ${recipients.length} recipients`);
    
    // Reset counters
    document.getElementById('total-accounts-count-tab3').textContent = accounts.length;
    document.getElementById('successful-tests-count-tab3').textContent = '0';
    document.getElementById('failed-tests-count-tab3').textContent = '0';
    document.getElementById('testing-progress-tab3').textContent = '0%';
    
    // Start testing process
    performSMTPTestsTab3(accounts, recipients);
}

function parseAccountsTab3(accountsText) {
    const lines = accountsText.split('\n').filter(line => line.trim());
    const accounts = [];
    
    lines.forEach(line => {
        const trimmed = line.trim();
        if (!trimmed) return;
        
        const parts = trimmed.split(':');
        if (parts.length >= 2) {
            const email = parts[0].trim();
            const password = parts.slice(1).join(':').trim();
            
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (emailRegex.test(email) && password.length > 0) {
                accounts.push({ email, password });
            }
        }
    });
    
    return accounts;
}

function parseRecipientsTab3(recipientsText) {
    return recipientsText.split('\n')
        .map(r => r.trim())
        .filter(r => r && r.includes('@'));
}

async function performSMTPTestsTab3(accounts, recipients) {
    const testMode = document.getElementById('test-mode-tab3').value;
    const delay = parseInt(document.getElementById('test-delay-tab3').value) || 1000;
    const maxConcurrent = parseInt(document.getElementById('max-concurrent-tab3').value) || 3;
    
    const emailSubject = document.getElementById('test-email-subject-tab3').value || 'SMTP Test Email';
    const emailBody = document.getElementById('test-email-body-tab3').value || 'This is a test email.';
    const emailPriority = document.getElementById('test-email-priority-tab3').value || 'normal';
    
    let completedTests = 0;
    let successfulTests = 0;
    let failedTests = 0;
    
    for (let i = 0; i < accounts.length && smtpTestingTab3; i += maxConcurrent) {
        const batch = accounts.slice(i, i + maxConcurrent);
        const promises = batch.map(account => testSingleSMTPAccountTab3(account, recipients, testMode, emailSubject, emailBody, emailPriority));
        
        try {
            const results = await Promise.allSettled(promises);
            
            results.forEach((result, index) => {
                completedTests++;
                const account = batch[index];
                
                if (result.status === 'fulfilled' && result.value.success) {
                    successfulTests++;
                    logMessageTab3('success', `Account ${account.email} test completed successfully`, result.value.details);
                } else {
                    failedTests++;
                    const error = result.status === 'rejected' ? result.reason : result.value.error;
                    logMessageTab3('error', `Account ${account.email} test failed`, error);
                }
                
                // Update progress
                const progress = Math.round((completedTests / accounts.length) * 100);
                document.getElementById('testing-progress-tab3').textContent = `${progress}%`;
                document.getElementById('successful-tests-count-tab3').textContent = successfulTests;
                document.getElementById('failed-tests-count-tab3').textContent = failedTests;
            });
            
        } catch (error) {
            logMessageTab3('error', `Batch processing error: ${error.message}`);
        }
        
        // Delay between batches
        if (i + maxConcurrent < accounts.length && smtpTestingTab3) {
            await new Promise(resolve => setTimeout(resolve, delay));
        }
    }
    
    if (smtpTestingTab3) {
        const duration = ((Date.now() - testStartTimeTab3) / 1000).toFixed(1);
        logMessageTab3('success', `SMTP testing completed in ${duration}s. Success: ${successfulTests}, Failed: ${failedTests}`);
        generateTestSummaryTab3(accounts, successfulTests, failedTests);
    }
    
    smtpTestingTab3 = false;
}

async function testSingleSMTPAccountTab3(account, recipients, testMode, subject, body, priority) {
    const server = document.getElementById('smtp-server-advanced-tab3').value;
    const port = document.getElementById('smtp-port-advanced-tab3').value;
    const security = document.getElementById('smtp-security-mode-tab3').value;
    const timeout = document.getElementById('smtp-timeout-tab3').value;
    
    // Prepare email content with template variables
    const timestamp = new Date().toLocaleString();
    const testId = Date.now().toString(36);
    
    const processedSubject = subject
        .replace('{timestamp}', timestamp)
        .replace('{test_id}', testId)
        .replace('{sender}', account.email);
    
    const processedBody = body
        .replace('{timestamp}', timestamp)
        .replace('{server}', server)
        .replace('{port}', port)
        .replace('{sender}', account.email)
        .replace('{security}', security)
        .replace('{test_id}', testId);
    
    try {
        const response = await fetch('/api/test-smtp-advanced', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                email: account.email,
                password: account.password,
                recipients: recipients,
                server: server,
                port: parseInt(port),
                security: security,
                timeout: parseInt(timeout),
                test_mode: testMode,
                email_data: {
                    subject: processedSubject,
                    body: processedBody,
                    priority: priority
                }
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            return {
                success: true,
                details: result.message || 'Test completed successfully'
            };
        } else {
            return {
                success: false,
                error: result.error || 'Unknown error occurred'
            };
        }
        
    } catch (error) {
        return {
            success: false,
            error: `Network error: ${error.message}`
        };
    }
}

function stopSMTPTestTab3() {
    if (smtpTestingTab3) {
        smtpTestingTab3 = false;
        logMessageTab3('warning', 'SMTP testing stopped by user');
        updateCurrentStatusTab3('Testing stopped by user');
    } else {
        logMessageTab3('info', 'No SMTP testing currently in progress');
    }
}

function testSingleAccountTab3() {
    logMessageTab3('info', 'Single account test feature - coming soon');
}

function exportTestResultsTab3() {
    logMessageTab3('info', 'Export test results feature - coming soon');
}

function clearAllTestDataTab3() {
    if (confirm('Clear all test data including logs and saved settings?')) {
        clearTestLogTab3();
        document.getElementById('smtp-accounts-list-tab3').value = '';
        document.getElementById('test-recipients-tab3').value = '';
        document.getElementById('account-validation-results-tab3').innerHTML = `
            <div class="status-info">
                <p><strong><i class="fas fa-info-circle"></i> Account Validation</strong></p>
                <p>Enter accounts above and click 'Validate Format' to check syntax</p>
            </div>
        `;
        logMessageTab3('info', 'All test data cleared');
    }
}

function generateTestSummaryTab3(accounts, successful, failed) {
    const summaryDiv = document.getElementById('test-results-summary-tab3');
    const total = successful + failed;
    const successRate = total > 0 ? ((successful / total) * 100).toFixed(1) : 0;
    
    const html = `
        <div style="padding: 16px;">
            <h4 style="margin: 0 0 12px 0; color: var(--color-fg-default);">
                <i class="fas fa-chart-pie"></i> Test Results Summary
            </h4>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                <div style="text-align: center; padding: 8px; background-color: var(--color-canvas-subtle); border-radius: 4px;">
                    <div style="font-size: 20px; font-weight: bold; color: var(--color-accent-fg);">${total}</div>
                    <div style="font-size: 12px;">Total Tested</div>
                </div>
                <div style="text-align: center; padding: 8px; background-color: var(--color-success-subtle); border-radius: 4px;">
                    <div style="font-size: 20px; font-weight: bold; color: var(--color-success-fg);">${successful}</div>
                    <div style="font-size: 12px;">Successful</div>
                </div>
                <div style="text-align: center; padding: 8px; background-color: var(--color-danger-subtle); border-radius: 4px;">
                    <div style="font-size: 20px; font-weight: bold; color: var(--color-danger-fg);">${failed}</div>
                    <div style="font-size: 12px;">Failed</div>
                </div>
            </div>
            
            <div style="margin-bottom: 16px;">
                <strong>Success Rate: ${successRate}%</strong>
                <div style="background-color: var(--color-canvas-subtle); height: 8px; border-radius: 4px; margin-top: 4px;">
                    <div style="background-color: var(--color-success-emphasis); height: 100%; width: ${successRate}%; border-radius: 4px;"></div>
                </div>
            </div>
            
            <div style="font-size: 13px; line-height: 1.4;">
                <p><strong>Recommendations:</strong></p>
                <ul style="margin: 4px 0; padding-left: 20px;">
                    ${successful > 0 ? '<li style="color: var(--color-success-fg);">‚úì Working accounts can be used for email campaigns</li>' : ''}
                    ${failed > 0 ? '<li style="color: var(--color-danger-fg);">‚úó Check failed accounts for credential issues</li>' : ''}
                    <li>Save working account configurations for future use</li>
                    <li>Test periodically as provider settings may change</li>
                </ul>
            </div>
        </div>
    `;
    
    summaryDiv.innerHTML = html;
}
let selectedDomain = null;

// Tab switching functionality
function showTab(tabId) {
    console.log('Switching to tab:', tabId);
    
    // Hide all tab contents
    const tabs = document.querySelectorAll('.tab-content');
    tabs.forEach(tab => {
        tab.classList.remove('active');
        tab.style.display = 'none';
    });
    
    // Remove active class from all tab buttons
    const buttons = document.querySelectorAll('.tab-button');
    buttons.forEach(button => {
        button.classList.remove('active');
        button.style.background = 'var(--color-canvas-subtle)';
        button.style.borderBottom = '1px solid var(--color-border-default)';
        button.style.color = 'var(--color-fg-muted)';
    });
    
    // Show selected tab
    const selectedTab = document.getElementById(tabId);
    if (selectedTab) {
        console.log('Found tab element:', selectedTab);
        selectedTab.classList.add('active');
        selectedTab.style.display = 'block';
        selectedTab.style.visibility = 'visible';
        selectedTab.style.opacity = '1';
        selectedTab.style.height = 'auto';
        selectedTab.style.overflow = 'visible';
        
                 // Special debug for tab4
         if (tabId === 'tab4') {
             console.log('SHOWING TAB 4 - SMTP & CSV Gen');
             console.log('Tab 4 HTML length:', selectedTab.innerHTML.length);
             
             // FORCE Tab 4 to start at top - NUCLEAR approach
             selectedTab.style.paddingTop = '0px';
             selectedTab.style.marginTop = '0px';
             selectedTab.style.position = 'relative';
             selectedTab.style.top = '0px';
             
             // Force first child to start at absolute top
             const firstChild = selectedTab.firstElementChild;
             if (firstChild) {
                 firstChild.style.marginTop = '0px';
                 firstChild.style.paddingTop = '8px'; // Minimal spacing for compact look
                 firstChild.style.position = 'relative';
                 firstChild.style.top = '0px';
                 console.log('First child forced to top:', firstChild.tagName);
             }
             
             // Scroll to top of the tab content immediately
             selectedTab.scrollIntoView({ behavior: 'instant', block: 'start' });
             window.scrollTo(0, selectedTab.offsetTop - 100);
             
             console.log('Tab 4 forced to start at top');
         }
         
         // Special handling for tab5 - Advanced SMTP Tester
         if (tabId === 'tab5') {
             console.log('SHOWING TAB 5 - Advanced SMTP Tester');
             
             // FORCE Tab 5 to start at top with compact spacing
             selectedTab.style.paddingTop = '0px';
             selectedTab.style.marginTop = '0px';
             selectedTab.style.position = 'relative';
             selectedTab.style.top = '0px';
             
             // Force first child to start at absolute top
             const firstChild = selectedTab.firstElementChild;
             if (firstChild) {
                 firstChild.style.marginTop = '0px';
                 firstChild.style.paddingTop = '8px'; // Compact spacing
                 firstChild.style.position = 'relative';
                 firstChild.style.top = '0px';
                 console.log('Tab 5 first child forced to top:', firstChild.tagName);
             }
             
             // Scroll to top of the tab content immediately
             selectedTab.scrollIntoView({ behavior: 'instant', block: 'start' });
             window.scrollTo(0, selectedTab.offsetTop - 100);
             
             console.log('Tab 5 advanced SMTP tester initialized');
         }
        
        console.log(`Successfully showing tab: ${tabId}`);
    } else {
        console.error('Tab not found:', tabId);
    }
    
    // Add active class to clicked button  
    const clickedButton = event ? event.target.closest('.tab-button') : document.querySelector(`[onclick="showTab('${tabId}')"]`);
    if (clickedButton) {
        clickedButton.classList.add('active');
        clickedButton.style.background = 'var(--color-canvas-default)';
        clickedButton.style.borderBottom = '3px solid var(--color-accent-emphasis)';
        clickedButton.style.color = 'var(--color-fg-default)';
        clickedButton.style.fontWeight = '600';
    }
}

// Initialize tabs on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing tabs...');
    
         // Check if all tabs exist
     for (let i = 1; i <= 5; i++) {
         const tab = document.getElementById(`tab${i}`);
         console.log(`Tab ${i} exists:`, !!tab);
         if (tab) {
             console.log(`Tab ${i} content length:`, tab.innerHTML.length);
         }
     }
    
    // Ensure tab1 is visible by default
    showTab('tab1');
    
    // Initialize Tab 4 properly without hiding it
    const tab4 = document.getElementById('tab4');
    if (tab4) {
        // Remove any potential conflicting CSS
        tab4.style.height = 'auto';
        tab4.style.maxHeight = 'none';
        tab4.style.overflow = 'visible';
        tab4.classList.remove('hidden');
        
        console.log('Tab 4 initialized with content length:', tab4.innerHTML.length);
        console.log('Tab 4 current classes:', tab4.className);
        console.log('Tab 4 current display:', window.getComputedStyle(tab4).display);
    }

    // Add a debug function to force tab4
    window.debugTab4 = function() {
        const tab4 = document.getElementById('tab4');
        if (tab4) {
            tab4.classList.add('active');
            tab4.style.display = 'block !important';
            tab4.style.visibility = 'visible !important';
            tab4.style.opacity = '1 !important';
            console.log('FORCED Tab 4 to be visible');
            return tab4;
        }
        return null;
    };

    // Force Tab 4 to be testable
    setTimeout(() => {
        console.log('Testing Tab 4 after timeout...');
        window.debugTab4();
    }, 2000);
});

async function loadTokenStatusWithLive() {
    try {
        console.log('=== Starting LIVE token status check ===');
        
        // Reset counters
        let totalAccounts = 0;
        let validAccounts = 0;
        let invalidAccounts = 0;
        
        // Get list of accounts first
        const accountItems = document.querySelectorAll('.account-item');
        totalAccounts = accountItems.length;
        
        // Initialize display
        updateAccountStats(totalAccounts, 0, 0, 'Checking...');
        
        // Check each account individually (LIVE UPDATES)
        for (let item of accountItems) {
            // FIX: Clean the account name - remove status symbols
            const itemCopy = item.cloneNode(true);
            const statusSpan = itemCopy.querySelector('.token-status');
            if (statusSpan) {
                statusSpan.remove();
            }
            const accountName = itemCopy.textContent.trim();
            
            try {
                // Show "checking" status
                showAccountChecking(item, accountName);
                
                // Check this specific account
                const isValid = await checkSingleAccountLive(accountName);
                
                // Update visual immediately
                updateAccountVisual(item, accountName, isValid);
                
                // Update counters
                if (isValid) {
                    validAccounts++;
                } else {
                    invalidAccounts++;
                }
                
                // Update stats in real-time
                updateAccountStats(totalAccounts, validAccounts, invalidAccounts, 'Checking...');
                
                // Update dropdown too (with clean name)
                updateDropdownOption(accountName, isValid);
                
            } catch (error) {
                console.error(`Error checking ${accountName}:`, error);
                updateAccountVisual(item, accountName, false);
                invalidAccounts++;
                updateAccountStats(totalAccounts, validAccounts, invalidAccounts, 'Checking...');
            }
        }
        
        // Final update
        updateAccountStats(totalAccounts, validAccounts, invalidAccounts, 'Complete');
        
        // Save results to cache/SFTP for persistence
        await saveTokenStatusResults();
        
        console.log(`‚úÖ Live check complete: ${validAccounts}/${totalAccounts} authenticated`);
        
    } catch (error) {
        console.error('Live token status check failed:', error);
    }
}

// Check single account status
async function checkSingleAccountLive(accountName) {
    try {
        const response = await fetch('/api/check-token-status', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({account_name: accountName})
        });
        
        const data = await response.json();
        return data.success && data.is_valid;
        
    } catch (error) {
        console.error(`Token check failed for ${accountName}:`, error);
        return false;
    }
}

// Show account being checked
function showAccountChecking(item, accountName) {
    const oldStatus = item.querySelector('.token-status');
    if (oldStatus) oldStatus.remove();
    
    const statusSpan = document.createElement('span');
    statusSpan.className = 'token-status checking';
    statusSpan.textContent = ' üîÑ';
    statusSpan.style.cssText = 'float: right; margin-left: 10px; color: orange;';
    item.appendChild(statusSpan);
}

// Update account visual status
function updateAccountVisual(item, accountName, isValid) {
    const oldStatus = item.querySelector('.token-status');
    if (oldStatus) oldStatus.remove();
    
    const statusSpan = document.createElement('span');
    statusSpan.className = isValid ? 'token-status valid' : 'token-status invalid';
    statusSpan.textContent = isValid ? ' ‚úÖ' : ' ‚ùå';
    statusSpan.style.cssText = 'float: right; margin-left: 10px;';
    item.appendChild(statusSpan);
    
    console.log(`‚úÖ Updated ${accountName}: ${isValid ? 'Valid' : 'Invalid'}`);
}

// Update dropdown option
function updateDropdownOption(accountName, isValid) {
    // Clean account name for selector (escape special characters)
    const cleanAccountName = accountName.replace(/[^a-zA-Z0-9@.\-_]/g, '');
    
    try {
        // Try to find option by value
        const option = document.querySelector(`#account-select option[value="${accountName}"]`);
        if (option) {
            option.textContent = `${accountName} ${isValid ? '‚úÖ' : '‚ùå'}`;
        } else {
            // If not found, try finding by text content
            const allOptions = document.querySelectorAll('#account-select option');
            allOptions.forEach(opt => {
                if (opt.value === accountName || opt.textContent.includes(accountName)) {
                    opt.textContent = `${accountName} ${isValid ? '‚úÖ' : '‚ùå'}`;
                }
            });
        }
    } catch (error) {
        console.error(`Error updating dropdown for ${accountName}:`, error);
    }
}

// Update stats counter in real-time
function updateAccountStats(total, valid, invalid, status) {
    const statsElement = document.getElementById('account-stats');
    if (statsElement) {
        const checked = valid + invalid;
        statsElement.innerHTML = `
            <span class="stat-item">Total: <strong>${total}</strong></span>
            <span class="stat-item">Checked: <strong>${checked}/${total}</strong></span>
            <span class="stat-item stat-valid">‚úÖ Authenticated: <strong>${valid}</strong></span>
            <span class="stat-item stat-invalid">‚ùå Need Auth: <strong>${invalid}</strong></span>
            <span class="stat-item" style="color: #007bff;">Status: <strong>${status}</strong></span>
        `;
    }
}

// Save results for persistence (survives restart)
async function saveTokenStatusResults() {
    try {
        // Collect current status with CLEAN account names
        const results = {};
        const accountItems = document.querySelectorAll('.account-item');
        
        accountItems.forEach(item => {
            // Get ONLY the account name text, exclude status symbols
            const accountNameElement = item.cloneNode(true);
            
            // Remove the status span to get clean account name
            const statusSpan = accountNameElement.querySelector('.token-status');
            if (statusSpan) {
                statusSpan.remove();
            }
            
            // Get clean account name
            const accountName = accountNameElement.textContent.trim();
            
            // Get the actual status
            const statusElement = item.querySelector('.token-status');
            
            if (statusElement && accountName) {
                const isValid = statusElement.textContent.includes('‚úÖ');
                results[accountName] = {
                    is_valid: isValid,
                    last_checked: new Date().toISOString()
                };
                
                console.log(`Clean save: "${accountName}" = ${isValid}`);
            }
        });
        
        console.log('Saving results for', Object.keys(results).length, 'accounts');
        
        // Save to server for persistence
        const response = await fetch('/api/save-token-status-cache', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({status_results: results})
        });
        
        const data = await response.json();
        console.log('Save response:', data);
        
    } catch (error) {
        console.error('Failed to save token status results:', error);
    }
}

// Load saved results on page load (for persistence)
async function loadSavedTokenStatus() {
    try {
        const response = await fetch('/api/load-token-status-cache', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        
        const data = await response.json();
        
        if (data.success && data.status) {
            console.log('Loading saved token status...');
            displaySavedTokenStatus(data.status);
            return true;
        }
        
        return false;
        
    } catch (error) {
        console.error('Failed to load saved token status:', error);
        return false;
    }
}

// Display saved status from cache
function displaySavedTokenStatus(statusData) {
    const accountItems = document.querySelectorAll('.account-item');
    let totalAccounts = accountItems.length;
    let validAccounts = 0;
    let invalidAccounts = 0;
    
    accountItems.forEach(item => {
        const accountName = item.textContent.trim();
        
        if (statusData[accountName]) {
            const isValid = statusData[accountName].is_valid;
            updateAccountVisual(item, accountName, isValid);
            updateDropdownOption(accountName, isValid);
            
            if (isValid) {
                validAccounts++;
            } else {
                invalidAccounts++;
            }
        }
    });
    
    updateAccountStats(totalAccounts, validAccounts, invalidAccounts, 'Loaded from cache');
    console.log(`Loaded cached status: ${validAccounts}/${totalAccounts} authenticated`);
}

// Main function - use database for token status
async function initializeTokenStatus() {
    console.log('Initializing token status from database...');
    await checkTokenStatusFromDatabase();
}

// Auto-refresh every 8 hours (but user can manually refresh anytime)
setInterval(checkTokenStatusFromDatabase, 8 * 60 * 60 * 1000);

// Load on page load
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(initializeTokenStatus, 1000);
    
    // Check if there's a currently authenticated account in session
    checkCurrentAuthenticationStatus();
});

// Check current authentication status from session
async function checkCurrentAuthenticationStatus() {
    try {
        const response = await fetch('/api/get-account-status', {
            method: 'GET',
            headers: {'Content-Type': 'application/json'}
        });
        
        const data = await response.json();
        
        if (data.success && data.status) {
            const { total, authenticated, need_auth } = data.status;
            
            // Update the auth status display
            if (authenticated > 0) {
                // Get the current authenticated account name
                const currentAccountName = sessionStorage.getItem('current_account_name');
                if (currentAccountName) {
                    updateAuthStatus(currentAccountName, true, `Currently authenticated (${authenticated}/${total} accounts)`);
                }
            }
            
            console.log(`Current authentication status: ${authenticated}/${total} accounts authenticated`);
        }
    } catch (error) {
        console.error('Failed to check current authentication status:', error);
    }
}


// Tab switching function
function showTab(tabId) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remove active class from all buttons
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById(tabId).classList.add('active');
    
    // Mark button as active
    event.target.classList.add('active');
    
             // Special handling for tab3 - Advanced SMTP Tester
         if (tabId === 'tab3') {
             console.log('SHOWING TAB 3 - Advanced SMTP Tester');
             
             // FORCE Tab 3 to start at top with compact spacing
             selectedTab.style.paddingTop = '0px';
             selectedTab.style.marginTop = '0px';
             selectedTab.style.position = 'relative';
             selectedTab.style.top = '0px';
             
             // Force first child to start at absolute top
             const firstChild = selectedTab.firstElementChild;
             if (firstChild) {
                 firstChild.style.marginTop = '0px';
                 firstChild.style.paddingTop = '8px'; // Compact spacing
                 firstChild.style.position = 'relative';
                 firstChild.style.top = '0px';
                 console.log('Tab 3 first child forced to top:', firstChild.tagName);
             }
             
             // Scroll to top of the tab content immediately
             selectedTab.scrollIntoView({ behavior: 'instant', block: 'start' });
             window.scrollTo(0, selectedTab.offsetTop - 100);
             
             console.log('Tab 3 advanced SMTP tester initialized');
         }
}

// Results log functions
function logResult(message) {
    const log = document.getElementById('results-log');
    const timestamp = new Date().toLocaleTimeString();
    log.textContent += `[${timestamp}] ${message}\n`;
    log.scrollTop = log.scrollHeight;
}

function clearResultsLog() {
    document.getElementById('results-log').textContent = '';
}

async function copyToClipboard(text) {
    try {
        // Try modern clipboard API first
        if (navigator.clipboard && window.isSecureContext) {
            await navigator.clipboard.writeText(text);
            return true;
        } else {
            // Fallback method for HTTP sites
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            const successful = document.execCommand('copy');
            document.body.removeChild(textArea);
            return successful;
        }
    } catch (err) {
        console.error('Copy failed:', err);
        return false;
    }
}

function enterAuthorizationCode() {
    const accountName = document.getElementById('account-select').value;
    
    if (!accountName) {
        alert('Please select an account first');
        return;
    }
    
    // Get the account ID from the selected option
    const selectedOption = document.querySelector(`#account-select option[value="${accountName}"]`);
    const accountId = selectedOption ? selectedOption.getAttribute('data-account-id') : null;
    
    if (!accountId) {
        alert('Account ID not found. Please refresh the page and try again.');
        return;
    }
    
    const authCode = prompt('Paste the authorization code from the authentication page:');
    
    if (!authCode) {
        return;
    }
    
    // Complete authentication with code
    fetch('/api/complete-oauth', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            auth_code: authCode.trim(),
            account_id: accountId,
            account_name: accountName
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ Authentication completed successfully!');
            
            // Store the authenticated account in sessionStorage for persistence
            sessionStorage.setItem('current_account_name', accountName);
            
            updateAccountStatusAfterAuth(accountName, true);
        } else {
            alert('‚ùå Authentication failed: ' + data.error);
        }
    })
    .catch(error => {
        alert('‚ùå Network error: ' + error);
    });
}

function copyResultsLog() {
    const logContent = document.getElementById('results-log').textContent;
    if (logContent.trim()) {
        copyToClipboard(logContent).then(success => {
            if (success) {
                alert('üìã Log copied to clipboard!');
            } else {
                alert('‚ùå Copy failed - please try manually selecting the text');
            }
        });
    } else {
        alert('No log content to copy');
    }
}

function updateAuthStatus(account, authenticated, message) {
    const statusBox = document.getElementById('auth-status');
    currentAccount = account;
    isAuthenticated = authenticated;
    
    if (authenticated) {
        statusBox.innerHTML = `<p style="color: green;">‚úÖ Authenticated as: ${account}</p>`;
        statusBox.className = 'status-box success';
    } else {
        statusBox.innerHTML = `<p style="color: red;">‚ùå ${message || 'Not authenticated'}</p>`;
        statusBox.className = 'status-box error';
    }
}

function authenticateAccount() {
    const select = document.getElementById('account-select');
    const accountName = select.value;
    
    if (!accountName) {
        alert('Please select an account first');
        return;
    }
    
    // Get the account ID from the selected option
    const selectedOption = select.querySelector(`option[value="${accountName}"]`);
    const accountId = selectedOption ? selectedOption.getAttribute('data-account-id') : null;
    
    if (!accountId) {
        alert('Account ID not found. Please refresh the page and try again.');
        return;
    }
    
    console.log('DEBUG: Authenticating account:', accountName, 'ID:', accountId);
    updateAuthStatus(accountName, false, 'Authenticating...');
    
    fetch('/api/authenticate', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({account_id: accountId, account_name: accountName})
    })
    .then(response => response.json())
    .then(data => {
        console.log('DEBUG: API response:', data);
        
        if (data.success) {
            updateAuthStatus(accountName, true, data.message);
            
            // Store the authenticated account in sessionStorage for persistence
            sessionStorage.setItem('current_account_name', accountName);
            
            // UPDATE THE VISUAL STATUS IMMEDIATELY
            updateAccountStatusAfterAuth(accountName, true);
            
        } else if (data.oauth_required && data.oauth_url) {
            console.log('DEBUG: OAuth URL received:', data.oauth_url);
            updateAuthStatus(accountName, false, 'OAuth URL generated - opening...');
            
            // Show OAuth modal with the URL
            showOAuthModal(data.oauth_url);
            
        } else {
            console.error('DEBUG: Authentication failed:', data.error);
            updateAuthStatus(accountName, false, data.error || 'Authentication failed');
        }
    })
    .catch(error => {
        console.error('DEBUG: Network error:', error);
        updateAuthStatus(accountName, false, 'Network error: ' + error);
    });
}

function completeOAuthWithCode() {
    const authCode = prompt('Paste the authorization code from the OAuth success page:');
    const accountName = document.getElementById('account-select').value;
    
    if (!authCode || !accountName) {
        alert('Code and account selection required');
        return;
    }
    
    fetch('/api/complete-oauth', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            auth_code: authCode.trim(),
            account_name: accountName
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ Authentication completed successfully!');
            updateAccountStatusAfterAuth(accountName, true);
        } else {
            alert('‚ùå Authentication failed: ' + data.error);
        }
    })
    .catch(error => {
        alert('‚ùå Network error: ' + error);
    });
}


// OAuth Modal functions
function showOAuthModal(authUrl) {
    const modal = document.getElementById('oauthModal');
    const urlDiv = document.getElementById('oauthUrl');
    
    urlDiv.textContent = authUrl;
    modal.style.display = 'block';
    
    // Store URL globally for copying
    window.currentOAuthUrl = authUrl;
}

function closeOAuthModal() {
    document.getElementById('oauthModal').style.display = 'none';
}

function copyOAuthUrl() {
    if (window.currentOAuthUrl) {
        copyToClipboard(window.currentOAuthUrl).then(success => {
            if (success) {
                alert('‚úÖ OAuth URL copied to clipboard!');
            } else {
                alert('‚ùå Copy failed - please select and copy manually');
            }
        });
    }
}

function openOAuthUrl() {
    if (window.currentOAuthUrl) {
        window.open(window.currentOAuthUrl, '_blank');
    }
}

// Update existing window click handler
window.onclick = function(event) {
    const modal = document.getElementById('oauthModal');
    if (event.target === modal) {
        closeOAuthModal();
    }
}

function retrieveUsers() {
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    document.getElementById('user-display').innerHTML = `
        <div class="status-info" style="background: #fff3cd; border-color: #ffeaa7;">
            <p><strong>üìä Loading Users</strong></p>
            <p>Retrieving user data from Google Admin API...</p>
            <p><small>This may take a few moments depending on the number of users.</small></p>
        </div>`;
    
    fetch('/api/retrieve-users', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Calculate status counts
            const activeUsers = data.users.filter(user => !user.suspended).length;
            const suspendedUsers = data.users.filter(user => user.suspended).length;
            const adminUsers = data.users.filter(user => user.admin).length;
            
            let html = `<div class="status-summary">
                <div class="status-item">
                    <span class="status-label">üìä Total Users:</span>
                    <span class="status-value">${data.total_count}</span>
                </div>
                <div class="status-item">
                    <span class="status-label">‚úÖ Active Users:</span>
                    <span class="status-value">${activeUsers}</span>
                </div>
                <div class="status-item">
                    <span class="status-label">üö´ Suspended Users:</span>
                    <span class="status-value">${suspendedUsers}</span>
                </div>
                <div class="status-item">
                    <span class="status-label">üëë Admin Users:</span>
                    <span class="status-value">${adminUsers}</span>
                </div>
            </div>`;
            
            data.users.forEach(user => {
                const statusBadge = user.suspended ? 
                    '<span class="badge suspended">üö´ Suspended</span>' : 
                    '<span class="badge active">‚úÖ Active</span>';
                
                html += `<div class="user-item ${user.suspended ? 'suspended-user-item' : ''}">
                    <span class="email">${user.email}</span>
                    <span class="name">${user.first_name} ${user.last_name}</span>
                    <span class="status-badges">
                    ${user.admin ? '<span class="badge admin">üëë Admin</span>' : ''}
                        ${statusBadge}
                    </span>
                </div>`;
            });
            document.getElementById('user-display').innerHTML = html;
            document.getElementById('user-count').textContent = `Total Users: ${data.total_count}`;
            
            // Auto-refresh suspended users display to show current status
            setTimeout(() => {
                loadSuspendedUsers();
            }, 500);
        } else {
            document.getElementById('user-display').innerHTML = `
                <div class="status-info" style="background: #f8d7da; border-color: #f5c6cb;">
                    <p><strong>‚ùå Error Loading Users</strong></p>
                    <p>${data.error}</p>
                    <p><small>Please try refreshing or re-authenticating your account.</small></p>
                </div>`;
        }
    })
    .catch(error => {
        document.getElementById('user-display').innerHTML = `
            <div class="status-info" style="background: #f8d7da; border-color: #f5c6cb;">
                <p><strong>‚ùå Network Error</strong></p>
                <p>Failed to connect to the server: ${error}</p>
                <p><small>Please check your connection and try again.</small></p>
            </div>`;
    });
}

function clearUserList() {
    document.getElementById('user-display').innerHTML = `
        <div class="status-info">
            <p><strong>üë• User Management</strong></p>
            <p>Click "üìä Retrieve All Users" to load and display all users from your Google Workspace.</p>
            <p><small>This will show user status (Active/Suspended), admin privileges, and provide options for bulk operations.</small></p>
        </div>`;
    document.getElementById('user-count').textContent = 'Total Users: 0';
}

function copyAllUsers() {
    const userElements = document.querySelectorAll('.user-item');
    if (userElements.length === 0) {
        alert('No users to copy');
        return;
    }
    
    const emails = Array.from(userElements).map(element => {
        const emailElement = element.querySelector('.email');
        return emailElement ? emailElement.textContent.trim() : '';
    }).filter(email => email);
    
    const emailText = emails.join('\n');
    
    copyToClipboard(emailText).then(success => {
        if (success) {
            alert(`‚úÖ Copied ${emails.length} user emails to clipboard`);
            logResult(`üìã Copied ${emails.length} user emails to clipboard`);
        } else {
            alert('‚ùå Copy failed - please try manually selecting the text');
        }
    });
}

function updateAllPasswords() {
    const password = document.getElementById('new-password').value;
    
    // Validation
    if (!password || password.length < 8) {
        alert('Password must be at least 8 characters');
        return;
    }
    
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    // Get emails from the displayed user items
    const userItems = document.querySelectorAll('.user-item .email');
    
    if (userItems.length === 0) {
        alert('No users found in the list. Please retrieve users first using "üìä Retrieve All Users" button.');
        return;
    }
    
    // Extract emails from the user display
    const userEmails = Array.from(userItems).map(item => item.textContent.trim());
    
    // Confirmation
    if (!confirm(`Update password for ALL ${userEmails.length} users?\n\nThis action cannot be undone.\n\nNew password: ${password}`)) {
        return;
    }
    
    // Show loading state
    const button = event.target;
    const originalText = button.textContent;
    button.textContent = 'üîÑ Updating Passwords...';
    button.disabled = true;
    
    // Make API request
    fetch('/api/update-all-passwords', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            password: password,
            user_emails: userEmails
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let message = data.message + '\n\n';
            
            if (data.successful_emails.length > 0) {
                message += `‚úÖ Successfully updated (${data.successful_emails.length}):\n`;
                message += data.successful_emails.slice(0, 10).join('\n');
                if (data.successful_emails.length > 10) {
                    message += `\n... and ${data.successful_emails.length - 10} more`;
                }
                message += '\n\n';
            }
            
            if (data.failed_details.length > 0) {
                message += `‚ùå Failed updates (${data.failed_details.length}):\n`;
                data.failed_details.slice(0, 5).forEach(failure => {
                    message += `${failure.email}: ${failure.error}\n`;
                });
                if (data.failed_details.length > 5) {
                    message += `... and ${data.failed_details.length - 5} more failures`;
                }
            }
            
            alert(message);
            
            // Clear password field
            document.getElementById('new-password').value = '';
            
        } else {
            alert('‚ùå Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Network error:', error);
        alert('‚ùå Network error: ' + error.message);
    })
    .finally(() => {
        // Restore button state
        button.textContent = originalText;
        button.disabled = false;
    });
}

function retrieveDomains() {
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    document.getElementById('domain-display').innerHTML = '<p>Loading domains...</p>';
    
    fetch('/api/retrieve-domains', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let html = '';
            data.domains.forEach(domain => {
                html += `<div class="domain-item">
                    <span class="domain-name">${domain.domain_name}</span>
                    <span class="user-count">${domain.user_count} users</span>
                    ${domain.verified ? '<span class="badge verified">‚úÖ Verified</span>' : '<span class="badge unverified">‚ùå Not Verified</span>'}
                </div>`;
            });
            document.getElementById('domain-display').innerHTML = html;
        } else {
            document.getElementById('domain-display').innerHTML = `<p style="color: red;">Error: ${data.error}</p>`;
        }
    })
    .catch(error => {
        document.getElementById('domain-display').innerHTML = `<p style="color: red;">Network error: ${error}</p>`;
    });
}

function clearDomainDisplay() {
    document.getElementById('domain-display').innerHTML = '<p>Click \'Retrieve Domains\' to view domains here...</p>';
}

function loadSuspendedUsers() {
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    document.getElementById('suspended-display').innerHTML = `
        <div class="status-info" style="background: #fff3cd; border-color: #ffeaa7;">
            <p><strong>üîç Loading Suspended Users</strong></p>
            <p>Retrieving user data from Google Admin API...</p>
            <p><small>This may take a few moments depending on the number of users.</small></p>
        </div>`;
    
    fetch('/api/load-suspended-users', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (data.users.length > 0) {
                let html = `<div class="status-info">
                    <p><strong>üìä Found ${data.total_count} suspended user(s):</strong></p>
                </div>`;
                
                data.users.forEach(user => {
                    const fullName = user.full_name || `${user.first_name} ${user.last_name}`.trim() || 'No Name';
                    const adminBadge = user.admin ? '<span class="badge admin">üëë Admin</span>' : '';
                    const suspendedBadge = '<span class="badge suspended">üö´ Suspended</span>';
                    
                    html += `<div class="suspended-user">
                        <div class="user-info">
                            <span class="email">${user.email}</span>
                            <span class="name">${fullName}</span>
                            ${adminBadge}
                            ${suspendedBadge}
                        </div>
                    </div>`;
                });
                
                document.getElementById('suspended-display').innerHTML = html;
            } else {
                document.getElementById('suspended-display').innerHTML = `
                    <div class="status-info">
                        <p><strong>‚úÖ No Suspended Users Found</strong></p>
                        <p>All users in this account are currently active.</p>
                    </div>`;
            }
        } else {
            document.getElementById('suspended-display').innerHTML = `
                <div class="status-info" style="background: #f8d7da; border-color: #f5c6cb;">
                    <p><strong>‚ùå Error Loading Suspended Users</strong></p>
                    <p>${data.error}</p>
                    <p><small>Please try refreshing or re-authenticating your account.</small></p>
                </div>`;
        }
    })
    .catch(error => {
        document.getElementById('suspended-display').innerHTML = `
            <div class="status-info" style="background: #f8d7da; border-color: #f5c6cb;">
                <p><strong>‚ùå Network Error</strong></p>
                <p>Failed to connect to the server: ${error}</p>
                <p><small>Please check your connection and try again.</small></p>
            </div>`;
    });
}

function copySuspendedUsers() {
    const suspendedItems = document.querySelectorAll('.suspended-user .email');
    const emails = Array.from(suspendedItems).map(item => item.textContent.trim());
    
    if (emails.length > 0) {
        copyToClipboard(emails.join('\n')).then(success => {
            if (success) {
                alert(`‚úÖ Copied ${emails.length} suspended email addresses to clipboard!`);
            } else {
                alert('‚ùå Copy failed - please try manually selecting the text');
            }
        });
    } else {
        alert('No suspended users to copy');
    }
}

function refreshSuspendedUsers() {
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    // Clear current display and reload
    document.getElementById('suspended-display').innerHTML = `
        <div class="status-info" style="background: #fff3cd; border-color: #ffeaa7;">
            <p><strong>üîÑ Refreshing Suspended Users</strong></p>
            <p>Updating user status from Google Admin API...</p>
            <p><small>Please wait while we refresh the data.</small></p>
        </div>`;
    
    // Reload after a short delay to show the refresh message
    setTimeout(() => {
        loadSuspendedUsers();
    }, 1000);
}

function clearSuspendedUsers() {
    document.getElementById('suspended-display').innerHTML = `
        <div class="status-info">
            <p><strong>‚õî Suspended User Management</strong></p>
            <p>Click "üîç Load Suspended Users" to check for suspended accounts in your Google Workspace.</p>
            <p><small>This will show all users with suspended status, including their names, emails, and admin privileges.</small></p>
        </div>`;
}

function refreshAccounts() {
    // Simply reload the page to refresh accounts from database
    location.reload();
}

// Modal functions
function openAddAccountModal() {
    document.getElementById('addAccountModal').style.display = 'block';
}

function closeAddAccountModal() {
    document.getElementById('addAccountModal').style.display = 'none';
    document.getElementById('addAccountForm').reset();
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('addAccountModal');
    if (event.target == modal) {
        closeAddAccountModal();
    }
}

// Save new account
function saveNewAccount() {
    const email = document.getElementById('new-account-email').value;
    const clientId = document.getElementById('new-client-id').value;
    const clientSecret = document.getElementById('new-client-secret').value;
    
    if (!email || !clientId || !clientSecret) {
        alert('All fields are required');
        return;
    }
    
    if (!email.includes('@')) {
        alert('Please enter a valid email address');
        return;
    }
    
    fetch('/api/add-account', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            account_name: email,
            client_id: clientId,
            client_secret: clientSecret
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ Account added successfully!');
            closeAddAccountModal();
            location.reload(); // Reload to show new account
        } else {
            alert('‚ùå Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('‚ùå Network error: ' + error);
    });
}

// Account list functions
function selectAccountFromList(accountName, accountId) {
    // Remove previous selection
    document.querySelectorAll('.account-item').forEach(item => {
        item.classList.remove('selected');
    });
    
    // Select clicked item
    event.target.classList.add('selected');
    selectedAccountFromList = accountName;
    selectedAccountId = accountId;
    
    // Also update dropdown
    document.getElementById('account-select').value = accountName;
}

function filterAccounts() {
    const searchTerm = document.getElementById('account-search').value.toLowerCase();
    const accountItems = document.querySelectorAll('.account-item');
    
    accountItems.forEach(item => {
        const accountName = item.textContent.toLowerCase();
        if (accountName.includes(searchTerm)) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
}

function authenticateFromList() {
    if (!selectedAccountFromList || !selectedAccountId) {
        alert('Please select an account from the list first');
        return;
    }
    
    // Set the dropdown to selected account and authenticate
    document.getElementById('account-select').value = selectedAccountFromList;
    
    // Call the updated authenticate function
    authenticateAccount();
}


function deleteFromList() {
    if (!selectedAccountFromList || !selectedAccountId) {
        alert('Please select an account from the list first');
        return;
    }
    
    if (!confirm(`Are you sure you want to delete account: ${selectedAccountFromList}?`)) {
        return;
    }
    
    // Delete directly using the stored account ID
    fetch('/api/delete-account', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({account_id: selectedAccountId})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ Account deleted successfully!');
            selectedAccountFromList = null;
            selectedAccountId = null;
            location.reload(); // Reload to refresh the display
        } else {
            alert('‚ùå Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Delete error:', error);
        alert('‚ùå Error: ' + error.message);
    });
}

function refreshAccountsDisplay() {
    // Simply reload the page to refresh accounts from database
            location.reload();
}

// Admin-only manual token status check
function forceTokenStatusCheck() {
    if (confirm('üîç Force token status check for all accounts?\n\nThis will check the database for current token status.')) {
        console.log('Admin triggered manual token status check');
        
        // Update status display
        updateAccountStats(0, 0, 0, 'Admin check starting...');
        
        // Use database API instead of JSON
        checkTokenStatusFromDatabase();
    }
}

// Check token status from database (replaces JSON-based approach)
async function checkTokenStatusFromDatabase() {
    try {
        console.log('=== Starting DATABASE token status check ===');
        
        // Get token status from database API
        const response = await fetch('/api/check-token-status', {
            method: 'GET',
            headers: {'Content-Type': 'application/json'}
        });
        
        const data = await response.json();
        
        if (data.success && data.token_status) {
            console.log('Database token status received:', data.token_status);
            
            // Update visual status for each account
            let totalAccounts = data.token_status.length;
            let validAccounts = 0;
            let invalidAccounts = 0;
            
            data.token_status.forEach(accountStatus => {
                const accountName = accountStatus.account_name;
                const hasTokens = accountStatus.has_tokens;
                const tokenValid = accountStatus.token_valid;
                
                // Find the account item in the UI
                const accountItems = document.querySelectorAll('.account-item');
                accountItems.forEach(item => {
                    const itemAccountName = item.textContent.trim().split('\n')[0].trim();
                    if (itemAccountName === accountName) {
                        // Remove old status
                        const oldStatus = item.querySelector('.token-status');
                        if (oldStatus) oldStatus.remove();
                        
                        // Add new status
                        const statusSpan = document.createElement('span');
                        statusSpan.className = 'token-status';
                        statusSpan.textContent = tokenValid ? ' ‚úÖ' : ' ‚ùå';
                        statusSpan.style.cssText = 'float: right; margin-left: 10px;';
                        item.appendChild(statusSpan);
                        
                        // Update dropdown
                        updateDropdownOption(accountName, tokenValid);
                        
                        // Count accounts
                        if (tokenValid) {
                            validAccounts++;
                        } else {
                            invalidAccounts++;
                        }
                    }
                });
            });
            
            // Update stats
            updateAccountStats(totalAccounts, validAccounts, invalidAccounts, 'Database check complete');
            console.log(`‚úÖ Database check complete: ${validAccounts}/${totalAccounts} authenticated`);
            
        } else {
            console.error('Failed to get token status from database:', data.error);
            updateAccountStats(0, 0, 0, 'Database check failed');
        }
        
    } catch (error) {
        console.error('Database token status check failed:', error);
        updateAccountStats(0, 0, 0, 'Database check failed');
    }
}

function updateAccountStatusAfterAuth(accountName, isAuthenticated) {
    // Update the account in the list
    const accountItems = document.querySelectorAll('.account-item');
    
    accountItems.forEach(item => {
        const itemAccountName = item.textContent.trim().split('\n')[0].trim();
        
        if (itemAccountName === accountName) {
            // Remove old status
            const oldStatus = item.querySelector('.token-status');
            if (oldStatus) oldStatus.remove();
            
            // Add new status
            const statusSpan = document.createElement('span');
            statusSpan.className = isAuthenticated ? 'token-status valid' : 'token-status invalid';
            statusSpan.textContent = isAuthenticated ? ' ‚úÖ' : ' ‚ùå';
            statusSpan.style.cssText = 'float: right; margin-left: 10px;';
            item.appendChild(statusSpan);
            
            console.log(`Updated ${accountName} status to: ${isAuthenticated ? 'Valid' : 'Invalid'}`);
        }
    });
    
    // Update dropdown
    const option = document.querySelector(`#account-select option[value="${accountName}"]`);
    if (option) {
        option.textContent = `${accountName} ${isAuthenticated ? '‚úÖ' : '‚ùå'}`;
    }
    
    // Update counter
    updateCountersAfterChange();
}

function updateCountersAfterChange() {
    const accountItems = document.querySelectorAll('.account-item');
    let totalAccounts = accountItems.length;
    let validAccounts = 0;
    let invalidAccounts = 0;
    
    accountItems.forEach(item => {
        const statusElement = item.querySelector('.token-status');
        if (statusElement) {
            if (statusElement.textContent.includes('‚úÖ')) {
                validAccounts++;
            } else {
                invalidAccounts++;
            }
        }
    });
    
    updateAccountStats(totalAccounts, validAccounts, invalidAccounts, 'Updated');
}

function addFromServerJSON() {
    // Create a modal dialog instead of simple prompt
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    `;
    
    const dialog = document.createElement('div');
    dialog.style.cssText = `
        background: white;
        padding: 30px;
        border-radius: 10px;
        width: 600px;
        max-width: 90vw;
        max-height: 80vh;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        color: #333;
    `;
    
    dialog.innerHTML = `
        <h3 style="margin-bottom: 20px; color: #007bff;">üìÅ Add Accounts from Server JSON</h3>
        
        <p style="margin-bottom: 15px; color: #666;">
            Enter Google Workspace admin email addresses below (one per line).<br>
            The system will search for corresponding JSON credential files on the server.
        </p>
        
        <div style="margin-bottom: 15px;">
            <label style="font-weight: bold; display: block; margin-bottom: 5px;">Email Addresses:</label>
            <textarea id="emailInput" placeholder="admin@domain1.com&#10;admin@domain2.com&#10;admin@domain3.com&#10;..." 
                style="width: 100%; height: 250px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-family: monospace; resize: vertical;"></textarea>
        </div>
        
        <div style="margin-bottom: 20px; padding: 10px; background: #f8f9fa; border-radius: 5px; border-left: 4px solid #007bff;">
            <strong>üí° Tips:</strong>
            <ul style="margin: 5px 0 0 20px; color: #666;">
                <li>Enter one email address per line</li>
                <li>You can paste multiple emails at once</li>
                <li>Empty lines will be ignored</li>
                <li>Files must be named exactly: <code>&lt;email&gt;.json</code></li>
            </ul>
        </div>
        
        <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button id="cancelBtn" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">
                ‚ùå Cancel
            </button>
            <button id="searchBtn" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;" disabled>
                üîç Search & Add Accounts
            </button>
        </div>
    `;
    
    modal.appendChild(dialog);
    document.body.appendChild(modal);
    
    // Get elements
    const emailInput = dialog.querySelector('#emailInput');
    const searchBtn = dialog.querySelector('#searchBtn');
    const cancelBtn = dialog.querySelector('#cancelBtn');
    
    // Update button state as user types
    function updateButtonState() {
        const text = emailInput.value.trim();
        if (!text) {
            searchBtn.disabled = true;
            return;
        }
        
        const emails = text.split('\n')
            .map(email => email.trim())
            .filter(email => email && email.includes('@'));
        
        searchBtn.disabled = emails.length === 0;
    }
    
    // Add event listeners
    emailInput.addEventListener('input', updateButtonState);
    emailInput.addEventListener('paste', () => setTimeout(updateButtonState, 10));
    
    cancelBtn.addEventListener('click', () => {
        document.body.removeChild(modal);
    });
    
    searchBtn.addEventListener('click', () => {
        const emails = emailInput.value.trim()
            .split('\n')
            .map(email => email.trim())
            .filter(email => email && email.includes('@'));
        
        if (emails.length === 0) {
            alert('No valid email addresses found');
            return;
        }
        
        // Close modal
        document.body.removeChild(modal);
        
        // Show confirmation
        if (!confirm(`Search for JSON credential files for ${emails.length} email address(es)?`)) {
            return;
        }
        
        // Process the search using server configuration
        processServerJSONSearch(emails);
    });
    
    // Close modal when clicking outside
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            document.body.removeChild(modal);
        }
    });
    
    // Focus on textarea
    setTimeout(() => emailInput.focus(), 100);
}

// Separate function to handle the actual API call using server configuration
function processServerJSONSearch(emails) {
    // Show loading in some button (you can modify this)
    const button = document.querySelector('[onclick="addFromServerJSON()"]');
    const originalText = button.textContent;
    button.textContent = 'üîç Searching...';
    button.disabled = true;
    
    // Make API request using server configuration
    fetch('/api/add-from-server-json', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({emails: emails})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let message = data.message + '\n\n';
            
            if (data.added_accounts && data.added_accounts.length > 0) {
                message += `‚úÖ Successfully added:\n${data.added_accounts.join('\n')}\n\n`;
            }
            
            if (data.failed_accounts && data.failed_accounts.length > 0) {
                message += `‚ùå Failed accounts:\n`;
                for (const failed of data.failed_accounts) {
                    message += `${failed.email}: ${failed.error}\n`;
                }
            }
            
            alert(message);
            
            // Refresh the account list if any were added
            if (data.added_accounts && data.added_accounts.length > 0) {
                refreshAccountsDisplay();
            }
        } else {
            alert('‚ùå Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Network error:', error);
        alert('‚ùå Network error: ' + error.message);
    })
    .finally(() => {
        // Restore button state
        button.textContent = originalText;
        button.disabled = false;
    });
}

function debugSFTPFiles() {
    fetch('/api/debug-sftp-files', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let message = "SFTP Directory Contents:\n\n";
            
            if (data.directories.shared_credentials) {
                if (data.directories.shared_credentials.error) {
                    message += `‚ùå shared_credentials: ${data.directories.shared_credentials.error}\n\n`;
                } else {
                    message += `üìÅ shared_credentials (${data.directories.shared_credentials.total_count} files):\n`;
                    message += data.directories.shared_credentials.files.join('\n') + '\n\n';
                }
            }
            
            if (data.directories.account) {
                if (data.directories.account.error) {
                    message += `‚ùå account: ${data.directories.account.error}\n\n`;
                } else {
                    message += `üìÅ account (${data.directories.account.total_count} files):\n`;
                    message += data.directories.account.files.join('\n');
                }
            }
            
            alert(message);
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('Network error: ' + error);
    });
}

// Placeholder functions for buttons that need implementation

function backupFiles() {
    alert('Backup Files feature coming soon!');
}

// Update the existing refreshAccounts function
function refreshAccounts() {
    refreshAccountsDisplay();
}

// Tab 2 Functions

function createUsersFromCSV() {
    const fileInput = document.getElementById('csv-file-input');
    if (!fileInput.files.length) {
        alert('Please select a CSV file first');
        return;
    }
    
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    logResult('üì• Starting CSV user creation...');
    
    const formData = new FormData();
    formData.append('csv_file', fileInput.files[0]);
    
    fetch('/api/create-users-from-csv', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            logResult(`‚úÖ CSV processing completed. Created ${data.created_count} users.`);
            if (data.results) {
                data.results.forEach(result => {
                    if (result.success) {
                        logResult(`‚úÖ Created: ${result.email}`);
                    } else {
                        logResult(`‚ùå Failed: ${result.email} - ${result.error}`);
                    }
                });
            }
        } else {
            logResult(`‚ùå CSV creation failed: ${data.error}`);
        }
    })
    .catch(error => {
        logResult(`‚ùå Network error: ${error}`);
    });
}

function createRandomUsers() {
    const count = document.getElementById('random-user-count').value;
    const domain = document.getElementById('random-user-domain').value;
    
    if (!count || count <= 0) {
        alert('Please enter a valid number of users');
        return;
    }
    
    if (!domain || !domain.includes('.')) {
        alert('Please enter a valid domain');
        return;
    }
    
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    logResult(`üé≤ Creating ${count} random users for ${domain}...`);
    
    fetch('/api/create-random-users', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            num_users: parseInt(count),
            domain: domain
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            logResult(`‚úÖ Random user creation completed. Password: ${data.password}`);
            if (data.results) {
                data.results.forEach(result => {
                    if (result.result.success) {
                        logResult(`‚úÖ Created: ${result.email}`);
                    } else {
                        logResult(`‚ùå Failed: ${result.email} - ${result.result.error}`);
                    }
                });
            }
        } else {
            logResult(`‚ùå Random user creation failed: ${data.error}`);
        }
    })
    .catch(error => {
        logResult(`‚ùå Network error: ${error}`);
    });
}

function changeDomainForUsers() {
    const oldDomain = document.getElementById('old-domain').value;
    const newDomain = document.getElementById('new-domain').value;
    const emailsText = document.getElementById('domain-change-emails').value;
    
    if (!oldDomain || !newDomain) {
        alert('Please enter both old and new domains');
        return;
    }
    
    if (!emailsText.trim()) {
        alert('Please enter email addresses');
        return;
    }
    
    const emails = emailsText.split('\n').map(e => e.trim()).filter(e => e);
    
    if (emails.length === 0) {
        alert('No valid email addresses found');
        return;
    }
    
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    logResult(`üîÑ Changing domain from ${oldDomain} to ${newDomain} for ${emails.length} users...`);
    
    fetch('/api/change-domain', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            old_domain: oldDomain,
            new_domain: newDomain,
            user_emails: emails
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            logResult(`‚úÖ Domain change completed for ${emails.length} users.`);
            if (data.results) {
                data.results.forEach(result => {
                    if (result.success) {
                        logResult(`‚úÖ Changed: ${result.old_email} ‚Üí ${result.new_email}`);
                    } else {
                        logResult(`‚ùå Failed: ${result.email} - ${result.error}`);
                    }
                });
            }
        } else {
            logResult(`‚ùå Domain change failed: ${data.error}`);
        }
    })
    .catch(error => {
        logResult(`‚ùå Network error: ${error}`);
    });
}

function deleteSpecificUsers() {
    const emailsText = document.getElementById('delete-user-emails').value;
    
    if (!emailsText.trim()) {
        alert('Please enter email addresses to delete');
        return;
    }
    
    const emails = emailsText.split('\n').map(e => e.trim()).filter(e => e);
    
    if (emails.length === 0) {
        alert('No valid email addresses found');
        return;
    }
    
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    if (!confirm(`‚ö†Ô∏è Are you sure you want to DELETE ${emails.length} users? This cannot be undone!`)) {
        return;
    }
    
    logResult(`‚ùå Deleting ${emails.length} users...`);
    
    fetch('/api/delete-users', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            user_emails: emails
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            logResult(`‚úÖ User deletion completed for ${emails.length} users.`);
            if (data.results) {
                data.results.forEach(result => {
                    if (result.result.success) {
                        logResult(`‚úÖ Deleted: ${result.email}`);
                    } else {
                        logResult(`‚ùå Failed to delete: ${result.email} - ${result.result.error}`);
                    }
                });
            }
        } else {
            logResult(`‚ùå User deletion failed: ${data.error}`);
        }
    })
    .catch(error => {
        logResult(`‚ùå Network error: ${error}`);
    });
}

function createSingleUser() {
    const firstName = document.getElementById('new-user-first-name').value;
    const lastName = document.getElementById('new-user-last-name').value;
    const email = document.getElementById('new-user-email').value;
    const password = document.getElementById('new-user-password').value;

    if (!firstName || !lastName || !email || !password) {
        alert('Please fill in all fields for the new user.');
        return;
    }

    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }

    logResult(`‚ûï Creating user: ${email}...`);

    fetch('/api/create-gsuite-user', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            first_name: firstName,
            last_name: lastName,
            email: email,
            password: password
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            logResult(`‚úÖ User ${email} created successfully.`);
        } else {
            logResult(`‚ùå Failed to create user ${email}: ${data.error}`);
        }
    })
    .catch(error => {
        logResult(`‚ùå Network error: ${error}`);
    });
}

function getDomainInfo() {
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }

    logResult('üîç Retrieving domain info...');
    const display = document.getElementById('domain-info-display');
    display.innerHTML = '<p>Loading domains...</p>';

    fetch('/api/get-domain-info')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let html = '';
            if (data.domains.length > 0) {
                data.domains.forEach(domain => {
                    html += `<div class="domain-item">
                        <span>${domain.domainName}</span>
                        <button class="delete-button" onclick="deleteDomain('${domain.domainName}')">Delete</button>
                    </div>`;
                });
            } else {
                html = '<p>No domains found.</p>';
            }
            display.innerHTML = html;
            logResult(`‚úÖ Domain info retrieved successfully.`);
        } else {
            display.innerHTML = `<p style="color: red;">Error: ${data.error}</p>`;
            logResult(`‚ùå Failed to retrieve domain info: ${data.error}`);
        }
    })
    .catch(error => {
        display.innerHTML = `<p style="color: red;">Network error: ${error}</p>`;
        logResult(`‚ùå Network error: ${error}`);
    });
}

function addDomainAlias() {
    const domainAlias = document.getElementById('new-domain-alias').value;

    if (!domainAlias) {
        alert('Please enter a domain alias.');
        return;
    }

    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }

    logResult(`‚ûï Adding domain alias: ${domainAlias}...`);

    fetch('/api/add-domain-alias', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ domain_alias: domainAlias })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            logResult(`‚úÖ Domain alias ${domainAlias} added successfully.`);
            getDomainInfo(); // Refresh the domain list
        } else {
            logResult(`‚ùå Failed to add domain alias ${domainAlias}: ${data.error}`);
        }
    })
    .catch(error => {
        logResult(`‚ùå Network error: ${error}`);
    });
}

function deleteDomain(domainName) {
    if (!confirm(`Are you sure you want to delete the domain: ${domainName}?`)) {
        return;
    }

    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }

    logResult(`‚ùå Deleting domain: ${domainName}...`);

    fetch('/api/delete-domain', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ domain_name: domainName })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            logResult(`‚úÖ Domain ${domainName} deleted successfully.`);
            getDomainInfo(); // Refresh the domain list
        } else {
            logResult(`‚ùå Failed to delete domain ${domainName}: ${data.error}`);
        }
    })
    .catch(error => {
        logResult(`‚ùå Network error: ${error}`);
    });
}


// Tab 3 Functions - Bulk Domain Change (Desktop App Style)


function downloadAllUsersCSV() {
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    logBulkDomain('üì• Starting download of all users to CSV...');
    
    fetch('/api/download-users-csv', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.csv_data) {
            // Create download
            const blob = new Blob([data.csv_data], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `all_users_${new Date().toISOString().slice(0,10)}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            // Update path display
            document.getElementById('csv-file-path').value = a.download;
            
            logBulkDomain(`‚úÖ Downloaded ${data.user_count} users to CSV: ${a.download}`);
        } else {
            logBulkDomain(`‚ùå Download failed: ${data.error}`);
            alert('Download failed: ' + data.error);
        }
    })
    .catch(error => {
        logBulkDomain(`‚ùå Network error: ${error}`);
        alert('Network error: ' + error);
    });
}

function retrieveAvailableDomains() {
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    logBulkDomain('üîç Retrieving available domains...');
    
    // Show loading state
    const domainList = document.getElementById('available-domains');
    domainList.innerHTML = '<div class="domain-loading">Retrieving domains from Google API...</div>';
    
    fetch('/api/retrieve-domains', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.domains) {
            displayAvailableDomains(data.domains);
            logBulkDomain(`‚úÖ Retrieved ${data.domains.length} available domains`);
        } else {
            logBulkDomain(`‚ùå Failed to retrieve domains: ${data.error}`);
            domainList.innerHTML = `<div class="domain-error">‚ùå Failed to retrieve domains: ${data.error}</div>`;
            alert('Failed to retrieve domains: ' + data.error);
        }
    })
    .catch(error => {
        logBulkDomain(`‚ùå Network error: ${error}`);
        domainList.innerHTML = `<div class="domain-error">‚ùå Network error: ${error}</div>`;
        alert('Network error: ' + error);
    });
}

function getDomainUsageStats() {
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    logBulkDomain('üìä Retrieving domain usage statistics for current account...');
    
    // Show loading state
    const domainList = document.getElementById('available-domains');
    domainList.innerHTML = '<div class="domain-loading">Retrieving domain usage statistics for current account...</div>';
    
    // First get fresh domain data from the authenticated account
    fetch('/api/retrieve-domains', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.domains) {
            // Display the domain data directly from the authenticated account
            displayDomainUsageStats({
                total_domains: data.domains.length,
                used_domains: data.domains.filter(d => d.is_used).length,
                available_domains: data.domains.filter(d => !d.is_used).length,
                total_users: data.domains.reduce((sum, d) => sum + (d.user_count || 0), 0),
                domains: data.domains.map(d => ({
                    domain_name: d.domain_name,
                    user_count: d.user_count || 0,
                    is_verified: d.verified || false,
                    is_used: d.is_used || false,
                    last_updated: new Date().toISOString()
                }))
            });
            logBulkDomain(`‚úÖ Retrieved domain usage statistics for current account`);
        } else {
            logBulkDomain(`‚ùå Failed to retrieve domain stats: ${data.error}`);
            domainList.innerHTML = `<div class="domain-error">‚ùå Failed to retrieve domain stats: ${data.error}</div>`;
            alert('Failed to retrieve domain stats: ' + data.error);
        }
    })
    .catch(error => {
        logBulkDomain(`‚ùå Network error: ${error}`);
        domainList.innerHTML = `<div class="domain-error">‚ùå Network error: ${error}</div>`;
        alert('Network error: ' + error);
    });
}



function clearOldDomainData() {
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    if (!confirm('‚ö†Ô∏è This will clear domain data older than 30 days. Continue?')) {
        return;
    }
    
    logBulkDomain('üóëÔ∏è Clearing old domain data...');
    
    fetch('/api/clear-old-domain-data', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            logBulkDomain(`‚úÖ ${data.message}`);
            alert(`‚úÖ ${data.message}`);
            // Refresh the display
            setTimeout(() => {
                getDomainUsageStats();
            }, 500);
        } else {
            logBulkDomain(`‚ùå Failed to clear old data: ${data.error}`);
            alert('Failed to clear old data: ' + data.error);
        }
    })
    .catch(error => {
        logBulkDomain(`‚ùå Network error: ${error}`);
        alert('Network error: ' + error);
    });
}

function debugDomainUsers() {
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    const currentDomain = document.getElementById('current-domain-suffix').value.trim();
    if (!currentDomain) {
        alert('Please enter a domain in the "Current Domain Suffix" field first');
        return;
    }
    
    logBulkDomain(`üêõ Debugging users for domain: ${currentDomain}`);
    
    fetch('/api/debug-domain-users', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({domain: currentDomain})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            logBulkDomain(`üêõ Debug Results for ${data.domain}:`);
            logBulkDomain(`   Total users found: ${data.total_users_found}`);
            logBulkDomain(`   Users with domain ${data.domain}: ${data.domain_users_found}`);
            
            if (data.domain_users && data.domain_users.length > 0) {
                logBulkDomain(`   Domain users:`);
                data.domain_users.forEach(user => {
                    logBulkDomain(`     - ${user.email} (Admin: ${user.isAdmin}, Suspended: ${user.suspended})`);
                });
            } else {
                logBulkDomain(`   ‚ùå No users found with domain ${data.domain}`);
            }
        } else {
            logBulkDomain(`‚ùå Debug failed: ${data.error}`);
            alert('Debug failed: ' + data.error);
        }
    })
    .catch(error => {
        logBulkDomain(`‚ùå Network error: ${error}`);
        alert('Network error: ' + error);
    });
}

function displayDomainUsageStats(stats) {
    const domainList = document.getElementById('available-domains');
    
    let html = `
        <div class="stats-summary" style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <h3 style="margin: 0 0 15px 0; color: #333;">üìä Domain Usage Summary</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                <div style="text-align: center; padding: 10px; background: white; border-radius: 5px;">
                    <div style="font-size: 24px; font-weight: bold; color: #2196F3;">${stats.total_domains}</div>
                    <div style="font-size: 12px; color: #666;">Total Domains</div>
                </div>
                <div style="text-align: center; padding: 10px; background: white; border-radius: 5px;">
                    <div style="font-size: 24px; font-weight: bold; color: #4CAF50;">${stats.used_domains}</div>
                    <div style="font-size: 12px; color: #666;">Used Domains</div>
                </div>
                <div style="text-align: center; padding: 10px; background: white; border-radius: 5px;">
                    <div style="font-size: 24px; font-weight: bold; color: #FF9800;">${stats.available_domains}</div>
                    <div style="font-size: 12px; color: #666;">Available Domains</div>
                </div>
                <div style="text-align: center; padding: 10px; background: white; border-radius: 5px;">
                    <div style="font-size: 24px; font-weight: bold; color: #9C27B0;">${stats.total_users}</div>
                    <div style="font-size: 12px; color: #666;">Total Users</div>
                </div>
            </div>
        </div>
    `;
    
    if (stats.domains.length === 0) {
        html += '<p class="placeholder-text">No domains found in database</p>';
    } else {
        html += '<h4 style="margin: 20px 0 10px 0; color: #333;">Domain Details:</h4>';
        html += stats.domains.map(domain => {
            const isUsed = domain.is_used;
            const domainClass = isUsed ? 'domain-item used-domain' : 'domain-item';
            const statusText = isUsed ? 'USED' : 'AVAILABLE';
            const statusColor = isUsed ? 'red' : 'green';
            
            return `<div class="${domainClass}">
                <strong style="color: ${isUsed ? 'red' : 'black'};">${domain.domain_name}</strong>
                <span style="float: right; color: #666;">${domain.user_count} users</span>
                <div style="margin-top: 5px;">
                    ${domain.is_verified ? '<span style="color: green;">‚úÖ Verified</span>' : '<span style="color: red;">‚ùå Not Verified</span>'}
                    <span style="color: ${statusColor}; margin-left: 10px; font-weight: bold;">${statusText}</span>
                </div>
                ${domain.last_updated ? `<div style="font-size: 11px; color: #999; margin-top: 3px;">Last updated: ${new Date(domain.last_updated).toLocaleString()}</div>` : ''}
            </div>`;
        }).join('');
    }
    
    domainList.innerHTML = html;
}

function displayAvailableDomains(domains) {
    const domainList = document.getElementById('available-domains');
    
    if (domains.length === 0) {
        domainList.innerHTML = '<p class="placeholder-text">No domains found</p>';
        return;
    }
    
    // Add summary at the top
    const totalDomains = domains.length;
    const usedDomains = domains.filter(d => d.is_used).length;
    const availableDomains = domains.filter(d => !d.is_used).length;
    const totalUsers = domains.reduce((sum, d) => sum + d.user_count, 0);
    
    let html = `
        <div class="stats-summary">
            <h3>üìä Domain Summary</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
                <div style="text-align: center; padding: 8px; background: white; border-radius: 5px;">
                    <div style="font-size: 20px; font-weight: bold; color: #2196F3;">${totalDomains}</div>
                    <div style="font-size: 11px; color: #666;">Total</div>
                </div>
                <div style="text-align: center; padding: 8px; background: white; border-radius: 5px;">
                    <div style="font-size: 20px; font-weight: bold; color: #4CAF50;">${availableDomains}</div>
                    <div style="font-size: 11px; color: #666;">Available</div>
                </div>
                <div style="text-align: center; padding: 8px; background: white; border-radius: 5px;">
                    <div style="font-size: 20px; font-weight: bold; color: #FF9800;">${usedDomains}</div>
                    <div style="font-size: 11px; color: #666;">Used</div>
                </div>
                <div style="text-align: center; padding: 8px; background: white; border-radius: 5px;">
                    <div style="font-size: 20px; font-weight: bold; color: #9C27B0;">${totalUsers}</div>
                    <div style="font-size: 11px; color: #666;">Users</div>
                </div>
            </div>
        </div>
        <h4 style="margin: 15px 0 10px 0; color: #333;">Domain Details:</h4>
    `;
    
    html += domains.map(domain => {
        const isUsed = domain.is_used || false;
        const domainClass = isUsed ? 'domain-item used-domain' : 'domain-item';
        const clickHandler = isUsed ? '' : `onclick="selectDomain('${domain.domain_name}')"`;
        const statusText = isUsed ? 'USED' : 'AVAILABLE';
        const statusColor = isUsed ? 'red' : 'green';
        
        return `<div class="${domainClass}" ${clickHandler}>
            <strong style="color: ${isUsed ? 'red' : 'black'};">${domain.domain_name}</strong>
            <span style="float: right; color: #666; font-weight: bold;">${domain.user_count} users</span>
            <div style="margin-top: 5px;">
                ${domain.verified ? '<span style="color: green;">‚úÖ Verified</span>' : '<span style="color: red;">‚ùå Not Verified</span>'}
                <span style="color: ${statusColor}; margin-left: 10px; font-weight: bold;">${statusText}</span>
            </div>
        </div>`;
    }).join('');
    
    domainList.innerHTML = html;
}

function selectDomain(domainName) {
    // Check if domain is used
    const domainElement = event.target.closest('.domain-item');
    if (domainElement.classList.contains('used-domain')) {
        alert('‚ùå This domain has already been used and cannot be selected again.');
        return;
    }
    
    // Remove previous selection
    document.querySelectorAll('.domain-item').forEach(item => {
        item.classList.remove('selected');
    });
    
    // Select clicked domain
    domainElement.classList.add('selected');
    selectedDomain = domainName;
    
    logBulkDomain(`üìå Selected domain: ${domainName}`);
}

function applySelectedDomainToCSV() {
    if (!selectedDomain) {
        alert('Please select a domain first');
        return;
    }
    
    const csvPath = document.getElementById('csv-file-path').value;
    if (!csvPath) {
        alert('Please download users CSV first');
        return;
    }
    
    logBulkDomain(`‚úÖ Applying domain ${selectedDomain} to CSV...`);
    
    fetch('/api/apply-domain-to-csv', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            selected_domain: selectedDomain,
            csv_path: csvPath
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            fetch('/api/mark-domain-used', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({domain: selectedDomain})
            });
            // Update CSV path to modified version
            document.getElementById('csv-file-path').value = data.modified_csv_path;
            logBulkDomain(`‚úÖ Domain applied successfully. Modified CSV: ${data.modified_csv_path}`);
            logBulkDomain(`üìä ${data.modified_count} users will be updated to ${selectedDomain}`);
        } else {
            logBulkDomain(`‚ùå Failed to apply domain: ${data.error}`);
            alert('Failed to apply domain: ' + data.error);
        }
    })
    .catch(error => {
        logBulkDomain(`‚ùå Network error: ${error}`);
        alert('Network error: ' + error);
    });
}

function browseCSVFile() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.csv';
    input.onchange = function(e) {
        const file = e.target.files[0];
        if (file) {
            document.getElementById('csv-file-path').value = file.name;
            logBulkDomain(`üìÅ Selected CSV file: ${file.name}`);
        }
    };
    input.click();
}

function processDomainChangesFromCSV() {
    const csvPath = document.getElementById('csv-file-path').value;
    
    if (!csvPath) {
        alert('Please select or specify a CSV file first');
        return;
    }
    
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    if (!confirm('‚ö†Ô∏è Process domain changes from CSV?\n\nThis will update user domains as specified in the CSV file.\n\nThis action cannot be easily undone!')) {
        return;
    }
    
    logBulkDomain(`‚öôÔ∏è Processing domain changes from CSV: ${csvPath}`);
    
    fetch('/api/process-csv-domain-changes', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            csv_path: csvPath
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            logBulkDomain(`‚úÖ CSV processing completed!`);
            logBulkDomain(`üìä Results: ${data.successful} successful, ${data.failed} failed, ${data.skipped} skipped`);
            
            if (data.results) {
                data.results.forEach(result => {
                    if (result.success) {
                        logBulkDomain(`‚úÖ Updated: ${result.old_email} ‚Üí ${result.new_email}`);
                    } else {
                        logBulkDomain(`‚ùå Failed: ${result.email} - ${result.error}`);
                    }
                });
            }
        } else {
            logBulkDomain(`‚ùå CSV processing failed: ${data.error}`);
            alert('CSV processing failed: ' + data.error);
        }
    })
    .catch(error => {
        logBulkDomain(`‚ùå Network error: ${error}`);
        alert('Network error: ' + error);
    });
}

function changeDomainForAllUsers() {
    const currentDomain = document.getElementById('current-domain-suffix').value.trim();
    const newDomain = document.getElementById('new-domain-suffix').value.trim();
    
    if (!currentDomain || !newDomain) {
        alert('Please enter both current and new domain suffixes');
        return;
    }
    
    if (!isAuthenticated) {
        alert('Please authenticate an account first');
        return;
    }
    
    if (!confirm(`‚ö†Ô∏è Change domain for ALL users?\n\n${currentDomain} ‚Üí ${newDomain}\n\nThis will affect ALL non-admin users with the current domain.\nThis action cannot be easily undone!\n\nContinue?`)) {
        return;
    }
    
    logBulkDomain(`üîÑ Starting bulk domain change: ${currentDomain} ‚Üí ${newDomain}`);
    
    fetch('/api/change-domain-all-users', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            current_domain: currentDomain,
            new_domain: newDomain,
            exclude_admin: true
        })
    })
    .then(response => {
        // Check if response is actually JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            throw new Error(`Server returned HTML instead of JSON. Status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            if (data.successful > 0) {
                // Only mark domain as used if there were successful changes
                fetch('/api/mark-domain-used', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({domain: newDomain})
                });
            }
            logBulkDomain(`‚úÖ Bulk domain change completed!`);
            logBulkDomain(`üìä Results: ${data.successful} successful, ${data.failed} failed, ${data.skipped} skipped (admin users)`);
            
            if (data.results) {
                data.results.forEach(result => {
                    if (result.success) {
                        logBulkDomain(`‚úÖ Updated: ${result.old_email} ‚Üí ${result.new_email}`);
                    } else if (result.skipped) {
                        logBulkDomain(`‚è≠Ô∏è Skipped: ${result.email} (admin user)`);
                    } else {
                        logBulkDomain(`‚ùå Failed: ${result.email} - ${result.error}`);
                    }
                });
            }
        } else {
            logBulkDomain(`‚ùå Bulk domain change failed: ${data.error}`);
            alert('Bulk domain change failed: ' + data.error);
        }
    })
    .catch(error => {
        logBulkDomain(`‚ùå Network error: ${error.message}`);
        console.error('Full error:', error);
        alert('Network error: ' + error.message);
    });
}

function logBulkDomain(message) {
    const log = document.getElementById('bulk-domain-results');
    const timestamp = new Date().toLocaleTimeString();
    
    if (log.querySelector('.placeholder-text')) {
        log.innerHTML = '';
    }
    
    log.textContent += `[${timestamp}] ${message}\n`;
    log.scrollTop = log.scrollHeight;
}

function clearBulkDomainLog() {
    document.getElementById('bulk-domain-results').innerHTML = '<p class="placeholder-text">Processing results will appear here...</p>';
}

// Tab 4 Functions - SMTP & CSV

function testSMTPCredentials() {
    const credentials = document.getElementById('smtp-credentials').value.trim();
    const recipient = document.getElementById('smtp-recipient').value.trim();
    const server = document.getElementById('smtp-server').value.trim();
    const port = document.getElementById('smtp-port').value;
    
    if (!credentials) {
        alert('Please enter SMTP credentials');
        return;
    }
    
    if (!recipient || !recipient.includes('@')) {
        alert('Please enter a valid recipient email');
        return;
    }
    
    smtpTesting = true;
    clearSMTPResults();
    logSMTPResult('üöÄ Starting SMTP credential testing...');
    logSMTPResult(`üìß Recipient: ${recipient}`);
    logSMTPResult(`üñ•Ô∏è Server: ${server}:${port}`);
    logSMTPResult('‚îÄ'.repeat(50));
    
    fetch('/api/test-smtp', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            credentials: credentials,
            recipient_email: recipient,
            smtp_server: server,
            smtp_port: parseInt(port)
        })
    })
    .then(response => response.json())
    .then(data => {
        smtpTesting = false;
        
        if (data.success && data.results) {
            logSMTPResult(`üìä Testing completed for ${data.results.length} credentials:`);
            logSMTPResult('‚îÄ'.repeat(50));
            
            let successCount = 0;
            let failCount = 0;
            
            data.results.forEach(result => {
                if (result.status === 'success') {
                    logSMTPResult(`‚úÖ ${result.email}: ${result.message || 'Success'}`);
                    successCount++;
                } else {
                    logSMTPResult(`‚ùå ${result.email}: ${result.error}`);
                    failCount++;
                }
            });
            
            logSMTPResult('‚îÄ'.repeat(50));
            logSMTPResult(`üìà Summary: ${successCount} successful, ${failCount} failed`);
        } else {
            logSMTPResult(`‚ùå SMTP testing failed: ${data.error}`);
        }
    })
    .catch(error => {
        smtpTesting = false;
        logSMTPResult(`‚ùå Network error: ${error}`);
    });
}

function interruptSMTPTesting() {
    if (smtpTesting) {
        smtpTesting = false;
        logSMTPResult('‚èπÔ∏è SMTP testing interrupted by user');
        alert('SMTP testing interrupted');
    } else {
        alert('No SMTP testing in progress');
    }
}

function clearSMTPResults() {
    document.getElementById('smtp-results-log').textContent = '';
}

function logSMTPResult(message) {
    const log = document.getElementById('smtp-results-log');
    const timestamp = new Date().toLocaleTimeString();
    log.textContent += `[${timestamp}] ${message}\n`;
    log.scrollTop = log.scrollHeight;
}

function generateUserCSV() {
    const numUsers = document.getElementById('csv-num-users').value;
    const domain = document.getElementById('csv-domain').value.trim();
    const password = document.getElementById('csv-password').value.trim();
    
    if (!numUsers || numUsers <= 0) {
        alert('Please enter a valid number of users');
        return;
    }
    
    if (!domain || !domain.includes('.')) {
        alert('Please enter a valid domain');
        return;
    }
    
    if (!password) {
        alert('Please enter a default password');
        return;
    }
    
    logResult(`üìù Generating CSV with ${numUsers} users for ${domain}...`);
    
    fetch('/api/generate-csv', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            num_users: parseInt(numUsers),
            domain: domain,
            password: password
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.csv_data) {
            // Create download link
            const blob = new Blob([data.csv_data], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const filename = `users_${domain}_${numUsers}.csv`;
            
            document.getElementById('csv-download-area').innerHTML = `
                <a href="${url}" download="${filename}" class="download-btn">
                    üì• Download ${filename} (${numUsers} users)
                </a>
            `;
            
            logResult(`‚úÖ CSV file generated successfully: ${filename}`);
        } else {
            logResult(`‚ùå CSV generation failed: ${data.error}`);
            alert('Failed to generate CSV: ' + data.error);
        }
    })
    .catch(error => {
        logResult(`‚ùå Network error: ${error}`);
        alert('Network error: ' + error);
    });
}


function previewCSV() {
    const numUsers = Math.min(document.getElementById('csv-num-users').value || 5, 10); // Preview max 10
    const domain = document.getElementById('csv-domain').value.trim() || 'example.com';
    const password = document.getElementById('csv-password').value.trim() || 'DefaultPass123';
    
    fetch('/api/preview-csv', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            num_users: parseInt(numUsers),
            domain: domain,
            password: password
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.preview) {
            document.getElementById('csv-preview-area').innerHTML = `
                <h4>üìã CSV Preview (first ${numUsers} rows):</h4>
                <pre>${data.preview}</pre>
            `;
        } else {
            alert('Failed to preview CSV: ' + data.error);
        }
    })
    .catch(error => {
        alert('Network error: ' + error);
    });
}



/*

// COMMENTED OUT - Email Template Functions
function generateEmailTemplate() {
    const subject = document.getElementById('email-subject').value.trim();
    const body = document.getElementById('email-body').value.trim();
    
    if (!subject || !body) {
        alert('Please enter both subject and body');
        return;
    }
    
    // Sample data for template preview
    const sampleData = {
        email: 'john.doe@example.com',
        password: 'TempPass123',
        first_name: 'John',
        last_name: 'Doe'
    };
    
    let previewSubject = subject;
    let previewBody = body;
    
    // Replace placeholders
    Object.keys(sampleData).forEach(key => {
        const placeholder = `{${key}}`;
        previewSubject = previewSubject.replace(new RegExp(placeholder, 'g'), sampleData[key]);
        previewBody = previewBody.replace(new RegExp(placeholder, 'g'), sampleData[key]);
    });
    
    document.getElementById('email-template-preview').innerHTML = `
        <h4>üìß Email Template Preview:</h4>
        <div style="border: 1px solid #ddd; padding: 1rem; background: white;">
            <div><strong>Subject:</strong> ${previewSubject}</div>
            <hr>
            <div style="white-space: pre-wrap;">${previewBody}</div>
        </div>
        <p><small>üìù Sample data used: ${JSON.stringify(sampleData, null, 2)}</small></p>
    `;
}

// COMMENTED OUT - Email Template Functions
function testEmailTemplate() {
    alert('Email template testing feature coming soon!');
}
*/

</script>
{% endblock %}
