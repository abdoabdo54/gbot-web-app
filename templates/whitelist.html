{% extends "base.html" %}

{% block title %}IP Whitelist Management{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>IP Whitelist Management</h2>
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    Add IP to Whitelist
                </div>
                <div class="card-body">
                    <form id="add-ip-form">
                        <div class="form-group">
                            <label for="ip_address">IP Address</label>
                            <input type="text" class="form-control" id="ip_address" name="ip_address" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Add IP</button>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    Whitelisted IPs
                </div>
                <div class="card-body">
                    <ul class="list-group" id="ip-list">
                        <!-- IPs will be loaded here dynamically -->
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        function loadIpList() {
            $.ajax({
                url: "/api/list-whitelist-ips",
                type: "GET",
                success: function(response) {
                    if (response.success) {
                        var ipList = $("#ip-list");
                        ipList.empty();
                        response.ips.forEach(function(ip) {
                            ipList.append('<li class="list-group-item d-flex justify-content-between align-items-center">' + ip +
                                ' <button class="btn btn-danger btn-sm delete-ip" data-ip="' + ip + '">Delete</button></li>');
                        });
                    }
                }
            });
        }

        loadIpList();

        $("#add-ip-form").submit(function(event) {
            event.preventDefault();
            var ipAddress = $("#ip_address").val();
            $.ajax({
                url: "/api/add-whitelist-ip",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({ ip_address: ipAddress }),
                success: function(response) {
                    if (response.success) {
                        toastr.success(response.message);
                        loadIpList();
                        $("#add-ip-form")[0].reset();
                    } else {
                        toastr.error(response.error);
                    }
                }
            });
        });

        $(document).on("click", ".delete-ip", function() {
            var ipAddress = $(this).data("ip");
            if (confirm("Are you sure you want to delete " + ipAddress + " from the whitelist?")) {
                $.ajax({
                    url: "/api/delete-whitelist-ip",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({ ip_address: ipAddress }),
                    success: function(response) {
                        if (response.success) {
                            toastr.success(response.message);
                            loadIpList();
                        } else {
                            toastr.error(response.error);
                        }
                    }
                });
            }
        });
    });
</script>
{% endblock %}
