{% extends "base.html" %}

{% block title %}IP Whitelist Management{% endblock %}

{% block content %}
<div class="whitelist-container">
    <!-- Header Section -->
    <div class="text-center mb-5">
        <h1 class="display-5 fw-bold text-gradient mb-3">
            <i class="bi bi-shield-check me-3"></i>IP Whitelist Management
        </h1>
        <p class="lead text-muted">Secure access control for your application</p>
        {% if session.get('emergency_access') %}
        <div class="mt-4">
            <span class="badge bg-warning text-dark px-3 py-2 fs-6">
                <i class="bi bi-exclamation-triangle me-2"></i>Emergency Access Mode
            </span>
            <a href="/logout" class="btn btn-outline-danger ms-3">
                <i class="bi bi-box-arrow-right me-2"></i>Exit Emergency Mode
            </a>
        </div>
        {% endif %}
    </div>

    <!-- Emergency Access Section -->
    <div class="card border-warning shadow-lg mb-5">
        <div class="card-header bg-warning text-dark text-center">
            <h4 class="mb-0">
                <i class="bi bi-exclamation-triangle me-2"></i>Emergency Access
            </h4>
        </div>
        <div class="card-body p-4">
            <p class="text-center mb-4">If you're locked out due to IP restrictions, use this emergency access method:</p>
            <div class="row g-4">
                <div class="col-md-6">
                    <label for="emergency_ip" class="form-label fw-bold">
                        <i class="bi bi-globe me-2"></i>Your Current IP Address
                    </label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="emergency_ip" readonly>
                        <button class="btn btn-primary" type="button" id="detectBtn">
                            <i class="bi bi-search me-1"></i>Detect
                        </button>
                    </div>
                    <div class="form-text">
                        <i class="bi bi-info-circle me-1"></i>Automatically detected or enter manually
                    </div>
                </div>
                <div class="col-md-6">
                    <label for="emergency_key" class="form-label fw-bold">
                        <i class="bi bi-key me-2"></i>Emergency Access Key
                    </label>
                    <input type="text" class="form-control" id="emergency_key" 
                           placeholder="Enter WHITELIST_TOKEN or SECRET_KEY">
                    <div class="form-text">
                        <i class="bi bi-info-circle me-1"></i>Use key from your environment configuration
                    </div>
                </div>
            </div>
            <div class="text-center mt-4">
                <button type="button" class="btn btn-warning btn-lg px-4" id="emergencyBtn">
                    <i class="bi bi-shield-check me-2"></i>Grant Emergency Access
                </button>
            </div>
        </div>
    </div>

    <!-- Main Management Section -->
    <div class="row g-4">
        <!-- Add IP Section -->
        <div class="col-lg-4">
            <div class="card h-100 shadow-lg">
                <div class="card-header bg-primary text-white text-center">
                    <h5 class="mb-0">
                        <i class="bi bi-plus-circle me-2"></i>Add IP to Whitelist
                    </h5>
                </div>
                <div class="card-body p-4">
                    <form id="add-ip-form">
                        <div class="mb-3">
                            <label for="ip_address" class="form-label fw-bold">IP Address</label>
                            <input type="text" class="form-control" id="ip_address" name="ip_address" 
                                   placeholder="e.g., 192.168.1.100" required>
                            <div class="form-text">
                                <i class="bi bi-info-circle me-1"></i>Enter the IP address you want to whitelist
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-plus-circle me-2"></i>Add IP
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Whitelisted IPs Section -->
        <div class="col-lg-8">
            <div class="card h-100 shadow-lg">
                <div class="card-header bg-success text-white text-center">
                    <h5 class="mb-0">
                        <i class="bi bi-list-check me-2"></i>Whitelisted IP Addresses
                    </h5>
                </div>
                <div class="card-body p-4">
                    <div id="ip-list" class="ip-list">
                        <div class="text-center text-muted py-4">
                            <i class="bi bi-hourglass-split fs-1 mb-3"></i>
                            <p>Loading whitelisted IPs...</p>
                        </div>
                    </div>
                    <div class="text-center mt-3">
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="refreshBtn">
                            <i class="bi bi-arrow-clockwise me-1"></i>Refresh List
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle text-warning me-2"></i>Confirm Deletion
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to remove <strong id="deleteIpAddress"></strong> from the whitelist?</p>
                <p class="text-muted small">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">
                    <i class="bi bi-trash me-2"></i>Delete IP
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Status Messages -->
<div id="statusMessages"></div>

{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    let currentIp = '';
    let deleteIp = '';

    // Detect current IP
    function detectCurrentIP() {
        $.get('https://api.ipify.org?format=json')
            .done(function(data) {
                currentIp = data.ip;
                $('#emergency_ip').val(currentIp);
            })
            .fail(function() {
                $('#emergency_ip').val('Detection failed');
            });
    }

    // Load whitelisted IPs
    function loadWhitelistedIPs() {
        $('#ip-list').html('<div class="text-center text-muted py-4"><i class="bi bi-hourglass-split fs-1 mb-3"></i><p>Loading...</p></div>');
        
        $.get('/api/get-whitelist-ips')
            .done(function(data) {
                if (data.success && data.ips && data.ips.length > 0) {
                    let html = '';
                    data.ips.forEach(function(ip) {
                        html += `
                            <div class="ip-item">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-shield-check text-success me-3 fs-5"></i>
                                    <span class="fw-bold">${ip.ip_address}</span>
                                    <span class="badge bg-secondary ms-2">${ip.created_at}</span>
                                </div>
                                <button class="btn btn-outline-danger btn-sm delete-ip" data-ip="${ip.ip_address}">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        `;
                    });
                    $('#ip-list').html(html);
                } else {
                    $('#ip-list').html(`
                        <div class="text-center text-muted py-4">
                            <i class="bi bi-shield-x fs-1 mb-3"></i>
                            <p>No IP addresses whitelisted</p>
                            <small>Add your first IP address to get started</small>
                        </div>
                    `);
                }
            })
            .fail(function() {
                $('#ip-list').html(`
                    <div class="text-center text-danger py-4">
                        <i class="bi bi-exclamation-triangle fs-1 mb-3"></i>
                        <p>Failed to load whitelisted IPs</p>
                        <button class="btn btn-outline-primary btn-sm" onclick="loadWhitelistedIPs()">Retry</button>
                    </div>
                `);
            });
    }

    // Show status message
    function showStatus(message, type = 'success') {
        const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        const icon = type === 'success' ? 'check-circle' : 'exclamation-triangle';
        
        const alert = `
            <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                <i class="bi bi-${icon} me-2"></i>${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        
        $('#statusMessages').html(alert);
        
        // Auto-dismiss after 5 seconds
        setTimeout(function() {
            $('.alert').fadeOut();
        }, 5000);
    }

    // Initialize
    detectCurrentIP();
    loadWhitelistedIPs();

    // Event handlers
    $('#detectBtn').click(detectCurrentIP);

    $('#refreshBtn').click(loadWhitelistedIPs);

    $('#add-ip-form').submit(function(e) {
        e.preventDefault();
        const ip = $('#ip_address').val().trim();
        
        if (!ip) {
            showStatus('Please enter an IP address', 'error');
            return;
        }

        $.post('/api/add-whitelist-ip', { ip_address: ip })
            .done(function(data) {
                if (data.success) {
                    showStatus('IP address added successfully!');
                    $('#ip_address').val('');
                    loadWhitelistedIPs();
                } else {
                    showStatus(data.message || 'Failed to add IP address', 'error');
                }
            })
            .fail(function() {
                showStatus('Network error: Failed to add IP address', 'error');
            });
    });

    $('#emergencyBtn').click(function() {
        const ip = $('#emergency_ip').val().trim();
        const key = $('#emergency_key').val().trim();
        
        if (!ip || !key) {
            showStatus('Please enter both IP address and emergency key', 'error');
            return;
        }

        $.post('/api/emergency-add-ip', { ip_address: ip, emergency_key: key })
            .done(function(data) {
                if (data.success) {
                    showStatus('Emergency access granted! You can now access the application.');
                    setTimeout(function() {
                        window.location.href = '/dashboard';
                    }, 2000);
                } else {
                    showStatus(data.message || 'Emergency access failed', 'error');
                }
            })
            .fail(function() {
                showStatus('Network error: Emergency access failed', 'error');
            });
    });

    // Delete IP functionality
    $(document).on('click', '.delete-ip', function(e) {
        e.preventDefault();
        e.stopPropagation();
        deleteIp = $(this).data('ip');
        $('#deleteIpAddress').text(deleteIp);
        new bootstrap.Modal(document.getElementById('deleteModal')).show();
    });

    $('#confirmDelete').click(function() {
        $.post('/api/delete-whitelist-ip', { ip_address: deleteIp })
            .done(function(data) {
                if (data.success) {
                    showStatus('IP address removed successfully!');
                    loadWhitelistedIPs();
                    bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
                } else {
                    showStatus(data.message || 'Failed to remove IP address', 'error');
                }
            })
            .fail(function() {
                showStatus('Network error: Failed to remove IP address', 'error');
            });
    });
});
</script>
{% endblock %}
