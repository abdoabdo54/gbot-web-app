{% extends "base.html" %}

{% block title %}IP Whitelist Management{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>IP Whitelist Management</h2>
    
    <!-- Emergency Access Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-warning">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">üö® Emergency Access</h5>
                </div>
                <div class="card-body">
                    <p class="mb-3">If you're locked out due to IP restrictions, use this emergency access method:</p>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="emergency_ip">Your Current IP Address</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="emergency_ip" readonly>
                                    <div class="input-group-append">
                                        <button class="btn btn-outline-secondary" type="button" onclick="detectCurrentIP()">üîç Detect</button>
                                    </div>
                                </div>
                                <small class="form-text text-muted">This will be automatically detected or you can enter it manually</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="emergency_key">Emergency Access Key</label>
                                <input type="text" class="form-control" id="emergency_key" placeholder="Enter your emergency access key">
                                <small class="form-text text-muted">Use the key from your environment configuration</small>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-warning" onclick="emergencyAddIP()">
                        üö® Emergency Add IP
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Regular IP Management Section -->
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">‚ûï Add IP to Whitelist</h5>
                </div>
                <div class="card-body">
                    <form id="add-ip-form">
                        <div class="form-group">
                            <label for="ip_address">IP Address</label>
                            <input type="text" class="form-control" id="ip_address" name="ip_address" placeholder="e.g., 192.168.1.100" required>
                            <small class="form-text text-muted">Enter the IP address you want to whitelist</small>
                        </div>
                        <button type="submit" class="btn btn-primary">Add IP</button>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">üìã Whitelisted IPs</h5>
                </div>
                <div class="card-body">
                    <div id="ip-loading" class="text-center" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                        <p class="mt-2">Loading IP list...</p>
                    </div>
                    <ul class="list-group" id="ip-list">
                        <!-- IPs will be loaded here dynamically -->
                    </ul>
                    <div id="no-ips" class="text-center text-muted" style="display: none;">
                        <p>No IPs are currently whitelisted</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Messages -->
    <div id="status-messages" class="mt-3"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        // Auto-detect current IP on page load
        detectCurrentIP();
        
        // Load IP list
        loadIpList();

        // Add IP form submission
        $("#add-ip-form").submit(function(event) {
            event.preventDefault();
            var ipAddress = $("#ip_address").val().trim();
            
            if (!ipAddress) {
                showStatus('Please enter an IP address', 'error');
                return;
            }
            
            addIPToWhitelist(ipAddress, false);
        });
    });

    function detectCurrentIP() {
        // Try to detect current IP using external service
        $.ajax({
            url: 'https://api.ipify.org?format=json',
            type: 'GET',
            timeout: 5000,
            success: function(data) {
                $('#emergency_ip').val(data.ip);
                $('#ip_address').val(data.ip);
            },
            error: function() {
                // Fallback to alternative service
                $.ajax({
                    url: 'https://ipinfo.io/ip',
                    type: 'GET',
                    timeout: 5000,
                    success: function(ip) {
                        $('#emergency_ip').val(ip.trim());
                        $('#ip_address').val(ip.trim());
                    },
                    error: function() {
                        $('#emergency_ip').val('Could not detect');
                        showStatus('Could not automatically detect your IP address. Please enter it manually.', 'warning');
                    }
                });
            }
        });
    }

    function emergencyAddIP() {
        var ipAddress = $('#emergency_ip').val().trim();
        var emergencyKey = $('#emergency_key').val().trim();
        
        if (!ipAddress || ipAddress === 'Could not detect') {
            showStatus('Please enter a valid IP address', 'error');
            return;
        }
        
        if (!emergencyKey) {
            showStatus('Please enter the emergency access key', 'error');
            return;
        }
        
        addIPToWhitelist(ipAddress, true, emergencyKey);
    }

    function addIPToWhitelist(ipAddress, isEmergency, emergencyKey) {
        var url = isEmergency ? '/api/emergency-add-ip' : '/api/add-whitelist-ip';
        var data = isEmergency ? 
            { ip_address: ipAddress, emergency_key: emergencyKey } : 
            { ip_address: ipAddress };
        
        showStatus('Adding IP to whitelist...', 'info');
        
        $.ajax({
            url: url,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(response) {
                if (response.success) {
                    showStatus(response.message, 'success');
                    loadIpList();
                    if (!isEmergency) {
                        $("#add-ip-form")[0].reset();
                    }
                } else {
                    showStatus(response.error, 'error');
                }
            },
            error: function(xhr, status, error) {
                showStatus('Network error: ' + error, 'error');
            }
        });
    }

    function loadIpList() {
        $('#ip-loading').show();
        $('#ip-list').hide();
        $('#no-ips').hide();
        
        $.ajax({
            url: "/api/list-whitelist-ips",
            type: "GET",
            success: function(response) {
                $('#ip-loading').hide();
                
                if (response.success) {
                    var ipList = $("#ip-list");
                    ipList.empty();
                    
                    if (response.ips && response.ips.length > 0) {
                        response.ips.forEach(function(ip) {
                            var listItem = $('<li class="list-group-item d-flex justify-content-between align-items-center">');
                            listItem.append('<span class="ip-address">' + ip + '</span>');
                            listItem.append('<button class="btn btn-danger btn-sm delete-ip" data-ip="' + ip + '">üóëÔ∏è Delete</button>');
                            ipList.append(listItem);
                        });
                        $('#ip-list').show();
                    } else {
                        $('#no-ips').show();
                    }
                } else {
                    showStatus('Failed to load IP list: ' + response.error, 'error');
                }
            },
            error: function(xhr, status, error) {
                $('#ip-loading').hide();
                showStatus('Network error loading IP list: ' + error, 'error');
            }
        });
    }

    // Delete IP functionality
    $(document).on("click", ".delete-ip", function() {
        var ipAddress = $(this).data("ip");
        if (confirm("Are you sure you want to remove " + ipAddress + " from the whitelist?")) {
            $.ajax({
                url: "/api/delete-whitelist-ip",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({ ip_address: ipAddress }),
                success: function(response) {
                    if (response.success) {
                        showStatus(response.message, 'success');
                        loadIpList();
                    } else {
                        showStatus(response.error, 'error');
                    }
                },
                error: function(xhr, status, error) {
                    showStatus('Network error: ' + error, 'error');
                }
            });
        }
    });

    function showStatus(message, type) {
        var alertClass = type === 'success' ? 'alert-success' : 
                        type === 'error' ? 'alert-danger' : 
                        type === 'warning' ? 'alert-warning' : 'alert-info';
        
        var statusHtml = '<div class="alert ' + alertClass + ' alert-dismissible fade show" role="alert">' +
                         message +
                         '<button type="button" class="close" data-dismiss="alert" aria-label="Close">' +
                         '<span aria-hidden="true">&times;</span></button></div>';
        
        $('#status-messages').html(statusHtml);
        
        // Auto-hide success messages after 5 seconds
        if (type === 'success') {
            setTimeout(function() {
                $('.alert-success').fadeOut();
            }, 5000);
        }
    }
</script>
{% endblock %}
