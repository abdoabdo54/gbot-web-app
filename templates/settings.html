{% extends "base.html" %}

{% block title %}Settings - GBot Web{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12 text-center">
            <h2 class="mb-0 display-4 text-primary">‚öôÔ∏è Settings</h2>
            <p class="text-muted lead">Configure application settings and server connections</p>
        </div>
    </div>

    <!-- Server Settings Section -->
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-lg border-primary">
                <div class="card-header bg-primary text-white text-center">
                    <h4 class="mb-0">üñ•Ô∏è Server Connection Settings</h4>
                </div>
                <div class="card-body p-4">
                    <p class="text-muted mb-4">
                        Configure server credentials to fetch JSON account files for the "Add from Server JSON" feature.
                    </p>
                    
                    <form id="server-settings-form">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="server_host" class="form-label fw-bold">Server Host/IP</label>
                                <input type="text" class="form-control" id="server_host" name="server_host" 
                                       placeholder="192.168.1.100 or server.domain.com" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="server_port" class="form-label fw-bold">SSH Port</label>
                                <input type="number" class="form-control" id="server_port" name="server_port" 
                                       value="22" min="1" max="65535" required>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="server_username" class="form-label fw-bold">Username</label>
                                <input type="text" class="form-control" id="server_username" name="server_username" 
                                       placeholder="root or admin" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="server_password" class="form-label fw-bold">Password (Optional if using SSH key)</label>
                                <input type="password" class="form-control" id="server_password" name="server_password" 
                                       placeholder="Leave empty if using SSH key">
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="server_key_path" class="form-label fw-bold">SSH Key Path (Optional)</label>
                                <input type="text" class="form-control" id="server_key_path" name="server_key_path" 
                                       placeholder="/path/to/private/key">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="json_files_path" class="form-label fw-bold">JSON Files Path</label>
                                <input type="text" class="form-control" id="json_files_path" name="json_files_path" 
                                       value="/opt/gbot-web-app/accounts/" required>
                            </div>
                        </div>
                        
                        <div class="text-center mt-4">
                            <button type="submit" class="btn btn-primary btn-lg px-5">
                                üíæ Save Server Settings
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-lg px-5 ms-3" onclick="testServerConnection()">
                                üîç Test Connection
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Current Settings Display -->
    <div class="row justify-content-center mt-4">
        <div class="col-lg-8">
            <div class="card shadow-lg border-info">
                <div class="card-header bg-info text-white text-center">
                    <h4 class="mb-0">üìã Current Server Settings</h4>
                </div>
                <div class="card-body p-4">
                    <div id="current-settings-display">
                        <div class="text-center py-4">
                            <div class="spinner-border text-info" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-3 text-muted">Loading current settings...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Messages -->
    <div id="status-messages" class="mt-4 text-center"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        console.log('Settings page loaded');
        
        // Load current settings on page load
        loadCurrentSettings();
        
        // Form submission
        $("#server-settings-form").submit(function(event) {
            event.preventDefault();
            saveServerSettings();
        });
    });

    function loadCurrentSettings() {
        console.log('Loading current server settings...');
        
        fetch('/api/get-server-settings', {
            method: 'GET',
            headers: {'Content-Type': 'application/json'}
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.settings) {
                displayCurrentSettings(data.settings);
            } else {
                displayCurrentSettings(null);
            }
        })
        .catch(error => {
            console.error('Error loading settings:', error);
            displayCurrentSettings(null);
        });
    }

    function displayCurrentSettings(settings) {
        const displayDiv = document.getElementById('current-settings-display');
        
        if (!settings) {
            displayDiv.innerHTML = `
                <div class="text-center py-4">
                    <div class="display-4 text-muted mb-3">‚öôÔ∏è</div>
                    <h5 class="text-muted">No server settings configured</h5>
                    <p class="text-muted">Configure server settings above to enable "Add from Server JSON" feature.</p>
                </div>
            `;
            return;
        }
        
        displayDiv.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6 class="fw-bold text-primary">Server Information</h6>
                    <p><strong>Host:</strong> ${settings.server_host}</p>
                    <p><strong>Port:</strong> ${settings.server_port}</p>
                    <p><strong>Username:</strong> ${settings.server_username}</p>
                    <p><strong>Password:</strong> ${settings.server_password ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : 'Not set'}</p>
                </div>
                <div class="col-md-6">
                    <h6 class="fw-bold text-primary">File Paths</h6>
                    <p><strong>SSH Key:</strong> ${settings.server_key_path || 'Not set'}</p>
                    <p><strong>JSON Files:</strong> ${settings.json_files_path}</p>
                    <p><strong>Last Updated:</strong> ${new Date(settings.updated_at).toLocaleString()}</p>
                </div>
            </div>
            <div class="text-center mt-3">
                <button class="btn btn-outline-danger btn-sm" onclick="deleteServerSettings()">
                    üóëÔ∏è Delete Settings
                </button>
            </div>
        `;
    }

    function saveServerSettings() {
        console.log('Saving server settings...');
        
        const formData = {
            server_host: $('#server_host').val().trim(),
            server_port: parseInt($('#server_port').val()),
            server_username: $('#server_username').val().trim(),
            server_password: $('#server_password').val(),
            server_key_path: $('#server_key_path').val().trim() || null,
            json_files_path: $('#json_files_path').val().trim()
        };
        
        // Validation
        if (!formData.server_host || !formData.server_username || !formData.json_files_path) {
            showStatus('Please fill in all required fields', 'error');
            return;
        }
        
        if (!formData.server_password && !formData.server_key_path) {
            showStatus('Please provide either password or SSH key path', 'error');
            return;
        }
        
        showStatus('Saving server settings...', 'info');
        
        fetch('/api/save-server-settings', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showStatus('‚úÖ Server settings saved successfully!', 'success');
                loadCurrentSettings(); // Refresh display
                $('#server-settings-form')[0].reset();
            } else {
                showStatus('‚ùå Failed to save settings: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error saving settings:', error);
            showStatus('‚ùå Network error: ' + error, 'error');
        });
    }

    function testServerConnection() {
        console.log('Testing server connection...');
        
        const formData = {
            server_host: $('#server_host').val().trim(),
            server_port: parseInt($('#server_port').val()),
            server_username: $('#server_username').val().trim(),
            server_password: $('#server_password').val(),
            server_key_path: $('#server_key_path').val().trim() || null
        };
        
        if (!formData.server_host || !formData.server_username) {
            showStatus('Please fill in server host and username', 'error');
            return;
        }
        
        showStatus('üîç Testing server connection...', 'info');
        
        fetch('/api/test-server-connection', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showStatus('‚úÖ Server connection successful! ' + data.message, 'success');
            } else {
                showStatus('‚ùå Connection failed: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error testing connection:', error);
            showStatus('‚ùå Network error: ' + error, 'error');
        });
    }

    function deleteServerSettings() {
        if (!confirm('‚ö†Ô∏è Are you sure you want to delete the server settings? This action cannot be undone.')) {
            return;
        }
        
        console.log('Deleting server settings...');
        showStatus('Deleting server settings...', 'info');
        
        fetch('/api/delete-server-settings', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showStatus('‚úÖ Server settings deleted successfully!', 'success');
                loadCurrentSettings(); // Refresh display
            } else {
                showStatus('‚ùå Failed to delete settings: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error deleting settings:', error);
            showStatus('‚ùå Network error: ' + error, 'error');
        });
    }

    function showStatus(message, type) {
        console.log('Showing status:', message, type);
        var alertClass = type === 'success' ? 'alert-success' : 
                        type === 'error' ? 'alert-danger' : 
                        type === 'warning' ? 'alert-warning' : 'alert-info';
        
        var icon = type === 'success' ? '‚úÖ' : 
                  type === 'error' ? '‚ùå' : 
                  type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
        
        var statusHtml = '<div class="alert ' + alertClass + ' alert-dismissible fade show fs-5" role="alert">' +
                         '<strong>' + icon + '</strong> ' + message +
                         '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>';
        
        $('#status-messages').html(statusHtml);
        
        // Auto-hide success messages after 5 seconds
        if (type === 'success') {
            setTimeout(function() {
                $('.alert-success').fadeOut();
            }, 5000);
        }
    }
</script>
{% endblock %}
