{% extends "base.html" %}

{% block title %}Settings - GBot Web{% endblock %}

{% block content %}
<h1>⚙️ Settings</h1>
<p class="text-muted mb-6">Configure application settings and server connections</p>

<!-- Server Configuration Section -->
<div class="section">
    <h3>🖥️ Server Configuration</h3>
    <p class="text-muted mb-4">
        Configure the server connection for importing accounts from JSON files. 
        This server should contain the credential JSON files for Google Workspace accounts.
    </p>
    
    <form id="server-config-form">
        <div class="form-row">
            <label for="server_host">🌐 Server Host/IP</label>
            <input type="text" id="server_host" placeholder="192.168.1.100 or server.domain.com" required>
        </div>
        
        <div class="form-row">
            <label for="server_port">🔌 Port</label>
            <input type="number" id="server_port" value="22" min="1" max="65535" required>
        </div>
        
        <div class="form-row">
            <label for="server_username">👤 Username</label>
            <input type="text" id="server_username" placeholder="ubuntu or root" required>
        </div>
        
        <div class="form-row">
            <label for="server_auth_method">🔐 Authentication Method</label>
            <select id="server_auth_method" required>
                <option value="password">Password</option>
                <option value="key">SSH Key</option>
            </select>
        </div>
        
        <div class="form-row" id="password-field">
            <label for="server_password">🔑 Password</label>
            <input type="password" id="server_password" placeholder="Server password">
        </div>
        
        <div id="key-field" style="display: none;">
            <label for="server_private_key">🔑 Private Key</label>
            <textarea id="server_private_key" rows="4" placeholder="-----BEGIN OPENSSH PRIVATE KEY-----&#10;...&#10;-----END OPENSSH PRIVATE KEY-----"></textarea>
        </div>
        
        <div class="form-row">
            <label for="server_json_path">📁 JSON Files Path</label>
            <input type="text" id="server_json_path" value="/opt/gbot-web-app/credentials/" placeholder="/path/to/json/files/" required>
        </div>
        
        <div class="form-row">
            <label for="server_file_pattern">📋 File Pattern</label>
            <input type="text" id="server_file_pattern" value="*.json" placeholder="*.json or admin@*.json" required>
        </div>
        
        <div class="button-row">
            <button type="button" class="btn-secondary" onclick="testServerConnection()">
                🔍 Test Connection
            </button>
            <button type="submit" class="btn-primary">
                💾 Save Configuration
            </button>
        </div>
    </form>
</div>

<!-- Current Configuration Display -->
<div class="section">
    <h3>📋 Current Configuration</h3>
    <div id="current-config-display">
        <div class="dark-loading-state">
            <div class="dark-loading-spinner"></div>
            <p>Loading current configuration...</p>
        </div>
    </div>
</div>

<!-- Status Messages -->
<div id="status-messages" class="mb-4"></div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Settings page loaded, initializing...');
    
    // Load current configuration
    loadCurrentConfiguration();
    
    // Handle authentication method change
    document.getElementById('server_auth_method').addEventListener('change', function() {
        const method = this.value;
        const passwordField = document.getElementById('password-field');
        const keyField = document.getElementById('key-field');
        const passwordInput = document.getElementById('server_password');
        const keyInput = document.getElementById('server_private_key');
        
        if (method === 'password') {
            passwordField.style.display = 'block';
            keyField.style.display = 'none';
            passwordInput.required = true;
            keyInput.required = false;
        } else {
            passwordField.style.display = 'none';
            keyField.style.display = 'block';
            passwordInput.required = false;
            keyInput.required = true;
        }
    });
    
    // Handle form submission
    document.getElementById('server-config-form').addEventListener('submit', function(e) {
        e.preventDefault();
        saveServerConfiguration();
    });
});

function loadCurrentConfiguration() {
    console.log('Loading current server configuration...');
    
    fetch('/api/get-server-config', {
        method: 'GET',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.config) {
            displayCurrentConfiguration(data.config);
        } else {
            displayCurrentConfiguration(null);
        }
    })
    .catch(error => {
        console.error('Error loading configuration:', error);
        displayCurrentConfiguration(null);
    });
}

function displayCurrentConfiguration(config) {
    const display = $('#current-config-display');
    
    if (!config) {
        display.html(`
            <div class="text-center py-4">
                <div class="display-4 text-muted mb-3">⚙️</div>
                <h5 class="text-muted">No Configuration Set</h5>
                <p class="text-muted">Configure server settings above to enable "Add from Server JSON" functionality.</p>
            </div>
        `);
        return;
    }
    
    // Populate form fields
    document.getElementById('server_host').value = config.host || '';
    document.getElementById('server_port').value = config.port || 22;
    document.getElementById('server_username').value = config.username || '';
    document.getElementById('server_auth_method').value = config.auth_method || 'password';
    document.getElementById('server_password').value = config.password || '';
    document.getElementById('server_private_key').value = config.private_key || '';
    document.getElementById('server_json_path').value = config.json_path || '';
    document.getElementById('server_file_pattern').value = config.file_pattern || '';
    
    // Trigger auth method change to show/hide fields
    document.getElementById('server_auth_method').dispatchEvent(new Event('change'));
    
    // Display current config
    const statusClass = config.is_configured ? 'success' : 'warning';
    const statusIcon = config.is_configured ? '✅' : '⚠️';
    const statusText = config.is_configured ? 'Configured' : 'Not Tested';
    
    display.html(`
        <div class="row">
            <div class="col-md-6">
                <h6 class="fw-bold">🖥️ Server Details</h6>
                <ul class="list-unstyled">
                    <li><strong>Host:</strong> ${config.host || 'Not set'}</li>
                    <li><strong>Port:</strong> ${config.port || 'Not set'}</li>
                    <li><strong>Username:</strong> ${config.username || 'Not set'}</li>
                    <li><strong>Auth Method:</strong> ${config.auth_method || 'Not set'}</li>
                </ul>
            </div>
            <div class="col-md-6">
                <h6 class="fw-bold">📁 File Configuration</h6>
                <ul class="list-unstyled">
                    <li><strong>JSON Path:</strong> ${config.json_path || 'Not set'}</li>
                    <li><strong>File Pattern:</strong> ${config.file_pattern || 'Not set'}</li>
                    <li><strong>Status:</strong> <span class="badge bg-${statusClass}">${statusIcon} ${statusText}</span></li>
                </ul>
            </div>
        </div>
        <div class="text-center mt-3">
            <button class="btn btn-outline-danger btn-sm" onclick="clearServerConfiguration()">
                🗑️ Clear Configuration
            </button>
        </div>
    `);
}

function saveServerConfiguration() {
    console.log('Saving server configuration...');
    
    const config = {
        host: document.getElementById('server_host').value.trim(),
        port: parseInt(document.getElementById('server_port').value),
        username: document.getElementById('server_username').value.trim(),
        auth_method: document.getElementById('server_auth_method').value,
        password: document.getElementById('server_password').value,
        private_key: document.getElementById('server_private_key').value.trim(),
        json_path: document.getElementById('server_json_path').value.trim(),
        file_pattern: document.getElementById('server_file_pattern').value.trim()
    };
    
    // Validate required fields
    if (!config.host || !config.username || !config.json_path || !config.file_pattern) {
        showStatus('Please fill in all required fields', 'error');
        return;
    }
    
    if (config.auth_method === 'password' && !config.password) {
        showStatus('Password is required when using password authentication', 'error');
        return;
    }
    
    if (config.auth_method === 'key' && !config.private_key) {
        showStatus('Private key is required when using SSH key authentication', 'error');
        return;
    }
    
    showStatus('Saving server configuration...', 'info');
    
    fetch('/api/save-server-config', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(config)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showStatus('✅ Server configuration saved successfully', 'success');
            loadCurrentConfiguration();
        } else {
            showStatus('❌ Failed to save configuration: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error saving configuration:', error);
        showStatus('❌ Network error: ' + error, 'error');
    });
}

function testServerConnection() {
    console.log('Testing server connection...');
    
    const config = {
        host: document.getElementById('server_host').value.trim(),
        port: parseInt(document.getElementById('server_port').value),
        username: document.getElementById('server_username').value.trim(),
        auth_method: document.getElementById('server_auth_method').value,
        password: document.getElementById('server_password').value,
        private_key: document.getElementById('server_private_key').value.trim(),
        json_path: document.getElementById('server_json_path').value.trim(),
        file_pattern: document.getElementById('server_file_pattern').value.trim()
    };
    
    // Validate required fields
    if (!config.host || !config.username || !config.json_path || !config.file_pattern) {
        showStatus('Please fill in all required fields before testing', 'error');
        return;
    }
    
    if (config.auth_method === 'password' && !config.password) {
        showStatus('Password is required when using password authentication', 'error');
        return;
    }
    
    if (config.auth_method === 'key' && !config.private_key) {
        showStatus('Private key is required when using SSH key authentication', 'error');
        return;
    }
    
    showStatus('🔍 Testing server connection...', 'info');
    
    fetch('/api/test-server-connection', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(config)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showStatus('✅ Server connection successful! Found ' + data.files_count + ' JSON files.', 'success');
            loadCurrentConfiguration();
        } else {
            showStatus('❌ Connection failed: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error testing connection:', error);
        showStatus('❌ Network error: ' + error, 'error');
    });
}

function clearServerConfiguration() {
    if (!confirm('Are you sure you want to clear the server configuration? This will disable the "Add from Server JSON" functionality.')) {
        return;
    }
    
    console.log('Clearing server configuration...');
    
    fetch('/api/clear-server-config', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showStatus('✅ Server configuration cleared', 'success');
            loadCurrentConfiguration();
        } else {
            showStatus('❌ Failed to clear configuration: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error clearing configuration:', error);
        showStatus('❌ Network error: ' + error, 'error');
    });
}

function showStatus(message, type) {
    console.log('Showing status:', message, type);
    
    var icon = type === 'success' ? '✅' : 
              type === 'error' ? '❌' : 
              type === 'warning' ? '⚠️' : 'ℹ️';
    
    var statusColor = type === 'success' ? 'var(--success)' : 
                     type === 'error' ? 'var(--danger)' : 
                     type === 'warning' ? 'var(--warning)' : 'var(--info)';
    
    var statusBg = type === 'success' ? 'rgba(16, 185, 129, 0.1)' : 
                  type === 'error' ? 'rgba(239, 68, 68, 0.1)' : 
                  type === 'warning' ? 'rgba(245, 158, 11, 0.1)' : 'rgba(6, 182, 212, 0.1)';
    
    var statusHtml = '<div style="background: ' + statusBg + '; border: 1px solid ' + statusColor + '; color: ' + statusColor + '; padding: var(--space-4); border-radius: var(--radius); margin: var(--space-4) 0; font-size: var(--text-sm);">' +
                     '<strong>' + icon + '</strong> ' + message + '</div>';
    
    document.getElementById('status-messages').innerHTML = statusHtml;
    
    // Auto-hide success messages after 5 seconds
    if (type === 'success') {
        setTimeout(function() {
            const element = document.getElementById('status-messages');
            if (element) element.innerHTML = '';
        }, 5000);
    }
}
</script>
{% endblock %}
