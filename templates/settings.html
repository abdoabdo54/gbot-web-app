{% extends "base.html" %}

{% block title %}Settings - GBot Web{% endblock %}

{% block content %}
<div class="space-y-8">
    <!-- Header Section -->
    <div class="text-center">
        <div class="flex items-center justify-center space-x-3 mb-4">
            <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-blue-600 rounded-xl flex items-center justify-center">
                <i class="fas fa-cog text-white text-xl"></i>
            </div>
            <h1 class="text-4xl font-bold text-white">Settings</h1>
        </div>
        <p class="text-vercel-gray-400 text-lg">Configure application settings and server connections</p>
    </div>

    <!-- Server Configuration Section -->
    <div class="vercel-card">
        <div class="flex items-center space-x-3 mb-6">
            <div class="w-10 h-10 bg-blue-500 bg-opacity-20 rounded-lg flex items-center justify-center">
                <i class="fas fa-server text-blue-500"></i>
            </div>
            <h3 class="text-xl font-bold text-white">Server Configuration</h3>
        </div>
        
        <div class="mb-6 p-4 bg-blue-500 bg-opacity-10 border border-blue-500 border-opacity-20 rounded-lg">
            <div class="flex items-start space-x-3">
                <div class="w-6 h-6 bg-blue-500 bg-opacity-20 rounded-full flex items-center justify-center mt-0.5">
                    <i class="fas fa-info-circle text-blue-400 text-sm"></i>
                </div>
                <div>
                    <p class="text-blue-300 font-medium mb-2">Server Configuration Purpose</p>
                    <p class="text-blue-200 text-sm">
                        Configure the server connection for importing accounts from JSON files. 
                        This server should contain the credential JSON files for Google Workspace accounts.
                    </p>
                </div>
            </div>
        </div>
        
        <form id="server-config-form" class="space-y-6">
            <!-- Server Host and Port -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div>
                    <label for="server_host" class="block text-sm font-medium text-vercel-gray-300 mb-2">
                        <i class="fas fa-globe mr-2"></i>Server Host/IP
                    </label>
                    <input 
                        type="text" 
                        class="vercel-input" 
                        id="server_host" 
                        placeholder="192.168.1.100 or server.domain.com" 
                        required
                    >
                    <p class="text-vercel-gray-500 text-xs mt-2">IP address or hostname of the server</p>
                </div>
                <div>
                    <label for="server_port" class="block text-sm font-medium text-vercel-gray-300 mb-2">
                        <i class="fas fa-plug mr-2"></i>Port
                    </label>
                    <input 
                        type="number" 
                        class="vercel-input" 
                        id="server_port" 
                        value="22" 
                        min="1" 
                        max="65535" 
                        required
                    >
                    <p class="text-vercel-gray-500 text-xs mt-2">SSH port (default: 22)</p>
                </div>
            </div>
            
            <!-- Username and Authentication Method -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div>
                    <label for="server_username" class="block text-sm font-medium text-vercel-gray-300 mb-2">
                        <i class="fas fa-user mr-2"></i>Username
                    </label>
                    <input 
                        type="text" 
                        class="vercel-input" 
                        id="server_username" 
                        placeholder="ubuntu or root" 
                        required
                    >
                    <p class="text-vercel-gray-500 text-xs mt-2">SSH username for server access</p>
                </div>
                <div>
                    <label for="server_auth_method" class="block text-sm font-medium text-vercel-gray-300 mb-2">
                        <i class="fas fa-shield-alt mr-2"></i>Authentication Method
                    </label>
                    <select class="vercel-select" id="server_auth_method" required>
                        <option value="password">Password</option>
                        <option value="key">SSH Key</option>
                    </select>
                    <p class="text-vercel-gray-500 text-xs mt-2">Choose authentication method</p>
                </div>
            </div>
            
            <!-- Authentication Credentials -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div id="password-field">
                    <label for="server_password" class="block text-sm font-medium text-vercel-gray-300 mb-2">
                        <i class="fas fa-key mr-2"></i>Password
                    </label>
                    <input 
                        type="password" 
                        class="vercel-input" 
                        id="server_password" 
                        placeholder="Server password"
                    >
                    <p class="text-vercel-gray-500 text-xs mt-2">SSH password (if using password auth)</p>
                </div>
                <div id="key-field" style="display: none;" class="lg:col-span-2">
                    <label for="server_private_key" class="block text-sm font-medium text-vercel-gray-300 mb-2">
                        <i class="fas fa-key mr-2"></i>Private Key
                    </label>
                    <textarea 
                        class="vercel-input" 
                        id="server_private_key" 
                        rows="6" 
                        placeholder="-----BEGIN OPENSSH PRIVATE KEY-----&#10;...&#10;-----END OPENSSH PRIVATE KEY-----"
                    ></textarea>
                    <p class="text-vercel-gray-500 text-xs mt-2">SSH private key content (if using key auth)</p>
                </div>
            </div>
            
            <!-- JSON Path Configuration -->
            <div>
                <label for="server_json_path" class="block text-sm font-medium text-vercel-gray-300 mb-2">
                    <i class="fas fa-folder mr-2"></i>JSON Files Path
                </label>
                <input 
                    type="text" 
                    class="vercel-input" 
                    id="server_json_path" 
                    value="/opt/gbot-web-app/credentials/" 
                    placeholder="/path/to/json/files/" 
                    required
                >
                <p class="text-vercel-gray-500 text-xs mt-2">Directory path where JSON credential files are stored on the server</p>
            </div>
            
            <!-- File Pattern -->
            <div>
                <label for="server_file_pattern" class="block text-sm font-medium text-vercel-gray-300 mb-2">
                    <i class="fas fa-file-alt mr-2"></i>File Pattern
                </label>
                <input 
                    type="text" 
                    class="vercel-input" 
                    id="server_file_pattern" 
                    value="*.json" 
                    placeholder="*.json or admin@*.json" 
                    required
                >
                <p class="text-vercel-gray-500 text-xs mt-2">File pattern to match JSON files (e.g., *.json, admin@*.json)</p>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex flex-wrap gap-4 pt-6">
                <button type="button" class="btn-vercel-secondary" onclick="testServerConnection()">
                    <i class="fas fa-search"></i>
                    Test Connection
                </button>
                <button type="submit" class="btn-vercel">
                    <i class="fas fa-save"></i>
                    Save Configuration
                </button>
                <button type="button" class="btn-vercel-secondary" onclick="clearConfiguration()">
                    <i class="fas fa-broom"></i>
                    Clear Configuration
                </button>
            </div>
        </form>
    </div>

    <!-- Current Configuration Section -->
    <div class="vercel-card" id="current-config-section">
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-green-500 bg-opacity-20 rounded-lg flex items-center justify-center">
                    <i class="fas fa-check-circle text-green-500"></i>
                </div>
                <h3 class="text-xl font-bold text-white">Current Configuration</h3>
            </div>
            <button type="button" class="btn-vercel-secondary" onclick="loadCurrentConfig()">
                <i class="fas fa-sync-alt"></i>
                Refresh
            </button>
        </div>
        
        <div id="current-config-display" class="vercel-table">
            <div class="text-center py-8">
                <div class="w-16 h-16 bg-vercel-gray-800 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-server text-vercel-gray-400 text-2xl"></i>
                </div>
                <p class="text-vercel-gray-400">No configuration found. Save a configuration to see details here.</p>
            </div>
        </div>
    </div>

    <!-- Connection Test Results -->
    <div class="vercel-card" id="test-results-section" style="display: none;">
        <div class="flex items-center space-x-3 mb-6">
            <div class="w-10 h-10 bg-yellow-500 bg-opacity-20 rounded-lg flex items-center justify-center">
                <i class="fas fa-flask text-yellow-500"></i>
            </div>
            <h3 class="text-xl font-bold text-white">Connection Test Results</h3>
        </div>
        
        <div id="test-results-display" class="vercel-table min-h-32">
            <!-- Test results will be populated here -->
        </div>
    </div>

    <!-- Status Messages -->
    <div id="status-messages" class="fixed bottom-6 right-6 max-w-md z-50"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Toggle authentication method fields
document.getElementById('server_auth_method').addEventListener('change', function() {
    const method = this.value;
    const passwordField = document.getElementById('password-field');
    const keyField = document.getElementById('key-field');
    
    if (method === 'password') {
        passwordField.style.display = 'block';
        keyField.style.display = 'none';
        document.getElementById('server_private_key').required = false;
        document.getElementById('server_password').required = true;
    } else {
        passwordField.style.display = 'none';
        keyField.style.display = 'block';
        keyField.classList.add('lg:col-span-2');
        document.getElementById('server_password').required = false;
        document.getElementById('server_private_key').required = true;
    }
});

// Form submission
document.getElementById('server-config-form').addEventListener('submit', function(e) {
    e.preventDefault();
    saveServerConfiguration();
});

function saveServerConfiguration() {
    const formData = {
        host: document.getElementById('server_host').value.trim(),
        port: parseInt(document.getElementById('server_port').value),
        username: document.getElementById('server_username').value.trim(),
        auth_method: document.getElementById('server_auth_method').value,
        json_path: document.getElementById('server_json_path').value.trim(),
        file_pattern: document.getElementById('server_file_pattern').value.trim()
    };
    
    if (formData.auth_method === 'password') {
        formData.password = document.getElementById('server_password').value;
    } else {
        formData.private_key = document.getElementById('server_private_key').value.trim();
    }
    
    // Validate required fields
    if (!formData.host || !formData.username || !formData.json_path || !formData.file_pattern) {
        showStatus('Please fill in all required fields', 'error');
        return;
    }
    
    if (formData.auth_method === 'password' && !formData.password) {
        showStatus('Please enter the server password', 'error');
        return;
    }
    
    if (formData.auth_method === 'key' && !formData.private_key) {
        showStatus('Please enter the SSH private key', 'error');
        return;
    }
    
    showStatus('Saving configuration...', 'info');
    
    fetch('/api/save-server-config', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showStatus('Configuration saved successfully!', 'success');
            loadCurrentConfig();
        } else {
            showStatus('Error: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showStatus('Network error: ' + error, 'error');
    });
}

function testServerConnection() {
    const formData = {
        host: document.getElementById('server_host').value.trim(),
        port: parseInt(document.getElementById('server_port').value),
        username: document.getElementById('server_username').value.trim(),
        auth_method: document.getElementById('server_auth_method').value,
        json_path: document.getElementById('server_json_path').value.trim(),
        file_pattern: document.getElementById('server_file_pattern').value.trim()
    };
    
    if (formData.auth_method === 'password') {
        formData.password = document.getElementById('server_password').value;
    } else {
        formData.private_key = document.getElementById('server_private_key').value.trim();
    }
    
    // Validate required fields
    if (!formData.host || !formData.username) {
        showStatus('Please enter at least host and username to test connection', 'error');
        return;
    }
    
    showStatus('Testing connection...', 'info');
    
    // Show test results section
    document.getElementById('test-results-section').style.display = 'block';
    document.getElementById('test-results-display').innerHTML = `
        <div class="text-center py-8">
            <div class="vercel-spinner mx-auto mb-4"></div>
            <p class="text-vercel-gray-400">Testing connection to ${formData.host}...</p>
        </div>
    `;
    
    fetch('/api/test-server-connection', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showStatus('Connection test successful!', 'success');
            
            document.getElementById('test-results-display').innerHTML = `
                <div class="space-y-4">
                    <div class="flex items-center space-x-3 p-4 bg-green-500 bg-opacity-10 border border-green-500 border-opacity-20 rounded-lg">
                        <i class="fas fa-check-circle text-green-500 text-xl"></i>
                        <div>
                            <h4 class="text-green-400 font-medium">Connection Successful</h4>
                            <p class="text-green-300 text-sm">Successfully connected to ${formData.host}</p>
                        </div>
                    </div>
                    
                    ${data.files_found ? `
                        <div class="p-4 bg-vercel-gray-800 rounded-lg border border-vercel-gray-700">
                            <h5 class="text-vercel-gray-200 font-medium mb-2">
                                <i class="fas fa-file-alt mr-2"></i>Files Found: ${data.files_found.length}
                            </h5>
                            <div class="space-y-1">
                                ${data.files_found.map(file => `
                                    <div class="text-vercel-gray-400 text-sm flex items-center space-x-2">
                                        <i class="fas fa-file text-xs"></i>
                                        <span>${file}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${data.connection_info ? `
                        <div class="p-4 bg-vercel-gray-800 rounded-lg border border-vercel-gray-700">
                            <h5 class="text-vercel-gray-200 font-medium mb-2">
                                <i class="fas fa-info-circle mr-2"></i>Connection Details
                            </h5>
                            <div class="text-vercel-gray-400 text-sm space-y-1">
                                <div>Server: ${data.connection_info.host}:${data.connection_info.port}</div>
                                <div>Authentication: ${data.connection_info.auth_method}</div>
                                <div>JSON Path: ${data.connection_info.json_path}</div>
                                <div>File Pattern: ${data.connection_info.file_pattern}</div>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        } else {
            showStatus('Connection test failed: ' + data.error, 'error');
            
            document.getElementById('test-results-display').innerHTML = `
                <div class="flex items-center space-x-3 p-4 bg-red-500 bg-opacity-10 border border-red-500 border-opacity-20 rounded-lg">
                    <i class="fas fa-exclamation-triangle text-red-500 text-xl"></i>
                    <div>
                        <h4 class="text-red-400 font-medium">Connection Failed</h4>
                        <p class="text-red-300 text-sm">${data.error}</p>
                    </div>
                </div>
            `;
        }
    })
    .catch(error => {
        showStatus('Network error: ' + error, 'error');
        
        document.getElementById('test-results-display').innerHTML = `
            <div class="flex items-center space-x-3 p-4 bg-red-500 bg-opacity-10 border border-red-500 border-opacity-20 rounded-lg">
                <i class="fas fa-exclamation-triangle text-red-500 text-xl"></i>
                <div>
                    <h4 class="text-red-400 font-medium">Network Error</h4>
                    <p class="text-red-300 text-sm">${error}</p>
                </div>
            </div>
        `;
    });
}

function loadCurrentConfig() {
    showStatus('Loading current configuration...', 'info');
    
    fetch('/api/get-server-config')
    .then(response => response.json())
    .then(data => {
        if (data.success && data.config) {
            const config = data.config;
            
            // Populate form fields
            document.getElementById('server_host').value = config.host || '';
            document.getElementById('server_port').value = config.port || 22;
            document.getElementById('server_username').value = config.username || '';
            document.getElementById('server_auth_method').value = config.auth_method || 'password';
            document.getElementById('server_json_path').value = config.json_path || '/opt/gbot-web-app/credentials/';
            document.getElementById('server_file_pattern').value = config.file_pattern || '*.json';
            
            // Trigger auth method change to show correct fields
            document.getElementById('server_auth_method').dispatchEvent(new Event('change'));
            
            // Display current config
            document.getElementById('current-config-display').innerHTML = `
                <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="p-4 bg-vercel-gray-800 rounded-lg border border-vercel-gray-700">
                            <h5 class="text-vercel-gray-200 font-medium mb-2">Server Details</h5>
                            <div class="text-vercel-gray-400 text-sm space-y-1">
                                <div><strong>Host:</strong> ${config.host}</div>
                                <div><strong>Port:</strong> ${config.port}</div>
                                <div><strong>Username:</strong> ${config.username}</div>
                                <div><strong>Auth Method:</strong> ${config.auth_method}</div>
                            </div>
                        </div>
                        
                        <div class="p-4 bg-vercel-gray-800 rounded-lg border border-vercel-gray-700">
                            <h5 class="text-vercel-gray-200 font-medium mb-2">File Configuration</h5>
                            <div class="text-vercel-gray-400 text-sm space-y-1">
                                <div><strong>JSON Path:</strong> ${config.json_path}</div>
                                <div><strong>File Pattern:</strong> ${config.file_pattern}</div>
                                <div><strong>Status:</strong> 
                                    <span class="status-${config.is_configured ? 'active' : 'pending'}">
                                        ${config.is_configured ? 'Configured' : 'Pending'}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    ${config.last_tested ? `
                        <div class="p-4 bg-vercel-gray-800 rounded-lg border border-vercel-gray-700">
                            <h5 class="text-vercel-gray-200 font-medium mb-2">Last Test</h5>
                            <div class="text-vercel-gray-400 text-sm">
                                ${new Date(config.last_tested).toLocaleString()}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            showStatus('Configuration loaded successfully', 'success');
        } else {
            document.getElementById('current-config-display').innerHTML = `
                <div class="text-center py-8">
                    <div class="w-16 h-16 bg-vercel-gray-800 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-server text-vercel-gray-400 text-2xl"></i>
                    </div>
                    <p class="text-vercel-gray-400">No configuration found. Save a configuration to see details here.</p>
                </div>
            `;
            showStatus('No configuration found', 'warning');
        }
    })
    .catch(error => {
        showStatus('Error loading configuration: ' + error, 'error');
    });
}

function clearConfiguration() {
    if (confirm('Are you sure you want to clear the server configuration? This action cannot be undone.')) {
        showStatus('Clearing configuration...', 'info');
        
        fetch('/api/clear-server-config', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showStatus('Configuration cleared successfully', 'success');
                
                // Clear form fields
                document.getElementById('server-config-form').reset();
                document.getElementById('server_port').value = 22;
                document.getElementById('server_json_path').value = '/opt/gbot-web-app/credentials/';
                document.getElementById('server_file_pattern').value = '*.json';
                
                // Trigger auth method change
                document.getElementById('server_auth_method').dispatchEvent(new Event('change'));
                
                // Update current config display
                loadCurrentConfig();
                
                // Hide test results
                document.getElementById('test-results-section').style.display = 'none';
            } else {
                showStatus('Error clearing configuration: ' + data.error, 'error');
            }
        })
        .catch(error => {
            showStatus('Network error: ' + error, 'error');
        });
    }
}

function showStatus(message, type) {
    const bgClass = type === 'success' ? 'alert-vercel-success' : 
                   type === 'error' ? 'alert-vercel-error' : 
                   type === 'warning' ? 'alert-vercel-warning' : 'alert-vercel-info';
    
    const icon = type === 'success' ? 'fa-check-circle' : 
                type === 'error' ? 'fa-exclamation-triangle' : 
                type === 'warning' ? 'fa-exclamation-circle' : 'fa-info-circle';
    
    const statusHtml = `
        <div class="${bgClass} flex items-center space-x-3 mb-3 rounded-lg shadow-lg">
            <i class="fas ${icon} text-lg"></i>
            <span class="font-medium flex-1">${message}</span>
            <button type="button" class="text-current opacity-50 hover:opacity-100" onclick="this.parentElement.remove()">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    
    document.getElementById('status-messages').insertAdjacentHTML('afterbegin', statusHtml);
    
    // Auto-hide success and info messages after 5 seconds
    if (type === 'success' || type === 'info') {
        setTimeout(function() {
            const alerts = document.querySelectorAll('.alert-vercel-success, .alert-vercel-info');
            alerts.forEach(alert => {
                if (alert.parentElement) {
                    alert.remove();
                }
            });
        }, 5000);
    }
}

// Load current configuration when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadCurrentConfig();
});
</script>
{% endblock %}