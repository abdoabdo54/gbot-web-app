{% extends "base.html" %}
{% block content %}
<div class="container" style="padding: 16px;">
  <h2 style="margin-bottom: 12px;">DNS Manager</h2>

  <div class="card" style="margin-bottom: 16px;">
    <div class="card-header">Namecheap API Configuration</div>
    <div class="card-body">
      <div id="cfg-status" class="alert" style="display:none;"></div>
      <form id="cfg-form">
        <div class="row">
          <div class="col">
            <label>ApiUser</label>
            <input type="text" class="form-control" id="cfg_api_user" required>
          </div>
          <div class="col">
            <label>UserName</label>
            <input type="text" class="form-control" id="cfg_username" required>
          </div>
        </div>
        <div class="row" style="margin-top:8px;">
          <div class="col">
            <label>ApiKey</label>
            <input type="password" class="form-control" id="cfg_api_key" required>
            <small style="color:#6c757d;"># !!! PLAIN STORAGE â€” REPLACE BEFORE PROD</small>
          </div>
          <div class="col">
            <label>ClientIp</label>
            <input type="text" class="form-control" id="cfg_client_ip" required>
          </div>
        </div>
        <div style="margin-top:12px;">
          <button type="submit" class="btn btn-primary">Save Configuration</button>
          <button type="button" id="btn-fetch-domains" class="btn btn-secondary">Fetch Domains</button>
        </div>
      </form>
    </div>
  </div>

  <div class="row">
    <div class="col-6">
      <div class="card" style="margin-bottom: 16px;">
        <div class="card-header">Domains</div>
        <div class="card-body">
          <ul id="domains-list" class="list-group"></ul>
        </div>
      </div>

      <div class="card" style="margin-bottom: 16px;">
        <div class="card-header">Google Site Verification</div>
        <div class="card-body">
          <div class="row">
            <div class="col">
              <label>Selected domain</label>
              <input type="text" id="ver_domain" class="form-control" readonly>
            </div>
            <div class="col">
              <label>Host/Subdomain</label>
              <input type="text" id="ver_host" class="form-control" placeholder="@ or subdomain" value="@">
            </div>
          </div>
          <div style="margin-top:12px;">
            <button id="btn-apply-token" class="btn btn-success">Generate TXT & Apply</button>
            <button id="btn-verify" class="btn btn-outline-success">Verify Now</button>
          </div>
          <div id="ver-status" class="alert" style="display:none; margin-top:10px;"></div>
        </div>
      </div>
    </div>

    <div class="col-6">
      <div class="card" style="margin-bottom: 16px;">
        <div class="card-header">DNS Records</div>
        <div class="card-body">
          <div class="row">
            <div class="col">
              <label>Selected domain</label>
              <input type="text" id="rec_domain" class="form-control" readonly>
            </div>
            <div class="col">
              <label>Host</label>
              <input type="text" id="rec_host" class="form-control" placeholder="@ or subdomain">
            </div>
            <div class="col">
              <label>Type</label>
              <select id="rec_type" class="form-control">
                <option>A</option>
                <option>AAAA</option>
                <option>CNAME</option>
                <option>TXT</option>
                <option>MX</option>
                <option>NS</option>
                <option>SRV</option>
              </select>
            </div>
            <div class="col">
              <label>Value</label>
              <input type="text" id="rec_value" class="form-control">
            </div>
            <div class="col">
              <label>TTL</label>
              <input type="number" id="rec_ttl" class="form-control" value="1800">
            </div>
          </div>
          <div style="margin-top:12px;">
            <button id="btn-upsert-record" class="btn btn-primary">Add/Update Record</button>
          </div>
          <div style="margin-top:12px;">
            <table class="table table-sm" id="hosts-table">
              <thead>
                <tr><th>Host</th><th>Type</th><th>Value</th><th>TTL</th><th>MXPref</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">Debug Log</div>
        <div class="card-body" style="max-height:240px; overflow:auto;">
          <ul id="logs" class="list-group"></ul>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function showMsg(el, msg, type) {
  el.className = 'alert alert-' + (type || 'info');
  el.textContent = msg;
  el.style.display = 'block';
}

async function loadConfig() {
  const res = await fetch('/api/dns/namecheap/config');
  const data = await res.json();
  if (data.config) {
    document.getElementById('cfg_api_user').value = data.config.api_user || '';
    document.getElementById('cfg_username').value = data.config.username || '';
    document.getElementById('cfg_client_ip').value = data.config.client_ip || '';
  }
}

document.getElementById('cfg-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const body = {
    api_user: document.getElementById('cfg_api_user').value.trim(),
    api_key: document.getElementById('cfg_api_key').value.trim(),
    username: document.getElementById('cfg_username').value.trim(),
    client_ip: document.getElementById('cfg_client_ip').value.trim(),
  };
  const res = await fetch('/api/dns/namecheap/config', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
  const data = await res.json();
  if (data.success) {
    showMsg(document.getElementById('cfg-status'), 'Configuration saved', 'success');
  } else {
    showMsg(document.getElementById('cfg-status'), data.error || 'Save failed', 'danger');
  }
});

async function fetchDomains() {
  const btn = document.getElementById('btn-fetch-domains');
  btn.disabled = true;
  try {
    const res = await fetch('/api/dns/namecheap/domains');
    const data = await res.json();
    const ul = document.getElementById('domains-list');
    ul.innerHTML = '';
    if (data.success && Array.isArray(data.domains)) {
      data.domains.forEach(d => {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        const name = d.Domain || d;
        const isOur = d.IsOurDNS === true || d.IsOurDNS === 'true';
        li.innerHTML = `<span>${name} <small class="text-muted">${d.Expires ? '(exp ' + d.Expires + ')' : ''}</small></span>` +
                       `<span class="badge ${isOur ? 'bg-success' : 'bg-secondary'}">${isOur ? 'Our DNS' : 'External DNS'}</span>`;
        li.style.cursor = 'pointer';
        li.addEventListener('click', () => selectDomain(name, isOur));
        ul.appendChild(li);
      });
    }
  } finally {
    btn.disabled = false;
  }
}

document.getElementById('btn-fetch-domains').addEventListener('click', fetchDomains);

let selectedDomain = '';
function selectDomain(name, isOur) {
  selectedDomain = name;
  document.getElementById('rec_domain').value = name;
  document.getElementById('ver_domain').value = name;
  loadHosts(name);
}

async function loadHosts(domain) {
  const res = await fetch('/api/dns/namecheap/hosts?domain=' + encodeURIComponent(domain));
  const data = await res.json();
  const tbody = document.querySelector('#hosts-table tbody');
  tbody.innerHTML = '';
  if (data.success && Array.isArray(data.hosts)) {
    data.hosts.forEach(h => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${h.HostName}</td><td>${h.RecordType}</td><td>${h.Address}</td><td>${h.TTL}</td><td>${h.MXPref || ''}</td>`;
      tbody.appendChild(tr);
    });
  }
}

document.getElementById('btn-upsert-record').addEventListener('click', async () => {
  const domain = document.getElementById('rec_domain').value.trim();
  const host = document.getElementById('rec_host').value.trim() || '@';
  const type = document.getElementById('rec_type').value;
  const value = document.getElementById('rec_value').value.trim();
  const ttl = parseInt(document.getElementById('rec_ttl').value || '1800', 10);
  if (!domain || !value) return;
  const res = await fetch('/api/dns/namecheap/record', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({domain, host, type, value, ttl})});
  const data = await res.json();
  if (data.success) {
    await loadHosts(domain);
  }
});

document.getElementById('btn-apply-token').addEventListener('click', async () => {
  const domain = document.getElementById('ver_domain').value.trim();
  const host = document.getElementById('ver_host').value.trim() || '@';
  if (!domain) return;
  const res = await fetch('/api/dns/namecheap/verify-domain', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({domain, host, auto_verify: false})});
  const data = await res.json();
  if (data.success) {
    showMsg(document.getElementById('ver-status'), 'TXT token applied', 'success');
    await loadHosts(domain);
  } else {
    showMsg(document.getElementById('ver-status'), data.error || 'Failed', 'danger');
  }
});

document.getElementById('btn-verify').addEventListener('click', async () => {
  const domain = document.getElementById('ver_domain').value.trim();
  const host = document.getElementById('ver_host').value.trim() || '@';
  if (!domain) return;
  const res = await fetch('/api/dns/namecheap/verify-domain', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({domain, host, auto_verify: true})});
  const data = await res.json();
  if (data.success) {
    showMsg(document.getElementById('ver-status'), 'Verification attempted. Check Google Search Console.', 'success');
  } else {
    showMsg(document.getElementById('ver-status'), data.error || 'Failed', 'danger');
  }
});

async function refreshLogs() {
  const res = await fetch('/api/dns/namecheap/logs?limit=100');
  const data = await res.json();
  const ul = document.getElementById('logs');
  ul.innerHTML = '';
  if (data.success && Array.isArray(data.logs)) {
    data.logs.slice().reverse().forEach(l => {
      const li = document.createElement('li');
      li.className = 'list-group-item';
      li.textContent = `[${l.timestamp}] ${l.operation} ${l.domain ? '(' + l.domain + ')' : ''} - ${l.status}: ${l.message}`;
      ul.appendChild(li);
    });
  }
}

setInterval(refreshLogs, 5000);

window.addEventListener('DOMContentLoaded', async () => {
  await loadConfig();
  await fetchDomains();
  await refreshLogs();
});
</script>
{% endblock %}
